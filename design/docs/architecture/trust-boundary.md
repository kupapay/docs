# Trust Boundary

Bono Pay enforces a **deny-by-default** trust boundary where every POS client, cloud sync agent, and auditor-facing UI lives in the *untrusted zone*, and the USB Fiscal Memory device (DEF) is the sole **trusted** authority that validates a canonical payload, signs it, increments the monotonic counters, and produces the fiscal response. The architectural rationale and the two-phase commit protocol are spelled out in `spec/architecture-kutapay-system-1.md` and `docs/adr/adr-0001-two-phase-commit-usb-protocol.md`.

!!! warning "Trust boundary enforcement"
    No data that can compromise fiscal integrity ever travels from the trusted zone back into the untrusted hosts. The DEF never releases private keys, raw counters, or hash-chain materials; hosts receive only the sealed fiscal response after a successful COMMIT.

!!! caution "Architecture review findings"
    - The specification did not explicitly call out replay or nonce-expiry failure modes; the new documentation explains how the PREPARE nonce resists replay and why expired nonces force a fresh PREPARE before the device mutates state.
    - Power/cable loss scenarios were present in ADR-0001 but lacked a boundary-level summary; this doc highlights each failure mode so integrators understand that no invoice leaves the device unless the COMMIT completes and a fiscal response is emitted.

## What crosses the boundary

1. **Canonical payloads** — Every invoice starts as deterministic JSON (`merchant_nif`, `client` classification, `items[]`, `tax_groups[]`, outlet/POS/cashier IDs, `totals`, `timestamp`) generated by the untrusted POS and routed through the local fiscal service before ever touching the DEF (spec §3.1, §3.2).
2. **USB CDC 2PC handshake** — The PREPARE/COMMIT messages, nonce challenge, and success/failure acknowledgments traverse the USB CDC connection; the DEF performs validation during PREPARE and atomic writes only when COMMIT arrives (ADR-0001 §Phase 1 & 2).
3. **Sealed fiscal response** — After the COMMIT succeeds the DEF emits `{fiscal_number, device_id, auth_code, timestamp, qr_payload}`. Hosts use this sealed response to print receipts, queue sealed invoices for cloud sync, and upload to the DGI, but nothing more trusted crosses back into the POS.
4. **Queued sealed invoices** (cloud) — The untrusted cloud sync service transports only the DEF-generated payload to the DGI, preserving the sealed envelope without re-signing or altering contents (spec §3.2, §3.3).

## What never crosses the boundary

- **Private keys or signing material** — The secure element inside the DEF keeps the signing key locked down; no host ever sees it.
- **Raw monotonic counters or journal data** — Only the DEF can append to the hash-chained journal; hosts never read or increment counters directly.
- **Unverified receipts** — Receipts are printed only after the POS receives the fiscal response; hosts may not issue fiscalized receipts without the DEF’s confirmation (ADR-0001 §Consequences).
- **Vendor-side nonce management** — The nonce generated during PREPARE lives in-device until COMMIT returns; the host cannot fabricate or replay a COMMIT without that nonce.
- **Audit or internal health metrics** — Command responses like `QRY|STATUS` surface derived, read-only views; the hosts cannot mutate device health directly.

```mermaid
flowchart LR
    subgraph Untrusted POS Zone
        POS["POS Clients<br/>Sale entry, Tax UI, Receipt Printer"]
        FS["Local Fiscal Service<br/>Serializes PREPARE/COMMIT + mediates multi-terminal access"]
    end
    subgraph Trusted USB Zone
        DEF["USB Fiscal Memory Device (DEF)<br/>Schema validator, Monotonic counter, Signer, Journal"]
    end
    subgraph Bono Pay Cloud
        Cloud[Cloud Sync + Registry]
    end
    subgraph DGI
        DGI["DGI (MCF/e-MCF)"]
    end
    POS -->|canonical JSON payload| FS
    FS -->|PREPARE / COMMIT over USB CDC| DEF
    DEF -->|fiscal response: fiscal_number, auth_code, timestamp, QR| FS
    FS -->|sealed invoice + security bundle| Cloud
    Cloud -->|sealed invoice upload| DGI
```

## Failure modes at the boundary

1. **Power loss before COMMIT** — The device never increments counters or writes to the journal during PREPARE. If power fails, the nonce expires and the POS must re-prepare; no fiscal number is issued (ADR-0001 §Failure Semantics).
2. **Power loss during COMMIT** — Firmware must ensure COMMIT is atomic; either the journal append completes and the response is retrievable via `QRY|LOG`, or the device rolls back without altering counters (ADR-0001 §Implementation Notes IMP-002).
3. **Cable disconnect / host crash** — The DEF never trusts the host; after a crash the host queries `QRY|STATUS`/`QRY|LOG` to reconcile. If COMMIT already succeeded, the sealed fiscal response remains the authoritative source for printing and syncing.
4. **Corrupt canonical payload** — During PREPARE the DEF validates schema, tax groups, and deterministic ordering. Any mismatch results in rejection with a clear error, forcing the host to fix the payload before COMMIT (spec §3.1, ADR-0001 §Phase 1).
5. **Replay or stale nonce** — The nonce issued during PREPARE has a short TTL. If the host delays or re-sends a COMMIT after expiry, the DEF rejects it, resets to PREPARE, and logs the event for auditing (ADR-0001 §Implementation Notes IMP-001).

## Trust assumptions table

| Assumption | Enforcement |
| --- | --- |
| The DEF is the only source of truth for fiscal numbers, signatures, and journals. | Firmware limits counter mutations to COMMIT and writes the append-only journal, preventing remote hosts from altering state. |
| Only canonical JSON payloads reach the DEF, and they include DGI-required fields and classifications. | Local fiscal service serializes deterministic payloads (merchant NIF, client classification, tax group breakdown) before USB handoff (spec §3.1, §3.4). |
| Hosts may not fabricate fiscal elements after the device replies. | The fiscal response bundle carries every security element (number, auth code, timestamp, QR) that printers, cloud, and auditors rely on; any absence triggers denial of service from the device. |
| Multi-terminal environments share one DEF per outlet. | The fiscal service gates access with the nonce-based 2PC handshake, serializing requests and preventing simultaneous counter consumption (spec §3.3, ADR-0001 §Consequences). |
| Audit stakeholders trust the device for reports (Z/X/A) and history exports. | The DEF generates reports from its hash-chained journal and exports data via dedicated commands (`RPT|Z`, `RPT|X`, `RPT|A`, `ADM|DUMPLOG`). |

## Next steps

Continue to tie these trust rules into the hardware and protocol docs (Tasks 006–011) so that future integrators understand that anything crossing the blue/red border above must go through the PREPARE→COMMIT handshake, while nothing trusted ever leaks back into the hosts.
