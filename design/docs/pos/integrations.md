# Integrations

KutaPay supports a spectrum of integrations that feed fiscal data from the POS/merchant stack to auditors, accountants, and regulators. The integration priority below keeps the most sensitive, trusted channels at the top of the stack.

!!! note "Integration priority"
    1. Core fiscal API (USB device communication)
    2. CSV import/export
    3. Accounting export
    4. Webhooks
    5. E-commerce plugins
    6. ERP connectors (Odoo, SAP)

Each tier adds value for a different audience while reusing the sealed invoice, tax group breakdown, and security elements generated by the USB Fiscal Memory device.

## 1. Core fiscal API (USB device communication)
**Target users:** POS integrators, fiscal service developers, and on-premise IT teams that keep a device service running beside every checkout lane.  
**Data format:** Canonical JSON payload (see spec) with deterministic field ordering: `merchant_nif`, `outlet_id`, `pos_terminal_id`, `cashier_id`, `invoice_type`, `timestamp`, `client`, `items[]`, `tax_groups[]`, `totals`, `payments`.  
**Authentication:** USB CDC connection + two-phase commit (PREPARE → COMMIT) using nonce validation so the device owns the fiscal counter.  
**Example payload (canonical JSON):**
```json
{
  "merchant_nif": "123456789",
  "outlet_id": "OUTLET-42",
  "pos_terminal_id": "POS-07",
  "cashier_id": "CASHIER-01",
  "invoice_type": "sale",
  "timestamp": "2026-02-17T12:15:00Z",
  "client": {
    "registration": "CUST-555",
    "classification": "company"
  },
  "items": [
    {
      "code": "SKU-INVERTER",
      "description": "Solar inverter",
      "quantity": 1,
      "unit_price": 100000,
      "tax_group": "TG02",
      "taxable_unit": "EA"
    }
  ],
  "tax_groups": [
    {
      "code": "TG02",
      "name": "Standard VAT — Goods",
      "rate": 0.16,
      "base_amount": 100000,
      "tax_amount": 16000
    }
  ],
  "totals": {
    "subtotal": 100000,
    "total_vat": 16000,
    "total": 116000,
    "currency": "CDF"
  },
  "payments": [
    {
      "method": "mobile_money",
      "amount": 116000,
      "instrument_id": "MOMO-012"
    }
  ]
}
```

## 2. CSV import/export
**Target users:** Finance clerks, compliance officers, and auditors who need bulk import/export for historical invoices or once-off reconciliations.  
**Data format:** CSV files with headers such as `invoice_number`, `issue_date`, `client_name`, `tax_group`, `subtotal`, `total_vat`, `total`, `status`. Each row references the sealed invoice number generated by the USB device.  
**Authentication:** Secure upload into KutaPay Cloud via SFTP/HTTPS using dedicated API keys and IP allow lists; the cloud service validates that each row maps to an existing sealed invoice before accepting it.  
**Example CSV snippet:**
```
invoice_number,issue_date,client_name,tax_group,subtotal,total_vat,total,status
KUTA001-105,2026-02-16,SF Enterprises,TG02,100000,16000,116000,fiscalized
+KUTA001-106,2026-02-16,Embassy of Kinshasa,TG01,500,0,500,fiscalized
```

## 3. Accounting export
**Target users:** Accountants, ERP adapters, and CFOs who push summarized fiscal data into ledgers, general journals, or budgeting tools.  
**Data format:** JSON or NDJSON stream with `period`, `currency`, and `entries` that include `account_code`, `invoice_ref`, `amount`, `tax_group`, and `fiscal_number`. Exports can be monthly or triggered on demand.  
**Authentication:** REST API with bearer tokens scoped per finance team; tokens are issued after device authentication and tied to the outlet’s registry entry to keep the audit trail intact.  
**Example payload:**
```json
{
  "period": "2026-02",
  "currency": "CDF",
  "entries": [
    {
      "account_code": "411001",
      "invoice_ref": "KUTA001-105",
      "amount": 116000,
      "tax_group": "TG02",
      "fiscal_number": "KUTA001-105"
    },
    {
      "account_code": "411002",
      "invoice_ref": "KUTA001-106",
      "amount": 500,
      "tax_group": "TG01",
      "fiscal_number": "KUTA001-106"
    }
  ]
}
```

## 4. Webhooks
**Target users:** Inventory systems, CRM platforms, or analytics pipelines that react the moment a fiscal event closes.  
**Data format:** Signed HTTP POST with JSON payload describing `event`, `merchant_nif`, `fiscal_number`, `total`, `tax_breakdown`, and `metadata`.  
**Authentication:** HMAC signature (`X-KutaPay-Signature`) calculated over the payload with a shared secret per subscriber; receivers must verify the signature before acting.  
**Example payload:**
```json
{
  "event": "invoice.fiscalized",
  "timestamp": "2026-02-17T12:16:00Z",
  "merchant_nif": "123456789",
  "fiscal_number": "KUTA001-105",
  "total": 116000,
  "tax_breakdown": [
    { "tax_group": "TG02", "tax_amount": 16000 }
  ],
  "metadata": {
    "pos_terminal_id": "POS-07",
    "cashier_id": "CASHIER-01"
  }
}
```

## 5. E-commerce plugins
**Target users:** Online merchants (Shopify, WooCommerce, Magento) and their developers who need frictionless fiscalization for web orders.  
**Data format:** Plugin POSTs JSON to KutaPay Cloud with order-level data (`order_id`, `customer`, `line_items`, `shipping`, `payments`) plus mapping to canonical invoice fields; the cloud service in turn calls the local fiscal service/USB device before streaming the sealed response back into the plugin.  
**Authentication:** OAuth2 client credentials or API tokens provisioned per storefront. Tokens are bound to the merchant account and limited to a specific domain or IP range.  
**Example payload:**
```json
{
  "order_id": "ECOM-2026-004",
  "customer": "Lumumba Market",
  "line_items": [
    {
      "sku": "ECOM-SOLAR",
      "description": "Solar kit",
      "quantity": 2,
      "unit_price": 55000,
      "tax_group": "TG02"
    }
  ],
  "shipping": {
    "method": "express",
    "amount": 4000
  },
  "payments": [
    { "method": "card", "amount": 114000 }
  ]
}
```

## 6. ERP connectors (Odoo, SAP)
**Target users:** Enterprise customers connecting their ERP suites to KutaPay’s fiscal engine for batch invoicing, advanced inventory control, and audit exports.  
**Data format:** Structured JSON (or ERP-native messages such as IDocs) that include `connector_reference`, `invoice_lines`, `client`, `totals`, and `fiscal_metadata`, allowing the ERP to reconcile fiscal numbers with its own documents.  
**Authentication:** Mutual TLS between the ERP connector and KutaPay Cloud or token-based authentication issued per `outlet_id`; connectors also carry the `device_id` of the linked USB device for traceability.  
**Example payload:**
```json
{
  "connector_reference": "ODOO-SO-299",
  "invoice_lines": [
    {
      "product_code": "ERP-001",
      "description": "Consulting hours",
      "quantity": 10,
      "unit_price": 25000,
      "tax_group": "TG03"
    }
  ],
  "client": {
    "name": "National Railways",
    "classification": "company"
  },
  "totals": {
    "subtotal": 250000,
    "total_vat": 40000,
    "total": 290000,
    "currency": "CDF"
  },
  "fiscal_metadata": {
    "merchant_nif": "123456789",
    "device_id": "KUTA001"
  }
}
```

