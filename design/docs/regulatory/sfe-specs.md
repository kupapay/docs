# SFE Specifications (v1)

This page distills the DGI Système de Facturation d'Entreprise (SFE) requirements so the KutaPay design team can trace every regulatory demand to our architecture, fiscal flows, and hardware guarantees.

The official summary calls out the layered deployment (SFE → DEF → MCF/e-MCF → DGI), mandates five invoice types, demands all 14 tax groups, requires Z/X/A/audit reporting, and insists security elements come from the trusted fiscal layer—not the POS. These constraints steer the content on the fiscal engine, hardware, and reports pages.

!!! warning "Trust boundary reminder"
    The USB Fiscal Memory device is the only component that can generate fiscal numbers, authentication codes, trusted timestamps, or QR codes. Everything else (POS, fiscal service, cloud sync) must treat the device as the trusted boundary; see [Architecture Trust Boundary](../architecture/trust-boundary.md) for details.

## Mandatory Invoice Types

| Invoice Type | French Label | Purpose |
|--------------|--------------|---------|
| Sale invoice | Facture de vente | Everyday retail/wholesale sales; the default workflow in `design/docs/fiscal/invoice-lifecycle.md`. |
| Advance invoice | Facture d'avance | Payments received before goods/services are fulfilled; still requires PREPARE → COMMIT. |
| Credit note | Note de crédit | Correction for returned goods or billing adjustments; treated as a new fiscal event. |
| Export invoice | Facture d'exportation | Sales destined outside the DRC; destines the invoice to TG07 (Export Zero Rate). |
| Export credit note | Note de crédit d'exportation | Refund tied to an export transaction, sequenced independently like all refunds. |

> Each type is implemented by the same canonical flow documented in the [Invoice Lifecycle](../fiscal/invoice-lifecycle.md) page: PREPARE the canonical JSON, COMMIT with the nonce, print the fiscal response, queue for sync.

## 14 DGI Tax Groups

| Code | Name | Rate | Notes |
|------|------|------|-------|
| TG01 | Exempt | 0% | Diplomats, embassies, NGOs, government transfers. |
| TG02 | Standard VAT — Goods | 16% | Default for tangible goods. |
| TG03 | Standard VAT — Services | 16% | Professional and intangible services. |
| TG04 | Reduced VAT | 9% | Essential foodstuffs and medicines flagged in catalog metadata. |
| TG05 | Public Financing VAT | 16% | Publicly funded programs; requires funding source metadata. |
| TG06 | Customs VAT | 16% | Imported goods (CIF basis) in addition to duties. |
| TG07 | Export Zero Rate | 0% | Goods/services consumed outside the DRC; requires export certificate. |
| TG08 | Special Regime — Agriculture | 5% | Agribusiness items registered under the agricultural regime. |
| TG09 | Special Regime — Mining | 10% | Mining sector goods/services with operator license metadata. |
| TG10 | Specific Tax — Fuel | 25% | Excise on gasoline, diesel, aviation fuel. |
| TG11 | Specific Tax — Tobacco | 30% | Applies to cigarettes, cigars, and tobacco preparations. |
| TG12 | Specific Tax — Alcohol | 20% | Spirits, beer, wine sold for domestic consumption. |
| TG13 | Specific Tax — Telecommunications | 15% | Mobile/data/SMS packages; include telecom operator ID. |
| TG14 | Specific Tax — Digital Services | 12% | Streaming, SaaS, online advertising delivered to DRC clients. |

These codes feed the canonical `tax_groups` manifest described in `spec/schema-tax-engine-1.md` (project root) and are enforced by the [Tax Engine](../fiscal/tax-engine.md). Each invoice must carry a `tax_summary` entry per group, and the device uses these to drive the Z/X/A reports.

## Required Reports

| Report | Purpose | Trigger |
|--------|---------|---------|
| Z Report | Daily closure with totals per tax group, fiscal number range, and journal hash. | End-of-day or manual closure; device-initiated. |
| X Report | Periodic/session snapshot with counts, totals by payment method, and device health. | Configurable (hourly/shift) for operators or auditors. |
| A Report | Article-level detail, enumerating every line item with tax group, client classification, and invoice reference. | On-demand for audits or DGI requests. |
| Audit Export | Full append-only journal (sales, voids, refunds, resets) sent in chunks for deep reconciliation. | Scheduled (monthly/annual) or upon DGI request. |

Report design lives in [`design/docs/fiscal/reports.md`](../fiscal/reports.md). The Z/X/A outputs also reinforce `design/docs/hardware/usb-device.md` because the device compiles them from its hash-chained journal and counters.

## Security Elements

| Element | Generated by | Where referenced |
|---------|--------------|------------------|
| Sequential fiscal number | USB Fiscal Memory device | Printed on every receipt; enforced by the trusted counter in `design/docs/hardware/usb-device.md`. |
| Device ID (DEF NID) | USB Fiscal Memory device | Identifies the outlet-level DEF in every response and sync payload. |
| Authentication code | DEF signature (e.g., ECDSA) | The cryptographic signature stored in `design/docs/fiscal/security-elements.md`. |
| Trusted timestamp | DEF RTC | Anchor for chronological integrity; the cloud sync agent uses it for ordering. |
| QR code | DEF (encoded fiscal number + auth code + timestamp) | Exposed to inspectors and customers; verified by DGI and internal tools. |

Every element comes from the DEF; the POS software may only display it. See `[Security Elements](../fiscal/security-elements.md)` for per-element verification rules and `[USB Fiscal Memory](../hardware/usb-device.md)` for how the hardware produces them.

## Offline Behavior & DGI Integration

The specification emphasizes that offline issuance is normal. Invoices must still contain security elements, and the SFE must sync with the MCF/e-MCF control modules once connectivity returns. A dedicated sync state machine ensures retries, grace periods, and conflict resolution:

- [`design/docs/cloud/offline-sync.md`](../cloud/offline-sync.md) documents how invoices transition from `PENDING_SYNC` to `ACKNOWLEDGED` or `FAILED`.
- [`design/docs/cloud/dgi-integration.md`](../cloud/dgi-integration.md) captures the known vs unknown pieces of the MCF/e-MCF API and highlights the remaining blockers for homologation.

This layered behavior mirrors the core architecture described in this spec: canonical payloads flow through the fiscal service to the DEF, then the sealed invoice flows through KutaPay Cloud to the DGI control modules before arriving at the backend.

## Data Integrity, Immutability, and Mutations

The SFE must never delete invoices. Corrections are credit notes, voids are new fiscal events, and all entries remain in the device's hash-chained journal. These expectations appear in the [Invoice Lifecycle](../fiscal/invoice-lifecycle.md) narrative and the Architecture Context Map (`memory-bank/context-map.md` in the project root). Any mutation references the original invoice and replays through the same PREPARE → COMMIT sequence, ensuring auditability.

> This page is part of the regulatory view of the MkDocs site. For additional context, consult the [DRC Legal Framework](./legal-framework.md) overview and the [Arrêté Summaries](./arretes.md) tabs.
