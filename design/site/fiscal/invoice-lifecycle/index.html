
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../platform/sdk/" rel="prev"/>
<link href="../tax-engine/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Invoice Lifecycle - Bono Pay Technical Design</title>
<link href="../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="#3FFF00" data-md-color-primary="#3FFF00" data-md-color-scheme="slate" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#invoice-lifecycle">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Bono Pay Technical Design" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Bono Pay Technical Design">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Bono Pay Technical Design
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Invoice Lifecycle
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Bono Pay Technical Design" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Bono Pay Technical Design">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Bono Pay Technical Design
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    
  
    Home
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/overview/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/trust-boundary/">
<span class="md-ellipsis">
    
  
    Trust Boundary
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/components/">
<span class="md-ellipsis">
    
  
    Component Map
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/data-flow/">
<span class="md-ellipsis">
    
  
    Data Flow
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Invoicing Platform
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Invoicing Platform
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/overview/">
<span class="md-ellipsis">
    
  
    Product Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/api/">
<span class="md-ellipsis">
    
  
    Invoicing API
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/dashboard/">
<span class="md-ellipsis">
    
  
    Web Dashboard
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/sdk/">
<span class="md-ellipsis">
    
  
    SDK &amp; Libraries
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Fiscal Engine
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Fiscal Engine
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Invoice Lifecycle
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    
  
    Invoice Lifecycle
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#non-negotiable-six-step-flow">
<span class="md-ellipsis">
      
        Non-negotiable six-step flow
      
    </span>
</a>
<nav aria-label="Non-negotiable six-step flow" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#primary-fiscalization-sequence">
<span class="md-ellipsis">
      
        Primary fiscalization sequence
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#invoice-state-machine">
<span class="md-ellipsis">
      
        Invoice state machine
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#invoice-types">
<span class="md-ellipsis">
      
        Invoice types
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-flows">
<span class="md-ellipsis">
      
        Special flows
      
    </span>
</a>
<nav aria-label="Special flows" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#void-flow">
<span class="md-ellipsis">
      
        Void flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#refund-credit-note-flow">
<span class="md-ellipsis">
      
        Refund (credit note) flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#draft-cancellation">
<span class="md-ellipsis">
      
        Draft cancellation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#report-generation-flow">
<span class="md-ellipsis">
      
        Report generation flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-3-note">
<span class="md-ellipsis">
      
        Phase 3 note
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#references">
<span class="md-ellipsis">
      
        References
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tax-engine/">
<span class="md-ellipsis">
    
  
    Tax Engine (14 Groups)
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../security-elements/">
<span class="md-ellipsis">
    
  
    Security Elements
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reports/">
<span class="md-ellipsis">
    
  
    Reports (Z/X/A)
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Cloud &amp; Sync
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            
  
    Cloud &amp; Sync
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cloud/architecture/">
<span class="md-ellipsis">
    
  
    Cloud Architecture
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cloud/offline-sync/">
<span class="md-ellipsis">
    
  
    Offline-First Sync
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../cloud/dgi-integration/">
<span class="md-ellipsis">
    
  
    DGI Integration
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Platform &amp; Integrations
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            
  
    Platform &amp; Integrations
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/multi-user/">
<span class="md-ellipsis">
    
  
    Multi-User Access
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../platform/integrations/">
<span class="md-ellipsis">
    
  
    Integrations
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Regulatory
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            
  
    Regulatory
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/legal-framework/">
<span class="md-ellipsis">
    
  
    DRC Legal Framework
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/arretes/">
<span class="md-ellipsis">
    
  
    Arrêté Summary
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../regulatory/sfe-specs/">
<span class="md-ellipsis">
    
  
    SFE Specifications
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    
  
    ADRs
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            
  
    ADRs
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/">
<span class="md-ellipsis">
    
  
    Index
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/adr-0001/">
<span class="md-ellipsis">
    
  
    0001 - Two-Phase Commit
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/adr-0002/">
<span class="md-ellipsis">
    
  
    0002 - Signature Algorithm
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/adr-0003/">
<span class="md-ellipsis">
    
  
    0003 - Platform Technology Stack
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/adr-0004/">
<span class="md-ellipsis">
    
  
    0004 - Cloud Fiscal Signing
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adr/adr-0005/">
<span class="md-ellipsis">
    
  
    0005 - Strategic Pivot
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
<span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/cloud/">
<span class="md-ellipsis">
    
  
    Cloud API
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/invoicing-sdk/">
<span class="md-ellipsis">
    
  
    Invoicing SDK
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Implementation
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_10_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_10">
<span class="md-nav__icon md-icon"></span>
            
  
    Implementation
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../implementation/roadmap/">
<span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../implementation/phase-1/">
<span class="md-ellipsis">
    
  
    Phase 1 - Software Invoicing
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../implementation/phase-2/">
<span class="md-ellipsis">
    
  
    Phase 2 - POS &amp; Retail
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../implementation/phase-3/">
<span class="md-ellipsis">
    
  
    Phase 3 - USB Hardware
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../implementation/phase-4/">
<span class="md-ellipsis">
    
  
    Phase 4 - Enterprise
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#non-negotiable-six-step-flow">
<span class="md-ellipsis">
      
        Non-negotiable six-step flow
      
    </span>
</a>
<nav aria-label="Non-negotiable six-step flow" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#primary-fiscalization-sequence">
<span class="md-ellipsis">
      
        Primary fiscalization sequence
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#invoice-state-machine">
<span class="md-ellipsis">
      
        Invoice state machine
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#invoice-types">
<span class="md-ellipsis">
      
        Invoice types
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#special-flows">
<span class="md-ellipsis">
      
        Special flows
      
    </span>
</a>
<nav aria-label="Special flows" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#void-flow">
<span class="md-ellipsis">
      
        Void flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#refund-credit-note-flow">
<span class="md-ellipsis">
      
        Refund (credit note) flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#draft-cancellation">
<span class="md-ellipsis">
      
        Draft cancellation
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#report-generation-flow">
<span class="md-ellipsis">
      
        Report generation flow
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#phase-3-note">
<span class="md-ellipsis">
      
        Phase 3 note
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#references">
<span class="md-ellipsis">
      
        References
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="invoice-lifecycle">Invoice lifecycle<a class="headerlink" href="#invoice-lifecycle" title="Permanent link">¶</a></h1>
<h2 id="non-negotiable-six-step-flow">Non-negotiable six-step flow<a class="headerlink" href="#non-negotiable-six-step-flow" title="Permanent link">¶</a></h2>
<p>Every fiscal invoice must follow the same locked-down path so the trust boundary stays intact, the canonical payload remains deterministic, and the Cloud Signing Service (HSM) retains sole authority over fiscal numbers, signatures, timestamps, and QR payloads.</p>
<ol>
<li><strong>Client apps prepare canonical payloads.</strong> Dashboards, SDKs, and API consumers queue invoices locally if offline (IndexedDB/SQLite) and, once connectivity returns, submit deterministic JSON that includes <code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code> (classification), <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, and <code>timestamp</code>.</li>
<li><strong>Invoicing API validates and taxes.</strong> The platform enforces schema, deterministic field ordering, the 14 DGI tax groups, and client classification before letting the Tax Engine compute the grouped totals and confirm the payload is well-formed.</li>
<li><strong>Cloud Signing Service (HSM) fiscalizes.</strong> The Monotonic Counter Manager guarantees sequential numbering per outlet, the HSM signs the payload (ECDSA), stamps a trusted UTC timestamp, and generates the QR code that bundles fiscal_number, auth_code, timestamp, and verification URL.</li>
<li><strong>Fiscal Ledger persists sealed events.</strong> The hash-chained, append-only ledger stores the sealed invoice, ledger hash, and security metadata so every report and audit entry can trace back to the same fiscal event.</li>
<li><strong>Clients deliver receipts.</strong> The platform surfaces the sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id) so merchants can deliver receipts via email, WhatsApp, PDF download, thermal print, or the API/web dashboard.</li>
<li><strong>Sync Agent uploads to DGI.</strong> The Sync Agent queues sealed invoices for MCF/e-MCF transmission, marks ledger entries <code>Synced_to_DGI</code>, and records acknowledgments as <code>Acknowledged</code>. If the DGI rejects a batch, the Sync Agent retries while preserving the hash chain and reportability.</li>
</ol>
<h3 id="primary-fiscalization-sequence">Primary fiscalization sequence<a class="headerlink" href="#primary-fiscalization-sequence" title="Permanent link">¶</a></h3>
<pre class="mermaid"><code>sequenceDiagram
    participant "Client App (API / Dashboard / SDK)"
    participant "Invoicing API"
    participant "Tax Engine"
    participant "Cloud Signing Service (HSM)"
    participant "Fiscal Ledger"
    participant "Sync Agent"
    participant "DGI (MCF/e-MCF)"

    "Client App (API / Dashboard / SDK)"-&gt;&gt;"Invoicing API": 1. Submit canonical invoice payload
    "Invoicing API"-&gt;&gt;"Tax Engine": 2. Validate schema &amp; compute 14 DGI tax groups
    "Tax Engine"-&gt;&gt;"Cloud Signing Service (HSM)": 3. Assign fiscal number + sign + timestamp + QR
    "Cloud Signing Service (HSM)"-&gt;&gt;"Fiscal Ledger": 4. Persist sealed invoice + ledger hash
    "Fiscal Ledger"-&gt;&gt;"Sync Agent": 5. Enqueue sealed invoice for DGI
    "Sync Agent"-&gt;&gt;"DGI (MCF/e-MCF)": 6. Upload sealed payload + security elements
    "Cloud Signing Service (HSM)"--&gt;&gt;"Client App (API / Dashboard / SDK)": Return sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id)</code></pre>
<h2 id="invoice-state-machine">Invoice state machine<a class="headerlink" href="#invoice-state-machine" title="Permanent link">¶</a></h2>
<pre class="mermaid"><code>stateDiagram-v2
    [*] --&gt; Draft
    Draft --&gt; Submitted : API request accepted
    Submitted --&gt; Validated : Tax engine + payload sanity
    Validated --&gt; Fiscalized : Cloud Signing Service (HSM) approves
    Fiscalized --&gt; Delivered : Receipts delivered / customer notified
    Delivered --&gt; Synced_to_DGI : Sync Agent uploads to DGI (MCF/e-MCF)
    Synced_to_DGI --&gt; Acknowledged : DGI acknowledges upload
    Submitted --&gt; Validation_Failed : Schema/tax mismatch
    Validation_Failed --&gt; Draft : Merchant fixes payload
    Validated --&gt; Signing_Error : HSM rejects or counter issue
    Signing_Error --&gt; Validated : Retry after cleanup
    Synced_to_DGI --&gt; DGI_Rejected : DGI rejects batch
    DGI_Rejected --&gt; Synced_to_DGI : Retry upload</code></pre>
<p>The state diagram enforces the expectation that invoices never skip validation, signing, or synchronization; errors route back to safe states for retries. <code>Synced_to_DGI</code> captures the ledger entry once the Sync Agent pushes the sealed payload to the control modules, and <code>Acknowledged</code> only occurs after DGI confirms receipt.</p>
<h2 id="invoice-types">Invoice types<a class="headerlink" href="#invoice-types" title="Permanent link">¶</a></h2>
<p>Every invoice type the DGI mandates flows through the cloud-first lifecycle above. The Cloud Signing Service (HSM) masks service differences while the Fiscal Ledger keeps the immutable record.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sale invoice</td>
<td><code>SALE</code></td>
<td>Standard retail/wholesale invoice that includes a full 14 tax-group breakdown and cloud-generated security elements.</td>
</tr>
<tr>
<td>Advance invoice</td>
<td><code>ADVANCE</code></td>
<td>Prepayment invoice that locks in tax treatment, yet still uses the same canonical flow and receives a sealed response from the cloud.</td>
</tr>
<tr>
<td>Credit note</td>
<td><code>CREDIT</code></td>
<td>Correction referencing the original fiscal number; signed as a new fiscal event so auditors can trace the adjustment.</td>
</tr>
<tr>
<td>Export invoice</td>
<td><code>EXPORT</code></td>
<td>Duty/export-centric invoice that records customs/product details and shares the canonical payload + signing pipeline.</td>
</tr>
<tr>
<td>Export credit note</td>
<td><code>EXPORT_CREDIT</code></td>
<td>Refund or correction for an export invoice; it binds to the export fiscal number and travels through the cloud signing sequence.</td>
</tr>
</tbody>
</table>
<h2 id="special-flows">Special flows<a class="headerlink" href="#special-flows" title="Permanent link">¶</a></h2>
<h3 id="void-flow">Void flow<a class="headerlink" href="#void-flow" title="Permanent link">¶</a></h3>
<p>Voids are new fiscal events. A merchant references the original <code>fiscal_number</code>, builds a canonical payload with <code>invoice_type: "CREDIT"</code> or a dedicated void marker, and resubmits via <code>POST /api/v1/invoices</code>. The same six-step lifecycle applies: the Tax Engine recomputes totals, the Cloud Signing Service (HSM) issues a fresh fiscal number + signature, and the Fiscal Ledger appends a link back to the voided invoice. No records are deleted.</p>
<h3 id="refund-credit-note-flow">Refund (credit note) flow<a class="headerlink" href="#refund-credit-note-flow" title="Permanent link">¶</a></h3>
<p>Refunds (credit notes) follow the canonical path because fiscalization happens inside the cloud. The Cloud Signing Service assigns a unique fiscal number, timestamps it, and emits a QR payload that the merchant can deliver alongside the refund receipt. The Fiscal Ledger tracks the lineage so auditors can reconcile the refund with the original invoice.</p>
<h3 id="draft-cancellation">Draft cancellation<a class="headerlink" href="#draft-cancellation" title="Permanent link">¶</a></h3>
<p>If a merchant cancels before submitting the canonical payload, the invoice stays local and never touches the trusted boundary. No fiscal number, ledger entry, or security elements are generated until the invoice re-enters the flow.</p>
<div class="admonition warning">
<p class="admonition-title">Ancillary records remain read-only</p>
<p>Every sealed invoice is append-only. Voids, refunds, and corrections create new fiscal events that reference the originals; nothing is rewound or deleted once the payload leaves the client application. This keeps the hash-chained ledger intact and satisfies the DGI mandate.</p>
</div>
<h2 id="report-generation-flow">Report generation flow<a class="headerlink" href="#report-generation-flow" title="Permanent link">¶</a></h2>
<pre class="mermaid"><code>sequenceDiagram
    participant "Merchant / Auditor"
    participant "Cloud API"
    participant "Fiscal Ledger"
    participant "Report Generator"

    "Merchant / Auditor"-&gt;&gt;"Cloud API": Request Z / X / A / audit export
    "Cloud API"-&gt;&gt;"Fiscal Ledger": Query hash-chained sealed invoices
    "Fiscal Ledger"-&gt;&gt;"Report Generator": Supply ordered entries
    "Report Generator"--&gt;&gt;"Cloud API": Return signed report + ledger hash
    "Cloud API"--&gt;&gt;"Merchant / Auditor": Deliver JSON/PDF download link</code></pre>
<p>Reports read the same hash-chained ledger, include fiscal_authority_id + ledger hash, and can stream data to auditors even while the Sync Agent handles DGI uploads.</p>
<h2 id="phase-3-note">Phase 3 note<a class="headerlink" href="#phase-3-note" title="Permanent link">¶</a></h2>
<p>When the archived USB Fiscal Memory device is deployed for DEF homologation, it replaces the Cloud Signing Service only for that outlet’s signing step. The rest of the lifecycle (canonical payload, tax engine, ledger, Sync Agent, reports) remains unchanged. Refer to <code>design/docs-archive/hardware/</code> for the DEF protocol.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">¶</a></h2>
<ul>
<li><code>spec/architecture-kutapay-system-1.md</code> (trust boundary, canonical payload, tax engine, and lifecycle guardrails)</li>
<li><code>.github/copilot-instructions.md</code> (Cloud Signing Service trust rules, offline behavior, and canonical payload requirements)</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
</body>
</html>