{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Bono Pay Technical Design Documentation","text":"<p>Bono Pay is fiscal compliance infrastructure for the DRC's Facture Normalis\u00e9e regime. These documents describe how untrusted POS front-ends, a trusted USB Fiscal Memory device, offline-first workflows, and cloud syncing collaborate to turn every commercial sale into a legally auditable tax event.</p> <p>The site collects architecture, hardware, fiscal engine, cloud, POS, regulatory, ADR, implementation, and API reference layers so the team can build aligned, compliant systems.</p>"},{"location":"#major-sections","title":"Major sections","text":"<ul> <li>Architecture: system overview, trust boundary, component map, and data flows.</li> <li>Hardware: USB device, 2PC protocol, secure element, and manufacturing guidance.</li> <li>Fiscal Engine: invoice lifecycle rules, tax engine, security elements, and reports.</li> <li>Cloud &amp; Sync: cloud architecture, offline-first sync logic, and DGI integration.</li> <li>POS Application: multi-terminal topology, UX principles, and integration strategy.</li> <li>Regulatory: DRC legal framework, arr\u00eat\u00e9 summaries, and SFE specifications.</li> <li>ADRs: architecture decision records with rationale.</li> <li>Implementation: roadmap and phased execution plans.</li> <li>API Reference: USB device commands, cloud endpoints, and POS plugin contracts.</li> </ul>"},{"location":"#how-to-use-this-documentation","title":"How to use this documentation","text":"<ol> <li>Navigate via the menu; each page will grow into its full design narrative.</li> <li>Start with the architecture section to understand trust boundaries, then work outward to hardware, fiscal engine, and cloud layers.</li> <li>Consult ADRs for formal decisions and the implementation pages for planning context.</li> <li>Search for keywords and use the \"Coming soon\" markers to identify work in progress.</li> </ol>"},{"location":"adr/","title":"Architecture Decision Records","text":"<p>The ADR process</p> <p>Architectural Decision Records (ADRs) capture important design trade\u2011offs so the team can revisit the reasoning long after a decision is made. 1. Draft the full record in <code>docs/adr/</code> with the canonical template (Context \u2192 Decision \u2192 Consequences \u2192 References). 2. Mirror the narrative for readers in <code>design/docs/adr/</code> so the marketing/ops audience can navigate the approved choices. 3. Link the ADR to the relevant design area (architecture, hardware, POS, etc.) and include status badges (<code>Accepted</code>, <code>Proposed</code>, <code>Superseded</code>). 4. Raise a new ADR as soon as a decision affects the trust boundary, protocol, hardware, or regulatory compliance; reference the implementation plan task that triggered it.</p>"},{"location":"adr/#current-decisions","title":"Current decisions","text":"ADR Status Summary Source Design doc ADR-0001: Two-Phase Commit for USB Fiscal Device Protocol Accepted Enforces the 2PC PREPARE \u2192 COMMIT handshake so fiscal numbers only exist once the trusted USB device signs and stores every invoice. See <code>docs/adr/</code> in project root <code>adr-0001.md</code> ADR-0002: Signature Algorithm Selection Proposed Compare ECDSA P-256, Ed25519, and RSA-2048, balancing SE support, signature size, and verification performance. Planned \u2014 see <code>docs/adr/</code> in project root <code>adr-0002.md</code> (placeholder) ADR-0003: POS Technology Stack Proposed Evaluate Flutter, React Native + native bridge, Electron + native Android, and other offline-ready stacks for the POS application. Planned \u2014 see <code>docs/adr/</code> in project root <code>adr-0003.md</code> (placeholder) <p>Add new ADRs by copying this page, updating the table, and linking to the supporting docs. Keep the \"Status\" column in sync with the implementation plan so readers can trace acceptance and deployment milestones.</p>"},{"location":"adr/adr-0001/","title":"ADR 0001 - Two-Phase Commit","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"adr/adr-0002/","title":"ADR-0002: Signature Algorithm Selection","text":""},{"location":"adr/adr-0002/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"adr/adr-0002/#context","title":"Context","text":"<ul> <li>The USB Fiscal Memory device and its Secure Element are the only components that ever see the private signing key (design/docs/hardware/secure-element.md). Nothing outside the SE can derive, export, or clone this key, so the algorithm must be supported inside the sealed chip.</li> <li>The Secure Element review already evaluated ECDSA P-256 versus Ed25519 and concluded that the family we selected (ATECC608B / SE050) already accelerates P-256 and matches the curve used on existing fiscal certificates. Ed25519 is treated as a future-proof option pending regulatory and vendor certification, while RSA is too heavy for the MCU (design context + DISCUSSION.md lines 7285-7400 explain why hardware is mandated).</li> <li>The DGI has not published a mandatory signature algorithm, but inspectors expect curves compatible with earlier fiscal memories and want minimal signature payloads on receipts.</li> </ul>"},{"location":"adr/adr-0002/#options","title":"Options","text":"<ol> <li>ECDSA P-256 (current baseline) </li> <li>Pros: Hardware acceleration available in ATECC608B/SE050; produces 64-byte signatures that fit on receipts and QR codes; aligns with curves used in existing fiscal certificates; familiar to auditors.  </li> <li> <p>Cons: Requires careful nonce and counter governance inside the SE, but that logic already exists.</p> </li> <li> <p>Ed25519 (future option) </p> </li> <li>Pros: Smaller signature size (64 bytes) with faster signing on modern SEs; better resilience to some side-channel attacks; easier canonicalization.  </li> <li> <p>Cons: Not yet certified by the SE vendor for our hardware, and the DGI has not approved the curve; adopting it would force a platform change and additional regulatory work.</p> </li> <li> <p>RSA-2048 </p> </li> <li>Pros: Very mature and widely understood by regulators.  </li> <li>Cons: Signature payloads are large (&gt; 256 bytes), which burdens QR codes and receipts; signing performance is poor on constrained MCUs; the SEs we selected (ATECC608B/SE050) are optimized for ECC, not RSA.</li> </ol>"},{"location":"adr/adr-0002/#rationale","title":"Rationale","text":"<p>ECDSA P-256 is the most practical choice today because it is natively accelerated by the Secure Element family we already selected, matches the public curve seen in the current fiscal authorities\u2019 certificates, and keeps signature sizes manageable for receipts and QR codes (design/docs/hardware/secure-element.md). The activation flow (<code>CFG|INIT</code>) and journal signing flow already assume this curve, so switching algorithms would require new protocol definitions and resets of the counter/nonce governance. Ed25519 remains a candidate for later phases once the vendor and DGI certify support, while RSA is ruled out because of its performance and payload penalties.</p>"},{"location":"adr/adr-0002/#decision","title":"Decision","text":"<p>Adopt ECDSA P-256 as the signature algorithm for all invoices signed by the USB Fiscal Memory device. The SE will generate the key pair on-device, enforce the PREPARE \u2192 COMMIT lifecycle, and never expose the private key.</p>"},{"location":"adr/adr-0002/#consequences","title":"Consequences","text":"<ul> <li>Downstream systems (receipts, cloud, auditors) can rely on 64-byte signatures produced by the SE and validated against the public certificate presented during <code>QRY|STATUS</code>.</li> <li>If future hardware or regulatory changes require another curve (e.g., Ed25519), we will document the migration in a new ADR and revise the USB protocol accordingly, including updates to nonce expiry and journal verification logic.</li> </ul>"},{"location":"adr/adr-0003/","title":"ADR-0003: POS Technology Stack","text":""},{"location":"adr/adr-0003/#decision-2026-02-17","title":"Decision - 2026-02-17","text":"<p>Decision: Adopt a Progressive Web App (PWA) front-end paired with a dedicated local fiscal daemon to run the Bono Pay POS across Android, desktop, and low-end hardware while respecting the trust boundary and USB fiscalization requirements.</p> <p>Context: - The POS UI must run on Android tablets/phones, laptops, and eventually desktops while keeping the experience as fluid as the Odoo baseline described in <code>design/docs/pos/ui-ux.md</code>. - The interface must stay offline-first (Service Worker + IndexedDB caching), show fiscal status in real time, and never print or persist a sale until the USB Fiscal Memory device completes PREPARE \u2192 COMMIT. - Browsers cannot access raw USB endpoints or run long-lived USB CDC connections, so any Web layer must delegate device interactions to a trusted local daemon that enforces the canonical payload, handles nonce lifecycles, and maintains the trust boundary. - The team must balance offline storage, USB communication, developer skill sets, and the desire to share UI assets across Android, desktop, and web-like surfaces.</p> <p>Options: 1. PWA + local daemon    - Pros: Leverages the PWA/offline lessons from the POS UX direction, runs on tablets, phones, and desktops without platform-specific builds, and updates instantly through the browser while IndexedDB and Service Workers keep catalogs and queue state offline. The local daemon (fiscal service) encapsulates USB CDC communication, nonce handling, and canonical payload serialization, keeping the trust boundary intact.    - Cons: Requires installing or running a small native helper on each terminal, but the helper can be minimal (Java/Go/Rust) and scoped strictly to device interactions. 2. Flutter (single codebase)    - Pros: Compiles to Android, desktop, and potentially web, offers smooth UI performance, and can reuse a single Dart codebase. Offline storage is supported via built-in plugins.    - Cons: Flutter apps still need a native module for USB CDC, complicating the trust boundary, and the team would need Dart expertise. Odoo-style web workflows would need to be rearchitected, and deploying updates requires reinstalling the app rather than just refreshing a browser page. 3. React Native + native bridge    - Pros: Shares JavaScript knowledge with the current web-focused team, supports Android and desktop via multi-platform frameworks, and integrates with native USB code through bridges.    - Cons: Native bridges add maintenance overhead for multiple platforms, offline caching and service worker\u2013style updates do not come naturally, and code sharing with the cloud/web experience remains limited compared to a true web UI. 4. Electron desktop app + separate Android native app    - Pros: Electron can host the Odoo-inspired UI with full control over the file system and USB APIs, while a bespoke Android native app handles tablets.    - Cons: Increases maintenance (two codebases), bloats resource usage, and loses the lightweight, instant-on feel of the PWA. Electron\u2019s appetite for CPU/memory conflicts with low-end retail hardware, and shipping separate apps for Android/tablet undermines the goal of a single POS experience.</p> <p>Rationale: The PWA + local daemon option best balances the UX directives in <code>design/docs/pos/ui-ux.md</code>, offline-first constraints, and the USB trust boundary. The PWA delivers immediate updates, dual-currency dashboards, IndexedDB caching, and the fiscal-first ribbon described in the UX guide. Relying on a local fiscal daemon preserves the canonical payload handshake, nonce lifecycle, and USB CDC framing without exposing those responsibilities to the browser. Flutter, React Native, and Electron introduce heavier runtimes, multi-codebase complexity, or weaker alignment with the Odoo-inspired patterns we already document.</p> <p>Impact: - Build and maintain a minimal local fiscal daemon that can start at terminal boot, expose a secure REST/IPC surface, and talk over USB CDC to the fiscal device while enforcing canonical payload ordering. - Harden deployment/installation so the daemon auto-starts and the browser UI can detect device status, nonces, and offline queue lengths via the daemon\u2019s API. - Document the daemon contract so frontend developers can continue to focus on PWA experiences (Service Workers, IndexedDB, localization) while the daemon owns USB trust boundary enforcement. - Keep observability, logging, and firmware compatibility checks centralized inside the daemon to avoid leaking sensitive state into the untrusted browser.</p> <p>Review: Reevaluate this choice if browsers gain reliable, secure USB CDC support without compromising the trust boundary, or if the daemon approach proves too brittle on specific merchant infrastructure. Also revisit if future compliance requirements demand a fully native stack for certified DGI integrations.</p>"},{"location":"api/cloud/","title":"Cloud API Reference","text":"<p>This API is the cloud-facing bridge between POS terminals, the trusted USB Fiscal Memory device, and the DGI control modules. It stores uploads from <code>spec/architecture-kutapay-system-1.md</code>, replays them in arrival order, and exposes reporting and audit endpoints aligned with <code>spec/design-cloud-api-1.md</code>.</p> <p>Security by design</p> <p>All endpoints require TLS 1.3+, <code>Authorization: Bearer &lt;token&gt;</code>, and the <code>X-KUTAPAY-DEVICE-ID</code> header so we can tie uploads to trusted DEF instances. Never accept invoices with missing canonical fields or unsigned nonces.</p>"},{"location":"api/cloud/#key-endpoints","title":"Key Endpoints","text":"Endpoint Purpose Response highlights <code>POST /api/v1/invoices/upload</code> Accept sealed invoices from the canonical payload and queue them for DGI transmission <code>dgi_status</code>, <code>queued_at</code>, retry hints <code>GET /api/v1/invoices/{fiscal_number}/status</code> Check whether the DGI acknowledged a fiscal number <code>dgi_status</code>, <code>processed_at</code> <code>POST /api/v1/devices/register</code> Register DEF hardware and provision prefixes <code>assigned_prefix</code>, <code>activation_code</code> <code>GET /api/v1/devices/{device_id}/health</code> Monitor DEF heartbeat, counter, and queue <code>current_counter</code>, <code>queued_invoices</code> <code>GET /api/v1/sync/status</code> Surface queue depth, state machine, and retry timing <code>backlog</code>, <code>state</code>, <code>next_retry</code> <code>POST /api/v1/reports</code> Trigger Z/X/A reports derived from the hash-chained journal <code>report_id</code>, <code>download_url</code> <code>GET /api/v1/audit/export</code> Download journal exports for inspections/audit <code>journal_hash</code>, <code>entries</code>, signed downloads <p>Specification reference</p> <p>The endpoint request/response schema definitions live in <code>spec/design-cloud-api-1.md</code> (project root).</p>"},{"location":"api/cloud/#example-invoice-upload","title":"Example: Invoice Upload","text":"<pre><code>POST /api/v1/invoices/upload\nContent-Type: application/json\nAuthorization: Bearer dgi-token\nX-KUTAPAY-DEVICE-ID: DEF-1A2B3C\n\n{\n  \"fiscal_number\": \"KUTA-2026-000123\",\n  \"device_id\": \"DEF-1A2B3C\",\n  \"auth_code\": \"h9fj2w8s...\",\n  \"timestamp\": \"2026-02-17T03:00:00Z\",\n  \"qr_payload\": \"https://secure.dgi/conformity?hash=...\",\n  \"canonical_payload\": {\n    \"merchant_nif\": \"123456789\",\n    \"client\": { \"name\": \"Acme Ltd\", \"nif\": \"987654321\" },\n    \"client_classification\": \"Company\",\n    \"outlet_id\": \"OUTLET-001\",\n    \"pos_terminal_id\": \"POS-01\",\n    \"cashier_id\": \"CASHIER-07\",\n    \"tax_groups\": [\n      { \"code\": \"VAT_STD\", \"amount\": 120.0, \"rate\": 16.0 }\n    ],\n    \"items\": [\n      { \"sku\": \"SKU-001\", \"description\": \"Widget\", \"quantity\": 2, \"unit_price\": 60.0, \"tax_group\": \"VAT_STD\" }\n    ],\n    \"totals\": { \"subtotal\": 120.0, \"tax\": 19.2, \"total\": 139.2 },\n    \"timestamp\": \"2026-02-17T03:00:00Z\"\n  }\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"status\": \"ok\",\n  \"code\": \"INVOICE_UPLOADED\",\n  \"payload\": {\n    \"queued_at\": \"2026-02-17T03:01:00Z\",\n    \"dgi_status\": \"pending\",\n    \"retry_after\": \"2026-02-17T03:05:00Z\"\n  }\n}\n</code></pre>"},{"location":"api/cloud/#example-report-request","title":"Example: Report Request","text":"<pre><code>POST /api/v1/reports\nContent-Type: application/json\nAuthorization: Bearer dgi-token\n\n{\n  \"type\": \"Z\",\n  \"period\": { \"date\": \"2026-02-17\" },\n  \"outlet_id\": \"OUTLET-001\",\n  \"include_journal_hash\": true\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"status\": \"ok\",\n  \"code\": \"REPORT_READY\",\n  \"payload\": {\n    \"report_id\": \"RPT-Z-2026-02-17\",\n    \"download_url\": \"/reports/zip/download/RPT-Z-2026-02-17\",\n    \"generated_at\": \"2026-02-17T03:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"api/cloud/#monitoring-endpoints","title":"Monitoring endpoints","text":"<ul> <li><code>GET /api/v1/devices/{device_id}/health</code> returns the last heartbeat, queue size, and current counter so operations can alert on stalled syncs.</li> <li><code>GET /api/v1/sync/status</code> exposes the sync state machine (PENDING \u2192 RETRYING \u2192 ACKNOWLEDGED) and should power dashboards and alerting rules.</li> <li><code>GET /api/v1/audit/export</code> returns the hash-chained journal with signed <code>journal_hash</code> plus downloadable artifacts for auditors.</li> </ul>"},{"location":"api/cloud/#error-handling-summary","title":"Error handling summary","text":"<ul> <li>Invalid canonical payload: respond with <code>error: INVALID_SIGNATURE</code>.</li> <li>Retries: When <code>dgi_status</code> remains <code>pending</code>, the client should respect <code>retry_after</code> and refrain from re-submitting until the time arrives.</li> <li>Authorization: Fail fast with <code>error: INSUFFICIENT_PERMISSIONS</code> when tokens lack the required scopes for device registration, reporting, or audit exports.</li> </ul>"},{"location":"api/cloud/#notes","title":"Notes","text":"<ul> <li>The cloud API keeps every invoice traceable through <code>fiscal_number</code>, <code>device_id</code>, and <code>outlet_id</code> tags.</li> <li>Keep audit exports within the 30-day window to avoid <code>RANGE_TOO_LARGE</code>.</li> <li>All endpoints should emit structured logs (<code>cloud.request</code>, <code>cloud.response</code>) that include <code>device_id</code>, <code>fiscal_number</code>, and <code>dgi_status</code>.</li> </ul>"},{"location":"api/pos-plugin/","title":"POS Plugin API Reference","text":"<p>The POS plugin is the untrusted client that runs inside each merchant's POS application. It exists to keep the POS software compliant with the Bono Pay trust boundary and to forward canonical JSON invoices through the local fiscal service so the USB Fiscal Memory device (DEF) can do the trusted work. Use this reference when you are integrating a third-party POS or writing a Bono Pay plugin adapter.</p> <p>Trust boundary reminder</p> <p>The POS plugin runs entirely in the untrusted zone. Never attempt to fabricate <code>fiscal_number</code>, <code>device_id</code>, <code>auth_code</code>, <code>timestamp</code>, or <code>qr_payload</code>. Those values must originate from the DEF after a successful PREPARE \u2192 COMMIT handshake.</p>"},{"location":"api/pos-plugin/#authentication-initialization","title":"Authentication &amp; initialization","text":"<p>Every request uses <code>Authorization: Bearer &lt;token&gt;</code> where the token is scoped to the outlet/terminal pair and expires regularly (rotate it before expiry). Include headers <code>X-KUTAPAY-DEVICE-ID</code> and <code>X-KUTAPAY-NONCE</code> when submitting invoices so the fiscal service can correlate nonces with the PREPARE step.</p>"},{"location":"api/pos-plugin/#post-apiv1plugininit","title":"<code>POST /api/v1/plugin/init</code>","text":"<ul> <li>Purpose: synchronize policy/version metadata, learn the current <code>nonce_pool</code>, and confirm the DEF assigned to the outlet.</li> <li>Payload: <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>plugin_version</code>.</li> <li>Response: Returns <code>device_id</code>, <code>policy_version</code>, list of supported tax groups, <code>nonce_pool</code>, and optional <code>max_payload_bytes</code>. Cache these values and refuse to submit invoices if <code>nonce_pool</code> is zero.</li> </ul>"},{"location":"api/pos-plugin/#invoice-submission","title":"Invoice submission","text":"<p>Endpoint: <code>POST /api/v1/plugin/invoices</code></p>"},{"location":"api/pos-plugin/#canonical-payload-requirements","title":"Canonical payload requirements","text":"<ul> <li>Follow the field ordering in <code>spec/architecture-kutapay-system-1.md</code>: <code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>invoice_type</code>, <code>timestamp</code>, <code>client</code> (with <code>classification</code>), <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>.</li> <li>Invoice types: <code>sale</code>, <code>advance</code>, <code>credit_note</code>, <code>export</code>, <code>export_credit</code>.</li> <li>Always include <code>outlet_id</code>, <code>pos_terminal_id</code>, and <code>cashier_id</code> so the fiscal service can enforce one DEF per outlet and maintain sequential counters.</li> <li>Tax groups must cover TG01\u2026TG14 and match the schema (rate, base_amount, tax_amount).</li> <li>Items should carry <code>code</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, <code>taxable_unit</code>.</li> </ul>"},{"location":"api/pos-plugin/#sample-submission","title":"Sample submission","text":"<pre><code>POST /api/v1/plugin/invoices HTTP/1.1\nAuthorization: Bearer eyJhbGciOi...\nContent-Type: application/json\n\n{\n  \"merchant_nif\": \"123456789\",\n  \"outlet_id\": \"OUTLET-005\",\n  \"pos_terminal_id\": \"POS-12\",\n  \"cashier_id\": \"CASHIER-07\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-17T03:10:00Z\",\n  \"client\": {\n    \"registration\": \"987654321\",\n    \"classification\": \"Company\"\n  },\n  \"items\": [\n    {\n      \"code\": \"ITEM-001\",\n      \"description\": \"Consulting hours\",\n      \"quantity\": 2,\n      \"unit_price\": \"500.00\",\n      \"tax_group\": \"TG03\",\n      \"taxable_unit\": \"hour\"\n    }\n  ],\n  \"tax_groups\": [\n    {\n      \"code\": \"TG03\",\n      \"name\": \"Standard VAT \u2014 Services\",\n      \"rate\": \"0.16\",\n      \"base_amount\": \"1000.00\",\n      \"tax_amount\": \"160.00\"\n    }\n  ],\n  \"totals\": {\n    \"subtotal\": \"1000.00\",\n    \"total_vat\": \"160.00\",\n    \"total\": \"1160.00\",\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    {\n      \"method\": \"mobile_money\",\n      \"amount\": \"1160.00\",\n      \"instrument_id\": \"MOMO-123\"\n    }\n  ]\n}\n</code></pre> <pre><code>{\n  \"status\": \"accepted\",\n  \"payload\": {\n    \"fiscal_number\": \"KUTA-2026-000145\",\n    \"device_id\": \"KUTA-OUTLET-005\",\n    \"auth_code\": \"OTS7-AB12-XY99\",\n    \"timestamp\": \"2026-02-17T03:10:05Z\",\n    \"qr_payload\": \"KUTA|145|OTS7AB12|2026-02-17T03:10:05Z\",\n    \"dgi_status\": \"queued\",\n    \"report_links\": [\"/reports/2026-02-17/z\"]\n  }\n}\n</code></pre> <p>Print or store the <code>fiscal_number</code>, <code>auth_code</code>, and <code>qr_payload</code> exactly as returned\u2014the device is the sole authority for those values. Do not proceed to print or re-transmit until VAT totals are confirmed by this response.</p>"},{"location":"api/pos-plugin/#status-endpoint","title":"Status endpoint","text":"<p><code>GET /api/v1/plugin/invoices/{fiscal_number}/status</code></p> <p>Checks whether the invoice has been committed locally and whether Bono Pay Cloud has synced it to the DGI. Useful for POS screens or auditors.</p>"},{"location":"api/pos-plugin/#sample-response","title":"Sample response","text":"<pre><code>{\n  \"status\": \"ok\",\n  \"payload\": {\n    \"fiscal_number\": \"KUTA-2026-000145\",\n    \"device_id\": \"KUTA-OUTLET-005\",\n    \"status\": \"synced\",\n    \"synced_at\": \"2026-02-17T03:15:01Z\",\n    \"last_error\": null\n  }\n}\n</code></pre>"},{"location":"api/pos-plugin/#report-retrieval","title":"Report retrieval","text":"<p><code>GET /api/v1/plugin/reports?type=Z&amp;since=2026-02-17&amp;format=json</code></p> <p>Retrieves device-generated Z/X/A/audit reports without making the POS talk to the DGI directly. Use this for audit exports or when inspectors request proof of the ledger.</p>"},{"location":"api/pos-plugin/#example","title":"Example","text":"<pre><code>GET /api/v1/plugin/reports?type=Z&amp;since=2026-02-17&amp;format=json HTTP/1.1\nAuthorization: Bearer eyJhbGci...\n</code></pre> <pre><code>{\n  \"status\": \"ok\",\n  \"payload\": [\n    {\n      \"report_id\": \"RPT-Z-2026-02-17\",\n      \"download_url\": \"/reports/zip/RPT-Z-2026-02-17\",\n      \"generated_at\": \"2026-02-17T03:30:00Z\",\n      \"summary\": {\n        \"sequence_start\": 120,\n        \"sequence_end\": 156,\n        \"invoice_count\": 37\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"api/pos-plugin/#error-handling","title":"Error handling","text":"Code Meaning Action <code>INVALID_CANONICAL_PAYLOAD</code> Required field missing/order wrong Show cashier the exact fields while prepping again <code>DEVICE_BUSY</code> DEF is processing another invoice Retry after 100\u2013200 ms <code>DEVICE_UNREGISTERED</code> Fiscal service no longer sees the outlet Re-run <code>/init</code> and verify device connectivity <code>RETRY_LATER</code> Nonce pool empty or storage pressure Respect <code>retry_after</code> and call <code>/init</code> when needed <code>AUTH_FAILED</code> Token expired/invalid Rotate token before retry <code>DUPLICATE_FISCAL_NUMBER</code> Invoice already submitted Inspect local journal\u2014do not re-submit <p>All error responses include <code>detail</code> (free text) and optional <code>retry_after</code>.</p>"},{"location":"api/pos-plugin/#implementation-notes","title":"Implementation notes","text":"<ul> <li>Keep a local queue for offline submissions and replay them in FIFO order so arrivals respect the device's sequential counter.</li> <li>Always validate canonical payloads using strict parsers or schema validators\u2014no string-building of JSON from user input (prevents injection-like mistakes).</li> <li>Log and surface <code>nonce</code> TTL to avoid expired nonces; re-call <code>/init</code> when TTL is in the last 10% of its lifetime.</li> <li>Surface <code>report_links</code> to dashboards so auditors can download the corresponding Z/X/A dumps alongside the invoice receipt.</li> <li>When the plugin receives a <code>synced</code> status, mark the invoice as fully complete and allow the cashier to close the transaction.</li> </ul>"},{"location":"api/pos-plugin/#see-also","title":"See also","text":"<ul> <li><code>spec/design-pos-plugin-api-1.md</code> \u2014 formal specification that defines every request/response field.</li> </ul>"},{"location":"api/usb-device/","title":"USB Fiscal Device API Reference","text":""},{"location":"api/usb-device/#overview","title":"Overview","text":"<p>This page documents every USB CDC command that untrusted POS terminals and the local fiscal service use to interact with the trusted USB Fiscal Memory device (DEF). Each command follows the STX/ETX framing described below, and every fiscal request must reuse the canonical invoice payload order so that the device\u2019s JSON hashes, nonce calculations, and signatures remain reproducible.</p>"},{"location":"api/usb-device/#framing-transport","title":"Framing &amp; Transport","text":"<ul> <li>Transport: USB CDC exposes a virtual COM port between the POS/fiscal service and the DEF.</li> <li>Frame structure: <code>STX &lt;ASCII command&gt; [payload] ETX</code>; payloads are UTF-8 encoded JSON with no trailing whitespace, and optional <code>\\r\\n</code> is ignored.</li> <li>Checksum: Commands may append an LRC or CRC32 before the closing <code>ETX</code> for quicker validation.</li> <li>Timeouts: Core transactional commands (<code>PREPARE</code>, <code>COMMIT</code>) must be answered in \u22645 seconds (typically &lt;1 second). Commands that produce reports or diagnostics may take up to 10 seconds and should stream progress if processing is lengthy.</li> <li>Retries: On nonce expiry or recoverable errors, hosts should re-send the <code>PREPARE</code> request. Other commands should be retried conservatively while paying attention to <code>DEVICE_BUSY</code> responses.</li> </ul>"},{"location":"api/usb-device/#canonical-invoice-payload","title":"Canonical Invoice Payload","text":"Field Description <code>merchant_nif</code> DRC tax identification number <code>outlet_id</code> Outlet-level identifier that maps to the DEF <code>pos_terminal_id</code> Terminal issuing the request <code>cashier_id</code> Cashier or waiter initiating the invoice <code>invoice_type</code> One of <code>sale</code>, <code>advance</code>, <code>credit_note</code>, <code>export</code>, <code>export_credit</code> <code>timestamp</code> ISO 8601 string sourced from the DEF RTC <code>client.registration</code> Client tax ID or passport <code>client.classification</code> <code>Individual</code>, <code>Company</code>, <code>CommercialIndividual</code>, <code>Professional</code>, or <code>Embassy</code> <code>items</code> Array of objects with <code>code</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, <code>taxable_unit</code> <code>tax_groups</code> Array with <code>code</code>, <code>name</code>, <code>rate</code>, <code>base_amount</code>, <code>tax_amount</code> <code>totals</code> Object containing <code>subtotal</code>, <code>total_vat</code>, <code>total</code>, <code>currency</code> <code>payments</code> Array describing each payment instrument (<code>method</code>, <code>amount</code>, <code>instrument_id</code>) <p>Caution</p> <p>The device rejects canonical payloads if any field is missing, misordered, or misformatted. Validate the JSON ordering and decimal formatting (<code>\"116.00\"</code> style with DGI rounding rules) before sending <code>TXN|PREPARE</code>.</p>"},{"location":"api/usb-device/#shared-error-codes","title":"Shared Error Codes","text":"Code Meaning <code>SCHEMA_INVALID</code> Required field missing, malformed JSON, or order deviation <code>DEVICE_REVOKED</code> DEF blacklisted by the tax authority <code>STORAGE_FULL</code> Flash journal cannot accept more entries <code>CLOCK_ROLLBACK_DETECTED</code> Device RTC moved backward <code>INVALID_NONCE</code> COMMIT nonce mismatch <code>NONCE_EXPIRED</code> COMMIT not received before nonce TTL <code>REPLAY_DETECTED</code> Invoice hash already processed <code>DEVICE_BUSY</code> Device is processing another operation <code>UNAUTHORIZED</code> Administrative credentials missing or invalid <p>Use these codes in every command response. Always surface the <code>detail</code> text to the POS UI so cashiers and operators understand the remediation steps.</p>"},{"location":"api/usb-device/#txnprepare","title":"TXN|PREPARE","text":"<p>Synopsis: Validate the canonical invoice payload, ensure it complies with schema and policy, and return a nonce before the device mutates any counters.</p> <p>Request</p> <pre><code>STX TXN|PREPARE\n{\n  \"merchant_nif\": \"123456789\",\n  \"outlet_id\": \"KUTA-OUTLET-01\",\n  \"pos_terminal_id\": \"POS-02\",\n  \"cashier_id\": \"CASH-17\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-04T10:15:27\",\n  \"client\": {\n    \"registration\": \"XYZ123\",\n    \"classification\": \"Company\"\n  },\n  \"items\": [\n    {\n      \"code\": \"ITEM-001\",\n      \"description\": \"Service Plan\",\n      \"quantity\": \"2\",\n      \"unit_price\": \"500.00\",\n      \"tax_group\": \"standard_vat\",\n      \"taxable_unit\": \"2\"\n    }\n  ],\n  \"tax_groups\": [\n    { \"code\": \"standard_vat\", \"name\": \"Standard VAT\", \"rate\": \"0.16\", \"base_amount\": \"1000.00\", \"tax_amount\": \"160.00\" }\n  ],\n  \"totals\": { \"subtotal\": \"1000.00\", \"total_vat\": \"160.00\", \"total\": \"1160.00\", \"currency\": \"CDF\" },\n  \"payments\": [\n    { \"method\": \"cash\", \"amount\": \"1160.00\", \"instrument_id\": \"CASH-1\" }\n  ]\n}\nETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"nonce\": \"A7F2D1\",\n  \"expires_in\": 7,\n  \"message\": \"ready to commit\"\n}\n</code></pre> <p>Errors: <code>SCHEMA_INVALID</code>, <code>DEVICE_REVOKED</code>, <code>STORAGE_FULL</code>, <code>CLOCK_ROLLBACK_DETECTED</code>, <code>REPLAY_DETECTED</code>, <code>DEVICE_BUSY</code></p> <p>Notes - Timeout: \u22645 seconds. Retry <code>TXN|PREPARE</code> if the nonce expires or recoverable error occurs. - Do not send any data other than the canonical invoice. - Use <code>expires_in</code> to start a timer\u2014POS must send <code>TXN|COMMIT</code> before the nonce expires.</p>"},{"location":"api/usb-device/#txncommit","title":"TXN|COMMIT","text":"<p>Synopsis: Atomically persist the invoice by incrementing the counter, hashing the payload, signing the journal entry, and returning the fiscal elements to print on the receipt.</p> <p>Request</p> <pre><code>STX TXN|COMMIT\n{ \"nonce\": \"A7F2D1\" }\nETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"invoice_seq\": 105,\n  \"auth_code\": \"ABCD1234EFGH5678\",\n  \"device_id\": \"KUTA001\",\n  \"timestamp\": \"2026-02-04T10:15:30\",\n  \"qr_payload\": \"KUTA001|105|ABCD1234...\"\n}\n</code></pre> <p>Errors: <code>INVALID_NONCE</code>, <code>NONCE_EXPIRED</code>, <code>DEVICE_BUSY</code>, <code>DEVICE_REVOKED</code>, <code>STORAGE_FULL</code>, <code>CLOCK_ROLLBACK_DETECTED</code></p> <p>Notes - Timeout: \u22645 seconds. The device either completes the invoice or leaves state unchanged; query <code>QRY|STATUS</code>/<code>QRY|LOG</code> if power loss occurs mid-commit. - The response provides every mandatory security element for the receipt (fiscal number, auth code, device ID, timestamp, QR data). - Do not send a new <code>PREPARE</code> until <code>TXN|COMMIT</code> succeeds or returns an error that has been resolved.</p>"},{"location":"api/usb-device/#qrystatus","title":"QRY|STATUS","text":"<p>Synopsis: Check device health and readiness before issuing invoices or after recovery from errors.</p> <p>Request</p> <pre><code>STX QRY|STATUS ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"firmware_version\": \"2026.02.17\",\n  \"device_id\": \"KUTA001\",\n  \"next_invoice_seq\": 106,\n  \"free_memory_bytes\": 655360,\n  \"last_sync_timestamp\": \"2026-02-04T10:15:30\",\n  \"nonce_pool\": 2\n}\n</code></pre> <p>Errors: <code>DEVICE_REVOKED</code>, <code>DEVICE_BUSY</code>, <code>STORAGE_FULL</code></p> <p>Notes - Poll every 30 seconds in low-volume setups to keep UI responsive. - <code>nonce_pool</code> shows how many PREPARE operations can be outstanding before the device refuses new requests. - Use before issuing <code>TXN|PREPARE</code> to ensure counters align with the POS state.</p>"},{"location":"api/usb-device/#qrylog","title":"QRY|LOG  <p>Synopsis: Fetch a specific journal entry for audits, reprints, or recovery after a POS crash.</p> <p>Request</p> <pre><code>STX QRY|LOG 105 ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"log_entry\": {\n    \"record_type\": \"sale\",\n    \"sequence\": 105,\n    \"timestamp\": \"2026-02-04T10:15:30\",\n    \"merchant_nif\": \"123456789\",\n    \"client_registration\": \"XYZ123\",\n    \"total\": \"116.00\",\n    \"vat_total\": \"16.00\",\n    \"prev_hash\": \"7F3B\",\n    \"signature\": \"ABCD1234...\"\n  }\n}\n</code></pre> <p>Errors: <code>DEVICE_BUSY</code>, <code>LOG_NOT_FOUND</code>, <code>DEVICE_REVOKED</code></p> <p>Notes - Entries include <code>prev_hash</code> to form the immutable hash chain; verifying the chain is the audit path. - Use this command after ambiguous commits to confirm whether the invoice was written. - The device may throttle repeated <code>QRY|LOG</code> requests\u2014space out retries if <code>DEVICE_BUSY</code> is returned.</p>","text":""},{"location":"api/usb-device/#rptz","title":"RPT|Z <p>Synopsis: Produce the daily closure report with totals per tax group for auditing.</p> <p>Request</p> <pre><code>STX RPT|Z {\"date\":\"2026-02-04\"} ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"period\": \"2026-02-04\",\n  \"sequence_start\": 1,\n  \"sequence_end\": 120,\n  \"totals\": [\n    { \"tax_group\": \"standard_vat\", \"base\": \"100.00\", \"vat\": \"16.00\" }\n  ]\n}\n</code></pre> <p>Errors: <code>DEVICE_BUSY</code>, <code>UNAUTHORIZED</code>, <code>STORAGE_FULL</code></p> <p>Notes - Typically executed at end of business day; device ensures sequence continuity. - Include this report in the daily closure package for DGI compliance. - The payload echoes totals per tax group; ensure the host stores a local copy.</p>","text":""},{"location":"api/usb-device/#rptx","title":"RPT|X <p>Synopsis: Emit an intra-day snapshot (session) of fiscal activity for monitoring or troubleshooting.</p> <p>Request</p> <pre><code>STX RPT|X {\"period\":\"session\"} ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"period\": \"session\",\n  \"transaction_count\": 40,\n  \"totals\": { \"total\": \"4640.00\", \"vat\": \"640.00\" }\n}\n</code></pre> <p>Errors: <code>DEVICE_BUSY</code>, <code>UNAUTHORIZED</code>, <code>STORAGE_FULL</code></p> <p>Notes - Use this report to reconcile mid-shift activity or troubleshoot high-volume lanes. - The device may limit how frequently X reports are generated to avoid overloading flash. - <code>transaction_count</code> helps detect missed invoices.</p>","text":""},{"location":"api/usb-device/#rpta","title":"RPT|A <p>Synopsis: Deliver article-level detail covering every sold item between two timestamps.</p> <p>Request</p> <pre><code>STX RPT|A {\"since\":\"2026-02-01\",\"until\":\"2026-02-04\"} ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"articles\": [\n    {\n      \"code\": \"ITEM-001\",\n      \"description\": \"Service Plan\",\n      \"quantity\": 2,\n      \"tax_group\": \"standard_vat\",\n      \"amount\": \"2320.00\"\n    }\n  ]\n}\n</code></pre> <p>Errors: <code>DEVICE_BUSY</code>, <code>UNAUTHORIZED</code>, <code>STORAGE_FULL</code></p> <p>Notes - Supports auditors who need per-article breakdowns. - The <code>since/until</code> window must be within the journal retention window. - The device streams data if the article list is long; acknowledge each chunk before requesting another.</p>","text":""},{"location":"api/usb-device/#admdumplog","title":"ADM|DUMPLOG <p>Synopsis: Export a full journal dump or digest for auditors or off-device reprocessing.</p> <p>Request</p> <pre><code>STX ADM|DUMPLOG {\"format\":\"json\"} ETX\n</code></pre> <p>Response</p>  <p>The device streams chunks of log entries or digests. Each chunk includes <code>status</code>, <code>chunk_index</code>, and a <code>records</code> array. The host must acknowledge each chunk before the next one is released.</p>  <p>Errors: <code>UNAUTHORIZED</code>, <code>STORAGE_FULL</code>, <code>DEVICE_BUSY</code></p> <p>Notes - Use only under audit or support scenarios due to the volume of data. - Respect the chunk handshake; failing to ack halts the stream. - Consider encrypting the exported dump when transmitting outside the local network.</p>","text":""},{"location":"api/usb-device/#admreset","title":"ADM|RESET <p>Synopsis: Reset counters under DGI supervision after storage rollover while preserving the device identity.</p> <p>Request</p> <pre><code>STX ADM|RESET {\"dgi_authorization\":\"&lt;signed token&gt;\"} ETX\n</code></pre> <p>Response</p> <pre><code>{\n  \"status\": \"OK\",\n  \"message\": \"Counters reset to zero\",\n  \"device_id\": \"KUTA001\"\n}\n</code></pre> <p>Errors: <code>UNAUTHORIZED</code>, <code>DEVICE_REVOKED</code>, <code>STORAGE_FULL</code></p> <p>Notes - Requires a DGI-signed activation token. Do not expose this command to general POS operators. - The device keeps the same <code>device_id</code> so downstream systems can re-sync after the reset. - After reset, re-run <code>CFG|INIT</code> if a new registration process is needed.</p>","text":""},{"location":"api/usb-device/#cfgtime","title":"CFG|TIME <p>Synopsis: Synchronize or verify the DEF RTC while preventing rollback attacks.</p> <p>Request</p> <pre><code>STX CFG|TIME {\"timestamp\":\"2026-02-04T10:00:00\",\"signature\":\"&lt;SE signature&gt;\"} ETX\n</code></pre> <p>Response</p> <pre><code>{ \"status\": \"OK\", \"timestamp\": \"2026-02-04T10:00:00\" }\n</code></pre> <p>Errors: <code>CLOCK_ROLLBACK_DETECTED</code>, <code>UNAUTHORIZED</code></p> <p>Notes - The signature binds the timestamp to the secure element to guard against rollback. - Only authorized administrators or the official time sync service should invoke this command. - The device rejects timestamps earlier than the current RTC value.</p>","text":""},{"location":"api/usb-device/#cfginit","title":"CFG|INIT <p>Synopsis: Provision a new DEF with cryptographic identity and register it with the DGI.</p> <p>Request</p> <pre><code>STX CFG|INIT {\"activation_code\":\"&lt;DGI issued code&gt;\",\"public_key\":\"&lt;PEM&gt;\"} ETX\n</code></pre> <p>Response</p> <pre><code>{ \"status\": \"OK\", \"device_id\": \"KUTA001\", \"fiscal_number_prefix\": \"KUTA\" }\n</code></pre> <p>Errors: <code>UNAUTHORIZED</code>, <code>DEVICE_REVOKED</code></p> <p>Notes - Typically executed once per outlet during deployment. - Record the <code>fiscal_number_prefix</code> so POS systems can format invoice numbers consistently. - The <code>public_key</code> lets DGI verify future signed payloads; store it securely in the cloud registry.</p>","text":""},{"location":"architecture/components/","title":"Component Map","text":"<p>This page captures the actors and services that hold Bono Pay together. The goal is to make every dependency and input/output explicit so new engineers can see how the untrusted POS, the trusted USB Fiscal Memory device, and the cloud sync terrain collaborate to satisfy the EARS requirements in <code>spec/architecture-kutapay-system-1.md</code>.</p> <p>Trust boundary reminder</p> <p>The USB Fiscal Memory device is the only component that grades, signs, numbers, and timestamps invoices. Everything else runs in the untrusted zone and must treat device responses as the single source of truth.</p>"},{"location":"architecture/components/#pos-layer-components","title":"POS Layer Components","text":"Component Purpose Inputs Outputs Dependencies Sale Entry Guides the cashier through the invoice, ensuring every line item, price, quantity, and client classification is captured. Merchant input, Product Catalog metadata, Tax Engine UI configuration, Multi-Terminal Mediator throttling. Raw transaction record sent to the Tax Calculation Engine and Canonical Serializer. Product Catalog, Tax Engine UI, Multi-Terminal Mediator. Receipt Printer Produces the customer-facing fiscal receipt (paper or digital) once the USB device approves the invoice. Fiscal response (fiscal number, device ID, auth code, timestamp, QR) from the USB device, Sale Entry layout. Printed/digital receipt for customer and internal audit copies. USB Fiscal Memory device, Sale Entry, Sync Queue (for archival). Sync Queue Buffers sealed invoices when the network or DGI are unavailable and orders uploads once connectivity returns. Canonical payload plus fiscal response, device status from the registry. Ordered requests delivered to the Cloud API/Sync Engine, status updates to the Dashboard. Cloud API, Device Registry, Sync Engine. Product Catalog Stores SKUs, descriptions, tax classifications, and pricing so the POS can reuse them across terminals. Merchant/ERP imports, dashboard updates. Enriched items for Sale Entry and Tax Engine UI, trust-labeled tax groups. Tax Engine UI, Tax Calculation Engine. Tax Engine UI Lets operators fine-tune 14 DGI tax groups, client types, rounding rules, and refund policies. DGI regulatory spec, merchant inputs, Product Catalog links. Tax definitions consumed by Sale Entry, Fiscal Service, and Cloud reporting. Product Catalog, spec/architecture-kutapay-system-1.md (14 tax groups)."},{"location":"architecture/components/#fiscal-service-components","title":"Fiscal Service Components","text":"Component Purpose Inputs Outputs Dependencies Device Proxy Marshals canonical payloads into PREPARE/COMMIT USB CDC commands, handles retries, and routes responses back to POS. Canonical JSON, nonce life cycle from the mediator, device health. Framed USB commands, fiscal responses, error notifications for the POS. Multi-Terminal Mediator, USB device, Sync Queue. Tax Calculation Engine Computes amounts for each DGI tax group, supports void/refund flags, and generates the totals that the device must sign. Sale Entry data, Product Catalog tax tags, Tax Engine UI settings. Structured tax breakdown handed to the Canonical Serializer and Hash-Chained Journal. Tax Engine UI, Product Catalog. Canonical Serializer Builds deterministic JSON with merchant/client IDs, itemized lines, tax breakdown, and outlet/POS/cashier metadata. Sale Entry capture, Tax Calculation Engine output, Device Registry IDs. Canonical payload sent to the Device Proxy for PREPARE. Tax Calculation Engine, Device Registry, Multi-Terminal Mediator. Multi-Terminal Mediator Coordinates simultaneous terminals, enforces nonce-based two-phase commit (PREPARE \u2192 COMMIT), and queues payloads so the trusted device is never overwhelmed. Concurrent canonical payloads, device health from the registry, USB readiness. Serialized request stream, conflict alerts, backlog telemetry. Device Proxy, Device Registry, Sync Queue."},{"location":"architecture/components/#usb-device-components","title":"USB Device Components","text":"Component Purpose Inputs Outputs Dependencies Schema Validator Rejects malformed payloads before counters advance, ensuring the device never accepts sketchy invoices. Canonical JSON payload from the Device Proxy. Accept/reject signal, diagnostic code for the POS. Device Proxy, Tax Calculation Engine. Monotonic Counter Supplies the next fiscal number in strict sequence for each outlet, preventing gaps or duplicate numbers. Prepared PREPARE state once the schema passes. Fiscal number appended to the response and journal entry. Hash-Chained Journal, RTC. ECDSA Signer Runs in the secure element to sign the journal entry and produce the authentication code (auth_code). Hashed invoice data, counter, trusted timestamp. Auth code stored in the journal and returned to the POS. RTC, secure element hardware. Hash-Chained Journal Appends every invoice, void, and refund entry with a pointer to the previous hash so audits can prove immutability. Signed entries (counter, timestamp, auth_code). Audit exports, report inputs, ledger proof for DGI. Monotonic Counter, Report Generator. RTC Provides the trusted timestamp every fiscal entry and report references, guarding against back-dating. Periodic CFG TIME sync commands from the Cloud. Timestamp values for responses and journal rows. Report Generator Streams Z, X, A, and audit exports out of the journal when auditors or merchants request them. Hash-Chained Journal, device metadata from the registry. Report payloads delivered over USB commands or to the cloud. Hash-Chained Journal, Device Registry."},{"location":"architecture/components/#cloud-layer-components","title":"Cloud Layer Components","text":"Component Purpose Inputs Outputs Dependencies Cloud API Receives sealed invoices from Sync Engine, publishes device configuration, and surfaces health data to dashboards. Sealed invoices, device heartbeats, merchant queries. Acknowledgments to Sync Engine, configuration pushes, metrics to Dashboard. Invoice Store, Device Registry. Sync Engine Manages deferred uploads of sealed invoices to the DGI, retries failed transmissions, and tracks synchronization health. Sync Queue backlog, network availability, DGI responses. Calls to the DGI endpoint, sync status for the Dashboard, alerts for retries. Cloud API, Device Registry, DGI credentials. Invoice Store Keeps a copy of each sealed invoice, its fiscal response, and DGI reference for replays, audits, and dashboards. Sealed invoices from Sync Engine, metadata from Device Registry. Queryable records for Dashboard, DGI reconciliation, and analytics. Cloud API, Sync Engine. Device Registry Tracks which USB devices are paired to which outlets, their firmware, and last sync sync. Heartbeats from Fiscal Service and direct device pings. Metadata for the Multi-Terminal Mediator, gating rules for Sync Engine, input to Dashboard. Cloud API, Dashboard. Dashboard Displays device health, upload backlog, report requests, and onboarding guidance so merchant/ops teams can act. Metrics from Cloud API, invoices from Invoice Store, registry data. Alerts, onboarding checklists, audit download links. Cloud API, Device Registry, Invoice Store."},{"location":"architecture/components/#system-component-diagram","title":"System Component Diagram","text":"<p>The diagram below shows how the POS layer, Fiscal Service, USB Fiscal Memory device, and cloud systems interconnect. Canonical payloads traverse the untrusted zone, the trusted device returns fiscal responses, and the cloud syncs sealed invoices to the DGI while providing observability.</p> <pre><code>flowchart LR\n    subgraph \"Untrusted POS Layer\"\n        ProductCatalog[\"Product Catalog\"]\n        TaxUI[\"Tax Engine UI\"]\n        SaleEntry[\"Sale Entry\"]\n        SyncQueue[\"Sync Queue\"]\n        ReceiptPrinter[\"Receipt Printer\"]\n    end\n    subgraph \"Fiscal Service\"\n        TaxEngine[\"Tax Calculation Engine\"]\n        CanonicalSerializer[\"Canonical Serializer\"]\n        MultiTerminalMediator[\"Multi-Terminal Mediator\"]\n        DeviceProxy[\"Device Proxy\"]\n    end\n    subgraph \"Trusted USB Fiscal Memory\"\n        USBDevice[\"USB Device\"]\n    end\n    subgraph \"Cloud &amp; Audit\"\n        SyncEngine[\"Sync Engine\"]\n        CloudAPI[\"Cloud API\"]\n        InvoiceStore[\"Invoice Store\"]\n        DeviceRegistry[\"Device Registry\"]\n        Dashboard[\"Dashboard\"]\n    end\n    DGI[\"DGI Tax Authority\"]\n\n    ProductCatalog --&gt; SaleEntry\n    TaxUI --&gt; TaxEngine\n    SaleEntry --&gt; TaxEngine\n    SaleEntry --&gt; SyncQueue\n    TaxEngine --&gt; CanonicalSerializer\n    CanonicalSerializer --&gt; MultiTerminalMediator\n    MultiTerminalMediator --&gt; DeviceProxy\n    DeviceProxy --&gt; USBDevice\n    USBDevice --&gt; ReceiptPrinter\n    USBDevice --&gt; SyncQueue\n    SyncQueue --&gt; SyncEngine\n    SyncEngine --&gt; CloudAPI\n    CloudAPI --&gt; InvoiceStore\n    CloudAPI --&gt; Dashboard\n    SyncEngine --&gt; DGI\n    DeviceRegistry --&gt; SyncEngine\n    DeviceRegistry --&gt; MultiTerminalMediator</code></pre> <p>The labelled arrows emphasize the canonical payload, the fiscal response, deferred syncs, and the guarded path to the DGI.</p>"},{"location":"architecture/components/#deployment-scenarios-single-terminal-vs-multi-terminal","title":"Deployment Scenarios (Single-terminal vs Multi-terminal)","text":"<p>Single-terminal deployments place one POS directly behind the fiscal service, while multi-terminal deployments keep multiple POS nodes synced through the Multi-Terminal Mediator before they reach the shared USB device. Both paths hand off sealed invoices to the same Sync Queue for cloud upload.</p> <pre><code>flowchart TB\n    subgraph \"Single-terminal Deployment\"\n        SinglePOS[\"Single POS Terminal\"] --&gt; FiscalServiceSingle[\"Fiscal Service (single)\"]\n        FiscalServiceSingle --&gt; USBDeviceSingle[\"USB Fiscal Memory\"]\n        FiscalServiceSingle --&gt; SyncQueueSingle[\"Sync Queue\"]\n    end\n    subgraph \"Multi-terminal Deployment\"\n        MultiPOSA[\"POS Terminal A\"]\n        MultiPOSB[\"POS Terminal B\"]\n        MultiPOSA --&gt; Mediator[\"Multi-Terminal Mediator\"]\n        MultiPOSB --&gt; Mediator\n        Mediator --&gt; FiscalServiceMulti[\"Fiscal Service (mediated)\"]\n        FiscalServiceMulti --&gt; USBDeviceMulti[\"USB Fiscal Memory\"]\n        FiscalServiceMulti --&gt; SyncQueueMulti[\"Sync Queue\"]\n    end\n    SyncQueueSingle --&gt; CloudAPI2[\"Cloud API\"]\n    SyncQueueMulti --&gt; CloudAPI2\n    CloudAPI2 --&gt; DGI2[\"DGI Tax Authority\"]</code></pre> <p>The deployment diagram emphasises how the same trusted device and cloud elevator support both single and multi-terminal outlets, ensuring every canonical payload experiences the PREPARE \u2192 COMMIT handshake before syncing.</p>"},{"location":"architecture/data-flow/","title":"Data Flow Diagrams","text":"<p>The architecture specification enforces that every fiscal interaction follows the trusted USB device and canonical payload rules. The diagrams below trace how invoices flow through the POS, fiscal service, DEF, cloud, and DGI in normal, degraded, and multi-terminal deployments.</p> <p>Trust boundary reminder</p> <p>The USB Fiscal Memory device is the only component that can fabricate fiscal numbers, signatures, and timestamps. Every diagram below keeps those primitives inside the trusted zone\u2014no POS, local fiscal service, or cloud component generates them.</p>"},{"location":"architecture/data-flow/#happy-path-sequence","title":"Happy path sequence","text":"<p>The happy path starts with the cashier confirming a sale and ends with the sealed invoice reaching the DGI. The local fiscal service mediates canonical payload creation and the PREPARE\u2192COMMIT handshake before the POS prints and syncs the sealed response.</p> <pre><code>sequenceDiagram\n    actor Cashier\n    participant POS\n    participant FiscalService as \"Fiscal Service\"\n    participant DEF as \"USB DEF\"\n    participant Cloud\n    participant DGI\n\n    Cashier-&gt;&gt;POS: confirm sale with items, tax groups, client classification\n    POS-&gt;&gt;FiscalService: serialize canonical payload (merchant_nif,outlet_id,totals)\n    FiscalService-&gt;&gt;DEF: TXN PREPARE canonical JSON\n    DEF--&gt;&gt;FiscalService: nonce + validation result\n    FiscalService-&gt;&gt;DEF: TXN COMMIT + nonce\n    DEF--&gt;&gt;FiscalService: fiscal response (fiscal_number,device_id,auth_code,timestamp,QR)\n    FiscalService-&gt;&gt;POS: deliver sealed response\n    POS-&gt;&gt;POS: print receipt with DEF security elements\n    POS-&gt;&gt;Cloud: queue sealed invoice for sync\n    Cloud-&gt;&gt;DGI: upload sealed invoice in arrival order</code></pre>"},{"location":"architecture/data-flow/#offline-first-sequence","title":"Offline-first sequence","text":"<p>When connectivity to the cloud/DGI is down, the device continues to accept PREPARE\u2192COMMIT flows while the POS stores sealed invoices locally. Once the network returns, the queue drains in chronological order so deferred uploads preserve the audit trail.</p> <pre><code>sequenceDiagram\n    actor Cashier\n    participant POS\n    participant FiscalService as \"Fiscal Service\"\n    participant DEF as \"USB DEF\"\n    participant Queue as \"Local Queue\"\n    participant Cloud\n    participant DGI\n\n    Cashier-&gt;&gt;POS: confirm sale\n    POS-&gt;&gt;FiscalService: send canonical payload\n    FiscalService-&gt;&gt;DEF: TXN PREPARE\n    DEF--&gt;&gt;FiscalService: nonce\n    FiscalService-&gt;&gt;DEF: TXN COMMIT\n    DEF--&gt;&gt;FiscalService: fiscal response\n    FiscalService-&gt;&gt;POS: deliver sealed reply\n    POS-&gt;&gt;Queue: store sealed invoice (cloud unreachable)\n    Note right of Queue: await connectivity\n    Queue-&gt;&gt;Cloud: push queued invoice when online\n    Cloud-&gt;&gt;DGI: upload sealed invoice</code></pre>"},{"location":"architecture/data-flow/#void-event-sequence","title":"Void event sequence","text":"<p>Voids become new fiscal events that reference the original invoice. The POS builds a canonical void payload, the DEF validates the reference and counters, and the system issues a fresh fiscal number for auditing.</p> <pre><code>sequenceDiagram\n    actor Cashier\n    participant POS\n    participant FiscalService as \"Fiscal Service\"\n    participant DEF as \"USB DEF\"\n    participant Cloud\n    participant DGI\n\n    Cashier-&gt;&gt;POS: request void referencing invoice #123\n    POS-&gt;&gt;FiscalService: canonical void payload with original fiscal_number\n    FiscalService-&gt;&gt;DEF: TXN PREPARE (void)\n    DEF--&gt;&gt;FiscalService: nonce + context\n    FiscalService-&gt;&gt;DEF: TXN COMMIT (void)\n    DEF--&gt;&gt;FiscalService: fiscal response (new fiscal_number,auth_code)\n    FiscalService-&gt;&gt;POS: print void receipt, queue sealed void\n    Cloud-&gt;&gt;DGI: upload void event alongside original reference</code></pre>"},{"location":"architecture/data-flow/#refund-credit-note-sequence","title":"Refund (credit note) sequence","text":"<p>Refunds and credit notes are handled as fresh fiscal events so auditors can trace them back to the original sale while preserving immutable counters and signatures.</p> <pre><code>sequenceDiagram\n    actor Cashier\n    participant POS\n    participant FiscalService as \"Fiscal Service\"\n    participant DEF as \"USB DEF\"\n    participant Cloud\n    participant DGI\n\n    Cashier-&gt;&gt;POS: initiate refund for invoice #123\n    POS-&gt;&gt;FiscalService: credit note payload with tax breakdown\n    FiscalService-&gt;&gt;DEF: TXN PREPARE (credit note)\n    DEF--&gt;&gt;FiscalService: nonce, tax validation\n    FiscalService-&gt;&gt;DEF: TXN COMMIT\n    DEF--&gt;&gt;FiscalService: fiscal response (new fiscal_number,QR)\n    FiscalService-&gt;&gt;POS: print credit note, queue sealed response\n    Cloud-&gt;&gt;DGI: upload credit note with memo referencing original</code></pre>"},{"location":"architecture/data-flow/#multi-terminal-coordination","title":"Multi-terminal coordination","text":"<p>Every outlet shares a single DEF. The local fiscal service serializes access from multiple POS terminals, enforces the nonce-based handshake, and attaches outlet/POS/cashier IDs to every canonical request so the USB device maintains sequential ordering per outlet.</p> <pre><code>flowchart LR\n    classDef untrusted fill:#fee,stroke:#c00;\n    classDef trusted fill:#e6ffe6,stroke:#2a8f2a;\n\n    subgraph Outlet [\"Outlet Local Network\"]\n        POS1[\"POS Terminal 1\"]\n        POS2[\"POS Terminal 2\"]\n        Proxy[\"Local Fiscal Service\"]\n    end\n    Cloud[\"Bono Pay Cloud\"]\n    DGI[\"DRC DGI\"]\n    DEF[\"USB Fiscal Memory Device\"]\n\n    POS1 --&gt;|canonical payload + IDs| Proxy\n    POS2 --&gt;|canonical payload + IDs| Proxy\n    Proxy --&gt;|PREPARE &amp; COMMIT| DEF\n    DEF --&gt;|fiscal response| Proxy\n    Proxy --&gt;|sealed invoice queue| Cloud\n    Cloud --&gt; DGI\n\n    class POS1,POS2,Proxy untrusted\n    class DEF trusted</code></pre>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>This page gives new developers a grounding in the Bono Pay system: the POS clients that operate in untrusted spaces, the trusted USB Fiscal Memory device that enforces compliance, and the cloud services that consolidate audit data and relay sealed invoices to the DGI. The text below draws directly from the architecture specification, the technical design brief, and the Copilot instructions so that everyone touching the docs stays aligned with the trust boundary, offline-first, and security-element requirements.</p>"},{"location":"architecture/overview/#system-context-c4","title":"System Context (C4)","text":"<p>Developers joining the project must know who depends on Bono Pay and what the platform communicates outward. Cashiers, outlet owners, and auditors interact with the platform directly, while sealed invoices leave the platform only once they are ready for the DGI or payment providers. This C4 context diagram keeps that actor-level view front and center.</p> <pre><code>flowchart LR\n    Cashier[\"Cashier / Teller\"]\n    Owner[\"Outlet Owner\"]\n    Auditor[\"Auditor / Regulator\"]\n    Bono Pay[\"Bono Pay Platform\\n(POS + Fiscal Service + Cloud)\"]\n    DGI[\"DGI MCF / e-MCF\"]\n    PaymentProviders[\"Payment Providers\"]\n    Cashier --&gt;|Issues fiscal invoice| Bono Pay\n    Owner --&gt;|Monitors compliance| Bono Pay\n    Auditor --&gt;|Requests reports &amp; audits| Bono Pay\n    Bono Pay --&gt;|Sealed invoice upload| DGI\n    Bono Pay --&gt;|Payment events + status| PaymentProviders</code></pre>"},{"location":"architecture/overview/#trust-boundary","title":"Trust Boundary","text":"<p>The USB Fiscal Memory device is the only trusted execution point: it validates canonical payloads, increments the monotonic counter, signs the invoice, stores it immutably, and returns the security elements (fiscal number, device ID, signature, timestamp, QR). All POS/Cloud services, even the local fiscal service trusted to serialize commands, remain in the untrusted zone and must never claim those security elements as their own.</p> <p>Trust boundary enforcement</p> <p>Never let the POS or cloud fabric fabricate fiscal numbers, signatures, device IDs, or timestamps. The USB Fiscal Memory device is the sole source of truth; every canonical payload must be serialized, sent via the PREPARE \u2192 COMMIT handshake, and the sealed invoice (fiscal response) returned before any receipt is printed or uploaded.</p>"},{"location":"architecture/overview/#trust-boundary-diagram","title":"Trust boundary diagram","text":"<pre><code>flowchart LR\n    subgraph Untrusted Zone\n        POSApp[POS App + Sync Queue]\n        FiscalService[\"Local Fiscal Service&lt;br/&gt;tokenizes PREPARE/COMMIT\"]\n    end\n    subgraph Trusted Zone\n        USBDevice[USB Fiscal Memory Device]\n    end\n    POSApp --&gt;|Canonical payload\\n(outlet_id + pos_terminal_id + cashier_id)| FiscalService\n    FiscalService --&gt;|PREPARE / COMMIT\\n\u3008nonce, deterministic JSON\u3009| USBDevice\n    USBDevice --&gt;|Fiscal response\\n(fiscal_number, auth_code, timestamp, QR)| FiscalService\n    FiscalService --&gt;|Sealed response / receipt print| POSApp\n    USBDevice --&gt;|Reports (Z/X/A + audit export)| POSApp</code></pre>"},{"location":"architecture/overview/#component-map","title":"Component Map","text":"<p>The layered component map spells out responsibilities: the POS layer collects items and tax details, the fiscal service mediates multi-terminal concurrency and serializes canonical payloads, the USB device enforces cryptographic seals and journaling, and the cloud layer stores sealed invoices, syncs when connectivity returns, and surfaces dashboards. The Mermaid map below emphasizes how data flows from the cashier through these layers.</p> <pre><code>graph LR\n    subgraph POS Layer\n        SaleEntry[Sale Entry + Tax UI]\n        ReceiptPrinter[Receipt Printer]\n        SyncQueue[Sync Queue]\n        TaxUI[Tax Engine UI]\n    end\n    subgraph Fiscal Service\n        CanonicalSerializer[Canonical Serializer]\n        MultiTermMediator[Multi-Terminal Mediator]\n        DeviceProxy[Device Proxy]\n        TaxCalculation[Tax Calculation Engine]\n    end\n    subgraph USB Device\n        SchemaValidator[Schema Validator]\n        MonotonicCounter[Monotonic Counter]\n        Signer[ECDSA Signer]\n        HashJournal[Hash-Chained Journal]\n        RTC[\"RTC / Trusted Timestamp\"]\n        ReportGen[\"Report Generator: Z/X/A + audit\"]\n    end\n    subgraph Cloud Layer\n        CloudAPI[Cloud API &amp; Device Registry]\n        SyncEngine[Sync Engine + Invoice Store]\n        Dashboard[Dashboard]\n    end\n\n    SaleEntry --&gt; TaxCalculation\n    SaleEntry --&gt; CanonicalSerializer\n    TaxUI --&gt; CanonicalSerializer\n    CanonicalSerializer --&gt; MultiTermMediator\n    MultiTermMediator --&gt; DeviceProxy\n    DeviceProxy --&gt; SchemaValidator\n    SchemaValidator --&gt; MonotonicCounter\n    SchemaValidator --&gt; Signer\n    Signer --&gt; HashJournal\n    HashJournal --&gt; ReportGen\n    HashJournal --&gt; SyncEngine\n    ReportGen --&gt; Dashboard\n    SyncEngine --&gt; CloudAPI\n    CloudAPI --&gt; Dashboard</code></pre>"},{"location":"architecture/overview/#operational-notes","title":"Operational Notes","text":"<p>This architecture must stay offline-first: the local fiscal service queues canonical payloads, negotiates PREPARE/COMMIT with the USB device, and only after receiving the fiscal response does it let the POS print or sync. Multi-terminal outlets rely on the mediator to prevent nonce reuse and to tag every payload with <code>outlet_id</code>, <code>pos_terminal_id</code>, and <code>cashier_id</code> before the USB device increments its per-outlet counter. The cloud layer stores sealed invoices, uploads them in arrival order when connectivity returns, and exposes dashboards/reports to auditors. Every sealed invoice still includes the five mandatory security elements sourced from the trusted device, not the POS.</p>"},{"location":"architecture/trust-boundary/","title":"Trust Boundary","text":"<p>Bono Pay enforces a deny-by-default trust boundary where every POS client, cloud sync agent, and auditor-facing UI lives in the untrusted zone, and the USB Fiscal Memory device (DEF) is the sole trusted authority that validates a canonical payload, signs it, increments the monotonic counters, and produces the fiscal response. The architectural rationale and the two-phase commit protocol are spelled out in <code>spec/architecture-kutapay-system-1.md</code> and <code>docs/adr/adr-0001-two-phase-commit-usb-protocol.md</code>.</p> <p>Trust boundary enforcement</p> <p>No data that can compromise fiscal integrity ever travels from the trusted zone back into the untrusted hosts. The DEF never releases private keys, raw counters, or hash-chain materials; hosts receive only the sealed fiscal response after a successful COMMIT.</p> <p>Architecture review findings</p> <ul> <li>The specification did not explicitly call out replay or nonce-expiry failure modes; the new documentation explains how the PREPARE nonce resists replay and why expired nonces force a fresh PREPARE before the device mutates state.</li> <li>Power/cable loss scenarios were present in ADR-0001 but lacked a boundary-level summary; this doc highlights each failure mode so integrators understand that no invoice leaves the device unless the COMMIT completes and a fiscal response is emitted.</li> </ul>"},{"location":"architecture/trust-boundary/#what-crosses-the-boundary","title":"What crosses the boundary","text":"<ol> <li>Canonical payloads \u2014 Every invoice starts as deterministic JSON (<code>merchant_nif</code>, <code>client</code> classification, <code>items[]</code>, <code>tax_groups[]</code>, outlet/POS/cashier IDs, <code>totals</code>, <code>timestamp</code>) generated by the untrusted POS and routed through the local fiscal service before ever touching the DEF (spec \u00a73.1, \u00a73.2).</li> <li>USB CDC 2PC handshake \u2014 The PREPARE/COMMIT messages, nonce challenge, and success/failure acknowledgments traverse the USB CDC connection; the DEF performs validation during PREPARE and atomic writes only when COMMIT arrives (ADR-0001 \u00a7Phase 1 &amp; 2).</li> <li>Sealed fiscal response \u2014 After the COMMIT succeeds the DEF emits <code>{fiscal_number, device_id, auth_code, timestamp, qr_payload}</code>. Hosts use this sealed response to print receipts, queue sealed invoices for cloud sync, and upload to the DGI, but nothing more trusted crosses back into the POS.</li> <li>Queued sealed invoices (cloud) \u2014 The untrusted cloud sync service transports only the DEF-generated payload to the DGI, preserving the sealed envelope without re-signing or altering contents (spec \u00a73.2, \u00a73.3).</li> </ol>"},{"location":"architecture/trust-boundary/#what-never-crosses-the-boundary","title":"What never crosses the boundary","text":"<ul> <li>Private keys or signing material \u2014 The secure element inside the DEF keeps the signing key locked down; no host ever sees it.</li> <li>Raw monotonic counters or journal data \u2014 Only the DEF can append to the hash-chained journal; hosts never read or increment counters directly.</li> <li>Unverified receipts \u2014 Receipts are printed only after the POS receives the fiscal response; hosts may not issue fiscalized receipts without the DEF\u2019s confirmation (ADR-0001 \u00a7Consequences).</li> <li>Vendor-side nonce management \u2014 The nonce generated during PREPARE lives in-device until COMMIT returns; the host cannot fabricate or replay a COMMIT without that nonce.</li> <li>Audit or internal health metrics \u2014 Command responses like <code>QRY|STATUS</code> surface derived, read-only views; the hosts cannot mutate device health directly.</li> </ul> <pre><code>flowchart LR\n    subgraph Untrusted POS Zone\n        POS[\"POS Clients&lt;br/&gt;Sale entry, Tax UI, Receipt Printer\"]\n        FS[\"Local Fiscal Service&lt;br/&gt;Serializes PREPARE/COMMIT + mediates multi-terminal access\"]\n    end\n    subgraph Trusted USB Zone\n        DEF[\"USB Fiscal Memory Device (DEF)&lt;br/&gt;Schema validator, Monotonic counter, Signer, Journal\"]\n    end\n    subgraph Bono Pay Cloud\n        Cloud[Cloud Sync + Registry]\n    end\n    subgraph DGI\n        DGI[\"DGI (MCF/e-MCF)\"]\n    end\n    POS --&gt;|canonical JSON payload| FS\n    FS --&gt;|PREPARE / COMMIT over USB CDC| DEF\n    DEF --&gt;|fiscal response: fiscal_number, auth_code, timestamp, QR| FS\n    FS --&gt;|sealed invoice + security bundle| Cloud\n    Cloud --&gt;|sealed invoice upload| DGI</code></pre>"},{"location":"architecture/trust-boundary/#failure-modes-at-the-boundary","title":"Failure modes at the boundary","text":"<ol> <li>Power loss before COMMIT \u2014 The device never increments counters or writes to the journal during PREPARE. If power fails, the nonce expires and the POS must re-prepare; no fiscal number is issued (ADR-0001 \u00a7Failure Semantics).</li> <li>Power loss during COMMIT \u2014 Firmware must ensure COMMIT is atomic; either the journal append completes and the response is retrievable via <code>QRY|LOG</code>, or the device rolls back without altering counters (ADR-0001 \u00a7Implementation Notes IMP-002).</li> <li>Cable disconnect / host crash \u2014 The DEF never trusts the host; after a crash the host queries <code>QRY|STATUS</code>/<code>QRY|LOG</code> to reconcile. If COMMIT already succeeded, the sealed fiscal response remains the authoritative source for printing and syncing.</li> <li>Corrupt canonical payload \u2014 During PREPARE the DEF validates schema, tax groups, and deterministic ordering. Any mismatch results in rejection with a clear error, forcing the host to fix the payload before COMMIT (spec \u00a73.1, ADR-0001 \u00a7Phase 1).</li> <li>Replay or stale nonce \u2014 The nonce issued during PREPARE has a short TTL. If the host delays or re-sends a COMMIT after expiry, the DEF rejects it, resets to PREPARE, and logs the event for auditing (ADR-0001 \u00a7Implementation Notes IMP-001).</li> </ol>"},{"location":"architecture/trust-boundary/#trust-assumptions-table","title":"Trust assumptions table","text":"Assumption Enforcement The DEF is the only source of truth for fiscal numbers, signatures, and journals. Firmware limits counter mutations to COMMIT and writes the append-only journal, preventing remote hosts from altering state. Only canonical JSON payloads reach the DEF, and they include DGI-required fields and classifications. Local fiscal service serializes deterministic payloads (merchant NIF, client classification, tax group breakdown) before USB handoff (spec \u00a73.1, \u00a73.4). Hosts may not fabricate fiscal elements after the device replies. The fiscal response bundle carries every security element (number, auth code, timestamp, QR) that printers, cloud, and auditors rely on; any absence triggers denial of service from the device. Multi-terminal environments share one DEF per outlet. The fiscal service gates access with the nonce-based 2PC handshake, serializing requests and preventing simultaneous counter consumption (spec \u00a73.3, ADR-0001 \u00a7Consequences). Audit stakeholders trust the device for reports (Z/X/A) and history exports. The DEF generates reports from its hash-chained journal and exports data via dedicated commands (<code>RPT|Z</code>, <code>RPT|X</code>, <code>RPT|A</code>, <code>ADM|DUMPLOG</code>)."},{"location":"architecture/trust-boundary/#next-steps","title":"Next steps","text":"<p>Continue to tie these trust rules into the hardware and protocol docs (Tasks 006\u2013011) so that future integrators understand that anything crossing the blue/red border above must go through the PREPARE\u2192COMMIT handshake, while nothing trusted ever leaks back into the hosts.</p>"},{"location":"cloud/architecture/","title":"Cloud Architecture","text":"<p>The Bono Pay Cloud sits on the trusted side of the architecture that is described in <code>spec/architecture-kutapay-system-1.md</code>. It never touches raw invoice payloads until they are sealed, and it is responsible for every step after the USB Fiscal Memory device emits the fiscal response. The cloud orchestrates sync, backup, DGI uploads, device provisioning, and operational insight while keeping the trust boundary intact and honoring the offline-first guarantees described in <code>DISCUSSION.md</code> (see the deployment, offline, and resilience commentary around lines 7030\u20117060).</p>"},{"location":"cloud/architecture/#responsibilities","title":"Responsibilities","text":"<ul> <li>Sync &amp; upload service \u2014 ingests sealed invoices from the local fiscal service, enqueues them in arrival order, retries uploads when the DGI endpoint is slow or offline, and confirms each invoice has arrived before discarding the local copy.</li> <li>Backup &amp; audit storage \u2014 keeps an encrypted ledger of every sealed invoice, metadata, and fulfillment event so auditors can reproduce Z/X/A reports even if POS terminals lose their local cache.</li> <li>DGI integration \u2014 handles authenticated uploads to the e\u2011DEF/MCF APIs, respects rate limits, and exposes a retry dashboard for operators when the DGI stack is unavailable.</li> <li>Device registry &amp; provisioning \u2014 tracks each outlet\u2019s DEF serial, activation token, firmware version, and certificate status; it also brokers activation flows that bind a device to a merchant and the DGI\u2019s credentials.</li> <li>Operations dashboard \u2014 surfaces sync health, device connectivity, report generation, and compliance KPIs for auditors and support staff.</li> </ul> <p>Trust boundary reminder</p> <p>The cloud only stores sealed invoices: the USB device is the only source of truth for fiscal numbers, device IDs, signatures, timestamps, and QR metadata. Any attempt to reconstruct or mutate those values on the cloud side breaks the trust boundary.</p>"},{"location":"cloud/architecture/#deployment-model","title":"Deployment model","text":""},{"location":"cloud/architecture/#deployment-options","title":"Deployment options","text":"<ol> <li>Serverless ingestion \u2014 stateless functions (e.g., FaaS) react to new invoices pushed through the fiscal service, validate signatures, and persist them to the audit store. This keeps bursty loads from overloading stateful systems and scales naturally when dozens of outlets sync concurrently.</li> <li>Containerized services \u2014 longer-running components (dashboard, registry, audit export generator) run inside orchestrated containers with horizontal pods per tenant cluster. Containers host the richer UI, reporting, and heavy CSV/Excel exports that need memory and CPU persistence.</li> <li>Hybrid pattern \u2014 front-door APIs and sync workers stay serverless for elasticity; the registry, dashboard, and report generation run on containers inside a private cloud/VPC that sits inside the DRC region.</li> </ol> <p>Each deployment option is wired into a multi-tenant namespace (see below) so containers and functions can be scaled independently per customer while still sharing operational tooling, logs, and secrets.</p>"},{"location":"cloud/architecture/#multi-tenant-per-outlet-isolation","title":"Multi-tenant &amp; per-outlet isolation","text":"<p>The cloud is multi-tenant by design: every merchant (and by extension, every outlet) receives its own namespace, audit partition, and quota enforcement while still being hosted inside the shared DRC deployment. Tenant metadata flows from the local fiscal service (outlet ID, POS terminal ID, cashier ID) into the registry and sync engine so the cloud can reconstruct per-outlet order and assign the correct device guardrails. Shared tooling (monitoring, billing, backups) reuses the same clusters, but each tenant\u2019s data sits in logically separated buckets with IAM policies, ensuring the single-device-per-outlet guarantee from <code>spec/architecture-kutapay-system-1.md</code> remains intact.</p> <p>A dedicated sync queue per outlet prevents terminal contention: even if multiple POS terminals attempt to upload simultaneously, the queue serializes them before the upload worker touches the DGI API, honoring the arrival order requirement expressed in the architecture spec.</p>"},{"location":"cloud/architecture/#data-residency-compliance","title":"Data residency &amp; compliance","text":"<p>All cloud workloads run in a DRC-hosted region to comply with local data residency expectations (see the regulatory positioning in <code>DISCUSSION.md</code> around offline and governance sections). Invoices, logs, and audit exports are stored encrypted at rest, keys are managed within the same region, and TLS enforces encryption in transit. Backups are kept on redundant DRC zones, and any cross-border reporting is delivered through sealed exports (not raw invoice data) so that no sensitive tax information leaves the country without explicit ministerial approval. The cloud also tracks regulatory metadata (compliance deadlines, report cadence, audit trail hashes) so operators can prove they met the DGI requirements described in the SFE summary.</p>"},{"location":"cloud/architecture/#deployment-diagram","title":"Deployment diagram","text":"<p>The following Mermaid diagram shows the key deployment elements, how POS/fiscal services connect to the cloud, and how the cloud forwards sealed data to the DGI while keeping everything inside the trusted zone:</p> <pre><code>graph LR\n    subgraph EDF[\"Bono Pay Cloud (DRC deployment)\"]\n        API[\"API Gateway\"]\n        Sync[\"Sync &amp; Upload Service\"]\n        Registry[\"Device Registry\"]\n        Storage[\"Encrypted Invoice Store\"]\n        Dashboard[\"Operations Dashboard\"]\n        Audit[\"Audit Export Generator\"]\n    end\n    subgraph Edge[\"Merchant Edge (Per-outlet)\"]\n        POS[POS Terminals]\n        FiscalService[Local fiscal service]\n        USB[USB Fiscal Memory device]\n    end\n    DGI[\"DGI MCF / e-MCF\"]\n    POS --&gt; FiscalService\n    FiscalService --&gt; Sync\n    USB --&gt; Sync\n    Sync --&gt; Storage\n    Sync --&gt; DGI\n    Registry --&gt; Sync\n    Sync --&gt; Dashboard\n    Registry --&gt; Dashboard\n    Storage --&gt; Audit\n    Audit --&gt; DGI\n    Dashboard --&gt;|alerts, compliance dashboards| API\n    API --&gt; Sync\n    subgraph Region[\"DRC Data Residency\"]\n        Storage\n        Registry\n        Dashboard\n        Audit\n    end</code></pre>"},{"location":"cloud/dgi-integration/","title":"DGI Integration","text":"<p>This page captures how the Bono Pay Cloud interfaces with the DGI control modules (MCF / e-MCF) and documents the known obligations versus the remaining unknowns uncovered during the integration spike (<code>spec/infrastructure-dgi-integration-1.md</code>).</p>"},{"location":"cloud/dgi-integration/#overview","title":"Overview","text":"<p>The DGI enforces a layered chain: the POS/SFE prepares invoices, the trusted DEF secures them, and the control modules (MCF / e-MCF) verify and relay fiscalized data to the DGI backend. Bono Pay Cloud is the synchronization agent: it queues sealed invoices when offline, uploads them to the MCF/e-MCF endpoint when connectivity returns, and stores the fiscal numbers, auth codes, and timestamps produced by those control modules. The infrastructure must be always-on, support fallback hardware, and present audit-ready logs at all times.</p>"},{"location":"cloud/dgi-integration/#known-constraints-and-responsibilities","title":"Known constraints and responsibilities","text":"<ul> <li>The MCF/e-MCF modules are the only entities authorized to produce the sequential fiscal number, authentication code, trusted timestamp, and QR payload that make an invoice legally valid.</li> <li>Every submission to the control modules must include the canonical payload plus device identifiers (DEF NID, outlet ID, cashier ID) so that the DGI can link the invoice to its originating outlet.</li> <li>Offline issuance is permitted, but the Cloud must replay queued invoices to the control modules as soon as connectivity is restored; regulators view uptime as mandatory and require replacement hardware ready if the primary link fails.</li> <li>The control modules enforce immutability, continuous compliance, and real-time VAT surveillance (per Arr\u00eat\u00e9 033), meaning the Cloud must log every retry, failure, and acknowledgement.</li> <li>Bono Pay Cloud is also responsible for device registry tasks such as storing activation codes, monitoring device health, and surfacing failure alerts to operators.</li> </ul>"},{"location":"cloud/dgi-integration/#integration-architecture","title":"Integration architecture","text":"<p>The following flow captures the responsibilities we control and the trust boundary between Bono Pay Cloud and DGI:</p> <pre><code>flowchart LR\n  POS[\"POS / SFE\"] --&gt;|canonical payload| Cloud[\"Bono Pay Cloud\\n(sync queue + registry)\"]\n  Cloud --&gt;|sealed invoice + metadata| MCF[\"DGI MCF / e-MCF control modules\"]\n  MCF --&gt;|security elements (fiscal number, auth code, timestamp)| Cloud\n  MCF --&gt;|delivery stream| DGI[\"DGI Backend\\n(central tax authority)\"]\n  Cloud --&gt;|fallback communication| Fallback[\"Replacement DEF\\n(hardware backup)\"]\n  Fallback --&gt;|same sync path| MCF</code></pre> <p>This diagram emphasizes that the Cloud never generates security elements\u2014it relays them between the POS (or the local fiscal service) and the DGI control modules, while also coordinating fallback hardware when the primary DEF or network link fails.</p>"},{"location":"cloud/dgi-integration/#unknowns-tracked-as-admonitions","title":"Unknowns (tracked as ??? admonitions)","text":"MCF/e-MCF API surface still unpublished <p>The research spike confirmed that the DGI has not released the endpoint URLs, transport protocol, or schema definitions for the control modules. Until those are published we cannot code the HTTP client or test payload validation.</p> Authentication method for the control modules is undefined <p>We do not know whether the control modules require a DGI-issued certificate, bearer token, signed JWT, or another credential, nor how key rotation or revocation is handled.</p> Offline behavior and retry rules are unspecified <p>The legislation insists every invoice must be reported, but the precise grace period, retry intervals, or thresholds that trigger manual intervention are unknown, so the sync engine must remain configurable until the DGI clarifies.</p>"},{"location":"cloud/dgi-integration/#spike-reference-next-steps","title":"Spike reference &amp; next steps","text":"<p>Refer to <code>spec/infrastructure-dgi-integration-1.md</code> for the full list of known facts and open questions gathered during this research pass. Update that file (and this page) as soon as the DGI publishes more integration guidance so the Cloud sync agent and device registry can evolve from placeholders to production-ready connectors.</p>"},{"location":"cloud/offline-sync/","title":"Offline-First Sync Design","text":"<p>Every invoice issued in the DRC must survive the most hostile networks. <code>spec/architecture-kutapay-system-1.md</code> makes this explicit: the USB Fiscal Memory device continues accepting <code>PREPARE \u2192 COMMIT</code> requests locally when the cloud or DGI are unreachable, and the queued sealed invoices must be uploaded in arrival order once connectivity returns. The offline queue is therefore the single source of truth for deferred transmissions, audit trails, and the compensating controls that keep the audit chain intact.</p>"},{"location":"cloud/offline-sync/#sync-queue-architecture","title":"Sync queue architecture","text":"<p>Invoices enter the offline queue after the DEF commits them. Each entry stores the sealed canonical payload plus its security elements (<code>fiscal_number</code>, <code>device_id</code>, <code>auth_code</code>, <code>timestamp</code>, QR) so nothing outside the DEF can rewrite history. The queue keys the items by the device\u2019s monotonic counter and the host-provided arrival timestamp so the system always uploads in the same order the DEF sealed them. While queued, every invoice record includes:</p> <ul> <li>canonical payload hash \u2013 detects duplicates across reconnect attempts.</li> <li>device_id + fiscal_number \u2013 ties it back to the trusted source of truth.</li> <li>host metadata (outlet_id, pos_terminal_id, cashier_id) \u2013 supplies traceability for multi-terminal scenarios.</li> <li>sync position \u2013 the queue slot referenced by the sync state machine (PENDING_SYNC, RETRY, etc.).</li> </ul> <p>Offline issuance is not a compliance loophole</p> <p>Offline is allowed; suspicious offline is not. The queue must never drop, reorder, or compact invoices before the DGI acknowledges receipt, because the law treats delays as audit data that must be logged and reviewed (<code>DISCUSSION.md</code>, lines 1479\u20111485 &amp; 4730\u20114748). The system should emit alerts when invoices linger past the configured grace period (e.g., 24\u202fhours) so field teams can investigate before auditors do.</p>"},{"location":"cloud/offline-sync/#retry-logic-and-conflict-resolution","title":"Retry logic and conflict resolution","text":"<p>Uploading a sealed invoice is orthogonal to issuance. The DEF is the only authority that prints, signs, and increments counters (<code>spec/architecture-kutapay-system-1.md</code>), so retransmissions never mutate fiscal data\u2014they simply replay the previously generated sealed response. The sync service therefore prioritizes idempotent retries with exponential backoff: the queue marks every attempt with a retry count, waits before re-entering <code>UPLOADING</code>, and escalates the invoice to <code>FAILED</code> only after the <code>max_retries</code> threshold so operators can intervene.</p> <p>Transmission itself can be host-mediated (Model A) or DEF-mediated (Model B), but issuance happens inside the trusted zone alone (<code>DISCUSSION.md</code>, lines 4750\u20114769). To avoid race conditions, the queue coordinator serializes attempts by ensuring only one uploader speaks to the DGI at a time per outlet. Any duplicate fingerprint detected during retries is logged as a <code>RETRY</code> transition, never as a new fiscal event, preserving the \u201cvoids/refunds are new events\u201d rule.</p>"},{"location":"cloud/offline-sync/#grace-period-audit-logging","title":"Grace period &amp; audit logging","text":"<p>The DGI expects \u201cguaranteed eventual transmission,\u201d not best-effort bestoers (<code>DISCUSSION.md</code>, lines 141\u2011170). As soon as the POS or the DEF regains connectivity, the queue flushes invoices in arrival order and records the delay reason (network outage, host swap, GSM handover). Each sync attempt appends an audit record that includes the out-of-band delay duration, the host that triggered the retry, and the resulting status (ACKNOWLEDGED, RETRY, FAILED). These logs are part of the \u201ctransmission delays are logged and auditable\u201d requirement, so regulators can prove no invoice vanished during long offline spells.</p> <p>Grace periods should be configurable per deployment, but the default should align with DRC regulators\u2019 intolerance for extended \u201csuspicious offline\u201d windows. When the queue detects that a document has lingered longer than the grace period, it surfaces a <code>FAILED</code> state (pending manual recovery) and raises a compliance alarm. This encourages field teams to either re\u2011establish GSM/Internet links or plug the DEF into a temporary host, keeping the issuance order intact while honoring the audit timeline.</p>"},{"location":"cloud/offline-sync/#pos-ui-offline-indicators","title":"POS UI offline indicators","text":"<p>The POS UI mirrors the queue state machine. Every invoice shows a badge that switches between:</p> <ol> <li>Offline \u2013 queued in <code>PENDING_SYNC</code>; the device has fiscalized but the cloud has not confirmed delivery.</li> <li>Uploading \u2013 a sync worker has picked the invoice and is waiting for the DGI acknowledgment.</li> <li>Synced \u2013 DGI acknowledged receipt (ACKNOWLEDGED); the invoice is safe to archive locally.</li> <li>Retrying / Failed \u2013 the daemon is retrying due to a transient error or waiting for manual recovery after <code>FAILED</code>.</li> </ol> <p>These indicators also drive other UI elements such as network status chips (green for connected, amber for limited connectivity, red for extended offline) and action buttons (\u201cResend now\u201d, \u201cPack &amp; ship journal\u201d) to honor <code>DISCUSSION.md</code>\u2019s suggestion that offline is acceptable but must be observable. Use telemetry (queue depth, max delay) to highlight outlets that are approaching the alert thresholds.</p>"},{"location":"cloud/offline-sync/#invoice-sync-state-machine","title":"Invoice sync state machine","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; PENDING_SYNC\n    PENDING_SYNC --&gt; UPLOADING : network available\n    UPLOADING --&gt; ACKNOWLEDGED : DGI acknowledged\n    UPLOADING --&gt; RETRY : temporary error\n    RETRY --&gt; UPLOADING : backoff timer expires\n    RETRY --&gt; FAILED : max retries exceeded\n    FAILED --&gt; RETRY : manual resume\n    ACKNOWLEDGED --&gt; [*]</code></pre>"},{"location":"cloud/offline-sync/#bandwidth-and-scheduling-optimizations","title":"Bandwidth and scheduling optimizations","text":"<p>Low-bandwidth deployments benefit from batching and compression. Group invoices by outlet and exchange them as a single envelope with a manifest that the DGI can verify (<code>DISCUSSION.md</code>, lines 1479\u20111485 &amp; 4730\u20114758). Attach a lightweight delta payload for invoices that the cloud already knows about, and drop unnecessary staging artifacts after the ACKNOWLEDGED state so the queue stays compact.</p> <p>The sync daemon should also respect \u201csuspicious offline is not\u201d by throttling reconnection storms and avoiding burst uploads during peak GSM charges. Spread retries over the grace period, apply jitter to backoff timers, and never attempt a sync while another upload for the same fiscal number is in-flight.</p> <p>Treat the queue like a compliance ledger</p> <p>Every state transition is proof that the invoice existed and was delivered responsibly. Because the DEF never releases a fiscal number until <code>COMMIT</code> succeeds, the queue can safely replay sealed records without risking duplicate issuance. Keep telemetry dashboards on this ledger so auditors can reconstruct the whole story if needed.</p>"},{"location":"fiscal/invoice-lifecycle/","title":"Invoice lifecycle","text":""},{"location":"fiscal/invoice-lifecycle/#non-negotiable-six-step-flow","title":"Non-negotiable six-step flow","text":"<p>Every invoice must traverse the same locked-down path so the trust boundary is respected and every fiscal payload carries the device-generated security elements mandated by the DGI. The sequence below captures the actors in the canonical handshake: the cashier, the POS client, the local fiscal service that mediates USB access, the trusted USB Fiscal Memory device (DEF), the cloud sync layer, and ultimately the DGI.</p> <pre><code>sequenceDiagram\n    participant Cashier\n    participant POS\n    participant FiscalService as Local Fiscal Service\n    participant DEF as USB Fiscal Memory Device\n    participant Cloud\n    participant DGI\n\n    Cashier-&gt;&gt;POS: 1. Finalize sale and request fiscalization\n    POS-&gt;&gt;FiscalService: 2. Send canonical invoice payload (PREPARE)\n    FiscalService-&gt;&gt;DEF: 3. Forward PREPARE for validation\n    DEF--&gt;&gt;FiscalService: 4. Return nonce and acceptance\n    FiscalService-&gt;&gt;DEF: 5. Issue COMMIT with nonce\n    DEF--&gt;&gt;FiscalService: 6. Return fiscal response (seq, auth, QR)\n    FiscalService--&gt;&gt;POS: Deliver sealed response for printing\n    POS-&gt;&gt;Cloud: Queue sealed invoice for upload\n    Cloud-&gt;&gt;DGI: Upload sealed invoice (deferred)</code></pre> <ol> <li>The POS gathers the finalized basket, serializes the canonical payload with deterministic field ordering, and asks the fiscal service to issue a PREPARE call.</li> <li>The fiscal service forwards PREPARE to the DEF, which checks schema, tax groups, counters, and replay status but does not yet change state.</li> <li>When the DEF validates the payload, it returns a short-lived nonce and a signal that it is ready to commit.</li> <li>The fiscal service consumes the nonce and sends COMMIT; the device atomically increments the counter, appends the hash-chained journal entry, signs the record, and stores it immutably.</li> <li>The DEF replies with the fiscal response (<code>fiscal_number</code>, <code>device_id</code>, <code>auth_code</code>, <code>timestamp</code>, QR) so the POS can print the receipt and mark the invoice as fiscalized.</li> <li>The POS stores the sealed invoice locally, the cloud queue uploads it (still carrying the DEF security elements), and the DGI receives the sealed payload later to close the audit loop.</li> </ol>"},{"location":"fiscal/invoice-lifecycle/#invoice-state-machine","title":"Invoice state machine","text":"<p>Every invoice transitions through six explicit states. The state machine prevents skips that would let an invoice appear fiscalized without a matching commit or reports.</p> <pre><code>stateDiagram-v2\n    Draft --&gt; Preparing : POS issues PREPARE\n    Preparing --&gt; Prepared : DEF validates schema + tax groups\n    Prepared --&gt; Fiscalized : COMMIT succeds &amp; DEF signs\n    Fiscalized --&gt; Delivered : Receipt printed + customer copy\n    Delivered --&gt; Synced : Cloud uploads sealed invoice to DGI</code></pre> <p><code>Draft</code> holds the cashier\u2019s local work-in-progress. <code>Preparing</code> and <code>Prepared</code> capture the two-phase commit so the DEF can enforce canonical payloads before altering counters. Once <code>Fiscalized</code>, the device has immutable proof, and <code>Delivered</code> + <code>Synced</code> cover the distribution and deferred upload responsibilities.</p>"},{"location":"fiscal/invoice-lifecycle/#invoice-types","title":"Invoice types","text":"<p>The SFE must support every type the DGI requires so no invoice ever circumvents a security path.</p> Type Code Description Sale invoice <code>SALE</code> Standard retail/wholesale invoice with 14 tax-group breakdowns and DEF security elements. Advance invoice <code>ADVANCE</code> Prepayment invoice that locks in tax treatment but awaits final receipt; still fiscalized via DEF. Credit note <code>CREDIT</code> Correction issued after a sale; references the original fiscal number and is sealed as a new fiscal event. Export invoice <code>EXPORT</code> Duty/export-focused invoice that records customs/product details and uses the same PREPARE\u2192COMMIT flow. Export credit note <code>EXPORT_CREDIT</code> Refund or correction for an export invoice; binds to the original export fiscal number and still circulates through the DEF."},{"location":"fiscal/invoice-lifecycle/#special-flows","title":"Special flows","text":""},{"location":"fiscal/invoice-lifecycle/#void-flow","title":"Void flow","text":"<p>A void is never a deletion. The POS flags the original fiscal number, composes a new canonical payload (<code>invoice_type</code>: <code>CREDIT</code> or a dedicated void indicator), and sends it through PREPARE \u2192 COMMIT exactly like any invoice. The DEF records a new sequence value, links the journal entry to the void reason, and emits its own fiscal response. Auditors follow the link from void to original; no prior record disappears.</p>"},{"location":"fiscal/invoice-lifecycle/#refund-credit-note-flow","title":"Refund (credit note) flow","text":"<p>Credit notes are new fiscalized events. The POS references the original <code>fiscal_number</code> and <code>invoice_type</code>, builds a payload that includes the refund totals and tax reversals, and runs it through the same two-phase commit. The DEF issues a brand-new fiscal number/auth code while preserving the trace back to the original invoice for reconciliation.</p>"},{"location":"fiscal/invoice-lifecycle/#draft-cancellation","title":"Draft cancellation","text":"<p>If the cashier cancels before PREPARE/COMMIT, the invoice never touches the DEF. The cancellation happens in the POS application with no fiscal number assigned, no journal entry created, and no audit trail\u2014because the work never reached the trusted layer.</p> <p>Nothing is ever deleted</p> <p>Every fiscal event is an append-only entry. Voids, refunds, and corrections create new invoices that reference the originals; there is no way to rewrite or drop the records once they leave the POS. This rule keeps the hash-chained ledger intact and aligns with the DGI mandate.</p>"},{"location":"fiscal/invoice-lifecycle/#references","title":"References","text":"<ul> <li><code>spec/architecture-kutapay-system-1.md</code> (trust boundary, canonical payload, actors)</li> <li><code>docs/sfe-specifications-v1-summary.md</code> (invoice types, security elements, immutability)</li> <li><code>.github/copilot-instructions.md</code> (invoice lifecycle and trust boundary rules)</li> </ul>"},{"location":"fiscal/reports/","title":"Reports (Z / X / A and Audit Export)","text":"<p>Bono Pay delivers the mandatory Z, X, and A reports plus an audit export directly from the fiscal journal that the USB device and cloud sync maintain. These reports are produced from the same canonical data that powers invoices, include the device-generated security elements (<code>device_id</code>, <code>fiscal_number</code>, <code>auth_code</code>, <code>trusted_timestamp</code>, <code>qr_payload</code>), and can be generated offline or on demand for auditors and the DGI.</p>"},{"location":"fiscal/reports/#report-catalog","title":"Report catalog","text":"Report Purpose Frequency Primary audience Z report Daily closure with per-tax-group totals and invoice range End of day / merchant close Merchant, auditor, DGI X report Mid-period snapshot for shifts, sessions, and spot checks Hourly / shift / on-demand Merchant supervisors, auditors A report Line-item detail across invoices filtered by time period Ad-hoc (audits, inspections) Auditors, inspectors Audit export Full hash-chained journal dump (sales, voids, refunds) Scheduled or triggered by DGI DGI, compliance teams"},{"location":"fiscal/reports/#z-report-daily-closure","title":"Z report (Daily closure)","text":"<ul> <li>What it tells you: The exact invoice sequence consumed that day plus totals for every tax group, payment method, and grand totals. Use it to reconcile the fiscal counter and to prove that no invoice was skipped.</li> <li>How it\u2019s produced: The device (or the cloud sync agent when online) samples the journal after the last <code>TXN|COMMIT</code> of the day, collects the totals, signs the report, and optionally uploads it to the cloud for archival.</li> <li>Key fields: <code>outlet_id</code>, <code>device_id</code>, <code>date</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>invoice_count</code>, <code>tax_totals</code>, <code>grand_totals</code>, <code>journal_hash</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#x-report-session-snapshot","title":"X report (Session snapshot)","text":"<ul> <li>What it tells you: Where the device stands mid-shift: invoiced range, totals by payment instrument, device health, and any warning flags (e.g., <code>CLOCK_ROLLBACK_DETECTED</code>, low <code>free_nonce_pool</code>).</li> <li>How it\u2019s produced: Triggered on demand, at the start/end of a shift, or automatically (e.g., hourly). It helps cashiers and supervisors detect drift before the day closes.</li> <li>Key fields: <code>period_id</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>totals</code>, <code>device_status</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#a-report-article-level-detail","title":"A report (Article-level detail)","text":"<ul> <li>What it tells you: Every line item contributing to the invoices in a time range, including <code>tax_group</code>, <code>tax_rate</code>, <code>client_classification</code>, <code>line_total</code>, and a reference to the originating invoice.</li> <li>How it\u2019s produced: Filtered view over the journal entries; the device streams the subset or exports are assembled by the cloud using the device\u2019s data plus the merchant\u2019s product metadata.</li> <li>Key fields: <code>invoice_ref</code>, <code>article_id</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, <code>tax_rate</code>, <code>tax_amount</code>, <code>client_classification</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#audit-export-full-journal-dump","title":"Audit export (Full journal dump)","text":"<ul> <li>What it tells you: The complete, append-only journal (sales, voids, refunds, resets) with hashes, signatures, and all canonical payload metadata. Ideal for DGI reconciliation or for auditors that need a forensic copy.</li> <li>How it\u2019s produced: Read each <code>log_entry</code> sequentially, attach <code>prev_hash</code>, <code>signature</code>, and <code>canonical_payload_hash</code>, then stream entries in chunked batches (<code>chunk_index</code>, <code>chunk_count</code>). Each chunk is acknowledged before the next is delivered to avoid partial exports.</li> <li>Key fields per entry: <code>record_type</code>, <code>sequence</code>, <code>timestamp</code>, <code>merchant_nif</code>, <code>client</code>, <code>totals</code>, <code>tax_breakdown</code>, <code>prev_hash</code>, <code>signature</code>, <code>canonical_payload_hash</code>.</li> </ul>"},{"location":"fiscal/reports/#sample-report-outputs","title":"Sample report outputs","text":"<pre><code>{\n  \"type\": \"Z\",\n  \"date\": \"2026-02-16\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"device_id\": \"KUTA001\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 125,\n  \"invoice_count\": 25,\n  \"tax_totals\": [\n    { \"tax_group\": \"TG02\", \"base_amount\": \"15000.00\", \"tax_amount\": \"2400.00\" },\n    { \"tax_group\": \"TG01\", \"base_amount\": \"500.00\", \"tax_amount\": \"0.00\" }\n  ],\n  \"grand_totals\": { \"subtotal\": \"15500.00\", \"total_vat\": \"2400.00\", \"total\": \"17900.00\", \"currency\": \"CDF\" },\n  \"journal_hash\": \"3F9B-7A12-...\",\n  \"generated_at\": \"2026-02-16T23:58:30Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"X\",\n  \"period_id\": \"Shift-A-2026-02-16-08\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 110,\n  \"invoice_count\": 10,\n  \"totals\": {\n    \"cash\": { \"subtotal\": \"4800.00\", \"tax\": \"768.00\", \"total\": \"5568.00\" },\n    \"mobile_money\": { \"subtotal\": \"2200.00\", \"tax\": \"352.00\", \"total\": \"2552.00\" }\n  },\n  \"device_status\": {\n    \"firmware_version\": \"2026.02.16\",\n    \"free_memory_bytes\": 512000,\n    \"next_invoice_seq\": 111\n  },\n  \"generated_at\": \"2026-02-16T13:00:00Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"A\",\n  \"reporting_period\": \"2026-02-16\",\n  \"entries\": [\n    {\n      \"invoice_ref\": \"KUTA001-110\",\n      \"description\": \"Wholesale service plan\",\n      \"quantity\": 1,\n      \"unit_price\": \"10000.00\",\n      \"line_total\": \"10000.00\",\n      \"tax_group\": \"TG03\",\n      \"tax_rate\": \"0.16\",\n      \"tax_amount\": \"1600.00\",\n      \"client_classification\": \"Company\",\n      \"generated_at\": \"2026-02-16T13:05:32Z\"\n    }\n  ]\n}\n</code></pre> <pre><code>{\n  \"type\": \"AUDIT_EXPORT\",\n  \"chunk_index\": 2,\n  \"chunk_count\": 5,\n  \"device_id\": \"KUTA001\",\n  \"entries\": [\n    {\n      \"sequence\": 109,\n      \"record_type\": \"sale\",\n      \"timestamp\": \"2026-02-16T12:54:17Z\",\n      \"total\": \"116.00\",\n      \"tax_breakdown\": [{ \"tax_group\": \"TG02\", \"tax_amount\": \"16.00\" }],\n      \"prev_hash\": \"A4B2\",\n      \"signature\": \"ABCD1234EFGH\",\n      \"canonical_payload_hash\": \"8F3C\"\n    }\n  ],\n  \"generated_at\": \"2026-02-16T23:59:50Z\"\n}\n</code></pre>"},{"location":"fiscal/reports/#report-generation-flow","title":"Report generation flow","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant Device\n    participant Cloud\n    participant DGI\n\n    POS-&gt;&gt;Device: TXN|PREPARE (canonical payload)\n    Device--&gt;&gt;POS: nonce, status\n    POS-&gt;&gt;Device: TXN|COMMIT\n    Device--&gt;&gt;POS: fiscal number + auth code\n    Device--&gt;&gt;Cloud: log entry + metadata\n    Cloud--&gt;&gt;DGI: audit export chunk (Z/X/A as needed)</code></pre> <p>Every completed invoice creates a log entry that can be sampled by the report generator. Z reports are usually emitted once the device detects the end-of-day closing event, X reports are streamed on shift/period boundaries, and A reports can be filtered per auditor request. Audit exports walk the journal in order, so auditors always receive the hash chain and signature sequence to prove immutability.</p>"},{"location":"fiscal/reports/#using-the-reports","title":"Using the reports","text":"<ol> <li>During operations \u2014 Supervisors pull X reports to ensure totals match the cash drawer and to monitor device health (<code>free_nonce_pool</code>, <code>last_sync_timestamp</code>, <code>warning_flags</code> for storage or clock drift).</li> <li>At close-of-day \u2014 Merchants run the Z report, print or upload it, and archive the output alongside the receipts; the report\u2019s <code>journal_hash</code> acts as a tamper-evident fingerprint of that day.</li> <li>Audits \u2014 Inspectors request A reports for specific clients, products, or dates. The exported lines include references to the canonical payload so they can verify the tax group and client classification.</li> <li>DGI exports \u2014 The audit export stream replicates the full journal to the tax authority (chunked if necessary). Each chunk is acknowledged before the next is delivered to protect against network interruptions.</li> </ol> <p>No data is deleted: voids and refunds appear as separate entries in every report, and the audit export documents the corrective events with their own <code>sequence</code> numbers. When operating offline, reports are cached on the device or POS service and transmitted once connectivity returns.</p>"},{"location":"fiscal/security-elements/","title":"Security elements on invoices","text":"<p>The DGI SFE specification and the Bono Pay architecture rules mandate that every fiscal event carries five immutable security elements. The USB Fiscal Memory device (DEF) owns the counters, identifiers, timestamps, and signatures that prove an invoice was issued by an authorized system; the POS, fiscal service, and cloud must treat them as sealed outputs. This page explains what each element is, who produces it, where it appears on the receipt, how the system verifies it, and what to do when it is missing.</p> <p>Device-generated security elements</p> <p>The POS MAY NOT fabricate any of these values. They must be generated inside the DEF, travel only in sealed payloads, and stay embedded in the hash-chained journal (spec/architecture-kutapay-system-1.md; docs/sfe-specifications-v1-summary.md). Missing or modified elements invalidate the invoice.</p>"},{"location":"fiscal/security-elements/#sequential-fiscal-invoice-number","title":"Sequential fiscal invoice number","text":"<ul> <li>What it is: A monotonic, non-resettable counter that assigns every invoice a unique fiscal number and anchors the hash-chained journal used for reports.</li> <li>Generated by: The DEF each time a PREPARE \u2192 COMMIT cycle concludes successfully (kutapay_technical_design.md \u00a75 and spec file).</li> <li>Receipt placement: Prominently printed near the merchant header so auditors see the office/local sequence.</li> <li>Verification: The cloud, dashboard, and DGI compare the printed number with the journal entry, the Z/X reports, and the expected counter for that device.</li> <li>Missing / invalid: The invoice is immediately rejected by the DGI and cannot be synchronized; operators must reissue the transaction after the DEF issues a new fiscal number.</li> </ul>"},{"location":"fiscal/security-elements/#device-id-def-nid","title":"Device ID (DEF NID)","text":"<ul> <li>What it is: A unique identifier assigned to each DEF (also called DEF NID) that proves which device produced the fiscal response.</li> <li>Generated by: The trusted hardware during provisioning; the DEF includes it in every response alongside the fiscal number and signature.</li> <li>Receipt placement: Printed beside the fiscal number (and often in the security block) so inspectors can trace the outlet/device pair.</li> <li>Verification: The cloud compares it to the device registry; auditors can cross-check it against the DEF\u2019s public key metadata in the registry.</li> <li>Missing / invalid: Without a DEF ID the invoice cannot be tied to a certified device, so the DGI and Bono Pay cloud must mark it non-compliant and block further uploads.</li> </ul>"},{"location":"fiscal/security-elements/#cryptographic-authentication-code-signature","title":"Cryptographic authentication code (signature)","text":"<ul> <li>What it is: A device-generated cryptographic signature over the canonical payload, counter, timestamp, and report metadata that proves the DEF approved the invoice.</li> <li>Generated by: The Secure Element inside the DEF using the device\u2019s private key (docs/sfe-specifications-v1-summary.md, kutapay_technical_design.md \u00a75).</li> <li>Receipt placement: Included in the security block or encoded inside the QR code so scanning software can read and verify it.</li> <li>Verification: The cloud, auditors, and DGI validate the signature using the DEF public key from the registry; signatures that fail to verify trigger rejection.</li> <li>Missing / invalid: If the signature is absent or fails verification, the invoice is treated as unauthenticated and cannot be lodged with the DGI; the sale must be repeated with a new fiscalization.</li> </ul>"},{"location":"fiscal/security-elements/#trusted-timestamp","title":"Trusted timestamp","text":"<ul> <li>What it is: The DEF\u2019s trusted clock value that timestamps the PREPARE \u2192 COMMIT event.</li> <li>Generated by: The DEF\u2019s RTC (linked to the secure element); it cannot be supplied by the POS or cloud.</li> <li>Receipt placement: Shown near the fiscal number/dev ID block and embedded in the QR payload to prove when the invoice occurred.</li> <li>Verification: The cloud compares it against the DEF journal order (must be monotonic per outlet) and the offline queue to detect drift or replay.</li> <li>Missing / invalid: Invoices without a trusted timestamp are non-compliant, cannot be reconciled with Z/X reports, and raise alerts for potential tampering.</li> </ul>"},{"location":"fiscal/security-elements/#qr-code-encoding-verification-data","title":"QR code encoding verification data","text":"<ul> <li>What it is: A machine-readable encoding of the fiscal number, DEF ID, timestamp, signature, and other verification payloads required by inspectors and the DGI.</li> <li>Generated by: The DEF after COMMIT; the QR code contains sealed data that the POS prints and the cloud uploads verbatim (docs/sfe-specifications-v1-summary.md).</li> <li>Receipt placement: Typically printed at the bottom-right of the receipt, adjacent to the totals and security block.</li> <li>Verification: Inspectors and software scan the QR code to replay the data, validate the signature, and confirm the device/partner match.</li> <li>Missing / invalid: Without the QR code the invoice fails the compliance checklist, and automated DGI upload tooling will flag it as incomplete.</li> </ul>"},{"location":"fiscal/security-elements/#mock-receipt-layout","title":"Mock receipt layout","text":"<pre><code>flowchart TB\n  subgraph receipt[\"Mock receipt (Bono Pay fiscalized)\"]\n    merchant[Merchant + outlet info]\n    fiscal[\"Fiscal number\\nDevice ID (DEF NID)\"]\n    timestamp[\"Trusted timestamp\"]\n    signature[\"Cryptographic authentication code\"]\n    qr[\"QR code (verification payload)\"]\n  end\n  merchant --&gt; fiscal --&gt; timestamp --&gt; signature --&gt; qr</code></pre> <p>The diagram above shows how the five security elements are grouped near the receipt header and security block so every printout carries the data inspectors need. The QR code encapsulates the entire sealed payload, making verification a single scan away.</p>"},{"location":"fiscal/security-elements/#maintaining-compliance","title":"Maintaining compliance","text":"<p>Even when offline, the DEF must continue generating these elements locally; the POS/cloud only forwards the sealed responses (spec/architecture-kutapay-system-1.md). Missing elements, altered values, or attempts to generate them outside the DEF immediately invalidate the invoice and keep it out of the audit trail. If a failure occurs (power loss, disconnected USB), the POS retries the PREPARE step so the DEF can reissue all five elements together.</p>"},{"location":"fiscal/tax-engine/","title":"Tax Engine","text":""},{"location":"fiscal/tax-engine/#regulatory-mandate","title":"Regulatory mandate","text":"<p>The DGI SFE specification and the Bono Pay discussion notes are unambiguous: the tax engine must handle all 14 DGI-defined tax groups, client classifications that drive tax selection, and precise rounding before an invoice is handed to the USB Fiscal Memory device. The <code>spec/schema-tax-engine-1.md</code> document controls the canonical schema, while this page focuses on implementation guidance and examples.</p> <p>Regulatory constraint</p> <p>The tax engine cannot shortcut the 14-group requirement. If the documentable tax group manifest does not list a TG## code, the invoice must fail validation before it reaches the device.</p>"},{"location":"fiscal/tax-engine/#tax-group-matrix","title":"Tax Group Matrix","text":"Code Name Default Rate Typical usage TG01 Exempt 0% Embassies, diplomatic transfers, NGOs TG02 Standard VAT \u2014 Goods 16% Domestic merchandise TG03 Standard VAT \u2014 Services 16% Professional and intangible services TG04 Reduced VAT 9% Essential food, medicine, medical devices TG05 Public Financing VAT 16% State-sponsored programs or subsidies TG06 Customs VAT 16% Import deliveries billed in CDF TG07 Export Zero Rate 0% Export invoices, cross-border services TG08 Special Regime \u2014 Agriculture 5% Agriculture supply chain participants TG09 Special Regime \u2014 Mining 10% Mining operators with an active license TG10 Specific Tax \u2014 Fuel 25% Gasoline, diesel, aviation fuel TG11 Specific Tax \u2014 Tobacco 30% Cigarettes, cigars, tobacco sheets TG12 Specific Tax \u2014 Alcohol 20% Distilled spirits, beer, wine TG13 Specific Tax \u2014 Telecommunications 15% Mobile voice, data, SMS bundles TG14 Specific Tax \u2014 Digital Services 12% SaaS, streaming, digital ads consumed in DRC <p>The manifest version must travel with every invoice via <code>tax_group_manifest_version</code> so that audits can map totals to the rate set that was active at issuance.</p>"},{"location":"fiscal/tax-engine/#decision-tree-which-tax-group-applies","title":"Decision Tree \u2014 Which tax group applies?","text":"<pre><code>flowchart TD\n    Start[Start: classify the transaction] --&gt; Embassy{Is the client an embassy or diplomatic mission?}\n    Embassy -- Yes --&gt; TG1[TG01: Exempt]\n    Embassy -- No --&gt; Export{Is the item exported or consumed outside DRC?}\n    Export -- Yes --&gt; TG7[TG07: Export Zero Rate]\n    Export -- No --&gt; Special{Does the catalog mark the item as special regime or excise?}\n    Special --&gt; |Fuel| TG10[TG10: Specific Tax \u2014 Fuel]\n    Special --&gt; |Tobacco| TG11[TG11: Specific Tax \u2014 Tobacco]\n    Special --&gt; |Alcohol| TG12[TG12: Specific Tax \u2014 Alcohol]\n    Special --&gt; |Telecom| TG13[TG13: Specific Tax \u2014 Telecommunications]\n    Special --&gt; |Digital| TG14[TG14: Specific Tax \u2014 Digital Services]\n    Special --&gt; |Agriculture| TG8[TG08: Special Regime \u2014 Agriculture]\n    Special --&gt; |Mining| TG9[TG09: Special Regime \u2014 Mining]\n    Special --&gt; |Public| TG5[TG05: Public Financing VAT]\n    Special --&gt; |Customs| TG6[TG06: Customs VAT]\n    Special --&gt; |None| Kind{Is the good tangible or a service?}\n    Kind --&gt; |Goods| TG2[TG02: Standard VAT \u2014 Goods]\n    Kind --&gt; |Service| TG3[TG03: Standard VAT \u2014 Services]\n    Kind --&gt; |Reduced| TG4[TG04: Reduced VAT]</code></pre> <p>This flowchart should be embedded into the POS taxonomy. At each branch, the catalog metadata must flag the appropriate tax group so that the fiscal service never guesses a code. The <code>special</code> branch also checks for catalogue flags such as <code>is_excise</code>, <code>use_customs_rate</code>, or <code>special_regime_code</code>.</p>"},{"location":"fiscal/tax-engine/#client-classification-and-its-effects","title":"Client Classification and Its Effects","text":"Classification Description Tax behavior individual Private person Default to TG02/TG03 or TG04 if the catalog marks the line as an essential good. company Registered corporation Use any tax group; TG02/TG03 are defaults. commercial_individual Sole trader Same as company but carries proprietor ID. professional Licensed professionals Services default to TG03; specify TG04 when the Ministry authorizes the reduced regime. embassy Diplomatic mission Always TG01 unless DGI issues a <code>tax_override_reason</code>. <p>Note</p> <p>Classification is recorded on every invoice. Use the classification to drive the first two branches of the tax group decision tree and to populate <code>client_classification</code> in the canonical payload.</p>"},{"location":"fiscal/tax-engine/#calculation-rounding-rules","title":"Calculation &amp; Rounding Rules","text":"<ol> <li>Calculate <code>tax_amount</code> as <code>tax_base \u00d7 tax_rate</code>.</li> <li>Round each line-level tax to the nearest centime (0.01 CDF) using half-up rounding; store any delta in <code>tax_rounding_adjustment</code>.</li> <li>Populate <code>tax_summary</code> with one row per tax group code, including zero-amount entries so auditors can verify conformity with the manifest.</li> <li>Apply TG07 (Export Zero Rate) only when the customer is outside DRC and the invoice_type is <code>export</code> or <code>export_service</code>.</li> <li>Do not mix TG01 with any other code in the same invoice unless the embassy provides a DGI override value that is logged in <code>tax_override_reason</code>.</li> </ol>"},{"location":"fiscal/tax-engine/#worked-examples","title":"Worked Examples","text":"Example Item Client classification Tax group Base (CDF) Rate Tax (CDF) Notes 1 Solar panels sold to a retailer company TG02 100000 16% 16000 Standard domestic goods example. 2 Galenic medicine sold to a clinic company TG04 150000 9% 13500 Reduced regime triggered by catalog flag <code>is_essential</code>. 3 Digital consultancy sold to a customer in Brussels company TG07 200000 0% 0 Export zero-rate; <code>tax_rounding_adjustment</code> remains 0."},{"location":"fiscal/tax-engine/#implementation-guidance","title":"Implementation guidance","text":"<ol> <li>Reference <code>spec/schema-tax-engine-1.md</code> for the authoritative TG## definitions and canonical schema fields before you add a new tax_group_code.</li> <li>Drive the taxonomy (export vs. local, special regime, excise) through catalog metadata and client classification.</li> <li>When the USB Fiscal Memory returns the fiscal response, persist <code>tax_summary</code> so you can regenerate Z/X/A reports that align with the manifest version.</li> <li>Update <code>tax_group_manifest_version</code> whenever DGI publishes a new rate or adds a group; the spec file mirrors the latest manifest and should be the source of truth for the document.</li> </ol>"},{"location":"hardware/bom/","title":"Bill of Materials (BOM) &amp; Manufacturing","text":"<p>This page captures the hardware cost structure for the USB Fiscal Memory device and the manufacturing steps required to keep the unit within the $10\u201315 COGS target while delivering the security required by the DRC regulators.</p>"},{"location":"hardware/bom/#component-cost-breakdown","title":"Component cost breakdown","text":"Component Example Part Qty Unit Cost (USD) Notes Secure MCU STM32L4 / NXP Kinetis (Cortex\u2011M4/M33) 1 $3.00\u20135.00 Handles USB CDC communication, JSON parsing, signing orchestration, and counter logic. Secure Element Microchip ATECC608B / NXP SE050 1 $1.00\u20132.00 Stores private keys, enforces monotonic counters, performs ECC signatures. External Flash 8\u201116 Mbit SPI Flash 1 $0.50\u20131.00 Optional journal extension when MCU flash is insufficient; protects log longevity. RTC + Crystal MCU RTC with 32.768 kHz crystal or dedicated RTC IC 1 ~$0.20 Provides trusted timestamp; add ~$0.50 if battery-backed RTC required for full offline guarantee. USB interface USB\u2011C receptacle + ESD protection diodes 1 ~$0.70 USB\u2011C female, protection components, and charging circuitry keep the device compliant with host ports. Power regulation Buck/LDO + supercap (optional) 1 ~$0.80 Regulates USB power, supplies RTC backup, and protects against dirty 5 V rails. Indicator LED SMD LED + resistor 1 $0.05 Communicates device health, sync status, and fiscalization success. PCB 4\u2011layer PCB with controlled impedance 1 ~$0.50 Ensures solid grounding for USB security and EMI; includes tamper sensing traces. Enclosure &amp; tamper Injection molded plastic / machining + seals 1 $0.50\u20131.00 Durable casing with tamper\u2011evident screws or potting to defend the secure element. Assembly &amp; testing SMT + firmware flashing + QA 1 $1.00\u20132.00 Includes firmware programming, burn\u2011in, signature validation, and QA logs. Contingency &amp; logistics Freight, customs, certificates \u2014 ~$0.50 Covers shipping, certifications, and regulatory paperwork. <p>Estimated materials + manufacturing: ~$10\u201315 per device (materials + assembly + testing + logistics). This leaves room for margin, support, and certification costs.</p>"},{"location":"hardware/bom/#total-cogs-pricing-approach","title":"Total COGS &amp; pricing approach","text":"<p>Bono Pay targets a $10\u201315 COGS for the fiscal device, which enables a retail/wholesale price in the $50\u2013100 range (per the regulatory appendix) while accounting for logistics, certification, and support. The markup funds:</p> <ul> <li>Merchant onboarding and activation tooling.</li> <li>Device registration with DGI and firmware validation.</li> <li>Support services for field deployment (helpdesk, monitoring).</li> </ul>"},{"location":"hardware/bom/#sensitivity-analysis","title":"Sensitivity analysis","text":"<ul> <li>Secure Element cost doubles: If the SE price jumps to $4 (e.g., switching to an SE050 or offering extra tamper protection), the BOM climbs to ~$11.8\u201317.0, pressuring the price unless we offset via lower margins or operational efficiencies.</li> <li>Microcontroller volatility: A MCU surge to $6.50 increases the upper bound above $16; mitigating actions include supplier contracts or redesigning firmware for alternative MCU families.</li> <li>Assembly/test labor spikes: A $0.50 rise in assembly pushes COGS ~0.5 higher; automation and batch programming reduce this risk.</li> </ul> <p>Use these scenarios when negotiating with contract manufacturers and to decide whether optional components (e.g., supercap, enclosure upgrades) are worth including in every unit or offered as premium upgrades.</p>"},{"location":"hardware/bom/#manufacturing-considerations","title":"Manufacturing considerations","text":"<p>Adhering to the trust boundary and regulator expectations requires more than parts pricing:</p> <ol> <li>Quality assurance: Each device must pass counter increment tests, signature verification, and memory dump checks before shipment. Maintain traceability records in the production log to satisfy audits.</li> <li>Tamper protection: The enclosure should favor tamper\u2011evident screws, potting, or seals so any physical intrusion invalidates the device; log this observation in the QA report.</li> <li>Firmware control: Firmware updates occur rarely; deliver signed firmware image packages and enforce signature checks, keeping older versions for rollback if DGI rules change unexpectedly.</li> <li>Device activation: Devices remain inert until associated with a merchant and registered with DGI. Activation includes key provisioning (either pre\u2011loaded keys or DGI certificate exchange) and printing the device ID on the casing for audit.</li> <li>Logistics: Batch shipments to DRC must consider customs clearance for cryptographic hardware. Keep track of serial numbers, firmware versions, and DGI registration status to expedite homologation.</li> </ol> <p>Caution</p> <p>Keep the $10\u201315 COGS goal visible during negotiations. Small increases in any component multiply across thousands of units, which can push the device past affordability thresholds mandated by the DRC market and regulators.</p>"},{"location":"hardware/protocol/","title":"USB Fiscal Device Protocol","text":"<p>This page summarizes the TXN / QRY / RPT / ADM / CFG commands that flow between the untrusted POS/fiscal service cluster and the trusted USB Fiscal Memory device. The full machine-readable definition lives in the protocol specification (<code>spec/protocol-usb-fiscal-device-1.md</code> in the project root), and ADR-0001 explains why the two-phase handshake is the only compliant option (read it here).</p> <p>The DEF is the only fiscal authority</p> <p>ADR-0001 mandates that no receipt may reach a customer unless the DEF has fully committed it (PREPARE \u2192 COMMIT \u2192 signed response). The POS must never print or queue a receipt before receiving the COMMIT response and verifying the <code>invoice_seq</code>, <code>auth_code</code>, and device timestamp.</p>"},{"location":"hardware/protocol/#command-families","title":"Command families","text":"Family Primary commands Role Transaction (TXN) <code>TXN|PREPARE</code>, <code>TXN|COMMIT</code> Nonce-based 2PC that validates and signs canonical invoices before exposing the security elements. Query (QRY) <code>QRY|STATUS</code>, <code>QRY|LOG &lt;seq&gt;</code> Health checks, recovery after power loss or crashes, and audit lookups. Reports (RPT) <code>RPT|Z</code>, <code>RPT|X</code>, <code>RPT|A</code> Z (daily closure), X (periodic snapshot), and A (article-level) reports generated in-device. Admin (ADM) <code>ADM|DUMPLOG</code>, <code>ADM|RESET</code> Exporting the hash\u2011chained journal and resetting counters under DGI authorization. Configuration (CFG) <code>CFG|TIME</code>, <code>CFG|INIT</code> Clock synchronization, device activation, and key provisioning."},{"location":"hardware/protocol/#canonical-payload-checklist","title":"Canonical payload checklist","text":"<p>Every <code>TXN|PREPARE</code> payload must follow the order in the protocol specification (<code>spec/protocol-usb-fiscal-device-1.md</code>). Include:</p> <ul> <li>Merchant metadata (<code>merchant_nif</code>, outlet/terminal/cashier IDs, invoice type).</li> <li>ISO 8601 timestamp that matches the device RTC.</li> <li>Client + classification block (Individual, Company, Commercial Individual, Professional, Embassy).</li> <li>Item list with code/description, quantity, unit price, and tax group.</li> <li>Tax group breakdown (code, rate, base, amount) for all 14 DGI tax groups.</li> <li>Totals object (<code>subtotal</code>, <code>total_vat</code>, <code>total</code>, <code>currency</code>).</li> <li>Payments array describing each instrument/method.</li> </ul> <p>Duplicating this order guarantees deterministic hashes and keeps signatures reproducible per Section 5.2 of the DISCUSSION document.</p>"},{"location":"hardware/protocol/#sequence-diagrams","title":"Sequence diagrams","text":""},{"location":"hardware/protocol/#happy-path-prepare-commit","title":"Happy path (PREPARE \u2192 COMMIT)","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE + canonical invoice\n    FiscalService-&gt;&gt;Device: PREPARE payload\n    Device--&gt;&gt;FiscalService: nonce + \"ready to commit\"\n    FiscalService-&gt;&gt;Device: TXN|COMMIT { \"nonce\": \"\u2026\" }\n    Device--&gt;&gt;FiscalService: fiscal response (invoice_seq, auth_code, QR)\n    FiscalService--&gt;&gt;POS: Receipt data + security elements</code></pre>"},{"location":"hardware/protocol/#error-path-schema-or-policy-violations","title":"Error path (schema or policy violations)","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE (malformed payload)\n    FiscalService-&gt;&gt;Device: PREPARE\n    Device--&gt;&gt;FiscalService: ERR SCHEMA_INVALID\n    FiscalService--&gt;&gt;POS: Alert cashier; show resolver UI\n    POS-&gt;&gt;FiscalService: TXN|PREPARE (canon payload retried)</code></pre>"},{"location":"hardware/protocol/#power-loss-recovery","title":"Power-loss recovery","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE\n    FiscalService-&gt;&gt;Device: PREPARE\n    Device--&gt;&gt;FiscalService: nonce\n    FiscalService-&gt;&gt;Device: TXN|COMMIT\n    Device---x Device: power loss during COMMIT\n    POS-&gt;&gt;FiscalService: QRY|STATUS\n    FiscalService-&gt;&gt;Device: STATUS\n    Device--&gt;&gt;FiscalService: next_invoice_seq still 105\n    FiscalService-&gt;&gt;Device: QRY|LOG 105\n    Device--&gt;&gt;FiscalService: log_entry (or \"not found\")</code></pre>"},{"location":"hardware/protocol/#failure-handling-and-rules","title":"Failure handling and rules","text":"<p>Nonces must never be reused</p> <p>Per ADR-0001, every COMMIT must carry the nonce issued by PREPARE. An invalid nonce yields <code>INVALID_NONCE</code> and a nonce that outlives its TTL yields <code>NONCE_EXPIRED</code>. The POS must restart the invoice flow (i.e., send a new <code>TXN|PREPARE</code> with the same canonical payload) rather than trying to reuse the old nonce.</p> <p>Device errors (<code>SCHEMA_INVALID</code>, <code>STORAGE_FULL</code>, <code>CLOCK_ROLLBACK_DETECTED</code>, <code>DEVICE_REVOKED</code>) always return <code>status: \"ERR\"</code> with a <code>code</code> field. The POS displays contextual guidance and only retries when the error signal indicates a temporary condition (<code>DEVICE_BUSY</code>, <code>STORAGE_FULL</code> after freeing space, <code>SCHEMA_INVALID</code> after user correction).</p> <p>No un-fiscalized receipt</p> <p>If the POS loses the fiscal response (COMMIT success but crash before printing), it must recover by querying <code>QRY|LOG &lt;seq&gt;</code> and reprint the missing ticket. Printing without a fiscal response violates the DRC mandate and is detectable by auditors (see ADR-0001, Section 5).</p>"},{"location":"hardware/protocol/#additional-resources","title":"Additional resources","text":"<ul> <li>Protocol specification \u2014 <code>spec/protocol-usb-fiscal-device-1.md</code> (project root)</li> <li>ADR-0001: Two-phase commit</li> </ul>"},{"location":"hardware/secure-element/","title":"Secure Element","text":"<p>The Secure Element embedded within the USB Fiscal Memory device is the heart of the trust boundary.  It is the only component that knows the private key used to sign invoices, the monotonic counters that enforce sequencing, and the tamper sensors that prove the device cannot be manipulated.  All other software (POS, fiscal service, cloud) is explicitly untrusted and only interacts with the SE through the USB protocol defined in <code>spec/protocol-usb-fiscal-device-1.md</code>.</p> <p>This page documents the Secure Element's key management and signature algorithm policies for the DRC-compliant invoice flow.</p>"},{"location":"hardware/secure-element/#security-review-takeaways","title":"Security review takeaways","text":"<p>Key lifecycle review</p> <p>The security review confirmed that keys must be generated on-device rather than injected from the cloud.  Each Secure Element derives its private key during the <code>CFG|INIT</code> activation handshake, using the DGI-provided activation code only to bind the new key to a known device ID.  No private key material ever leaves the sealed chip, preventing remote cloning even if the host is compromised.</p> <p>Signature algorithm review</p> <p>The review also evaluated ECDSA P-256 vs Ed25519 for this constrained MCU.  ECDSA P-256 won because the selected secure element family (e.g., ATECC608B/SE050) already accelerates P-256, and DGI inspectors expect a curve that matches existing fiscal certs.  We treat Ed25519 as a future-proof option, but we will not ship it until the tax authority and hardware vendor certify the curve.  This signature algorithm decision is our current baseline, and any future curve must demonstrate vendor support and regulatory approval before adoption.</p>"},{"location":"hardware/secure-element/#key-management-lifecycle","title":"Key management lifecycle","text":"<ol> <li>Activation. During provisioning, the POS/fiscal service issues <code>CFG|INIT</code> with the DGI-signed activation payload and the desired <code>device_id</code>.  The Secure Element uses that payload only to seed its internal RNG and bind the generated key pair to the fiscal identity.</li> <li>Counter binding. The monotonic counter resides inside the SE and increments with every <code>TXN|COMMIT</code>.  The counter value is signed along with the invoice hash so auditors can prove no numbers were skipped.</li> <li>Certificate chain. The SE exposes a public certificate that the cloud or DGI can verify; the private key never leaves the device.  A simple challenge-response during <code>QRY|STATUS</code> can prove the device still holds the key.</li> </ol> <p>Private key backup is explicitly forbidden.  If the Secure Element is destroyed, the outlet must receive a new device and restart the activation flow.  That policy is enforced by the SE rejecting any attempt to export the key or copy it to another unit.</p>"},{"location":"hardware/secure-element/#anti-cloning-and-tamper-resistance","title":"Anti-cloning and tamper resistance","text":"<p>The Secure Element arrives in a sealed USB-C, cable-only form factor with no exposed buttons or screens (DISCUSSION.md lines 7343\u20117353).  Its packaging, potting compound, and fuses guard against physical tampering:</p> <ul> <li>Tamper mesh and light sensors detect when the lid is opened and immediately zeroize volatile secrets.</li> <li>The SE enforces voltage and clock checks; deviations trigger a lockdown that stops signing until power returns.</li> <li>The MCU only sees abstracted SE responses; it cannot read or write private key material, so even compromised firmware cannot clone the device.</li> </ul> <p>Hardware vs software boundary</p> <p>Software responsibilities (UI, syncing, printing, catalog) live outside the sealed box described in the architecture spec.  The Secure Element alone performs invoice issuance, signing, counter management, timestamps, and immutable storage.</p>"},{"location":"hardware/secure-element/#monotonic-counters-immutable-signing","title":"Monotonic counters &amp; immutable signing","text":"<p>Every invoice hash that arrives via <code>TXN|PREPARE</code> is hashed again inside the MCU, then passed to the SE along with the current counter value.  The SE enforces a strict PREPARE \u2192 COMMIT cycle:</p> <ul> <li>PREPARE validates schema and nonce without touching the counter.</li> <li>COMMIT increments the counter, appends the entry to the hash-chained journal stored in flash, signs the entry with the private key, and returns the fiscal response (fiscal number, auth code, timestamp, QR).</li> </ul> <p>The journal entry links to the previous record via <code>prev_hash</code> so auditors can traverse the chain.  Counter increments happen inside the SE, so the host cannot skip any numbers even if it replays COMMIT after power loss.</p>"},{"location":"hardware/secure-element/#signing-flow","title":"Signing flow","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant MCU\n    participant SecureElement as SE\n\n    POS-&gt;&gt;MCU: Send canonical JSON + nonce\n    MCU-&gt;&gt;SE: Hash payload + counter (PREPARE)\n    SE--&gt;&gt;MCU: Nonce approval (no counter change)\n    POS-&gt;&gt;MCU: Request COMMIT with nonce\n    MCU-&gt;&gt;SE: Provide nonce, trigger counter increment\n    SE-&gt;&gt;SE: Increment counter, sign hash, store journal entry\n    SE--&gt;&gt;MCU: Signature + counter + timestamp + QR\n    MCU-&gt;&gt;POS: Fiscal response (fiscal number, auth code, timestamp)</code></pre> <p>The diagram captures the in-device hash-and-sign cycle: the MCU hashes the canonical payload and forwards it to the SE, the SE increments the counter, signs the entry, and streams the signed response back for printing and syncing.</p>"},{"location":"hardware/secure-element/#recovery-and-policy","title":"Recovery and policy","text":"<ul> <li>Clock protection: The SE requires signed <code>CFG|TIME</code> updates so the RTC cannot roll backward; any rollback attempt rejects new commits.</li> <li>No backup: Private keys and counters never leave the SE; the only recovery is device replacement and reactivation.</li> <li>Nonce governance: Nonces expire quickly (7 seconds in the protocol spec) to thwart replay; failed PREPARE/COMMIT pairs force a new nonce request.</li> </ul> <p>Key backup policy</p> <p>Backing up the Secure Element private key is disallowed.  Attempting to clone, dump, or export the key will cause the SE to lock and refuse new URIs until reinitialized via <code>CFG|INIT</code>.</p>"},{"location":"hardware/usb-device/","title":"USB Fiscal Memory Device","text":"<p>Bono Pay's USB Fiscal Memory device is the trusted anchor of the fiscal compliance stack. It sits inside the trust boundary, listens to canonical payloads from the untrusted POS, and emits sealed fiscal responses that the POS prints and the cloud eventually uploads to the DGI. Every fiscalized invoice flows through this hardware so it alone controls counters, timestamps, signatures, and the immutable journal.</p> <p>Trusted boundary</p> <p>Only the USB Fiscal Memory device may increment counters, sign journals, or emit authentication codes. The POS and cloud may prepare payloads and relay responses, but they must never forge or cache these sensitive elements.</p>"},{"location":"hardware/usb-device/#purpose-and-form-factor","title":"Purpose and Form Factor","text":"<p>The device is a compact, matte-black module roughly the size of a key fob, with a single USB-C female port on one end and a removable cable that lets merchants plug into phones, tablets, or PCs without stressing the enclosure. A subtle lock icon and a recessed blue LED speak to its security-focused purpose while staying unobtrusive in retail or mobile scenarios. Its sealed housing resists dust, drops, and the tropical heat common in the DRC, and the detachable cable lets the wiring absorb flex while the module stays solid.</p>"},{"location":"hardware/usb-device/#indicators-and-tamper-responses","title":"Indicators and Tamper Responses","text":"<p>A single blue LED communicates operational states: steady when ready, blinking during PREPARE/COMMIT exchanges, amber when storage is nearing capacity, and red when a tamper or fatal error is detected. Internal tamper detection (e.g., magnetic switches or tamper-evident seals) forces the firmware into a safe state, alerts the POS with an error code, and refuses to fiscalize until servicing restores integrity. The LED and tamper logic keep the device from silently issuing invoices under suspicious conditions.</p>"},{"location":"hardware/usb-device/#environmental-hardening","title":"Environmental Hardening","text":"<p>The hardware is designed for dusty marketplaces, humid kiosks, and unreliable power. It runs inside an industrial-grade plastic or aluminum shell, protects electronics with potting or conformal coatings, and uses power-conditioning circuitry so brief surges do not corrupt the flash journal. Firmware guards against clock rollback by refusing to issue new entries until the onboard RTC (backed by a coin-cell or supercap) shows steady progression, and the flash storage is kept transactional so brownouts either complete or roll back cleanly.</p>"},{"location":"hardware/usb-device/#functional-responsibilities","title":"Functional Responsibilities","text":"<ul> <li>Maintain monotonic counters for every invoice type (sales, advances, credit notes, exports). The counter cannot decrement, roll back, or skip numbers, and it powers the sequential fiscal number printed on receipts.</li> <li>Log every fiscal event in flash with hash chaining so auditors can prove immutability even when the POS is offline. The log contains invoice metadata, tax breakdowns, and references to the prior entry so tampering is detectable.</li> <li>Apply trusted timestamps using the onboard RTC and cross-checks, ensuring each invoice record carries a chronological time even if the POS clock is manipulated.</li> <li>Generate cryptographic authentication codes by hashing invoice details (canonical payload) and signing them inside the secure element (ATECC608/SE050). The resulting code is returned to the POS, printed, and embedded in the QR.</li> <li>Store sealed responses until the POS confirms and prints a receipt. Responses include device ID, fiscal number, auth code, and status so the merchant never prints without a fiscalized invoice.</li> <li>Produce reports (Z, X, A, audit export) directly from the secure journal, exporting daily closures or article-level detail on demand without involving the POS.</li> <li>Operate offline without cloud or DGI connectivity, continuing PREPARE \u2192 COMMIT flows and buffering audit data for later sync. It only refuses invoices when flash is full, tamper is detected, or policy forbids issuance (e.g., clock rollback).</li> <li>Emit failure states through error codes and the LED so the POS can notify cashiers and halt fiscalization rather than issuing non-compliant receipts.</li> </ul>"},{"location":"hardware/usb-device/#internal-architecture-block-diagram","title":"Internal Architecture Block Diagram","text":"<pre><code>graph LR\n    MCU([MCU &lt;br&gt;STM32L4 / Cortex-M4])\n    SE([Secure Element &lt;br&gt;ATECC608B / SE050])\n    Flash([Flash Storage])\n    RTC([RTC / Battery-backed])\n    USB([USB-C Connector])\n    MCU &lt;--&gt; SE\n    SE &lt;--&gt; Flash\n    Flash &lt;--&gt; RTC\n    RTC &lt;--&gt; USB\n    MCU --&gt; USB</code></pre> <p>The MCU orchestrates the PREPARE/COMMIT handshake, drives the LED/tamper GPIOs, and hands sensitive signing operations to the secure element. Flash preserves the hash-chained journal, the RTC anchors time, and the USB-C connector exposes the transactional USB CDC interface to the fiscal service mediator. All firmware paths route through this chain so the device remains a single source of truth.</p>"},{"location":"hardware/usb-device/#operations-reports","title":"Operations &amp; Reports","text":"<p>The DEF reports Z (daily closure), X (periodic/session summary), A (per-article detail), and audit exports straight from the hash-chained log, ensuring every report entry shares the same security elements as invoices. During power losses or timeouts, the PREPARE/COMMIT exchange either completes or rolls back, preventing phantom invoices. Error codes like \"memory full\" or \"tamper\" are surfaced to the POS, which halts further fiscalization and displays the LED state until maintenance resolves the issue. Because the device keeps a unique DEF ID (DEF NID) in every record, auditors can trace each invoice back to the precise hardware unit even when multiple POS terminals share the same device.</p>"},{"location":"hardware/usb-device/#bom-manufacturing","title":"BOM &amp; Manufacturing","text":"<p>Target COGS stays within the $10\u201315 range by relying on commodity yet certified components and a minimalist enclosure. The table below captures the high-level parts list and their purpose:</p> Component Example Part Description Unit Cost (USD) Notes Secure MCU STM32L4 / NXP Kinetis Controls the PREPARE/COMMIT flow, orchestrates peripherals, and runs watchdog-backed firmware 3.00\u20135.00 ARM Cortex-M4/M33 with crypto accelerators Secure Element ATECC608B / SE050 Stores private keys, performs ECDSA (or EdDSA) signing, enforces tamper/protection policies 1.00\u20132.00 Certified for FIPS/CC; no private key leaks Flash Storage SPI NOR Flash (4\u201316 MB) Hash-chained journal, report logs, firmware rollback 0.50\u20131.50 Fast writes with transactional support RTC DS3231 / integrated RTC Trusted timestamp source with battery/supercap backup 0.50\u20130.75 Prevents time rollback abuse USB Interface USB-C connector, power conditioning 10 Gbps-capable port with ESD protection and surge filtering 0.50\u20131.00 Provides the only external I/O Indicators &amp; Sensors LED + tamper switch Single status LED plus tamper detection switches/magnets 0.25\u20130.40 LED shows ready/error states; tamper forces safe mode Mechanical &amp; PCB 4-layer PCB, enclosure, detachable cable Rugged board and housing with molded USB-C cable (or reinforced jack) 2.00\u20133.00 Includes EMI shielding, conformal coat, tooling Misc. Assembly, calibration Factory assembly, security laser etching, verification 0.50\u20131.00 Includes serialization of DEF NID <p>Total COGS targets $10\u201315 per unit while still supporting audit-grade hardware and tamper detection.</p>"},{"location":"hardware/usb-device/#comparative-positioning","title":"Comparative Positioning","text":"<p>Compared to Italian fiscal memories and other African Electronic Fiscal Devices (EFDs), the Bono Pay DEF matches the same sequential counters, Z/X/A reports, and tamper-proof journal but adds a detachable USB-C cable that suits modern tablets and mobile cashiers. Against crypto-focused hardware wallets, it borrows their secure element model (isolating private keys, enforcing monotonic counters) while extending it with a dedicated invoice journal, RTC, and DGI-friendly reporting. These similarities keep certification straightforward while differentiating Bono Pay through its tight integration with the offline-first POS, local fiscal service mediator, and DGI sync pipeline.</p>"},{"location":"implementation/phase-1/","title":"Phase 1 \u2014 B2B Pilot","text":"<p>The B2B pilot proves that the architecture described in <code>spec/architecture-kutapay-system-1.md</code> can deliver sealed invoices, security elements, and regulatory reports without changing existing POS workflows. This 3\u2011month sprint targets 10 pilot clients (service companies, wholesalers, schools) using a single-terminal POS/fiscal-service combo with manual DGI submissions while the USB Fiscal Memory device executes the canonical PREPARE \u2192 COMMIT handshake.</p>"},{"location":"implementation/phase-1/#pilot-targets","title":"Pilot targets","text":"<ul> <li>Duration: 3 months (March through May 2026) to align with the roadmap\u2019s Phase 1 Gantt lane.</li> <li>Clients: 10 pilot partners representing service businesses, wholesalers, and schools who need invoice sealing, trust-boundary enforcement, and offline resilience.</li> <li>Scope: Single-terminal POS + fiscal service + USB device per outlet, manual DGI upload (CSV/audit export) while the cloud queue matures, and foundational reporting (Z, X, A).</li> </ul>"},{"location":"implementation/phase-1/#epics","title":"Epics","text":"<ol> <li>USB Firmware MVP (PREPARE / COMMIT + immutable journal + Z report)</li> <li>Description: Ship USB Fiscal Memory firmware that validates the canonical JSON payload (deterministic field order, tax groups, client classification) on PREPARE/COMMIT, atomically increments the monotonic counter, signs the record, and stores it in the hash-chained journal described in <code>spec/protocol-usb-fiscal-device-1.md</code>.</li> <li>Acceptance criteria:<ul> <li>PREPARE validates schema, taxonomy, and replay status, returning a nonce while leaving counters untouched.</li> <li>COMMIT increments the fiscal number, produces the device ID/auth code/timestamp/QR, appends to the hash chain, and surfaces those security elements back to the POS.</li> <li>Firmware can generate a Z report that contains sequence ranges, per-tax-group totals, and journal hashes per <code>spec/process-fiscal-reports-1.md</code>.</li> </ul> </li> <li>Estimated effort: 4 weeks of firmware development plus 1 week of hardware-in-the-loop testing.</li> <li> <p>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>design/docs/hardware/usb-device.md</code>, <code>design/docs/fiscal/reports.md</code>.</p> </li> <li> <p>Fiscal Service Library (canonical serializer + device proxy + tax engine)</p> </li> <li>Description: Build the untrusted fiscal service that mediates between the POS and the USB device, serializes canonical invoices, enforces the 14 DGI tax groups in <code>spec/schema-tax-engine-1.md</code>, and brokers multi-terminal access to the device.</li> <li>Acceptance criteria:<ul> <li>Canonical invoices include outlet/terminal/cashier IDs, client classification, tax_groups[], totals, and payment instruments in deterministic order before issuing TXN|PREPARE.</li> <li>Tax engine calculates TG01\u2013TG14 amounts, applies client classification rules (individual, company, commercial individual, professional, embassy), and records rounding deltas per <code>spec/schema-tax-engine-1.md</code>.</li> <li>Fiscal service serializes responses from QRY/TXN commands, logs nonce lifetimes, retries failed PREPAREs/COMMITs, and surfaces device health (QRY|STATUS) to the POS UI.</li> </ul> </li> <li>Estimated effort: 3 weeks for canonical service + 1 week for tax engine integration.</li> <li> <p>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/schema-tax-engine-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>design/docs/architecture/trust-boundary.md</code>, <code>design/docs/pos/multi-terminal.md</code>.</p> </li> <li> <p>POS MVP (sale entry, receipt generation, tax-aware catalog)</p> </li> <li>Description: Deliver a single-terminal POS workflow that lets cashiers prepare invoices, prints receipts with the device-provided security elements, and shows offline/nonce status per <code>.github/copilot-instructions.md</code> UX guidance.</li> <li>Acceptance criteria:<ul> <li>Sale flow (add items, select tax groups, choose payment method) completes fiscalization in under 5 seconds and prints receipt only after COMMIT returns fiscal number, auth code, timestamp, and QR.</li> <li>Receipt includes fiscal number, device ID, signature/auth code, trusted timestamp, QR, and references to the canonical payload (items, tax breakdown) so auditors can reconcile.</li> <li>UI exposes offline indicators, device-disconnect recovery, and nonce exhaustion warnings, keeping cashiers informed while the device enforces the trust boundary.</li> </ul> </li> <li>Estimated effort: 3 weeks to build sale entry + 1 week to polish receipt/UX messaging.</li> <li> <p>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>design/docs/fiscal/security-elements.md</code>, <code>docs/odoo-pos-lessons-for-kutapay.md</code>, <code>design/docs/pos/ui-ux.md</code>.</p> </li> <li> <p>Manual compliance tooling (CSV export + audit dump)</p> </li> <li>Description: Provide the compliance belt that lets pilot clients deliver mandated outputs to the DGI before automated cloud uploads arrive: CSV exports for sealed invoices, Z/X/A reports, and audit dumps derived from the hash-chained journal.</li> <li>Acceptance criteria:<ul> <li>Generate a DGI-ready CSV containing the canonical invoice metadata, fiscal number, auth code, totals, and per-tax-group amounts.</li> <li>Produce Z/X/A reports plus an audit export (streamed chunk) as described in <code>spec/process-fiscal-reports-1.md</code>, with counters, journal hashes, and security elements intact.</li> <li>Surface explicit instructions for manual upload to the DGI control module (via email or portal) and track evidence of submission in the pilot logs.</li> </ul> </li> <li>Estimated effort: 2 weeks to implement exports + 1 week for documentation/guidance.</li> <li> <p>Dependencies: <code>spec/process-fiscal-reports-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>docs/sfe-specifications-v1-summary.md</code>, <code>design/docs/cloud/dgi-integration.md</code> (for future automation notes).</p> </li> <li> <p>Testing &amp; homologation prep (pilot onboarding + risk mitigation)</p> </li> <li>Description: Validate the pilot with 10 clients, automate regression scripts for offline resilience, and prepare evidence for homologation reviews (DGI, auditors).</li> <li>Acceptance criteria:<ul> <li>Onboard at least 10 service/wholesale/school partners, run fiscalization in offline (48\u201372 h queue) and synchronous scenarios, and collect logs demonstrating canonical payload integrity, nonce handling, and retries.</li> <li>Document failure modes (power loss during COMMIT, cable disconnects, nonce expiration) and verify the firmware/service recovers without incrementing counters or producing duplicates.</li> <li>Demonstrate DGI compliance by submitting the CSV/Z/X/A/audit exports, logging reviewer feedback, and flagging open questions (e.g., unknown MCF endpoint or signature algorithm) with <code>???</code> admonitions in the compliance notebook.</li> </ul> </li> <li>Estimated effort: 4 weeks of field testing combined with 1 week for homologation paperwork.</li> <li>Dependencies: <code>spec/infrastructure-dgi-integration-1.md</code>, <code>design/docs/cloud/offline-sync.md</code>, <code>design/docs/implementation/roadmap.md</code>, <code>memory-bank/context-map.md</code>.</li> </ol>"},{"location":"implementation/phase-2/","title":"Phase 2 \u2014 Retail &amp; Restaurants","text":"<p>Phase 1 proved that the PREPARE \u2192 COMMIT handshake, hash-chained journal, and manual compliance tooling can keep a small B2B pilot honest. Phase 2 now scales the platform to the retail and restaurant segments that demand multi-terminal coverage, full cloud sync, automatic DGI uploads, and real-time reporting while serving 100 pilot clients over 3 months (June\u2013August 2026).</p>"},{"location":"implementation/phase-2/#objectives","title":"Objectives","text":"<ul> <li>Target: onboard 100 retail/restaurant outlets (10-lane retail counters, mobile waiter stacks, and fast-service kiosks) without sacrificing the Phase 1 trust boundary.</li> <li>Duration: 3-month sprint with milestones each month for multi-terminal orchestration, cloud automation, and report automation.</li> <li>New capabilities: multi-terminal mediator, resilient cloud sync, automatic DGI uploads, complete Z/X/A/audit report pipeline, mobile waiter UX, and observability/alerting for the larger fleet.</li> <li>Reference artifacts: <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>spec/design-cloud-api-1.md</code>, <code>spec/infrastructure-dgi-integration-1.md</code>, <code>spec/process-fiscal-reports-1.md</code>, <code>spec/schema-tax-engine-1.md</code>, and the Phase 1 roadmap (<code>design/docs/implementation/phase-1.md</code>).</li> </ul>"},{"location":"implementation/phase-2/#epics","title":"Epics","text":"<ol> <li>Multi-terminal orchestration &amp; fiscal service hardening</li> <li>Description: Extend the fiscal service mediator so many POS terminals per outlet share one DEF without racing fiscal numbers. Honor the ordered canonical payload from <code>spec/architecture-kutapay-system-1.md</code>/<code>spec/protocol-usb-fiscal-device-1.md</code>, keep outlet/POS/cashier IDs intact, and serialize PREPARE/COMMIT calls to avoid nonce conflicts.</li> <li>Acceptance criteria:<ul> <li>Local fiscal mediator sequences requests from every terminal and exposes explicit wait states when the DEF is busy.</li> <li>Each payload carries outlet_id, pos_terminal_id, cashier_id, and client classification (per <code>spec/schema-tax-engine-1.md</code>) so the USB device enforces the trust boundary.</li> <li>Concurrency guards (mutex/queue) prevent duplicate fiscal numbers while logging who owns the next nonce.</li> </ul> </li> <li>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>design/docs/pos/multi-terminal.md</code>, <code>design/docs/architecture/trust-boundary.md</code>.</li> <li> <p>Estimate: 3 weeks to refactor the mediator and 1 week for multi-terminal QA.</p> </li> <li> <p>Cloud sync automation &amp; DGI upload pipeline</p> </li> <li>Description: Automate the offline queue, retries, and eventual upload to the DGI control modules via the cloud API described in <code>spec/design-cloud-api-1.md</code> while acknowledging the unknowns captured in <code>spec/infrastructure-dgi-integration-1.md</code>. The sync agent must surface <code>retry_after</code>, DGI status, and queue depth without leaking secrets or violating the trust boundary.</li> <li>Acceptance criteria:<ul> <li>Sealed invoices are queued and retried automatically, honoring the sync state machine from <code>design/docs/cloud/offline-sync.md</code>.</li> <li>Automatic uploads include headers (<code>X-KUTAPAY-DEVICE-ID</code>, <code>X-KUTAPAY-NONCE</code>) and canonical payload order so the DGI receives precise security elements.</li> <li>Sync dashboard exposes backlog, oldest queued invoice, and next retry timestamp so operators know when to intervene.</li> </ul> </li> <li>Dependencies: <code>spec/design-cloud-api-1.md</code>, <code>spec/infrastructure-dgi-integration-1.md</code>, <code>design/docs/cloud/offline-sync.md</code>, <code>design/docs/cloud/dgi-integration.md</code>.</li> <li> <p>Estimate: 4 weeks for cloud agent automation plus 1 week for ops dashboards and handoffs.</p> </li> <li> <p>Report automation &amp; audit readiness</p> </li> <li>Description: Build the full suite of Z, X, A, and audit exports from <code>spec/process-fiscal-reports-1.md</code>, ship them through both device and cloud pipelines, and integrate them with the larger fleet so auditors never wait.</li> <li>Acceptance criteria:<ul> <li>Z reports close each retail shift with per-tax-group totals, journal hashes, and device security elements.</li> <li>X reports can be triggered manually or on a schedule (e.g., hourly) with device health metadata.</li> <li>A reports stream article-level detail plus client classification/line references.</li> <li>Audit exports deliver hash-chained chunks (with prev_hash/signature) to satisfy DGI spot checks.</li> </ul> </li> <li>Dependencies: <code>spec/process-fiscal-reports-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>design/docs/fiscal/reports.md</code>, <code>design/docs/cloud/dgi-integration.md</code>.</li> <li> <p>Estimate: 2 weeks to implement report generators and 1 week for integration and automation.</p> </li> <li> <p>Mobile waiter &amp; POS UX resilience</p> </li> <li>Description: Adapt the POS UX to support roaming waitstaff, portable terminals, and rapid checkout while surfacing offline helpers and device status per <code>.github/copilot-instructions.md</code> UX guidance and the existing <code>design/docs/pos/ui-ux.md</code>.</li> <li>Acceptance criteria:<ul> <li>Mobile waiters can pair/disconnect safely, view nonce/connection status, and retry COMMITs without duplicating invoices.</li> <li>Receipt templates keep the device-issued fiscal number, auth code, timestamp, and QR visible so inspectors can verify every transaction.</li> <li>POS UI clearly alarms when the multi-terminal mediator is busy, the DEF is offline, or canonical payload validation fails.</li> </ul> </li> <li>Dependencies: <code>design/docs/pos/ui-ux.md</code>, <code>design/docs/pos/multi-terminal.md</code>, <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/schema-tax-engine-1.md</code>.</li> <li> <p>Estimate: 2 weeks for UI changes plus 1 week of usability testing with pilots.</p> </li> <li> <p>Observability, onboarding, and fleet operations</p> </li> <li>Description: Prepare for 100 outlets by instrumenting device health, sync queues, and report generation telemetry; publish onboarding playbooks (install steps, DGI manual uploads) for retail staff.</li> <li>Acceptance criteria:<ul> <li>Dashboards combine cloud API status (<code>/sync/status</code>, <code>/devices/{device_id}/health</code>) with DEF reports/queues so engineers can spot blocked uploads.</li> <li>Onboarding docs walk merchant teams through pairing the DEF, configuring tax groups, and verifying the trust boundary before going live.</li> <li>Alerts cover dropped connections, nonce exhaustion, failed uploads, and missing security elements so operations can react before regulators notice.</li> </ul> </li> <li>Dependencies: <code>spec/design-cloud-api-1.md</code>, <code>spec/process-fiscal-reports-1.md</code>, <code>design/docs/cloud/architecture.md</code>, <code>design/docs/implementation/roadmap.md</code>.</li> <li>Estimate: 2 weeks for dashboards/playbooks plus 1 week for training pilots.</li> </ol>"},{"location":"implementation/phase-3/","title":"Phase 3 \u2014 Enterprise","text":"<p>Phase 3 expands the Bono Pay platform beyond the pilot and retail deployments by preparing for a 6\u2011month enterprise launch where 1,000+ outlets (multi-branch retailers, logistics fleets, franchise networks) rely on our fiscal stack for compliance, analytics, and interoperability. The work inherits everything from Phases 1 and 2 (PREPARE \u2192 COMMIT trust boundary, multi-terminal orchestration, offline sync, cloud automation, and compliance tooling) and adds enterprise-grade integration, fleet/dashboards, and analytics so large customers can connect ERPs, consume webhooks, and manage thousands of devices without violating the trust boundary.</p>"},{"location":"implementation/phase-3/#objectives","title":"Objectives","text":"<ul> <li>Scope: Extend Phase 1+2 deliverables to support distributed enterprise fleets with ERP connectors, webhook API, fleet management controls, multi-branch dashboards, and advanced analytics.</li> <li>Target: 1,000+ merchant locations spread across multiple branches or regions, synchronized via the cloud sync agent and dashboard, where every invoice still carries the hardware-generated fiscal number, security hashes, and report outputs.</li> <li>Duration: 6 months (September 2026 through February 2027) with monthly milestones for integrations, fleet roll\u2011outs, analytics, compliance automation, and resilience/observability improvements.</li> <li>Reference artifacts: <code>spec/architecture-kutapay-system-1.md</code>, <code>spec/design-cloud-api-1.md</code>, <code>spec/design-pos-plugin-api-1.md</code>, <code>spec/process-fiscal-reports-1.md</code>, <code>spec/schema-tax-engine-1.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>design/docs/cloud/architecture.md</code>, <code>design/docs/cloud/offline-sync.md</code>, <code>design/docs/pos/integrations.md</code>, <code>design/docs/fiscal/reports.md</code>, <code>design/docs/pos/multi-terminal.md</code>.</li> </ul>"},{"location":"implementation/phase-3/#epics","title":"Epics","text":"<ol> <li>Enterprise integration fabric (ERP connectors + webhook API)</li> <li>Description: Build a catalog of ERP connectors and a webhook-based API layer so enterprise finance teams can automatically pull sealed invoices, reconcile fiscal reports, and integrate with core ERP workflows while honoring the trust boundary.</li> <li>Acceptance criteria:<ul> <li>ERP connectors for at least two platforms (e.g., SAP S/4HANA and Odoo) that ingest sealed invoices, map TG01\u2013TG14 tax groups, and push acknowledgement receipts back to the fiscal service.</li> <li>A webhook API that streams fiscal events (invoice sealed, report generated, sync failure) to customer endpoints using signed payloads that mirror <code>spec/design-cloud-api-1.md</code>.</li> <li>Connectors and webhooks expose canonical metadata (fiscal number, device ID, branch ID, reporting hashes) so CFOs can reconcile with their ERP-ledgers.</li> </ul> </li> <li>Dependencies: <code>design/docs/pos/integrations.md</code>, <code>spec/design-pos-plugin-api-1.md</code>, <code>spec/design-cloud-api-1.md</code>, <code>kutapay_technical_design.md</code> integration priorities, <code>.github/copilot-instructions.md</code> (security/integration guidance).</li> <li> <p>Estimated effort: 5 weeks to build connectors + 2 weeks to instrument webhook delivery, retries, and documentation.</p> </li> <li> <p>Multi-branch fleet management &amp; dashboard</p> </li> <li>Description: Enable Bono Pay Cloud to operate and monitor thousands of outlets: device registration, fleet-wide health, configuration drift alerts, and short/long-lived dashboard views (per-branch + consolidated).</li> <li>Acceptance criteria:<ul> <li>Dashboard surfaces device health (from <code>/devices/{device_id}/health</code>), queue depth, pending DGI uploads, and branch-level sync status with drilldowns to multi-terminal POS IDs.</li> <li>Fleet management workflow for onboarding/replacing a DEF per outlet, including revoke/regenerate flows tied to <code>spec/protocol-usb-fiscal-device-1.md</code> and <code>spec/design-cloud-api-1.md</code>.</li> <li>Integration with the offline sync state machine (<code>design/docs/cloud/offline-sync.md</code>) so operators know when uploads are pending and can trigger retries per branch.</li> </ul> </li> <li>Dependencies: <code>design/docs/cloud/architecture.md</code>, <code>design/docs/cloud/offline-sync.md</code>, <code>spec/design-cloud-api-1.md</code>, <code>spec/infrastructure-dgi-integration-1.md</code>, <code>design/docs/implementation/roadmap.md</code>, <code>memory-bank/context-map.md</code>.</li> <li> <p>Estimated effort: 4 weeks to implement dashboard/front-end + 2 weeks for fleet automation and playbooks.</p> </li> <li> <p>Advanced analytics &amp; compliance reporting at scale</p> </li> <li>Description: Offer advanced analytics (branch trends, tax-group heatmaps, anomaly detection) built on the immutable journal plus automation for Z/X/A/audit exports so auditors can trust the data without manual requests.</li> <li>Acceptance criteria:<ul> <li>Analytics feeds derived from <code>spec/process-fiscal-reports-1.md</code> that highlight branch-level totals per TG01\u2013TG14, differences between manual and automated exports, and queue aging.</li> <li>Automated report publication hooks that push Z/X/A exports and audit chunks to DGI channels with notification webhooks and retention policies.</li> <li>Tax engine validation (per <code>spec/schema-tax-engine-1.md</code>) ensures analytics respect client classification rules, rounding, and manifest versions.</li> </ul> </li> <li>Dependencies: <code>spec/process-fiscal-reports-1.md</code>, <code>design/docs/fiscal/reports.md</code>, <code>spec/schema-tax-engine-1.md</code>, <code>design/docs/cloud/dgi-integration.md</code>.</li> <li> <p>Estimated effort: 3 weeks for analytics pipelines + 2 weeks for report automation and audit exports.</p> </li> <li> <p>Enterprise-grade resiliency &amp; trust boundary compliance</p> </li> <li>Description: Harden the firmware/service stack and guidance so the expanded fleet never loosens the trust boundary (no new paths for the POS to write fiscal numbers or tamper with journals) while delivering enterprise SLAs.</li> <li>Acceptance criteria:<ul> <li>Firmware/service automation that enforces PREPARE/COMMIT (per <code>spec/protocol-usb-fiscal-device-1.md</code>) even under network partitions or rollback scenarios, plus documented recovery instructions.</li> <li>Enterprise incident runbooks covering power/fiber outages, nonce exhaustion, and multi-terminal collisions, referencing <code>design/docs/hardware/secure-element.md</code> and <code>design/docs/architecture/trust-boundary.md</code>.</li> <li>Monitoring &amp; alerts for audit log integrity (hash chains, sequential counters) with auto-remediation if anomalies appear.</li> </ul> </li> <li>Dependencies: <code>design/docs/hardware/secure-element.md</code>, <code>design/docs/architecture/trust-boundary.md</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>, <code>docs/adr/adr-0002-signature-algorithm.md</code> (once written), <code>design/docs/pos/multi-terminal.md</code>.</li> <li> <p>Estimated effort: 4 weeks of hardening plus 2 weeks of documentation/testing.</p> </li> <li> <p>Operational excellence &amp; change control</p> </li> <li>Description: Institutionalize change control, scalability, and support practices so enterprise customers can roll out new branches, update tax rules, and respond to DGI changes without breaking existing invoices.</li> <li>Acceptance criteria:<ul> <li>Branch onboarding/outage playbooks tied to <code>design/docs/cloud/architecture.md</code> and <code>design/docs/implementation/phase-2.md</code>, covering device provisioning, ERP connector configuration, and compliance checklists.</li> <li>Change control process for tax manifest updates, firmware releases, and webhook API changes with regression testing against <code>spec/schema-tax-engine-1.md</code> and <code>spec/process-fiscal-reports-1.md</code>.</li> <li>Enterprise support KPIs (MTTR for device replacement, SLA for DGI upload, audit readiness) documented and tracked via the dashboard.</li> </ul> </li> <li>Dependencies: <code>design/docs/implementation/roadmap.md</code>, <code>memory-bank/context-map.md</code>, <code>design/docs/cloud/architecture.md</code>, <code>spec/schema-tax-engine-1.md</code>, <code>design/docs/pos/ui-ux.md</code>.</li> <li>Estimated effort: 4 weeks for playbooks + 2 weeks for automation and KPI reporting.</li> </ol>"},{"location":"implementation/roadmap/","title":"Implementation Roadmap","text":""},{"location":"implementation/roadmap/#overview","title":"Overview","text":"<p>This document lays out the phased rollout for Bono Pay\u2019s fiscal compliance platform, beginning with a tightly scoped B2B pilot, scaling through retail and restaurant multi-terminal deployments, and culminating in an enterprise-grade offering with ERP/webhook integrations and analytics. Each phase has a fixed duration (Phase 1 &amp; Phase 2 are three months each, Phase 3 spans six months) and builds on the architecture, hardware, and fiscal-engine work captured earlier in the technical design docs.</p>"},{"location":"implementation/roadmap/#timeline","title":"Timeline","text":"<p>The Gantt chart below visualizes the overlapping deliverables, dependencies, and validation checkpoints that keep the rollout on schedule.</p> <pre><code>gantt\n    title Bono Pay Implementation Roadmap\n    dateFormat  YYYY-MM-DD\n    axisFormat  %b %d\n\n    section Phase 1 \u2014 B2B Pilot (3 months)\n    USB firmware + PREPARE/COMMIT validation :crit, 2026-03-01, 90d\n    Single-terminal POS &amp; fiscal service MVP :active, 2026-03-01, 90d\n    Manual DGI compliance tooling : 2026-04-01, 60d\n    Pilot homologation &amp; client onboarding : 2026-05-01, 60d\n\n    section Phase 2 \u2014 Retail &amp; Restaurants (3 months)\n    Multi-terminal mediator + fiscal queue : 2026-06-01, 90d\n    Cloud sync + automatic DGI upload : 2026-06-15, 75d\n    Full report suite (Z/X/A) &amp; audit export readiness : 2026-07-01, 60d\n    Mobile-waiter experience + UI polish : 2026-07-15, 45d\n\n    section Phase 3 \u2014 Enterprise (6 months)\n    ERP connectors + webhook API : 2026-09-01, 150d\n    Fleet management + multi-branch dashboard : 2026-10-01, 150d\n    Advanced analytics &amp; compliance automation : 2026-11-01, 120d</code></pre>"},{"location":"implementation/roadmap/#phase-1-b2b-pilot","title":"Phase 1 \u2014 B2B Pilot","text":""},{"location":"implementation/roadmap/#milestones","title":"Milestones","text":"<ul> <li>Finish USB Fiscal Memory firmware that implements the PREPARE \u2192 COMMIT cycle, immutable journal, and report generation.</li> <li>Deliver the single-terminal POS + fiscal service bundle with canonical payload serializer, tax engine UI, and receipt printer integration.</li> <li>Ship manual DGI compliance tooling (CSV export, audit dump, Z/X/A report generation) to support homologation.</li> <li>Onboard the first 10 pilot clients (service companies, wholesalers, schools) and validate the offline-first behavior together with the cloud sync queue.</li> </ul>"},{"location":"implementation/roadmap/#dependencies","title":"Dependencies","text":"<ul> <li>Architecture overview/trust boundary docs (design/docs/architecture/*) and spec/architecture-kutapay-system-1.md to prove the zones of trust before device deployment.</li> <li>Hardware pages (design/docs/hardware/*.md) and the USB device protocol to fix the BOM, power/performance targets, and cable/RTC constraints.</li> <li>Fiscal engine docs (design/docs/fiscal/*) so billing flows, security elements, and reports align with the canonical payload expectations.</li> </ul>"},{"location":"implementation/roadmap/#risks","title":"Risks","text":"<p>Phase 1 Risks</p> <ul> <li>The DGI MCF/e-MCF API remains undefined, so the pilot\u2019s compliance tooling may need rework once the official spec lands.</li> <li>Hitting the $10\u201315 BOM target while integrating secure MCU, SE, flash, and RTC hardware is tight; supply chain or yield issues could delay deployment.</li> <li>Field testing in DRC conditions could expose unexpected offline/latency behavior before the cloud queue matures.</li> </ul>"},{"location":"implementation/roadmap/#phase-2-retail-restaurants","title":"Phase 2 \u2014 Retail &amp; Restaurants","text":""},{"location":"implementation/roadmap/#milestones_1","title":"Milestones","text":"<ul> <li>Enable the multi-terminal mediator service so many POS terminals can queue payloads against a single outlet-level USB device.</li> <li>Launch the cloud sync stack with deferred upload, retry logic, and automatic DGI upload once connectivity returns.</li> <li>Expand the reporting suite to include X and A reports, audit export hooks, and dashboard drilldowns.</li> <li>Polish the mobile-waiter UX, multi-language indicators, and notifications for offline status and device disconnect events.</li> </ul>"},{"location":"implementation/roadmap/#dependencies_1","title":"Dependencies","text":"<ul> <li>Completion of Phase 1 deliverables so the baseline hardware + POS + compliance tooling has been proven in production pilots.</li> <li>Cloud architecture, offline-sync, and DGI integration docs (design/docs/cloud/*.md) that describe sync states, conflict resolution, and unknowns that surfaced in the spike.</li> <li>POS UX and multi-terminal design docs to guide the mediator UI, LAN discovery, and concurrency handling.</li> </ul>"},{"location":"implementation/roadmap/#risks_1","title":"Risks","text":"<p>Phase 2 Risks</p> <ul> <li>Ensuring sequential fiscal numbers when dozens of terminals write to one device stresses the mediator and the hash-chained journal; race conditions must be fully exercised.</li> <li>The offline cache/sync queue must survive long outages (48\u201372h) without data loss or duplicate uploads, especially over unreliable networks.</li> <li>DGI readiness and regulatory approvals for auto-uploading sealed invoices could arrive late, requiring feature toggles or manual overrides.</li> </ul>"},{"location":"implementation/roadmap/#phase-3-enterprise","title":"Phase 3 \u2014 Enterprise","text":""},{"location":"implementation/roadmap/#milestones_2","title":"Milestones","text":"<ul> <li>Build ERP connectors, webhook endpoints, and webhook validation for SAP/Odoo partners so enterprise clients can sync to their ecosystems.</li> <li>Deliver fleet management and multi-branch dashboards for centralized monitoring, device health, and audit trails.</li> <li>Implement advanced analytics, automated alerting, and audit export automation for regulatory reviews.</li> </ul>"},{"location":"implementation/roadmap/#dependencies_2","title":"Dependencies","text":"<ul> <li>Full completion of Phases 1 &amp; 2 so hardware, POS, sync, and reporting layers are stable.</li> <li>API reference docs (design/docs/api/*.md) to describe device and cloud endpoints as ownership shifts to partner integrators.</li> <li>Roadmap and implementation guidance from previous phases so enterprise teams inherit tested automation and risk mitigations.</li> </ul>"},{"location":"implementation/roadmap/#risks_2","title":"Risks","text":"<p>Phase 3 Risks</p> <ul> <li>ERP and webhook integrations add API surface area that must safely handle high-volume invoice uploads and retries.</li> <li>Multi-branch fleets amplify monitoring, firmware upgrade, and provisioning complexity\u2014lacking tooling here could stall adoption.</li> <li>Unforeseen regulatory changes (e.g., signature algorithm shifts or new DGI fields) during this six-month phase could require re-validation.</li> </ul>"},{"location":"implementation/roadmap/#monitoring-validation","title":"Monitoring &amp; Validation","text":"<p>Maintain a rolling review cadence after each phase completes, using the security and architecture review findings (review/*.md) plus monthly sync audits to confirm the roadmap remains aligned with DGI requirements and hardware realities.</p>"},{"location":"pos/integrations/","title":"Integrations","text":"<p>Bono Pay supports a spectrum of integrations that feed fiscal data from the POS/merchant stack to auditors, accountants, and regulators. The integration priority below keeps the most sensitive, trusted channels at the top of the stack.</p> <p>Integration priority</p> <ol> <li>Core fiscal API (USB device communication)</li> <li>CSV import/export</li> <li>Accounting export</li> <li>Webhooks</li> <li>E-commerce plugins</li> <li>ERP connectors (Odoo, SAP)</li> </ol> <p>Each tier adds value for a different audience while reusing the sealed invoice, tax group breakdown, and security elements generated by the USB Fiscal Memory device.</p>"},{"location":"pos/integrations/#1-core-fiscal-api-usb-device-communication","title":"1. Core fiscal API (USB device communication)","text":"<p>Target users: POS integrators, fiscal service developers, and on-premise IT teams that keep a device service running beside every checkout lane. Data format: Canonical JSON payload (see spec) with deterministic field ordering: <code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>invoice_type</code>, <code>timestamp</code>, <code>client</code>, <code>items[]</code>, <code>tax_groups[]</code>, <code>totals</code>, <code>payments</code>. Authentication: USB CDC connection + two-phase commit (PREPARE \u2192 COMMIT) using nonce validation so the device owns the fiscal counter. Example payload (canonical JSON): <pre><code>{\n  \"merchant_nif\": \"123456789\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"pos_terminal_id\": \"POS-07\",\n  \"cashier_id\": \"CASHIER-01\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-17T12:15:00Z\",\n  \"client\": {\n    \"registration\": \"CUST-555\",\n    \"classification\": \"company\"\n  },\n  \"items\": [\n    {\n      \"code\": \"SKU-INVERTER\",\n      \"description\": \"Solar inverter\",\n      \"quantity\": 1,\n      \"unit_price\": 100000,\n      \"tax_group\": \"TG02\",\n      \"taxable_unit\": \"EA\"\n    }\n  ],\n  \"tax_groups\": [\n    {\n      \"code\": \"TG02\",\n      \"name\": \"Standard VAT \u2014 Goods\",\n      \"rate\": 0.16,\n      \"base_amount\": 100000,\n      \"tax_amount\": 16000\n    }\n  ],\n  \"totals\": {\n    \"subtotal\": 100000,\n    \"total_vat\": 16000,\n    \"total\": 116000,\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    {\n      \"method\": \"mobile_money\",\n      \"amount\": 116000,\n      \"instrument_id\": \"MOMO-012\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"pos/integrations/#2-csv-importexport","title":"2. CSV import/export","text":"<p>Target users: Finance clerks, compliance officers, and auditors who need bulk import/export for historical invoices or once-off reconciliations. Data format: CSV files with headers such as <code>invoice_number</code>, <code>issue_date</code>, <code>client_name</code>, <code>tax_group</code>, <code>subtotal</code>, <code>total_vat</code>, <code>total</code>, <code>status</code>. Each row references the sealed invoice number generated by the USB device. Authentication: Secure upload into Bono Pay Cloud via SFTP/HTTPS using dedicated API keys and IP allow lists; the cloud service validates that each row maps to an existing sealed invoice before accepting it. Example CSV snippet: <pre><code>invoice_number,issue_date,client_name,tax_group,subtotal,total_vat,total,status\nKUTA001-105,2026-02-16,SF Enterprises,TG02,100000,16000,116000,fiscalized\n+KUTA001-106,2026-02-16,Embassy of Kinshasa,TG01,500,0,500,fiscalized\n</code></pre></p>"},{"location":"pos/integrations/#3-accounting-export","title":"3. Accounting export","text":"<p>Target users: Accountants, ERP adapters, and CFOs who push summarized fiscal data into ledgers, general journals, or budgeting tools. Data format: JSON or NDJSON stream with <code>period</code>, <code>currency</code>, and <code>entries</code> that include <code>account_code</code>, <code>invoice_ref</code>, <code>amount</code>, <code>tax_group</code>, and <code>fiscal_number</code>. Exports can be monthly or triggered on demand. Authentication: REST API with bearer tokens scoped per finance team; tokens are issued after device authentication and tied to the outlet\u2019s registry entry to keep the audit trail intact. Example payload: <pre><code>{\n  \"period\": \"2026-02\",\n  \"currency\": \"CDF\",\n  \"entries\": [\n    {\n      \"account_code\": \"411001\",\n      \"invoice_ref\": \"KUTA001-105\",\n      \"amount\": 116000,\n      \"tax_group\": \"TG02\",\n      \"fiscal_number\": \"KUTA001-105\"\n    },\n    {\n      \"account_code\": \"411002\",\n      \"invoice_ref\": \"KUTA001-106\",\n      \"amount\": 500,\n      \"tax_group\": \"TG01\",\n      \"fiscal_number\": \"KUTA001-106\"\n    }\n  ]\n}\n</code></pre></p>"},{"location":"pos/integrations/#4-webhooks","title":"4. Webhooks","text":"<p>Target users: Inventory systems, CRM platforms, or analytics pipelines that react the moment a fiscal event closes. Data format: Signed HTTP POST with JSON payload describing <code>event</code>, <code>merchant_nif</code>, <code>fiscal_number</code>, <code>total</code>, <code>tax_breakdown</code>, and <code>metadata</code>. Authentication: HMAC signature (<code>X-Bono Pay-Signature</code>) calculated over the payload with a shared secret per subscriber; receivers must verify the signature before acting. Example payload: <pre><code>{\n  \"event\": \"invoice.fiscalized\",\n  \"timestamp\": \"2026-02-17T12:16:00Z\",\n  \"merchant_nif\": \"123456789\",\n  \"fiscal_number\": \"KUTA001-105\",\n  \"total\": 116000,\n  \"tax_breakdown\": [\n    { \"tax_group\": \"TG02\", \"tax_amount\": 16000 }\n  ],\n  \"metadata\": {\n    \"pos_terminal_id\": \"POS-07\",\n    \"cashier_id\": \"CASHIER-01\"\n  }\n}\n</code></pre></p>"},{"location":"pos/integrations/#5-e-commerce-plugins","title":"5. E-commerce plugins","text":"<p>Target users: Online merchants (Shopify, WooCommerce, Magento) and their developers who need frictionless fiscalization for web orders. Data format: Plugin POSTs JSON to Bono Pay Cloud with order-level data (<code>order_id</code>, <code>customer</code>, <code>line_items</code>, <code>shipping</code>, <code>payments</code>) plus mapping to canonical invoice fields; the cloud service in turn calls the local fiscal service/USB device before streaming the sealed response back into the plugin. Authentication: OAuth2 client credentials or API tokens provisioned per storefront. Tokens are bound to the merchant account and limited to a specific domain or IP range. Example payload: <pre><code>{\n  \"order_id\": \"ECOM-2026-004\",\n  \"customer\": \"Lumumba Market\",\n  \"line_items\": [\n    {\n      \"sku\": \"ECOM-SOLAR\",\n      \"description\": \"Solar kit\",\n      \"quantity\": 2,\n      \"unit_price\": 55000,\n      \"tax_group\": \"TG02\"\n    }\n  ],\n  \"shipping\": {\n    \"method\": \"express\",\n    \"amount\": 4000\n  },\n  \"payments\": [\n    { \"method\": \"card\", \"amount\": 114000 }\n  ]\n}\n</code></pre></p>"},{"location":"pos/integrations/#6-erp-connectors-odoo-sap","title":"6. ERP connectors (Odoo, SAP)","text":"<p>Target users: Enterprise customers connecting their ERP suites to Bono Pay\u2019s fiscal engine for batch invoicing, advanced inventory control, and audit exports. Data format: Structured JSON (or ERP-native messages such as IDocs) that include <code>connector_reference</code>, <code>invoice_lines</code>, <code>client</code>, <code>totals</code>, and <code>fiscal_metadata</code>, allowing the ERP to reconcile fiscal numbers with its own documents. Authentication: Mutual TLS between the ERP connector and Bono Pay Cloud or token-based authentication issued per <code>outlet_id</code>; connectors also carry the <code>device_id</code> of the linked USB device for traceability. Example payload: <pre><code>{\n  \"connector_reference\": \"ODOO-SO-299\",\n  \"invoice_lines\": [\n    {\n      \"product_code\": \"ERP-001\",\n      \"description\": \"Consulting hours\",\n      \"quantity\": 10,\n      \"unit_price\": 25000,\n      \"tax_group\": \"TG03\"\n    }\n  ],\n  \"client\": {\n    \"name\": \"National Railways\",\n    \"classification\": \"company\"\n  },\n  \"totals\": {\n    \"subtotal\": 250000,\n    \"total_vat\": 40000,\n    \"total\": 290000,\n    \"currency\": \"CDF\"\n  },\n  \"fiscal_metadata\": {\n    \"merchant_nif\": \"123456789\",\n    \"device_id\": \"KUTA001\"\n  }\n}\n</code></pre></p>"},{"location":"pos/multi-terminal/","title":"Multi-terminal orchestration","text":"<p>Bono Pay keeps one trusted USB Fiscal Memory device per outlet, so when multiple POS terminals share the same retail counter or restaurant floor, a local fiscal service mediates every interaction. This page explains how that mediator keeps the trust boundary intact while coordinating concurrent terminals, starving the device only one canonical PREPARE/COMMIT stream at a time, and delivering auditable invoices with the required metadata.</p>"},{"location":"pos/multi-terminal/#core-principles","title":"Core principles","text":"<ul> <li>One device per outlet, not per cashier: every outlet advertises a single DEF NID and a single monotonic counter. Multiple POS stations rely on that device\u2019s serial number for reporting and audit.</li> <li>Canonical payloads include traceability fields: every request carries <code>outlet_id</code>, <code>pos_terminal_id</code>, and <code>cashier_id</code> plus the usual merchant, client, items, and tax-engine data so auditors can reconstruct where each fiscal number originated.</li> <li>Local fiscal service acts as the queue: POS terminals never talk directly to the DEF in a multi-terminal setup; they always send their canonical JSON to the mediator, which serializes PREPARE/COMMIT requests, respects nonce-based 2PC, and forwards only one in-flight command to the device at a time.</li> <li>Trust boundary enforcement: the device remains the only producer of fiscal numbers, device IDs, signatures, timestamps, and QR codes; the mediator merely relays responses back to the originating terminal.</li> </ul> <p>Trust boundary reminder</p> <p>The DEF never exposes private keys, counters, or auth codes to the POS layer. Even though multiple terminals share a device, no terminal may fabricate security elements or bypass the queueing mediator.</p>"},{"location":"pos/multi-terminal/#local-fiscal-service-mediator","title":"Local fiscal service mediator","text":"<p>The mediator runs inside the outlet\u2019s LAN (or on the same host if it is the POS). It maintains:</p> <ol> <li>A request queue that orders PREPARE commands across terminals and stores the payload ID until COMMIT completes.</li> <li>A nonce tracker that pairs each PREPARE with the matching COMMIT and retries failed exchanges.</li> <li>A concurrency locker so that simultaneous POS sessions cannot step on each other and cause duplicate fiscal numbers.</li> <li>A network router\u2014POS terminals connect over Wi-Fi or Ethernet (single lane, 10-lane retail, or waiter tablets), while the mediator uses USB CDC to talk to the DEF.</li> </ol> <p>Every payload forwarded to the DEF already includes <code>outlet_id</code>, <code>pos_terminal_id</code>, and <code>cashier_id</code> so that:</p> <ul> <li>the device\u2019s ledger shows exactly which terminal requested each fiscal number,</li> <li>audits or compliance reports can tie violations back to a person,</li> <li>offline sync can queue by terminal and preserve sequencing when uploading to the cloud/DGI.</li> </ul>"},{"location":"pos/multi-terminal/#payload-metadata-concurrency","title":"Payload metadata &amp; concurrency","text":"<p>The DAO ensures that every PREPARE/COMMIT pair is tagged with the terminal hierarchy and that the nonce-based two-phase commit from <code>spec/architecture-kutapay-system-1.md</code> resolves races:</p> <ul> <li>When a PREPARE succeeds, the mediator issues the nonce to the requesting terminal and notes the <code>pos_terminal_id</code>.</li> <li>If multiple PREPAREs arrive, the mediator buffers them and forwards the next one only after the current COMMIT returns (or fails).</li> <li>The DEF increments its monotonic counter only inside COMMIT, guaranteeing whoever finishes first gets the next fiscal number; the mediator prevents two terminals from hitting COMMIT simultaneously.</li> <li>Rejected PREPAREs immediately bubble an error back to the originating terminal so the cashier can retry rather than issuing a receipt without fiscalization.</li> </ul> <p>Additional safeguards:</p> <ul> <li>The payload includes cashier identifiers so rollback or refund requests can show who initiated them.</li> <li>The mediator tracks audit timestamps and attaches them to the queued entry so offline uploads preserve time order.</li> </ul>"},{"location":"pos/multi-terminal/#single-terminal-deployment","title":"Single-terminal deployment","text":"<p>In a single-terminal outlet the mediator can be embedded in the POS app, but the same flow still applies: canonical payload \u2192 queued PREPARE \u2192 DEF \u2192 fiscal response \u2192 receipt/queue. The diagram below depicts the minimal deployment.</p> <pre><code>graph LR\n    POS[\"POS terminal (single lane)\"]\n    FISCAL[\"Local fiscal service (embedded)\"]\n    USB[\"USB Fiscal Memory device\"]\n    CLOUD[\"Bono Pay Cloud / Sync Agent\"]\n    DGI[\"DGI / MCF endpoint\"]\n\n    POS --&gt;|canonical payload| FISCAL\n    FISCAL --&gt;|PREPARE/COMMIT| USB\n    USB --&gt;|fiscal response| FISCAL\n    FISCAL --&gt;|receipt + sealed invoice| POS\n    FISCAL --&gt;|queued sealed invoice| CLOUD\n    CLOUD --&gt;|upload| DGI</code></pre>"},{"location":"pos/multi-terminal/#retail-10-lanes","title":"Retail: 10 lanes","text":"<p>Large retailers run up to ten checkout lanes behind a single outlet-level device. POS lanes connect over the same LAN/Wi-Fi to the fiscal service mediator, which serializes every invoice, enforces nonce matching, and ensures queue fairness so that each lane knows when it can send the next PREPARE. The mediator also labels the payloads with <code>pos_terminal_id</code> and <code>lane_number</code> so auditors will know which lane produced each fiscal number.</p> <pre><code>graph TD\n    subgraph POS Area\n        POS1[\"Lane 1 POS\"]\n        POS2[\"Lane 2 POS\"]\n        POS3[\"Lane 10 POS\"]\n    end\n    FISCAL[\"Local fiscal service (retail mediator)\"]\n    USB[\"USB Fiscal Memory device\"]\n    CLOUD[\"Bono Pay Cloud\"]\n    DGI[\"DGI / MCF\"]\n\n    POS1 --&gt;|canonical payload| FISCAL\n    POS2 --&gt;|canonical payload| FISCAL\n    POS3 --&gt;|canonical payload| FISCAL\n    FISCAL --&gt;|serialized PREPARE/COMMIT| USB\n    USB --&gt;|fiscal response| FISCAL\n    FISCAL --&gt;|sealed invoice| CLOUD\n    CLOUD --&gt;|upload| DGI</code></pre>"},{"location":"pos/multi-terminal/#restaurant-mobile-waiters","title":"Restaurant: mobile waiters","text":"<p>Restaurants and food halls often deploy mobile waiter tablets that connect back to the same mediator over Wi-Fi, Bluetooth tethering, or a local hub. Each waiter is a POS terminal with unique <code>pos_terminal_id</code> and <code>cashier_id</code>. The mediator keeps a sliding window of active terminals, forwards PREPARE requests one at a time, and ensures that voids/refunds linked to a table retain the correct fiscal references. Since waiters frequently move, the mediator also tracks connection health and retries PREPAREs when a tablet roams out of range before committing.</p> <pre><code>graph LR\n    Waiter1[\"Waiter Tablet 1\"]\n    Waiter2[\"Waiter Tablet 2\"]\n    Waiter3[\"Waiter Tablet N\"]\n    HUB[\"Local fiscal service hub\"]\n    USB[\"USB Fiscal Memory device\"]\n    CLOUD[\"Bono Pay Cloud\"]\n    DGI[\"DGI / MCF\"]\n\n    Waiter1 --&gt;|canonical payload| HUB\n    Waiter2 --&gt;|canonical payload| HUB\n    Waiter3 --&gt;|canonical payload| HUB\n    HUB --&gt;|PREPARE/COMMIT queue| USB\n    USB --&gt;|fiscal response| HUB\n    HUB --&gt;|sealed invoice| CLOUD\n    CLOUD --&gt;|upload| DGI</code></pre>"},{"location":"pos/multi-terminal/#failure-modes-and-monitoring","title":"Failure modes and monitoring","text":"<p>The mediator exposes health endpoints so operations teams can see:</p> <ol> <li>Which terminal is currently holding the PREPARE/COMMIT lock.</li> <li>How many requests are queued and their statuses.</li> <li>Last good fiscal number returned by the DEF (this is the single source of truth for sequencing; terminals must not guess the next number).</li> </ol> <p>If the device reports an error (memory full, tamper, power loss), the mediator alerts each terminal so the cashier can halt checkouts rather than issuing un-fiscalized receipts. When connectivity returns after offline operation, the mediator continues uploading queued sealed invoices to the cloud/DGI in arrival order.</p> <p>Why the mediator matters</p> <p>Without the mediator, terminals would compete for the same USB channel and risk slipping outside the trust boundary\u2014this single service keeps the two-phase commit deterministic, tracks terminal IDs, and preserves the sequential fiscal numbers the regulators demand.</p>"},{"location":"pos/ui-ux/","title":"POS UX &amp; UI Direction","text":"<p>This page captures the UX and interface rules that help the Bono Pay POS feel as fluid as Odoo while obeying the DRC fiscal trust boundary. The POS remains the untrusted data-entry surface; every sale, void, refund, and report must be gated by the USB Fiscal Memory device before any receipt, journal entry, or Z-report is considered valid.</p> <p>Trust &amp; fiscalization gate</p> <p>The POS never assigns fiscal numbers, signs invoices, or finalizes a sale until the USB Fiscal Memory device confirms PREPARE \u2192 COMMIT success. No receipt, no saved invoice, no queue promotion happens without that handshake. Nothing is ever deleted\u2014voids and refunds are new fiscal events with their own signatures.</p>"},{"location":"pos/ui-ux/#ux-principles","title":"UX Principles","text":"<ol> <li>PWA + offline cohesion. Bootstrap the POS as a Progressive Web App so the UI loads on any Android tablet, phone, or laptop. Use a Service Worker + IndexedDB (per the Odoo lesson) to cache catalogs, offline sessions, and UI assets so everything renders instantly, even when connectivity is absent.</li> <li>Single-screen checkout. Follow Odoo\u2019s single-screen flow: product grid, order summary, and numpad all visible without page reloads. Large tap targets (\u226544\u00d744\u202fpx), instant search-as-you-type, and barcode capture make the screen feel responsive even on low-end hardware.</li> <li>Fiscal-first status ribbon. Always show a persistent device status band that reports \u201cDevice connected / disconnected / error\u201d with color coding. Include the latest fiscal number, auth code snippet, and a countdown if the device is waiting for PREPARE/COMMIT.</li> <li>Dual-currency + payment clarity. Display USD and CDF totals side-by-side. Payment method chips (Cash, Mobile Money, Bank Transfer) show currency, available balance, and split-payment stacking right on the checkout screen.</li> <li>Minimal typing, maximal touch. Favor tap, drag, scan, and numpad input over keyboards. Input fields exist only for customer selection (with classification) and notes. Buttons and chips replace drop-downs whenever possible.</li> <li>Localization-ready labels. Every label supports French and Lingala with a global language toggle. Numbers, dates, and currency formats adjust automatically.</li> <li>Visibility of sync state. Show a queue indicator (\u201c5 invoices pending cloud sync\u201d) separate from fiscal status. The offline queue widget highlights when uploads are overdue and links to retry actions.</li> </ol> <p>Lessons from Odoo</p> <p>Odoo\u2019s offline resilience, IndexedDB caching, and single-screen sales workflow remain the baseline. Bono Pay adopts those patterns but adds the fiscal device overlays, dual-currency handling, and queued sync indicators described above.</p>"},{"location":"pos/ui-ux/#user-journeys","title":"User Journeys","text":""},{"location":"pos/ui-ux/#fiscalized-sale","title":"Fiscalized sale","text":"<ol> <li>Cashier selects products (instant search, barcode, categories) and the tax engine tags each line with one of the 14 DGI tax groups.</li> <li>Customer and client classification (individual, company, commercial individual, professional, embassy) are chosen before the \u201cValidate/Print\u201d action becomes available.</li> <li>The POS builds the canonical payload (ordered JSON), then sends <code>TXN|PREPARE</code> to the USB device. The UI highlights \u201cAwaiting fiscal device\u2026\u201d while the device increments its monotonic counter and hashes the previous invoice.</li> <li>On <code>TXN|COMMIT</code> success, the device replies with fiscal number, auth code, timestamp, and QR metadata. The POS saves the sale locally, prints the receipt, and shows a success banner with the new fiscal number and QR preview.</li> <li>The offline queue widget continues to track whether the invoice has been uploaded to the cloud/DGI; the sale remains compliant even if upload is pending.</li> </ol>"},{"location":"pos/ui-ux/#void-flow","title":"Void flow","text":"<ol> <li>Immediately after a sale (before upload), the cashier taps the sale, selects \u201cVoid,\u201d and confirms the reason.</li> <li>The POS sends a void command with the original fiscal number to the USB device. The UI warns that the void cannot proceed until the device confirms and displays the \u201cNothing can exit the trusted zone without device approval\u201d reminder.</li> <li>The device writes a void entry referencing the original invoice, replies with a new authorization code, and the POS prints a void receipt. The sale stays marked as voided; the canonical payload is stored in IndexedDB for audit.</li> </ol>"},{"location":"pos/ui-ux/#refund-flow","title":"Refund flow","text":"<ol> <li>Later, when a customer returns, the cashier searches past invoices (by fiscal number or QR scan) and taps \u201cRefund.\u201d Items and amounts are selected, and the refund total displays in USD/CDF.</li> <li>The POS generates a refund payload (negative amounts referencing the original) and transmits it to the device as a new fiscal event.</li> <li>After COMMIT, a refund receipt prints with the new fiscal number, auth code, and reference to the original invoice. The UI labels the refund as a credit note, never modifying the original order.</li> </ol>"},{"location":"pos/ui-ux/#z-report-shift-close","title":"Z-report &amp; shift close","text":"<ol> <li>At cashier shift close, the user taps \u201cZ-report\u201d from the session overview screen.</li> <li>The UI collects cash count inputs, triggers <code>RPT|Z</code> on the USB device, and displays the daily totals per tax group plus the device\u2019s signature/ hash.</li> <li>The POS prints the Z-report, marks the session as closed, and queues any pending uploads to DGI. A \u201cZ-report sent\u201d badge remains until the cloud confirms receipt.</li> </ol>"},{"location":"pos/ui-ux/#wireframe-descriptions","title":"Wireframe descriptions","text":"Checkout screen Adjustment modals (void/refund) Back-office / Z-report screen"},{"location":"pos/ui-ux/#layout","title":"Layout","text":"<ul> <li>Left: product grid with categories, barcode input, instant search, and favorites.</li> <li>Right: order summary with item list, dual-currency subtotal/VAT, tax group badges, and payment method chips.</li> <li>Bottom: numpad overlay (quantity/price entry) that slides up from the footer.</li> </ul>"},{"location":"pos/ui-ux/#device-fiscal-status","title":"Device &amp; fiscal status","text":"<ul> <li>Top ribbon: device connection icon, fiscal number, auth code snippet, and compliance warning if the device is missing.</li> <li>Inline alert below the ribbon for \u201cFiscal device not found\u201d or \u201cCOMMIT timeout,\u201d blocking receipt printing until cleared.</li> <li>Persistent footer widget showing offline queue count and \u201cUpload pending\u201d status.</li> </ul>"},{"location":"pos/ui-ux/#void-modal","title":"Void modal","text":"<ul> <li>Displays original fiscal number, amount, and reason field.</li> <li>Buttons: \u201cSend to USB device\u201d (primary) and \u201cCancel.\u201d</li> <li>Warning text: \u201cThe device will log a void entry with its own fiscal number. Nothing is deleted.\u201d</li> </ul>"},{"location":"pos/ui-ux/#refund-modal","title":"Refund modal","text":"<ul> <li>Selected items listed with checkboxes and return quantities.</li> <li>Refund total preview with USD + CDF breakdown and tax group info.</li> <li>Submit button triggers device handshake; disable until device responds.</li> </ul>"},{"location":"pos/ui-ux/#session-overview","title":"Session overview","text":"<ul> <li>Session card with cashier name, cash drawer totals, offline queue count, and \u201cClose session\u201d button.</li> <li>Z-report card showing daily totals by tax group, device signature, and \u201cPrint Z-report\u201d action.</li> <li>Language toggle (FR / LN) and accessibility controls (contrast, font size) grouped near the header.</li> </ul>"},{"location":"pos/ui-ux/#localization-accessibility","title":"Localization &amp; accessibility","text":"<ol> <li>Language toggle: Every screen includes a French / Lingala switch that updates labels, button text, and compliance messaging simultaneously.</li> <li>High contrast and text scaling: Buttons enlarge to support touch; icons and text meet WCAG 2.1 AA contrast ratios (especially the fiscal status ribbon).</li> <li>Accessible notifications: Fiscal errors, sync warnings, and device disconnections are repeated both visually (badges, banners) and audibly (optional tone) for noisy retail environments.</li> <li>Dual-currency formatting: All totals display USD and CDF with the configured exchange rate, and number inputs honor the local decimal conventions.</li> <li>Payment method icons: Mobile money partners (Airtel, Orange, Vodacom M-Pesa) get recognizable icons that stay legible even at smaller sizes.</li> </ol> <p>Offline visibility</p> <p>The POS keeps an offline queue indicator separate from fiscal status. Fiscalization happens first; the queue only tracks uploads to the cloud and DGI. If invoices linger offline beyond the grace period, highlight the queue in amber and provide a \u201cRetry upload\u201d action.</p>"},{"location":"regulatory/arretes/","title":"DRC fiscal arr\u00eat\u00e9s that govern Bono Pay","text":"<p>Bono Pay lives inside the tightly regulated world of the Facture Normalis\u00e9e mandate. Four ministerial orders work together: - Arr\u00eat\u00e9 032/2023 defines the governance and committee that approves architecture, vendors, and timelines. - Arr\u00eat\u00e9 033/2023 lays down the operational requirements for every invoice and device, enforcing the trust boundary that the governance committee supervises. - Arr\u00eat\u00e9 034/2023 regulates who may commercialize devices and software, so the governance committee can evaluate those suppliers. - Arr\u00eat\u00e9 016/2025 patches the commercialization regime defined in 034 while keeping the operational and governance foundations intact.</p> <p>Each tab below distills one arr\u00eat\u00e9 with the latest implications for Bono Pay. Cross-links point to related orders so reviewers see how governance, operational rules, commercialization, and amendments intersect.</p> Arr\u00eat\u00e9 032 \u2014 Governance"},{"location":"regulatory/arretes/#arrete-032","title":"Arr\u00eat\u00e9 n\u00b0032/2023 \u2014 Governance of the reform","text":"<p>Arr\u00eat\u00e9 032 does not touch invoices directly; it creates the Comit\u00e9 de Suivi with a Steering Committee, Technical Committee, and Technical Secretariat that oversee every design, budget, and deployment decision. It authorizes external technical providers, controls procurement, and appoints the bodies that approve the operational framework in Arr\u00eat\u00e9 033 and the commercialization rules in Arr\u00eat\u00e9 034.</p> <p>Key responsibilities - Validate the project charter, architecture, and vendor selections. - House the Technical Committee that drafts specifications, including the Bono Pay architecture. - Command the Technical Secretariat to document all decisions and preserve institutional memory. - Manage political relationships with the DGI, DGDA, and other ministries so that operational changes (e.g., new invoices, reports, or compliance hooks) can roll out in harmony with the enforcement path defined in Arr\u00eat\u00e9 033.</p> <p>Bono Pay implications - Every new architecture document (specs, ADRs, APIs) must be up for review by this committee, so keep changelogs and summaries ready. - Vendor certification requests and pricing disclosures ultimately flow to the same governance body that owns the rules in Arr\u00eat\u00e9 034. - The Technical Committee can change specs without new legislation; the documentation process must stay flexible to respond to rapid directives.</p> Arr\u00eat\u00e9 033 \u2014 Operational rules"},{"location":"regulatory/arretes/#arrete-033","title":"Arr\u00eat\u00e9 n\u00b0033/2023 \u2014 Operationalizing the standardized invoice","text":"<p>This is the core operational law. It forces every VAT-registered merchant to issue a standardized invoice through an approved system, insists on physical DEFs or e-UF/e-MCF fallback pathways, and moves compliance from periodic reporting to continuous, always-on discipline.</p> <p>Highlights - Every transaction must return a sealed invoice with DEF-generated security elements; no invoice equals non-compliance, even offline. - Two parallel enforcement paths: physical USB/DEF devices (UF + MCF) or controlled cloud/electronic systems, both required to keep fallback hardware handy. - Vendors must certify devices, provide maintenance, and keep audited change logs\u2014feeding back into the governance structure in Arr\u00eat\u00e9 032. - Device lifecycles are strictly controlled: activation, deactivation, and failure reporting happen under DGI supervision. - Financial incentives (50% hardware tax credit) accelerate adoption while tightening penalties for misuse.</p> <p>Cross-references - The governance in Arr\u00eat\u00e9 032 approves the technical architecture that this operational order enforces. - The supplier certification pipeline in Arr\u00eat\u00e9 034 makes sure only homologated technology appears in this mandate. - Arr\u00eat\u00e9 016/2025 (see below) softens supplier scarcity but leaves the obligation to fiscalize every sale unchanged.</p> <p>Bono Pay implications - Device behavior (PREPARE/COMMIT, reports, offline sync) must map 1:1 to the operational flows mandated here. - Offline-first issuance is a legal requirement\u2014not a convenience\u2014so documentation must highlight queueing, retries, and fallback indicators. - Device registration, deactivation, and failure reporting need automation so DGI inspectors see the same data the law demands.</p> Arr\u00eat\u00e9 034 \u2014 Commercialization and market design"},{"location":"regulatory/arretes/#arrete-034","title":"Arr\u00eat\u00e9 n\u00b0034/2023 \u2014 Licensing fiscal sellers","text":"<p>Arr\u00eat\u00e9 034 regulates who can sell DEF hardware and SFE software. It institutes a four-role model (DEF, SFE, suppliers, distributors), a multi-stage approval pipeline (agr\u00e9ment \u2192 homologation \u2192 authorization), strict distributor obligations, and price visibility to keep the market traceable. The first version even limited suppliers to three, creating regional monopolies (later relaxed by Arr\u00eat\u00e9 016/2025).</p> <p>Key rules - Suppliers must prove technical, financial, and logistical readiness, maintain 24-month manufacturer partnerships, and undergo homologation every time they change their product. - Distributors install, train, and support \u2014 users cannot self-install, ensuring traceability. - The tax authority monitors stock, spare parts, pricing, and reporting; any deviation can trigger withdrawal. - SFE providers must guarantee immutability, security, and archival retention, aligning with the reporting expectations from Arr\u00eat\u00e9 033.</p> <p>Bono Pay implications - Homologation planning is critical: almost any firmware or configuration change needs declaration or re-certification. - Distributor relationships matter; Bono Pay needs trusted partners to cover installation, training, and maintenance. - Pricing changes are visible to DGI, so every offer must include a pre-approved price list. - The governance body in Arr\u00eat\u00e9 032 uses these commercialization metrics to approve vendors, so keep documentation ready.</p> Arr\u00eat\u00e9 016/2025 \u2014 Amendment to Arr\u00eat\u00e9 034"},{"location":"regulatory/arretes/#arrete-016-2025","title":"Arr\u00eat\u00e9 n\u00b0016/2025 \u2014 Scaling amendment","text":"<p>This amendment keeps the commercialization controls of Arr\u00eat\u00e9 034 but fixes key bottlenecks: it removes the three-supplier ceiling, limits approvals to two-year renewable terms, clarifies minor update handling, and tightens distributor accountability while leaving mandatory fiscalization intact.</p> <p>What changed - Unlimited suppliers (while retaining technical, financial, and coverage thresholds) so the market can scale without artificial scarcity. - Supplier approvals now expire after two years, introducing planned renewal activities for Bono Pay. - Minor software changes can be declared instead of undergoing full re-homologation, reducing friction for SFE iterations noted in Arr\u00eat\u00e9 033. - Distributor obligations now explicitly cover user onboarding, training, and fair territorial coverage with price discipline still enforced. - Enterprises may seek conditional exemptions, acknowledging complex ERP/SFE deployments while keeping governance oversight from Arr\u00eat\u00e9 032.</p> <p>Bono Pay implications - The path to certification is more realistic, but the two-year cadence demands an approval lifecycle plan. - Minor updates no longer require major re-certification, so the documentation strategy should categorize changes as \"minor\" vs. \"material\" and declare them appropriately. - Pricing discipline and distributor accountability remain high-priority constraints, so contractual language must reference this order alongside Arr\u00eat\u00e9 034. - The amendment is an explicit acknowledgement that the same operational rules in Arr\u00eat\u00e9 033 still apply even as the commercialization regime adapts.</p>"},{"location":"regulatory/legal-framework/","title":"DRC Fiscal Compliance Legal Framework","text":"<p>The Democratic Republic of Congo layers multiple ministerial orders and technical specifications to move every transaction through a trusted fiscal control stack. Bono Pay must navigate that stack: the governance machine that approves strategy, the operational rules that ban deleted invoices, the commercialization controls that limit who may sell hardware, the amendments easing scaling, and the SFE technical specification that defines what every compliant billing system must emit.</p>"},{"location":"regulatory/legal-framework/#regulatory-hierarchy","title":"Regulatory hierarchy","text":"<pre><code>flowchart TB\n    A[\"Arr\u00eat\u00e9 032/2023&lt;br/&gt;Governance Committee\"]\n    B[\"Arr\u00eat\u00e9 033/2023&lt;br/&gt;Standardized Invoice &amp; DEF Rules\"]\n    C[\"Arr\u00eat\u00e9 034/2023&lt;br/&gt;Commercialization &amp; Licensing\"]\n    D[\"Arr\u00eat\u00e9 016/2025&lt;br/&gt;Scaling Discipline &amp; Updates\"]\n    E[\"SFE Specifications v1.0&lt;br/&gt;Technical Billing Requirements\"]\n    A --&gt; B\n    A --&gt; C\n    B --&gt; E\n    C --&gt; E\n    D --&gt; C\n    D --&gt; E\n    C -.-&gt; D</code></pre>"},{"location":"regulatory/legal-framework/#document-summaries","title":"Document summaries","text":"Document Scope Bono Pay impact Arr\u00eat\u00e9 032/2023 Creates the Comit\u00e9 de Suivi with Steering Committee, Technical Committee, and Secretariat that own governance, procurement, and documentation for the standardized invoicing reform. Stay aligned with the committees, treat governance decisions as authoritative, keep documentation up to date, and position Bono Pay as a staffed technical partner rather than a pure vendor. Arr\u00eat\u00e9 033/2023 Defines the mandatory issuance of standardized invoices, the dual (physical DEF + e-DEF) enforcement paths, device/fallback requirements, and the operational discipline every VAT-registered merchant must maintain. Design Bono Pay so every sale is a fiscal event, support offline-first issuance with trusted security elements, include fallback hardware (USB device per outlet), and make error reporting realtime; expect inspectors everywhere. Arr\u00eat\u00e9 034/2023 Regulates who may commercialize DEF and SFE products through pre-qualification, homologation, and distribution pipelines, with certified suppliers, distributors, and price transparency obligations. Plan for a regulated sales channel: seek homologation, partner with distributors for installation/support, disclose pricing, and maintain spare parts / stock for at least three years. Arr\u00eat\u00e9 016/2025 Adjusts commercialization rules by removing supply caps, adding two-year approval windows, clarifying which updates require re-homologation, and reinforcing distributor accountability. Treat regulatory approvals as renewable (every two years), declare minor IMS updates instead of full re-cert, honor consistent pricing, and ensure distributors can cover training/support/territory responsibilities. SFE Specifications v1.0 DGI technical requirements for certified enterprise billing systems: layered SFE \u2192 DEF \u2192 MCF \u2192 DGI architecture plus 14 tax groups, five invoice types, mandatory security elements, reports, offline behavior, and immutable storage. Embed all five invoice types, implement every tax group/client classification, enforce security element generation in the hardware layer, produce Z/X/A/audit outputs, and respect immutability/offline expectations before any cloud sync."},{"location":"regulatory/legal-framework/#adoption-timeline","title":"Adoption timeline","text":"Date Regulation Milestone 2023-10-23 Arr\u00eat\u00e9 032/033/034 Governance body formed, standardized invoice rules enforced, and commercialization controls put in place; merchants had a three-month compliance window (extendable two months) and must keep approved hardware active. 2025-02-27 Arr\u00eat\u00e9 016/2025 Supplier cap removed, approval validity capped at two years, minor software updates declarable, pricing discipline strengthened, and distributor obligations clarified to improve throughput. 2023 (DGI) SFE Specifications v1.0 Living technical reference for every billing system to integrate with DEF/MCF, enforce 14 tax groups, 5 invoice types, security elements, and mandated reports; treat as evergreen until superseded."},{"location":"regulatory/legal-framework/#key-compliance-deadlines-expectations","title":"Key compliance deadlines &amp; expectations","text":"<ul> <li>Rapid compliance window (Arr\u00eat\u00e9 033): VAT-registered merchants had three months (plus two-month extension) to transition to approved invoicing systems. Bono Pay\u2019s rollout must be fast because regulators expect no gaps.</li> <li>Approval cadence (Arr\u00eat\u00e9 034 &amp; 016/2025): Pre-qualification and homologation reviews each take up to 30 working days; major modifications trigger re-homologation, while minor updates require declarations. Plan firmware/system changes with these gating periods in mind.</li> <li>Renewal rhythm (Arr\u00eat\u00e9 016/2025): Every homologated DEF/SFE approval lasts two years, so renewal processes must be resourced and scheduled before expiry.</li> <li>Distribution commitments (Arr\u00eat\u00e9 034 &amp; 016/2025): Maintain 60-day replenishment pledges, three-year spare-part guarantees, consistent pricing disclosures, and accountable distributors covering onboarding and after-sales.</li> <li>Technical observability (SFE spec): Archives must retain invoices for at least one year, report outputs (Z/X/A/audit) must be generated locally, and every invoice must carry sequential fiscal number, device ID, signature, timestamp, and QR code before syncing; offline issuance remains normal operation.</li> <li>Fallback &amp; resilience (Arr\u00eat\u00e9 033): Hardware failure is not an excuse\u2014fallback systems must stay powered; replacement devices and offline queues must be ready immediately whenever connectivity or device issues occur.</li> </ul>"},{"location":"regulatory/legal-framework/#implications-for-bono-pay","title":"Implications for Bono Pay","text":"<ol> <li>Governance alignment: Treat the Steering and Technical Committees as the ultimate arbiters\u2014submit architecture and compliance reports, engage politically, and log every decision for the Secretariat.</li> <li>Operational discipline: The POS / USB device / cloud stack must enforce the layered mandate (SFE \u2192 DEF \u2192 MCF \u2192 DGI) with immutable journals, security elements, and multi-terminal per-outlet rules.</li> <li>Commercial readiness: Homologation, distributor partnerships, pricing disclosures, spare parts, and two-year renewal plans are as critical as firmware.</li> <li>Technical completeness: Support all 14 tax groups, five invoice types, offline-first issuance, and mandated reports before reaching DGI; treat the SFE spec as a living contract even as regulatory details (e.g., QR payloads) evolve.</li> </ol>"},{"location":"regulatory/sfe-specs/","title":"SFE Specifications (v1)","text":"<p>This page distills the DGI Syst\u00e8me de Facturation d'Entreprise (SFE) requirements so the Bono Pay design team can trace every regulatory demand to our architecture, fiscal flows, and hardware guarantees.</p> <p>The official summary calls out the layered deployment (SFE \u2192 DEF \u2192 MCF/e-MCF \u2192 DGI), mandates five invoice types, demands all 14 tax groups, requires Z/X/A/audit reporting, and insists security elements come from the trusted fiscal layer\u2014not the POS. These constraints steer the content on the fiscal engine, hardware, and reports pages.</p> <p>Trust boundary reminder</p> <p>The USB Fiscal Memory device is the only component that can generate fiscal numbers, authentication codes, trusted timestamps, or QR codes. Everything else (POS, fiscal service, cloud sync) must treat the device as the trusted boundary; see Architecture Trust Boundary for details.</p>"},{"location":"regulatory/sfe-specs/#mandatory-invoice-types","title":"Mandatory Invoice Types","text":"Invoice Type French Label Purpose Sale invoice Facture de vente Everyday retail/wholesale sales; the default workflow in <code>design/docs/fiscal/invoice-lifecycle.md</code>. Advance invoice Facture d'avance Payments received before goods/services are fulfilled; still requires PREPARE \u2192 COMMIT. Credit note Note de cr\u00e9dit Correction for returned goods or billing adjustments; treated as a new fiscal event. Export invoice Facture d'exportation Sales destined outside the DRC; destines the invoice to TG07 (Export Zero Rate). Export credit note Note de cr\u00e9dit d'exportation Refund tied to an export transaction, sequenced independently like all refunds. <p>Each type is implemented by the same canonical flow documented in the Invoice Lifecycle page: PREPARE the canonical JSON, COMMIT with the nonce, print the fiscal response, queue for sync.</p>"},{"location":"regulatory/sfe-specs/#14-dgi-tax-groups","title":"14 DGI Tax Groups","text":"Code Name Rate Notes TG01 Exempt 0% Diplomats, embassies, NGOs, government transfers. TG02 Standard VAT \u2014 Goods 16% Default for tangible goods. TG03 Standard VAT \u2014 Services 16% Professional and intangible services. TG04 Reduced VAT 9% Essential foodstuffs and medicines flagged in catalog metadata. TG05 Public Financing VAT 16% Publicly funded programs; requires funding source metadata. TG06 Customs VAT 16% Imported goods (CIF basis) in addition to duties. TG07 Export Zero Rate 0% Goods/services consumed outside the DRC; requires export certificate. TG08 Special Regime \u2014 Agriculture 5% Agribusiness items registered under the agricultural regime. TG09 Special Regime \u2014 Mining 10% Mining sector goods/services with operator license metadata. TG10 Specific Tax \u2014 Fuel 25% Excise on gasoline, diesel, aviation fuel. TG11 Specific Tax \u2014 Tobacco 30% Applies to cigarettes, cigars, and tobacco preparations. TG12 Specific Tax \u2014 Alcohol 20% Spirits, beer, wine sold for domestic consumption. TG13 Specific Tax \u2014 Telecommunications 15% Mobile/data/SMS packages; include telecom operator ID. TG14 Specific Tax \u2014 Digital Services 12% Streaming, SaaS, online advertising delivered to DRC clients. <p>These codes feed the canonical <code>tax_groups</code> manifest described in <code>spec/schema-tax-engine-1.md</code> (project root) and are enforced by the Tax Engine. Each invoice must carry a <code>tax_summary</code> entry per group, and the device uses these to drive the Z/X/A reports.</p>"},{"location":"regulatory/sfe-specs/#required-reports","title":"Required Reports","text":"Report Purpose Trigger Z Report Daily closure with totals per tax group, fiscal number range, and journal hash. End-of-day or manual closure; device-initiated. X Report Periodic/session snapshot with counts, totals by payment method, and device health. Configurable (hourly/shift) for operators or auditors. A Report Article-level detail, enumerating every line item with tax group, client classification, and invoice reference. On-demand for audits or DGI requests. Audit Export Full append-only journal (sales, voids, refunds, resets) sent in chunks for deep reconciliation. Scheduled (monthly/annual) or upon DGI request. <p>Report design lives in <code>design/docs/fiscal/reports.md</code>. The Z/X/A outputs also reinforce <code>design/docs/hardware/usb-device.md</code> because the device compiles them from its hash-chained journal and counters.</p>"},{"location":"regulatory/sfe-specs/#security-elements","title":"Security Elements","text":"Element Generated by Where referenced Sequential fiscal number USB Fiscal Memory device Printed on every receipt; enforced by the trusted counter in <code>design/docs/hardware/usb-device.md</code>. Device ID (DEF NID) USB Fiscal Memory device Identifies the outlet-level DEF in every response and sync payload. Authentication code DEF signature (e.g., ECDSA) The cryptographic signature stored in <code>design/docs/fiscal/security-elements.md</code>. Trusted timestamp DEF RTC Anchor for chronological integrity; the cloud sync agent uses it for ordering. QR code DEF (encoded fiscal number + auth code + timestamp) Exposed to inspectors and customers; verified by DGI and internal tools. <p>Every element comes from the DEF; the POS software may only display it. See <code>[Security Elements](../fiscal/security-elements.md)</code> for per-element verification rules and <code>[USB Fiscal Memory](../hardware/usb-device.md)</code> for how the hardware produces them.</p>"},{"location":"regulatory/sfe-specs/#offline-behavior-dgi-integration","title":"Offline Behavior &amp; DGI Integration","text":"<p>The specification emphasizes that offline issuance is normal. Invoices must still contain security elements, and the SFE must sync with the MCF/e-MCF control modules once connectivity returns. A dedicated sync state machine ensures retries, grace periods, and conflict resolution:</p> <ul> <li><code>design/docs/cloud/offline-sync.md</code> documents how invoices transition from <code>PENDING_SYNC</code> to <code>ACKNOWLEDGED</code> or <code>FAILED</code>.</li> <li><code>design/docs/cloud/dgi-integration.md</code> captures the known vs unknown pieces of the MCF/e-MCF API and highlights the remaining blockers for homologation.</li> </ul> <p>This layered behavior mirrors the core architecture described in this spec: canonical payloads flow through the fiscal service to the DEF, then the sealed invoice flows through Bono Pay Cloud to the DGI control modules before arriving at the backend.</p>"},{"location":"regulatory/sfe-specs/#data-integrity-immutability-and-mutations","title":"Data Integrity, Immutability, and Mutations","text":"<p>The SFE must never delete invoices. Corrections are credit notes, voids are new fiscal events, and all entries remain in the device's hash-chained journal. These expectations appear in the Invoice Lifecycle narrative and the Architecture Context Map (<code>memory-bank/context-map.md</code> in the project root). Any mutation references the original invoice and replays through the same PREPARE \u2192 COMMIT sequence, ensuring auditability.</p> <p>This page is part of the regulatory view of the MkDocs site. For additional context, consult the DRC Legal Framework overview and the Arr\u00eat\u00e9 Summaries tabs.</p>"}]}