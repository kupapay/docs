{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"KutaPay Technical Design Documentation","text":"<p>KutaPay is fiscal compliance infrastructure for the DRC's Facture Normalis\u00e9e regime. These documents describe how untrusted POS front-ends, a trusted USB Fiscal Memory device, offline-first workflows, and cloud syncing collaborate to turn every commercial sale into a legally auditable tax event.</p> <p>The site collects architecture, hardware, fiscal engine, cloud, POS, regulatory, ADR, implementation, and API reference layers so the team can build aligned, compliant systems.</p>"},{"location":"#major-sections","title":"Major sections","text":"<ul> <li>Architecture: system overview, trust boundary, component map, and data flows.</li> <li>Hardware: USB device, 2PC protocol, secure element, and manufacturing guidance.</li> <li>Fiscal Engine: invoice lifecycle rules, tax engine, security elements, and reports.</li> <li>Cloud &amp; Sync: cloud architecture, offline-first sync logic, and DGI integration.</li> <li>POS Application: multi-terminal topology, UX principles, and integration strategy.</li> <li>Regulatory: DRC legal framework, arr\u00eat\u00e9 summaries, and SFE specifications.</li> <li>ADRs: architecture decision records with rationale.</li> <li>Implementation: roadmap and phased execution plans.</li> <li>API Reference: USB device commands, cloud endpoints, and POS plugin contracts.</li> </ul>"},{"location":"#how-to-use-this-documentation","title":"How to use this documentation","text":"<ol> <li>Navigate via the menu; each page will grow into its full design narrative.</li> <li>Start with the architecture section to understand trust boundaries, then work outward to hardware, fiscal engine, and cloud layers.</li> <li>Consult ADRs for formal decisions and the implementation pages for planning context.</li> <li>Search for keywords and use the \"Coming soon\" markers to identify work in progress.</li> </ol>"},{"location":"adr/","title":"ADR Index","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"adr/adr-0001/","title":"ADR 0001 - Two-Phase Commit","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"adr/adr-0002/","title":"ADR 0002 - Signature Algorithm","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"adr/adr-0003/","title":"ADR 0003 - POS Technology Stack","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"api/cloud/","title":"Cloud API","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"api/pos-plugin/","title":"POS Plugin API","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"api/usb-device/","title":"USB Device API","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"architecture/components/","title":"Component Map","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"architecture/data-flow/","title":"Data Flow","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>This page gives new developers a grounding in the KutaPay system: the POS clients that operate in untrusted spaces, the trusted USB Fiscal Memory device that enforces compliance, and the cloud services that consolidate audit data and relay sealed invoices to the DGI. The text below draws directly from the architecture specification, the technical design brief, and the Copilot instructions so that everyone touching the docs stays aligned with the trust boundary, offline-first, and security-element requirements.</p>"},{"location":"architecture/overview/#system-context-c4","title":"System Context (C4)","text":"<p>Developers joining the project must know who depends on KutaPay and what the platform communicates outward. Cashiers, outlet owners, and auditors interact with the platform directly, while sealed invoices leave the platform only once they are ready for the DGI or payment providers. This C4 context diagram keeps that actor-level view front and center.</p> <pre><code>flowchart LR\n    Cashier[\"Cashier / Teller\"]\n    Owner[\"Outlet Owner\"]\n    Auditor[\"Auditor / Regulator\"]\n    KutaPay[\"KutaPay Platform\\n(POS + Fiscal Service + Cloud)\"]\n    DGI[\"DGI MCF / e-MCF\"]\n    PaymentProviders[\"Payment Providers\"]\n    Cashier --&gt;|Issues fiscal invoice| KutaPay\n    Owner --&gt;|Monitors compliance| KutaPay\n    Auditor --&gt;|Requests reports &amp; audits| KutaPay\n    KutaPay --&gt;|Sealed invoice upload| DGI\n    KutaPay --&gt;|Payment events + status| PaymentProviders</code></pre>"},{"location":"architecture/overview/#trust-boundary","title":"Trust Boundary","text":"<p>The USB Fiscal Memory device is the only trusted execution point: it validates canonical payloads, increments the monotonic counter, signs the invoice, stores it immutably, and returns the security elements (fiscal number, device ID, signature, timestamp, QR). All POS/Cloud services, even the local fiscal service trusted to serialize commands, remain in the untrusted zone and must never claim those security elements as their own.</p> <p>Trust boundary enforcement</p> <p>Never let the POS or cloud fabric fabricate fiscal numbers, signatures, device IDs, or timestamps. The USB Fiscal Memory device is the sole source of truth; every canonical payload must be serialized, sent via the PREPARE \u2192 COMMIT handshake, and the sealed invoice (fiscal response) returned before any receipt is printed or uploaded.</p>"},{"location":"architecture/overview/#trust-boundary-diagram","title":"Trust boundary diagram","text":"<pre><code>flowchart LR\n    subgraph Untrusted Zone\n        POSApp[POS App + Sync Queue]\n        FiscalService[Local Fiscal Service\\n(tokenizes PREPARE/COMMIT)]\n    end\n    subgraph Trusted Zone\n        USBDevice[USB Fiscal Memory Device]\n    end\n    POSApp --&gt;|Canonical payload\\n(outlet_id + pos_terminal_id + cashier_id)| FiscalService\n    FiscalService --&gt;|PREPARE / COMMIT\\n\u3008nonce, deterministic JSON\u3009| USBDevice\n    USBDevice --&gt;|Fiscal response\\n(fiscal_number, auth_code, timestamp, QR)| FiscalService\n    FiscalService --&gt;|Sealed response / receipt print| POSApp\n    USBDevice --&gt;|Reports (Z/X/A + audit export)| POSApp</code></pre>"},{"location":"architecture/overview/#component-map","title":"Component Map","text":"<p>The layered component map spells out responsibilities: the POS layer collects items and tax details, the fiscal service mediates multi-terminal concurrency and serializes canonical payloads, the USB device enforces cryptographic seals and journaling, and the cloud layer stores sealed invoices, syncs when connectivity returns, and surfaces dashboards. The Mermaid map below emphasizes how data flows from the cashier through these layers.</p> <pre><code>graph LR\n    subgraph POS Layer\n        SaleEntry[Sale Entry + Tax UI]\n        ReceiptPrinter[Receipt Printer]\n        SyncQueue[Sync Queue]\n        TaxUI[Tax Engine UI]\n    end\n    subgraph Fiscal Service\n        CanonicalSerializer[Canonical Serializer]\n        MultiTermMediator[Multi-Terminal Mediator]\n        DeviceProxy[Device Proxy]\n        TaxCalculation[Tax Calculation Engine]\n    end\n    subgraph USB Device\n        SchemaValidator[Schema Validator]\n        MonotonicCounter[Monotonic Counter]\n        Signer[ECDSA Signer]\n        HashJournal[Hash-Chained Journal]\n        RTC[RTC / Trusted Timestamp]\n        ReportGen[Report Generator (Z/X/A, audit)]\n    end\n    subgraph Cloud Layer\n        CloudAPI[Cloud API &amp; Device Registry]\n        SyncEngine[Sync Engine + Invoice Store]\n        Dashboard[Dashboard]\n    end\n\n    SaleEntry --&gt; TaxCalculation\n    SaleEntry --&gt; CanonicalSerializer\n    TaxUI --&gt; CanonicalSerializer\n    CanonicalSerializer --&gt; MultiTermMediator\n    MultiTermMediator --&gt; DeviceProxy\n    DeviceProxy --&gt; SchemaValidator\n    SchemaValidator --&gt; MonotonicCounter\n    SchemaValidator --&gt; Signer\n    Signer --&gt; HashJournal\n    HashJournal --&gt; ReportGen\n    HashJournal --&gt; SyncEngine\n    ReportGen --&gt; Dashboard\n    SyncEngine --&gt; CloudAPI\n    CloudAPI --&gt; Dashboard</code></pre>"},{"location":"architecture/overview/#operational-notes","title":"Operational Notes","text":"<p>This architecture must stay offline-first: the local fiscal service queues canonical payloads, negotiates PREPARE/COMMIT with the USB device, and only after receiving the fiscal response does it let the POS print or sync. Multi-terminal outlets rely on the mediator to prevent nonce reuse and to tag every payload with <code>outlet_id</code>, <code>pos_terminal_id</code>, and <code>cashier_id</code> before the USB device increments its per-outlet counter. The cloud layer stores sealed invoices, uploads them in arrival order when connectivity returns, and exposes dashboards/reports to auditors. Every sealed invoice still includes the five mandatory security elements sourced from the trusted device, not the POS.</p>"},{"location":"architecture/trust-boundary/","title":"Trust Boundary","text":"<p>KutaPay enforces a deny-by-default trust boundary where every POS client, cloud sync agent, and auditor-facing UI lives in the untrusted zone, and the USB Fiscal Memory device (DEF) is the sole trusted authority that validates a canonical payload, signs it, increments the monotonic counters, and produces the fiscal response. The architectural rationale and the two-phase commit protocol are spelled out in <code>spec/architecture-kutapay-system-1.md</code> and <code>docs/adr/adr-0001-two-phase-commit-usb-protocol.md</code>.</p> <p>Trust boundary enforcement</p> <p>No data that can compromise fiscal integrity ever travels from the trusted zone back into the untrusted hosts. The DEF never releases private keys, raw counters, or hash-chain materials; hosts receive only the sealed fiscal response after a successful COMMIT.</p> <p>Architecture review findings</p> <ul> <li>The specification did not explicitly call out replay or nonce-expiry failure modes; the new documentation explains how the PREPARE nonce resists replay and why expired nonces force a fresh PREPARE before the device mutates state.</li> <li>Power/cable loss scenarios were present in ADR-0001 but lacked a boundary-level summary; this doc highlights each failure mode so integrators understand that no invoice leaves the device unless the COMMIT completes and a fiscal response is emitted.</li> </ul>"},{"location":"architecture/trust-boundary/#what-crosses-the-boundary","title":"What crosses the boundary","text":"<ol> <li>Canonical payloads \u2014 Every invoice starts as deterministic JSON (<code>merchant_nif</code>, <code>client</code> classification, <code>items[]</code>, <code>tax_groups[]</code>, outlet/POS/cashier IDs, <code>totals</code>, <code>timestamp</code>) generated by the untrusted POS and routed through the local fiscal service before ever touching the DEF (spec \u00a73.1, \u00a73.2).</li> <li>USB CDC 2PC handshake \u2014 The PREPARE/COMMIT messages, nonce challenge, and success/failure acknowledgments traverse the USB CDC connection; the DEF performs validation during PREPARE and atomic writes only when COMMIT arrives (ADR-0001 \u00a7Phase 1 &amp; 2).</li> <li>Sealed fiscal response \u2014 After the COMMIT succeeds the DEF emits <code>{fiscal_number, device_id, auth_code, timestamp, qr_payload}</code>. Hosts use this sealed response to print receipts, queue sealed invoices for cloud sync, and upload to the DGI, but nothing more trusted crosses back into the POS.</li> <li>Queued sealed invoices (cloud) \u2014 The untrusted cloud sync service transports only the DEF-generated payload to the DGI, preserving the sealed envelope without re-signing or altering contents (spec \u00a73.2, \u00a73.3).</li> </ol>"},{"location":"architecture/trust-boundary/#what-never-crosses-the-boundary","title":"What never crosses the boundary","text":"<ul> <li>Private keys or signing material \u2014 The secure element inside the DEF keeps the signing key locked down; no host ever sees it.</li> <li>Raw monotonic counters or journal data \u2014 Only the DEF can append to the hash-chained journal; hosts never read or increment counters directly.</li> <li>Unverified receipts \u2014 Receipts are printed only after the POS receives the fiscal response; hosts may not issue fiscalized receipts without the DEF\u2019s confirmation (ADR-0001 \u00a7Consequences).</li> <li>Vendor-side nonce management \u2014 The nonce generated during PREPARE lives in-device until COMMIT returns; the host cannot fabricate or replay a COMMIT without that nonce.</li> <li>Audit or internal health metrics \u2014 Command responses like <code>QRY|STATUS</code> surface derived, read-only views; the hosts cannot mutate device health directly.</li> </ul> <pre><code>flowchart LR\n    subgraph Untrusted POS Zone\n        POS[POS Clients&lt;br/&gt;Sale entry, Tax UI, Receipt Printer]\n        FS[Local Fiscal Service&lt;br/&gt;Serializes PREPARE/COMMIT + mediates multi-terminal access]\n    end\n    subgraph Trusted USB Zone\n        DEF[USB Fiscal Memory Device (DEF)&lt;br/&gt;Schema validator, Monotonic counter, Signer, Journal]\n    end\n    subgraph KutaPay Cloud\n        Cloud[Cloud Sync + Registry]\n    end\n    subgraph DGI\n        DGI[DGI (MCF/e-MCF)]\n    end\n    POS --&gt;|canonical JSON payload| FS\n    FS --&gt;|PREPARE / COMMIT over USB CDC| DEF\n    DEF --&gt;|fiscal response: fiscal_number, auth_code, timestamp, QR| FS\n    FS --&gt;|sealed invoice + security bundle| Cloud\n    Cloud --&gt;|sealed invoice upload| DGI</code></pre>"},{"location":"architecture/trust-boundary/#failure-modes-at-the-boundary","title":"Failure modes at the boundary","text":"<ol> <li>Power loss before COMMIT \u2014 The device never increments counters or writes to the journal during PREPARE. If power fails, the nonce expires and the POS must re-prepare; no fiscal number is issued (ADR-0001 \u00a7Failure Semantics).</li> <li>Power loss during COMMIT \u2014 Firmware must ensure COMMIT is atomic; either the journal append completes and the response is retrievable via <code>QRY|LOG</code>, or the device rolls back without altering counters (ADR-0001 \u00a7Implementation Notes IMP-002).</li> <li>Cable disconnect / host crash \u2014 The DEF never trusts the host; after a crash the host queries <code>QRY|STATUS</code>/<code>QRY|LOG</code> to reconcile. If COMMIT already succeeded, the sealed fiscal response remains the authoritative source for printing and syncing.</li> <li>Corrupt canonical payload \u2014 During PREPARE the DEF validates schema, tax groups, and deterministic ordering. Any mismatch results in rejection with a clear error, forcing the host to fix the payload before COMMIT (spec \u00a73.1, ADR-0001 \u00a7Phase 1).</li> <li>Replay or stale nonce \u2014 The nonce issued during PREPARE has a short TTL. If the host delays or re-sends a COMMIT after expiry, the DEF rejects it, resets to PREPARE, and logs the event for auditing (ADR-0001 \u00a7Implementation Notes IMP-001).</li> </ol>"},{"location":"architecture/trust-boundary/#trust-assumptions-table","title":"Trust assumptions table","text":"Assumption Enforcement The DEF is the only source of truth for fiscal numbers, signatures, and journals. Firmware limits counter mutations to COMMIT and writes the append-only journal, preventing remote hosts from altering state. Only canonical JSON payloads reach the DEF, and they include DGI-required fields and classifications. Local fiscal service serializes deterministic payloads (merchant NIF, client classification, tax group breakdown) before USB handoff (spec \u00a73.1, \u00a73.4). Hosts may not fabricate fiscal elements after the device replies. The fiscal response bundle carries every security element (number, auth code, timestamp, QR) that printers, cloud, and auditors rely on; any absence triggers denial of service from the device. Multi-terminal environments share one DEF per outlet. The fiscal service gates access with the nonce-based 2PC handshake, serializing requests and preventing simultaneous counter consumption (spec \u00a73.3, ADR-0001 \u00a7Consequences). Audit stakeholders trust the device for reports (Z/X/A) and history exports. The DEF generates reports from its hash-chained journal and exports data via dedicated commands (<code>RPT|Z</code>, <code>RPT|X</code>, <code>RPT|A</code>, <code>ADM|DUMPLOG</code>)."},{"location":"architecture/trust-boundary/#next-steps","title":"Next steps","text":"<p>Continue to tie these trust rules into the hardware and protocol docs (Tasks 006\u2013011) so that future integrators understand that anything crossing the blue/red border above must go through the PREPARE\u2192COMMIT handshake, while nothing trusted ever leaks back into the hosts.</p>"},{"location":"cloud/architecture/","title":"Cloud Architecture","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"cloud/dgi-integration/","title":"DGI Integration","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"cloud/offline-sync/","title":"Offline-First Sync","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"fiscal/invoice-lifecycle/","title":"Invoice Lifecycle","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"fiscal/reports/","title":"Reports (Z/X/A)","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"fiscal/security-elements/","title":"Security Elements","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"fiscal/tax-engine/","title":"Tax Engine (14 Groups)","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"hardware/bom/","title":"BOM &amp; Manufacturing","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"hardware/protocol/","title":"USB Protocol (2PC)","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"hardware/secure-element/","title":"Secure Element","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"hardware/usb-device/","title":"USB Fiscal Memory","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"implementation/phase-1/","title":"Phase 1 - B2B Pilot","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"implementation/phase-2/","title":"Phase 2 - Retail","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"implementation/phase-3/","title":"Phase 3 - Enterprise","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"implementation/roadmap/","title":"Implementation Roadmap","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"pos/integrations/","title":"Integrations","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"pos/multi-terminal/","title":"Multi-Terminal","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"pos/ui-ux/","title":"UI/UX","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"regulatory/arretes/","title":"Arr\u00eat\u00e9 Summary","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"regulatory/legal-framework/","title":"DRC Legal Framework","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"regulatory/sfe-specs/","title":"SFE Specifications","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"}]}