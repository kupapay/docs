{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Bono Pay Technical Design Documentation","text":"<p>Bono Pay is fiscal invoicing infrastructure for the DRC's Facture Normalis\u00e9e mandate. The platform creates, validates, signs, and synchronizes invoices in a software-first system that delivers fiscal numbers, cryptographic signatures, and trusted timestamps without requiring merchants to adopt bespoke hardware. Invoices are sealed by a cloud signing service backed by an HSM, then synced to the DGI while clients queue requests offline and deliver sealed receipts.</p> <p>The platform combines an API-first invoicing surface (REST + SDKs), a web dashboard, a cloud signing service backed by an HSM, and a resilient sync agent that delivers sealed invoices to the DGI. AI capabilities \u2014 natural language invoice creation, tax auto-classification, and anomaly detection \u2014 are embedded across the platform, while a public verification portal lets anyone confirm an invoice's authenticity by scanning its QR code. Each section below shows how Bono Pay enforces fiscal compliance while keeping the developer experience modern and familiar.</p>"},{"location":"#key-sections","title":"Key sections","text":"<ul> <li>Architecture: System overview, trust boundary, component map, and data flows that explain how client applications interact with the Cloud Signing Service, fiscal ledger, and DGI.</li> <li>Invoicing Platform: Product overview, API walkthrough, web dashboard experience, SDKs, multi-user controls, and AI-powered capabilities including natural language invoice creation, tax auto-classification, and anomaly detection.</li> <li>Fiscal Engine: Invoice lifecycle rules, the 14 DGI tax groups, canonical payload schema, mandatory security elements, reports (Z/X/A/audit), and public invoice verification via QR code or fiscal number.</li> <li>Cloud &amp; Sync: Cloud architecture, offline-first sync logic, resilience to connectivity loss, and DGI integration requirements.</li> <li>Platform &amp; Integrations: Multi-user/multi-tenant access controls, integration playbooks, and partner-ready libraries.</li> <li>Regulatory: DRC legal framework, arr\u00eat\u00e9 summaries, and SFE specifications that ground every compliance decision.</li> <li>ADRs: Authoritative decisions about architecture, signing, security, and platform strategy.</li> <li>Implementation: Roadmap, phase summaries, and execution guidance for shipping the software invoicing platform.</li> <li>API Reference: Open endpoints for invoice creation, listing, voiding, and refunding, plus SDK guidance for integrating with Bono Pay.</li> </ul>"},{"location":"#phase-roadmap-summary","title":"Phase roadmap summary","text":"<ol> <li>Phase 1 \u2013 Software Invoicing: API-first invoicing platform with cloud fiscal signing, tax engine coverage, and dashboard controls.</li> <li>Phase 2 \u2013 POS &amp; Retail: Multi-terminal retail/restaurant extensions with optional local fiscal services that coordinate with the cloud.</li> <li>Phase 3 \u2013 USB Hardware: Optional USB Fiscal Memory device for DEF homologation, serving as a trust anchor for high-compliance merchants.</li> <li>Phase 4 \u2013 Enterprise: ERP integrations, analytics, and scaling across outlets, fleets, and geographies.</li> </ol>"},{"location":"#design-principles-inspired-by-the-odoo-lessons","title":"Design principles (inspired by the Odoo lessons)","text":"<ul> <li>Offline-first confidence: Clients can cache catalogs and queue requests, but fiscal finality is achieved via the cloud signing service once connectivity returns.</li> <li>PWA-friendly: Build the dashboard and POS clients as progressive web apps that load fast, work across devices, and feel native on tablets.</li> <li>Mobile-optimized: Prioritize the lowest-cost Android tablets, large touch targets, and minimal text entry so merchant staff can move quickly.</li> <li>Multi-currency (CDF/USD): Support dual-currency pricing and payments out of the box, reflecting how DRC businesses operate day to day.</li> <li>Mobile money native: Embed Airtel Money, M-Pesa, Orange Money, and similar providers into the payment flow as first-class citizens.</li> </ul>"},{"location":"#how-to-use-this-documentation","title":"How to use this documentation","text":"<ol> <li>Start with the Architecture section to internalize the trust boundary between untrusted clients and the Cloud Signing Service.</li> <li>Explore the Invoicing Platform, Fiscal Engine, and Cloud &amp; Sync pages to understand the lifecycle of a sealed invoice.</li> <li>Consult the Regulatory and ADR folders when you need compliance rationale or formal decisions.</li> <li>Drop into Implementation and API Reference when planning integrations, rollouts, or partner onboarding.</li> </ol>"},{"location":"adr/","title":"Architecture Decision Records","text":"<p>The ADR process</p> <p>Architectural Decision Records (ADRs) capture important design trade-offs so the team can revisit the reasoning long after a decision is made. 1. Draft the full record in <code>docs/adr/</code> with the canonical template (Context \u2192 Decision \u2192 Consequences \u2192 References). 2. Link the ADR to the relevant design area (architecture, cloud, fiscal, etc.) and include status badges (<code>Accepted</code>, <code>Proposed</code>, <code>Superseded</code>). 3. Raise a new ADR as soon as a decision affects the trust boundary, protocol, signing infrastructure, or regulatory compliance; reference the implementation plan task that triggered it.</p>"},{"location":"adr/#current-decisions","title":"Current decisions","text":"ADR Status Summary ADR-0001: Two-Phase Commit Accepted Enforces the 2PC PREPARE \u2192 COMMIT handshake for the USB Fiscal Memory device protocol. Relevant to Phase 3 (USB Hardware). ADR-0002: Signature Algorithm Selection Accepted Adopts ECDSA P-256 for all invoice signatures \u2014 used by both the Cloud Signing Service (HSM) and the USB Fiscal Memory device (Phase 3). ADR-0003: Platform Technology Stack Accepted Selects REST API + Web Dashboard + Client SDKs (JavaScript / Python) as the platform stack, replacing the original PWA + local fiscal daemon architecture. ADR-0004: Cloud Fiscal Signing (HSM) Accepted Adopts an HSM-backed Cloud Signing Service as the primary fiscal authority for Phase 1+, with the USB Fiscal Memory device as an optional alternative signer in Phase 3. ADR-0005: Strategic Pivot \u2014 API-First Accepted Documents the decision to pivot from POS-hardware-first to an API-first invoicing platform with phased hardware introduction. <p>Add new ADRs by copying this page, updating the table, and linking to the supporting docs. Keep the \"Status\" column in sync with the implementation plan so readers can trace acceptance and deployment milestones.</p>"},{"location":"adr/adr-0001/","title":"ADR 0001 - Two-Phase Commit","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"adr/adr-0002/","title":"ADR-0002: Signature Algorithm Selection","text":""},{"location":"adr/adr-0002/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"adr/adr-0002/#context","title":"Context","text":"<ul> <li>The USB Fiscal Memory device and its Secure Element are the only components that ever see the private signing key (design/docs/hardware/secure-element.md). Nothing outside the SE can derive, export, or clone this key, so the algorithm must be supported inside the sealed chip.</li> <li>The Secure Element review already evaluated ECDSA P-256 versus Ed25519 and concluded that the family we selected (ATECC608B / SE050) already accelerates P-256 and matches the curve used on existing fiscal certificates. Ed25519 is treated as a future-proof option pending regulatory and vendor certification, while RSA is too heavy for the MCU (design context + DISCUSSION.md lines 7285-7400 explain why hardware is mandated).</li> <li>The DGI has not published a mandatory signature algorithm, but inspectors expect curves compatible with earlier fiscal memories and want minimal signature payloads on receipts.</li> </ul>"},{"location":"adr/adr-0002/#options","title":"Options","text":"<ol> <li>ECDSA P-256 (current baseline) </li> <li>Pros: Hardware acceleration available in ATECC608B/SE050; produces 64-byte signatures that fit on receipts and QR codes; aligns with curves used in existing fiscal certificates; familiar to auditors.  </li> <li> <p>Cons: Requires careful nonce and counter governance inside the SE, but that logic already exists.</p> </li> <li> <p>Ed25519 (future option) </p> </li> <li>Pros: Smaller signature size (64 bytes) with faster signing on modern SEs; better resilience to some side-channel attacks; easier canonicalization.  </li> <li> <p>Cons: Not yet certified by the SE vendor for our hardware, and the DGI has not approved the curve; adopting it would force a platform change and additional regulatory work.</p> </li> <li> <p>RSA-2048 </p> </li> <li>Pros: Very mature and widely understood by regulators.  </li> <li>Cons: Signature payloads are large (&gt; 256 bytes), which burdens QR codes and receipts; signing performance is poor on constrained MCUs; the SEs we selected (ATECC608B/SE050) are optimized for ECC, not RSA.</li> </ol>"},{"location":"adr/adr-0002/#rationale","title":"Rationale","text":"<p>ECDSA P-256 is the most practical choice today because it is natively accelerated by the Secure Element family we already selected, matches the public curve seen in the current fiscal authorities\u2019 certificates, and keeps signature sizes manageable for receipts and QR codes (design/docs/hardware/secure-element.md). The activation flow (<code>CFG|INIT</code>) and journal signing flow already assume this curve, so switching algorithms would require new protocol definitions and resets of the counter/nonce governance. Ed25519 remains a candidate for later phases once the vendor and DGI certify support, while RSA is ruled out because of its performance and payload penalties.</p>"},{"location":"adr/adr-0002/#decision","title":"Decision","text":"<p>Adopt ECDSA P-256 as the signature algorithm for all invoices signed by the USB Fiscal Memory device. The SE will generate the key pair on-device, enforce the PREPARE \u2192 COMMIT lifecycle, and never expose the private key.</p>"},{"location":"adr/adr-0002/#consequences","title":"Consequences","text":"<ul> <li>Downstream systems (receipts, cloud, auditors) can rely on 64-byte signatures produced by the SE and validated against the public certificate presented during <code>QRY|STATUS</code>.</li> <li>If future hardware or regulatory changes require another curve (e.g., Ed25519), we will document the migration in a new ADR and revise the USB protocol accordingly, including updates to nonce expiry and journal verification logic.</li> </ul>"},{"location":"adr/adr-0003/","title":"ADR-0003: Platform Technology Stack","text":""},{"location":"adr/adr-0003/#decision-2026-02-17-revised-2026-06-01","title":"Decision - 2026-02-17 (revised 2026-06-01)","text":"<p>Decision: Build Bono Pay as a cloud-first invoicing platform with a REST API, web dashboard, and client SDKs (JavaScript / Python) \u2014 replacing the original PWA + local fiscal daemon architecture that assumed USB hardware from day one.</p> <p>Context: - The strategic pivot (see ADR-0005) moves Bono Pay from a POS-hardware-first product to an API-first invoicing platform (think Stripe Invoices for DRC fiscal compliance). Phase 1 targets B2B service companies, wholesalers, and schools that need sealed fiscal invoices without deploying POS terminals or USB devices. - The Cloud Signing Service (HSM) is the trusted fiscal authority in Phase 1. Client applications are untrusted \u2014 they submit canonical payloads and receive sealed responses containing fiscal numbers, signatures, timestamps, and QR codes. - The platform must support two client surfaces from launch: a REST API for programmatic integrations and a web dashboard for manual invoice management. - Offline-first remains non-negotiable: client apps queue unsigned drafts locally (IndexedDB/Service Worker for web, SQLite for SDKs) and submit them when connectivity returns. Fiscalization only happens in the cloud. - Phase 2 adds POS terminals as API consumers. Phase 3 optionally introduces the USB Fiscal Memory device (DEF) as an alternative signer. The technology stack must accommodate these future layers without rearchitecture.</p> <p>Options: 1. REST API + Web Dashboard + Client SDKs (selected)    - Pros: Fastest path to market for B2B pilot. REST API is universally understood and integrates with any language or ERP. Web dashboard provides immediate value without installation. SDKs (JavaScript, Python) abstract API complexity and enable offline queuing. Cloud HSM centralizes the trust boundary \u2014 no local daemon needed for Phase 1.    - Cons: Requires cloud infrastructure from day one (HSM, database, sync agent). No offline fiscalization until Phase 3 introduces the DEF.</p> <ol> <li>PWA + Local Fiscal Daemon (original architecture)</li> <li>Pros: Enables offline fiscalization via the USB device. Single codebase runs on tablets, phones, and desktops.</li> <li> <p>Cons: Requires USB hardware from day one, which delays market entry. Local daemon adds deployment complexity. Not suitable for API-first B2B integrations (service companies, schools). Assumes POS UX that most Phase 1 customers don't need.</p> </li> <li> <p>GraphQL API instead of REST</p> </li> <li>Pros: Flexible querying for complex invoice structures. Single endpoint simplifies versioning.</li> <li> <p>Cons: Adds complexity for simple CRUD operations. Tooling ecosystem is smaller in the DRC developer community. Over-engineering for the current feature set.</p> </li> <li> <p>Mobile-first native apps (iOS/Android)</p> </li> <li>Pros: Best mobile UX. Direct access to device hardware (camera for QR scanning, NFC).</li> <li>Cons: Two codebases to maintain. App store distribution delays updates. Most Phase 1 customers (B2B) prefer web/API access over mobile apps.</li> </ol> <p>Rationale: The REST API + Web Dashboard + SDKs stack aligns with the API-first strategy. It delivers the fastest path to the B2B pilot (Phase 1) without requiring USB hardware or POS terminals. The cloud HSM centralizes the trust boundary, eliminating the need for a local fiscal daemon in Phase 1. JavaScript and Python SDKs cover the majority of integration scenarios in the DRC market. The web dashboard (built as a standard SPA) provides immediate value for merchants who prefer manual invoice management. This stack naturally extends to Phase 2 (POS terminals become API consumers) and Phase 3 (USB device proxy communicates with the same Cloud API).</p> <p>Impact: - Cloud infrastructure (HSM, PostgreSQL, Redis, message queue) must be provisioned and secured from Phase 1. - REST API design follows the canonical payload contract documented in <code>api/cloud.md</code>. - Web dashboard is a standard SPA (React or Vue) that consumes the same REST API as external integrators. - SDKs implement offline queuing (IndexedDB/SQLite), idempotency (payload hash + <code>Idempotency-Key</code> header), and automatic retry logic. - The local fiscal daemon from the original architecture is deferred to Phase 3 as the USB Device Proxy, scoped to outlets that opt into DEF signing.</p> <p>Review: Reevaluate if Phase 1 pilot feedback indicates that offline fiscalization (without cloud connectivity) is a hard requirement for the initial market segment, which would accelerate Phase 3 USB hardware delivery.</p>"},{"location":"adr/adr-0004/","title":"ADR-0004: Cloud Fiscal Signing (HSM)","text":""},{"location":"adr/adr-0004/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"adr/adr-0004/#context","title":"Context","text":"<ul> <li>The DRC's Facture Normalis\u00e9e regime requires every commercial invoice to carry five security elements: sequential fiscal number, fiscal authority ID, cryptographic authentication code, trusted timestamp, and QR code (see <code>fiscal/security-elements.md</code>).</li> <li>The original architecture assumed that a USB Fiscal Memory device (DEF) would generate these elements locally at each point of sale. This approach requires hardware procurement, firmware development, DGI homologation, and physical deployment to every merchant outlet before any invoices can be sealed \u2014 a 9\u201312 month critical path.</li> <li>Bono Pay's Phase 1 targets B2B service companies, wholesalers, and schools that generate invoices from web dashboards and API integrations. These users do not operate POS terminals and have no need for local USB hardware.</li> <li>An HSM-backed cloud signing service can deliver the same five security elements without requiring local hardware. The Cloud Signing Service becomes the trusted fiscal authority: it assigns fiscal numbers via a Monotonic Counter Manager, signs payloads with ECDSA P-256 keys stored in the HSM, generates trusted timestamps from NTP-synced infrastructure, and produces verification QR codes.</li> </ul>"},{"location":"adr/adr-0004/#options","title":"Options","text":"<ol> <li>Cloud Signing Service (HSM) as primary fiscal authority (selected)</li> <li>Pros: Zero hardware dependency for Phase 1. Fastest path to market. Centralized key management eliminates key distribution complexity. Monotonic Counter Manager with serializable database isolation guarantees sequential fiscal numbering even under concurrent multi-terminal load. Cloud HSMs (AWS CloudHSM, Azure Dedicated HSM, or self-hosted) provide FIPS 140-2 Level 3 key protection. All fiscalization logic is centralized, simplifying audits.</li> <li> <p>Cons: Requires internet connectivity for fiscalization (mitigated by offline queuing \u2014 unsigned drafts are submitted when connectivity returns). Cloud infrastructure must be highly available and secure. No offline fiscalization until Phase 3 introduces the optional DEF.</p> </li> <li> <p>USB Fiscal Memory device (DEF) as day-one requirement (original architecture)</p> </li> <li>Pros: Enables offline fiscalization at the point of sale. Aligns with traditional DGI expectations for hardware-based fiscal memory. Keys never leave the device.</li> <li> <p>Cons: 9\u201312 month delay for firmware development, supply chain, and DGI homologation. Per-device cost ($10\u201315 BOM) creates a barrier for B2B pilot. Not needed by Phase 1's target segment (service companies, schools). Physical deployment and maintenance complexity in DRC conditions.</p> </li> <li> <p>Software-only signing (no HSM)</p> </li> <li>Pros: Simplest implementation \u2014 signing keys stored in application memory or encrypted at rest.</li> <li>Cons: Keys are exposed to the application runtime, violating the trust boundary principle. No hardware-backed key protection. Would not satisfy DGI expectations for tamper-resistant signing. Unacceptable security posture for fiscal infrastructure.</li> </ol>"},{"location":"adr/adr-0004/#decision","title":"Decision","text":"<p>Adopt an HSM-backed Cloud Signing Service as the primary fiscal authority for Phase 1 (and beyond). The Cloud Signing Service:</p> <ul> <li>Stores ECDSA P-256 signing keys inside an HSM boundary; keys never leave the HSM.</li> <li>Assigns sequential fiscal numbers via the Monotonic Counter Manager using serializable database isolation (<code>SELECT ... FOR UPDATE</code> within a serializable transaction).</li> <li>Signs canonical payloads and returns sealed responses containing all five security elements.</li> <li>Generates verification QR codes encoding <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, and verification URL.</li> <li>Writes every sealed invoice to the append-only, hash-chained Fiscal Ledger.</li> </ul> <p>In Phase 3, the USB Fiscal Memory device (DEF) is introduced as an optional alternative signer for merchants requiring DGI hardware homologation. Both signers produce structurally identical sealed responses and write to the same Fiscal Ledger.</p>"},{"location":"adr/adr-0004/#consequences","title":"Consequences","text":"<ul> <li>Client applications (web dashboard, REST API, SDKs) are untrusted. They submit canonical payloads and receive sealed responses. They may display security elements but never fabricate them.</li> <li>Internet connectivity is required for fiscalization. Clients queue unsigned drafts locally (IndexedDB, SQLite) and submit them when online. The Cloud Signing Service is the only entity that can produce valid fiscal numbers and signatures.</li> <li>Cloud HSM infrastructure must meet high availability targets (99.9%+ uptime). Key ceremony, backup, and rotation procedures must be documented.</li> <li>The Monotonic Counter Manager must handle concurrent requests from multiple outlets without producing gaps or duplicates in fiscal numbering sequences.</li> <li>Phase 3's USB Device Proxy communicates with the same Cloud API, routing payloads to the local DEF instead of the Cloud HSM based on outlet configuration.</li> <li>If the DGI mandates hardware-based signing for all merchants (not just those seeking DEF homologation), Phase 3 delivery must be accelerated.</li> </ul>"},{"location":"adr/adr-0004/#review","title":"Review","text":"<p>Reevaluate if: (1) the DGI publishes regulations that explicitly require hardware-based signing for all merchants, (2) Phase 1 pilot merchants report that cloud-only connectivity is insufficient for their operations, or (3) HSM infrastructure costs exceed projections and a hybrid approach becomes more economical.</p>"},{"location":"adr/adr-0005/","title":"ADR-0005: Strategic Pivot \u2014 API-First Invoicing Platform","text":""},{"location":"adr/adr-0005/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"adr/adr-0005/#context","title":"Context","text":"<ul> <li>Bono Pay was originally designed as a POS-hardware-first product: a Progressive Web App paired with a USB Fiscal Memory device (DEF) at every point of sale. The USB device was the trusted fiscal authority, signing invoices locally via the PREPARE \u2192 COMMIT protocol. The cloud layer existed primarily to sync sealed invoices to the DGI.</li> <li>After initial design work (42-task implementation plan, UX wireframes, hardware specifications, protocol definitions), the team concluded that the hardware-first approach created an unacceptable time-to-market delay:<ul> <li>USB firmware development, secure element integration, and DGI homologation require 9\u201312 months before any merchant can issue a single fiscal invoice.</li> <li>Per-device BOM cost ($10\u201315) and physical deployment logistics create barriers for the initial pilot.</li> <li>The Phase 1 target segment (B2B service companies, wholesalers, schools) generates invoices from accounting software and web interfaces \u2014 they do not operate POS terminals and have no use for USB hardware.</li> </ul> </li> <li>Competitor analysis shows that similar fiscal compliance platforms in other markets (Rwanda's EBM, Kenya's TIMS) have succeeded with cloud-first approaches, adding hardware options later for specific retail segments.</li> </ul>"},{"location":"adr/adr-0005/#options","title":"Options","text":"<ol> <li>Pivot to API-first invoicing platform with phased hardware introduction (selected)</li> <li>Phase 1: Cloud Signing Service (HSM) as the trusted fiscal authority. REST API + web dashboard + SDKs for B2B pilot.</li> <li>Phase 2: Add POS SDK and mobile money for retail segment. POS terminals are API consumers, not USB mediators.</li> <li>Phase 3: Introduce USB Fiscal Memory device (DEF) as an optional alternative signer for merchants requiring DGI hardware homologation.</li> <li>Phase 4: Enterprise features \u2014 ERP connectors, fleet management, analytics.</li> <li>Pros: Fastest path to market (3 months to Phase 1 pilot). Addresses the largest segment first (B2B). Cloud HSM delivers the same five security elements without hardware. USB hardware remains available for merchants that need it.</li> <li> <p>Cons: No offline fiscalization until Phase 3. Requires cloud infrastructure investment from day one.</p> </li> <li> <p>Continue with hardware-first approach (original plan)</p> </li> <li>Pros: Offline fiscalization from day one. Full DGI hardware compliance.</li> <li> <p>Cons: 9\u201312 month delay. Hardware supply chain risk. Misaligned with Phase 1 target segment. Higher upfront capital required.</p> </li> <li> <p>Hybrid: ship cloud and hardware in parallel</p> </li> <li>Pros: Both segments addressed simultaneously.</li> <li>Cons: Doubles the team's focus and development surface. Risk of shipping neither well. Same hardware timeline constraints apply.</li> </ol>"},{"location":"adr/adr-0005/#decision","title":"Decision","text":"<p>Pivot Bono Pay from a POS-hardware-first product to an API-first fiscal invoicing platform (think Stripe Invoices for DRC). The phasing is:</p> Phase Name Duration Trust anchor 1 Software Invoicing 3 months Cloud Signing Service (HSM) 2 POS &amp; Retail 3 months Cloud Signing Service (HSM) 3 USB Hardware 6 months Cloud HSM + optional DEF 4 Enterprise &amp; Integrations 6 months Cloud HSM + optional DEF <p>The Cloud Signing Service (HSM) is the primary fiscal authority from Phase 1 onward. The USB Fiscal Memory device becomes an optional trust anchor in Phase 3, not a prerequisite. All hardware design documents are preserved in <code>docs-archive/hardware/</code> for Phase 3 reference.</p>"},{"location":"adr/adr-0005/#consequences","title":"Consequences","text":"<ul> <li>Architecture: The cloud is the trusted half; client apps are untrusted. The Cloud Signing Service, Fiscal Ledger, and Monotonic Counter Manager are the core fiscal components. The USB device proxy is deferred to Phase 3.</li> <li>Documentation: All existing docs are rewritten for the cloud-first model. POS-specific docs (<code>pos/multi-terminal.md</code>, <code>pos/ui-ux.md</code>, <code>pos/integrations.md</code>, <code>api/pos-plugin.md</code>) are archived to <code>docs-archive/</code>. ADR-0003 is revised from \"POS Technology Stack\" to \"Platform Technology Stack.\"</li> <li>Product identity: Bono Pay is positioned as fiscal invoicing infrastructure (like Stripe Invoices), not a POS system. Marketing, sales, and documentation reflect this identity.</li> <li>Risk: If the DGI mandates hardware-based fiscal signing for all merchants before Phase 3, the USB development timeline must be accelerated. The cloud-first architecture is designed to accommodate the DEF as a drop-in alternative signer without rearchitecture.</li> <li>Team focus: Phase 1 development focuses entirely on cloud infrastructure, REST API, web dashboard, and SDKs. No hardware or firmware work until Phase 3.</li> </ul>"},{"location":"adr/adr-0005/#review","title":"Review","text":"<p>Reevaluate if: (1) Phase 1 pilot feedback reveals that the target segment requires offline fiscalization, (2) the DGI publishes regulations mandating hardware-only fiscal signing, or (3) a competitor captures the B2B segment before Bono Pay reaches market.</p>"},{"location":"api/cloud/","title":"Cloud API Reference","text":"<p>The Bono Pay Cloud API is the primary interface for creating fiscalized invoices, querying their status, generating reports, and managing outlets. All client applications (web dashboard, REST API consumers, SDKs) interact with the platform through this API.</p> <p>Security by design</p> <p>All endpoints require TLS 1.3+, <code>Authorization: Bearer &lt;api_key&gt;</code>, and the <code>X-Bono-Outlet-ID</code> header to scope requests to a specific outlet. Never accept payloads with missing canonical fields or unauthorized API keys.</p>"},{"location":"api/cloud/#key-endpoints","title":"Key Endpoints","text":"Endpoint Method Purpose Response highlights <code>/api/v1/invoices</code> POST Submit a canonical payload for fiscalization <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>qr_payload</code> <code>/api/v1/invoices/{fiscal_number}</code> GET Retrieve a sealed invoice Full sealed payload + <code>dgi_status</code> <code>/api/v1/invoices/batch</code> POST Submit multiple payloads in one request Array of sealed responses <code>/api/v1/invoices/{fiscal_number}/status</code> GET Check DGI sync status <code>dgi_status</code>, <code>acknowledged_at</code> <code>/api/v1/outlets</code> POST Register a new outlet <code>outlet_id</code>, <code>fiscal_authority_id</code> <code>/api/v1/outlets/{outlet_id}/status</code> GET Check outlet health and counter <code>next_fiscal_number</code>, <code>pending_sync</code>, <code>status</code> <code>/api/v1/reports</code> POST Generate Z/X/A reports <code>report_id</code>, <code>download_url</code> <code>/api/v1/audit/export</code> GET Download hash-chained journal exports <code>ledger_hash</code>, <code>entries</code>, signed downloads <code>/api/v1/webhooks</code> POST Register a webhook endpoint <code>webhook_id</code>, <code>events</code>, <code>active</code> <code>/api/v1/api-keys</code> POST Create a scoped API key <code>api_key_id</code>, <code>key</code>, <code>scopes</code> <code>/api/v1/verify/{fiscal_number}</code> GET Public \u2014 verify a sealed invoice by fiscal number + auth code <code>status</code>, <code>signature_valid</code>, <code>dgi_status</code> <code>/api/v1/verify/qr</code> POST Public \u2014 verify by QR payload data Same as above <code>/api/v1/verify/batch</code> POST Bulk-verify multiple invoices (authenticated) Array of verification results <p>Specification reference</p> <p>The endpoint request/response schema definitions are based on <code>spec/design-cloud-api-1.md</code> (project root).</p>"},{"location":"api/cloud/#example-create-invoice","title":"Example: Create Invoice","text":"<pre><code>POST /api/v1/invoices\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\nX-Bono-Outlet-ID: OUTLET-001\nIdempotency-Key: hash_of_canonical_payload\n\n{\n  \"invoice_type\": \"sale\",\n  \"merchant_nif\": \"123456789\",\n  \"client\": {\n    \"name\": \"Acme Ltd\",\n    \"nif\": \"987654321\",\n    \"classification\": \"company\"\n  },\n  \"items\": [\n    {\n      \"sku\": \"SKU-001\",\n      \"description\": \"Consulting service\",\n      \"quantity\": 1,\n      \"unit_price\": 100000,\n      \"tax_group\": \"TG03\"\n    }\n  ],\n  \"tax_groups\": [\n    { \"code\": \"TG03\", \"base_amount\": 100000, \"rate\": 0.16, \"tax_amount\": 16000 }\n  ],\n  \"totals\": {\n    \"subtotal\": 100000,\n    \"tax\": 16000,\n    \"total\": 116000,\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    { \"method\": \"bank_transfer\", \"amount\": 116000, \"reference\": \"TXN-789\" }\n  ]\n}\n</code></pre> <p>Response (201 Created):</p> <pre><code>{\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"auth_code\": \"MEUCIQD8j2w8s...\",\n  \"timestamp\": \"2026-02-17T03:00:00Z\",\n  \"qr_payload\": \"https://verify.bonopay.cd/i?hash=...\",\n  \"dgi_status\": \"pending_sync\",\n  \"submitted_by\": {\n    \"type\": \"api_key\",\n    \"id\": \"KEY-abc123\"\n  }\n}\n</code></pre>"},{"location":"api/cloud/#example-generate-report","title":"Example: Generate Report","text":"<pre><code>POST /api/v1/reports\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\nX-Bono-Outlet-ID: OUTLET-001\n\n{\n  \"type\": \"Z\",\n  \"period\": { \"date\": \"2026-02-17\" },\n  \"include_ledger_hash\": true\n}\n</code></pre> <p>Response (200 OK):</p> <pre><code>{\n  \"report_id\": \"RPT-Z-OUTLET001-2026-02-17\",\n  \"type\": \"Z\",\n  \"download_url\": \"/api/v1/reports/RPT-Z-OUTLET001-2026-02-17/download\",\n  \"generated_at\": \"2026-02-17T23:58:30Z\",\n  \"ledger_hash\": \"3F9B-7A12-...\"\n}\n</code></pre>"},{"location":"api/cloud/#example-outlet-registration","title":"Example: Outlet Registration","text":"<pre><code>POST /api/v1/outlets\nContent-Type: application/json\nAuthorization: Bearer bono_owner_key\n\n{\n  \"merchant_nif\": \"123456789\",\n  \"name\": \"Acme Kinshasa Branch\",\n  \"address\": \"123 Boulevard du 30 Juin, Kinshasa\"\n}\n</code></pre> <p>Response (201 Created):</p> <pre><code>{\n  \"outlet_id\": \"OUTLET-001\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"next_fiscal_number\": 1,\n  \"status\": \"active\"\n}\n</code></pre>"},{"location":"api/cloud/#monitoring-endpoints","title":"Monitoring endpoints","text":"Endpoint Purpose <code>GET /api/v1/outlets/{outlet_id}/status</code> Returns sync health, pending invoice count, next fiscal number, and platform status. <code>GET /api/v1/sync/status</code> Exposes aggregate sync pipeline health: backlog, state, next retry timestamp. <code>GET /api/v1/audit/export</code> Returns the hash-chained Fiscal Ledger with signed <code>ledger_hash</code> plus downloadable artifacts for auditors."},{"location":"api/cloud/#error-handling","title":"Error handling","text":"Scenario HTTP status Error code Notes Invalid canonical payload 400 <code>INVALID_PAYLOAD</code> Missing required fields or tax group validation failure. Invalid signature / auth 401 <code>UNAUTHORIZED</code> API key invalid, expired, or revoked. Insufficient permissions 403 <code>INSUFFICIENT_PERMISSIONS</code> API key lacks the required scope for this operation. Outlet not found 404 <code>OUTLET_NOT_FOUND</code> The <code>X-Bono-Outlet-ID</code> does not match a registered outlet. Duplicate request 409 <code>DUPLICATE_PAYLOAD</code> <code>Idempotency-Key</code> matches an already-sealed invoice; returns the existing sealed response. Rate limit exceeded 429 <code>RATE_LIMIT_EXCEEDED</code> Retry after the duration specified in <code>Retry-After</code> header."},{"location":"api/cloud/#rate-limiting","title":"Rate limiting","text":"<ul> <li>Default: 100 requests/second per API key.</li> <li>Burst: up to 200 requests in a 1-second window.</li> <li>Rate limit headers: <code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, <code>X-RateLimit-Reset</code>.</li> </ul>"},{"location":"api/cloud/#notes","title":"Notes","text":"<ul> <li>Every invoice is traceable through <code>fiscal_number</code>, <code>outlet_id</code>, and <code>submitted_by</code> (user_id or api_key_id).</li> <li>Audit exports default to a 30-day window. Use <code>start_date</code> and <code>end_date</code> query parameters to customize.</li> <li>All endpoints emit structured logs (<code>bono.api.request</code>, <code>bono.api.response</code>) that include <code>outlet_id</code>, <code>fiscal_number</code>, and <code>dgi_status</code>.</li> </ul>"},{"location":"api/invoicing-sdk/","title":"Invoicing SDK Reference","text":"<p>The Bono Pay SDK provides client libraries for JavaScript and Python that wrap the Cloud API with type-safe models, built-in offline queuing, automatic retries, and receipt rendering helpers. Use the SDK when you want to integrate fiscal invoicing into your application without managing raw HTTP calls.</p>"},{"location":"api/invoicing-sdk/#installation","title":"Installation","text":"JavaScript (npm) <pre><code>npm install @bonopay/sdk\n</code></pre> Python (pip) <pre><code>pip install bonopay-sdk\n</code></pre>"},{"location":"api/invoicing-sdk/#quick-start","title":"Quick start","text":"JavaScript <pre><code>import { BonoPay } from '@bonopay/sdk';\n\nconst client = new BonoPay({\n  apiKey: process.env.BONO_API_KEY,\n  outletId: 'OUTLET-001',\n  // Enable offline queue (uses IndexedDB in browser, SQLite in Node.js)\n  offline: { enabled: true, gracePeriodMs: 24 * 60 * 60 * 1000 }\n});\n\n// Create a fiscalized invoice\nconst invoice = await client.invoices.create({\n  invoiceType: 'sale',\n  merchantNif: '123456789',\n  client: { name: 'Acme Ltd', nif: '987654321', classification: 'company' },\n  items: [\n    { sku: 'SKU-001', description: 'Consulting', quantity: 1, unitPrice: 100000, taxGroup: 'TG03' }\n  ],\n  payments: [\n    { method: 'bank_transfer', amount: 116000, reference: 'TXN-789' }\n  ]\n});\n\nconsole.log(invoice.fiscalNumber);  // \"BONO-OUTLET001-000123\"\nconsole.log(invoice.authCode);      // \"MEUCIQD8j2w8s...\"\nconsole.log(invoice.qrPayload);     // \"https://verify.bonopay.cd/i?hash=...\"\n</code></pre> Python <pre><code>from bonopay import BonoPay\n\nclient = BonoPay(\n    api_key=os.environ[\"BONO_API_KEY\"],\n    outlet_id=\"OUTLET-001\",\n    offline={\"enabled\": True, \"grace_period_seconds\": 86400}\n)\n\n# Create a fiscalized invoice\ninvoice = client.invoices.create(\n    invoice_type=\"sale\",\n    merchant_nif=\"123456789\",\n    client={\"name\": \"Acme Ltd\", \"nif\": \"987654321\", \"classification\": \"company\"},\n    items=[\n        {\"sku\": \"SKU-001\", \"description\": \"Consulting\", \"quantity\": 1, \"unit_price\": 100000, \"tax_group\": \"TG03\"}\n    ],\n    payments=[\n        {\"method\": \"bank_transfer\", \"amount\": 116000, \"reference\": \"TXN-789\"}\n    ]\n)\n\nprint(invoice.fiscal_number)  # \"BONO-OUTLET001-000123\"\nprint(invoice.auth_code)      # \"MEUCIQD8j2w8s...\"\n</code></pre>"},{"location":"api/invoicing-sdk/#core-modules","title":"Core modules","text":""},{"location":"api/invoicing-sdk/#clientinvoices","title":"<code>client.invoices</code>","text":"Method Description <code>create(payload)</code> Submit a canonical payload for fiscalization. Returns a sealed invoice with security elements. <code>get(fiscalNumber)</code> Retrieve a sealed invoice by fiscal number. <code>getStatus(fiscalNumber)</code> Check DGI sync status for a specific invoice. <code>list(filters?)</code> List invoices with optional filters (date range, status, client). <code>createBatch(payloads[])</code> Submit multiple payloads in one call. Returns array of sealed responses."},{"location":"api/invoicing-sdk/#clientreports","title":"<code>client.reports</code>","text":"Method Description <code>generate(type, period)</code> Generate a Z, X, or A report for the specified period. <code>download(reportId)</code> Download a generated report as PDF or JSON. <code>list(filters?)</code> List previously generated reports."},{"location":"api/invoicing-sdk/#clientaudit","title":"<code>client.audit</code>","text":"Method Description <code>export(options?)</code> Download the hash-chained Fiscal Ledger export."},{"location":"api/invoicing-sdk/#clientoutlets","title":"<code>client.outlets</code>","text":"Method Description <code>getStatus()</code> Check outlet health, next fiscal number, and sync status."},{"location":"api/invoicing-sdk/#clientwebhooks","title":"<code>client.webhooks</code>","text":"Method Description <code>register(config)</code> Register a webhook endpoint. <code>list()</code> List registered webhooks. <code>delete(webhookId)</code> Remove a webhook registration. <code>verifySignature(payload, signature, secret)</code> Verify webhook payload signature (HMAC-SHA256)."},{"location":"api/invoicing-sdk/#clientverify","title":"<code>client.verify</code>","text":"Method Description <code>verify(fiscalNumber, authCode)</code> Verify a sealed invoice via the public Verification API \u2014 no API key required. Returns <code>status</code>, <code>signature_valid</code>, <code>dgi_status</code>. <code>verifyQR(qrData)</code> Parse a QR code URL and verify the referenced invoice. <code>verifyBatch(invoices)</code> Bulk-verify an array of <code>{ fiscal_number, auth_code }</code> pairs (requires API key). <code>verifySignatureOffline(payload, signature, publicKey)</code> Verify the ECDSA signature locally without an API call \u2014 useful for auditors and air-gapped environments. <p>See Invoice Verification for the full verification flow, portal, and anti-abuse protections.</p>"},{"location":"api/invoicing-sdk/#offline-queue","title":"Offline queue","text":"<p>The SDK includes a built-in offline queue that automatically handles connectivity issues:</p> <pre><code>flowchart LR\n    App[\"Your Application\"] --&gt; SDK[\"Bono Pay SDK\"]\n    SDK --&gt;|Online| API[\"Cloud API\"]\n    SDK --&gt;|Offline| Queue[\"Local Queue\\n(IndexedDB / SQLite)\"]\n    Queue --&gt;|Connectivity restored| API\n    API --&gt; HSM[\"Cloud Signing Service\"]\n    HSM --&gt; Response[\"Sealed Invoice\"]</code></pre>"},{"location":"api/invoicing-sdk/#queue-behavior","title":"Queue behavior","text":"<ol> <li>When <code>offline.enabled</code> is <code>true</code>, the SDK intercepts failed API calls and stores payloads in the local queue.</li> <li>A background sync worker checks connectivity periodically (default: every 30 seconds).</li> <li>When online, queued payloads are submitted in creation order with idempotency keys.</li> <li>The <code>onSync</code> callback fires for each successfully sealed invoice.</li> <li>Payloads older than <code>gracePeriodMs</code> trigger an <code>onGracePeriodExceeded</code> warning.</li> </ol>"},{"location":"api/invoicing-sdk/#queue-events","title":"Queue events","text":"JavaScript <pre><code>client.on('queue:synced', (invoice) =&gt; {\n  console.log(`Invoice ${invoice.fiscalNumber} sealed after offline queue`);\n});\n\nclient.on('queue:failed', (error, payload) =&gt; {\n  console.error(`Failed to submit queued invoice: ${error.message}`);\n});\n\nclient.on('queue:grace-exceeded', (payload) =&gt; {\n  console.warn(`Draft has been queued for over ${payload.age}ms`);\n});\n</code></pre> Python <pre><code>@client.on(\"queue:synced\")\ndef on_synced(invoice):\n    print(f\"Invoice {invoice.fiscal_number} sealed after offline queue\")\n\n@client.on(\"queue:failed\")\ndef on_failed(error, payload):\n    print(f\"Failed to submit queued invoice: {error}\")\n</code></pre>"},{"location":"api/invoicing-sdk/#tax-engine-helpers","title":"Tax engine helpers","text":"<p>The SDK includes helpers for building valid tax summaries:</p> JavaScript <pre><code>import { TaxEngine } from '@bonopay/sdk';\n\nconst taxSummary = TaxEngine.calculate({\n  items: [\n    { unitPrice: 100000, quantity: 1, taxGroup: 'TG03' }\n  ],\n  clientClassification: 'company'\n});\n// Returns: { taxGroups: [{ code: 'TG03', baseAmount: 100000, rate: 0.16, taxAmount: 16000 }], totals: { ... } }\n</code></pre>"},{"location":"api/invoicing-sdk/#error-handling","title":"Error handling","text":"<p>The SDK throws typed errors for common scenarios:</p> Error class HTTP status Description <code>ValidationError</code> 400 Invalid payload (missing fields, bad tax group) <code>AuthenticationError</code> 401 Invalid or expired API key <code>PermissionError</code> 403 API key lacks required scope <code>NotFoundError</code> 404 Invoice or outlet not found <code>DuplicateError</code> 409 Idempotency key collision (returns existing invoice) <code>RateLimitError</code> 429 Rate limit exceeded (includes <code>retryAfter</code>) <code>NetworkError</code> \u2014 No connectivity (queued if offline mode enabled)"},{"location":"api/invoicing-sdk/#configuration","title":"Configuration","text":"Option Default Description <code>apiKey</code> \u2014 Required. Your Bono Pay API key. <code>outletId</code> \u2014 Required. The outlet to scope requests to. <code>baseUrl</code> <code>https://api.bonopay.cd</code> API base URL. <code>timeout</code> <code>30000</code> Request timeout in milliseconds. <code>offline.enabled</code> <code>false</code> Enable local offline queue. <code>offline.gracePeriodMs</code> <code>86400000</code> Grace period before warning (24h default). <code>offline.maxRetries</code> <code>10</code> Max retries per queued payload. <code>offline.storage</code> <code>auto</code> Storage backend: <code>indexeddb</code>, <code>sqlite</code>, or <code>auto</code>."},{"location":"architecture/components/","title":"Component Map","text":"<p>This page records the layered services, actors, and dependencies that deliver Bono Pay's software-first invoicing platform. It highlights how untrusted clients feed canonical payloads into the platform services, how the trusted fiscal core seals invoices, and how cloud infrastructure stores, syncs, and observes every fiscal event.</p> <p>Phase 1 trust boundary</p> <p>The Cloud Signing Service (HSM-backed) is the only trusted component in Phase 1. Clients (dashboard, API consumers, SDKs, and future POS integrations) remain untrusted, and every security element (fiscal number, auth code, timestamp, QR) originates inside the cloud. Phase 3 reserves the archived USB Fiscal Memory device as an optional trust anchor, but until DEF homologation is required the cloud signs and stores every invoice.</p>"},{"location":"architecture/components/#client-layer","title":"Client Layer","text":"<p>Bono Pay clients live in the untrusted zone. They prepare invoices with deterministic identifiers and tax data, queue drafts while offline, and hand canonical serializers the inputs that the platform services validate and fiscalize.</p> <ul> <li><code>Web Dashboard (PWA)</code> \u2014 Tablet-friendly interface with service workers, IndexedDB queues, simplified invoice entry, and status indicators (green/yellow/red) for fiscalization progress.</li> <li><code>API Consumers</code> \u2014 Backend integrations (ERPs, e-commerce, ERP connectors) that call the Invoicing API with canonical payloads, metadata (merchant_nif, outlet_id, pos_terminal_id), and source headers.</li> <li><code>SDK &amp; Libraries</code> \u2014 JavaScript/Python/PHP clients that enforce canonical ordering, handle offline queues (IndexedDB/SQLite), and surface callbacks for fiscalized/queued/error states.</li> <li><code>Mobile App (future PWA)</code> \u2014 Mobile-first UI that reuses the dashboard experience with push notifications and offline-first behavior.</li> <li><code>POS Integrations (Phase 2 preview)</code> \u2014 Legacy POS systems that will plug into the SDKs and delegate signing requests to Bono Pay Cloud instead of local hardware.</li> </ul>"},{"location":"architecture/components/#platform-services-layer","title":"Platform Services Layer","text":"<p>Platform services normalize, secure, and route every request before the fiscal core signs it. They convert raw user input into deterministic payloads, enforce multi-user policies, apply the tax engine, and deliver receipts.</p> <ul> <li><code>Canonical Serializer</code> \u2014 Produces deterministic JSON (merchant/outlet identifiers, timestamp, client, items, tax_groups, totals, payments) so the Cloud Signing Service can reproduce hashes and ledger entries.</li> <li><code>Invoicing API (REST)</code> \u2014 The developer-facing surface that handles authentication (merchant/outlet-scoped API keys), rate limiting, request validation, and orchestration of tax calculation + signing.</li> <li><code>Tax Calculation Engine (14 DGI groups)</code> \u2014 Computes per-tax-group amounts, client classification rules, and rounding adjustments before attaching totals to the canonical payload.</li> <li><code>Multi-User Access Control (API keys, roles, outlet scoping)</code> \u2014 Enforces quotas, roles (admin, invoicer, viewer, auditor), and source metadata so only authorized users can fiscalize invoices.</li> <li><code>Receipt Delivery (email/WhatsApp/PDF/print)</code> \u2014 Renders sealed invoices with fiscal numbers, auth codes, timestamps, and QR payloads for immediate customer delivery.</li> </ul>"},{"location":"architecture/components/#fiscal-core-layer-trusted","title":"Fiscal Core Layer (trusted)","text":"<p>The fiscal core contains the Cloud Signing Service and its supporting services that live behind the trust boundary.</p> <ul> <li><code>Cloud Signing Service (HSM)</code> \u2014 Assigns sequential fiscal numbers, generates authentication codes, anchors trusted timestamps, and builds QR payloads; all operations execute within the HSM so keys never leave the boundary.</li> <li><code>Monotonic Counter Manager</code> \u2014 Ensures strictly increasing fiscal numbers per outlet even with concurrent API/SDK/cashier activity via serializable database isolation.</li> <li><code>Hash-Chained Fiscal Ledger</code> \u2014 Appends every invoice, void, refund, and report entry with a prev-hash so auditors can verify immutability.</li> <li><code>Report Generator (Z/X/A + audit)</code> \u2014 Derives compliance reports from the ledger (fiscal number ranges, auth codes, tax group totals) and surfaces downloads through the dashboard or API.</li> </ul>"},{"location":"architecture/components/#cloud-infrastructure-layer","title":"Cloud Infrastructure Layer","text":"<p>Cloud infrastructure stores sealed invoices, uploads them to the DGI, and gives operators visibility while preserving backups.</p> <ul> <li><code>Sync Agent + Invoice Store</code> \u2014 Queues sealed invoices, retries uploads to the MCF/e-MCF endpoint when connectivity returns, and keeps a copy of every fiscal response for replays or audits.</li> <li><code>DGI Integration Agent (MCF / e-MCF)</code> \u2014 Dedicated connector that authenticates to the tax authority, packages sealed payloads, and records acknowledgments (<code>queued</code>, <code>synced</code>, <code>failed</code>).</li> <li><code>Merchant &amp; Outlet Registry</code> \u2014 Tracks which merchants, outlets, API keys, and POS integrations are active, their quotas, firmware versions (for future hardware), and metadata required by the fiscal core.</li> <li><code>Dashboard &amp; Analytics</code> \u2014 Observability layer for device health, backlog depth, report generation, and sync failures. It consumes metrics from the Invoicing API, Sync Agent, and ledger.</li> <li><code>Backup &amp; Archival</code> \u2014 Off-site snapshots of the fiscal ledger, report payloads, and DAG metadata so compliance teams can restore or audit historical data.</li> </ul>"},{"location":"architecture/components/#component-dependency-map","title":"Component Dependency Map","text":"<p>The diagram below shows how the client layer feeds canonical data into the platform services, how the fiscal core seals invoices, and how cloud infrastructure persists and syncs every fiscal event. The labels show the services mentioned above and their calling directions.</p> <pre><code>flowchart LR\n    subgraph \"Client Layer\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        APIConsumers[\"API Consumers\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        MobileApp[\"Mobile App (future)\"]\n        POSIntegrations[\"POS Integrations (Phase 2)\"]\n    end\n    subgraph \"Platform Services\"\n        Canonical[\"Canonical Serializer\"]\n        InvoicingAPI[\"Invoicing API (REST)\"]\n        TaxEngine[\"Tax Calculation Engine (14 DGI groups)\"]\n        MultiAccess[\"Multi-User Access Control (API keys, roles, outlets)\"]\n        Delivery[\"Receipt Delivery (email/WhatsApp/PDF/print)\"]\n    end\n    subgraph \"Fiscal Core (trusted)\"\n        CloudSigner[\"Cloud Signing Service (HSM)\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n    end\n    subgraph \"Cloud Infrastructure\"\n        SyncAgent[\"Sync Agent + Invoice Store\"]\n        DGI[\"DGI Integration Agent (MCF / e-MCF)\"]\n        Registry[\"Merchant &amp; Outlet Registry\"]\n        Analytics[\"Dashboard &amp; Analytics\"]\n        Backup[\"Backup &amp; Archival\"]\n        Payments[\"Notification &amp; Payment Partners\"]\n    end\n    Dashboard --&gt; Canonical\n    APIConsumers --&gt; Canonical\n    SDKs --&gt; Canonical\n    MobileApp --&gt; Canonical\n    POSIntegrations --&gt; Canonical\n    Canonical --&gt; InvoicingAPI\n    MultiAccess --&gt; InvoicingAPI\n    InvoicingAPI --&gt; TaxEngine\n    TaxEngine --&gt; CloudSigner\n    InvoicingAPI --&gt; CloudSigner\n    CloudSigner --&gt; Counter\n    CloudSigner --&gt; Ledger\n    Ledger --&gt; Reports\n    Reports --&gt; Delivery\n    Delivery --&gt; Payments\n    Ledger --&gt; SyncAgent\n    SyncAgent --&gt; DGI\n    Registry --&gt; SyncAgent\n    Registry --&gt; MultiAccess\n    Ledger --&gt; Analytics\n    Analytics --&gt; Backup\n    Reports --&gt; Analytics\n    Payments --&gt; Analytics</code></pre>"},{"location":"architecture/components/#cloud-deployment-diagram","title":"Cloud Deployment Diagram","text":"<p>This deployment diagram emphasizes the cloud services that fiscalize invoices, store them, and sync them to the DGI. Every client hits the Invoicing API, the Cloud Signing Service signs the payload, and the Sync Agent ships the ledger to the tax authority while analytics and payment partners observe the results.</p> <pre><code>flowchart TB\n    subgraph \"Client Edge\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        APIConsumers[\"API Consumers\"]\n    end\n    subgraph \"Cloud Services\"\n        InvoicingAPI[\"Invoicing API (REST)\"]\n        CloudSigner[\"Cloud Signing Service (HSM)\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        InvoiceStore[\"Invoice Store\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n        SyncAgent[\"Sync Agent (DGI / e-MCF)\"]\n        Analytics[\"Dashboard &amp; Analytics\"]\n    end\n    DGI[\"DGI (MCF / e-MCF)\"]\n    PaymentPartners[\"Payment &amp; Notification Partners\"]\n    Dashboard --&gt; InvoicingAPI\n    SDKs --&gt; InvoicingAPI\n    APIConsumers --&gt; InvoicingAPI\n    InvoicingAPI --&gt; CloudSigner\n    CloudSigner --&gt; Ledger\n    Ledger --&gt; InvoiceStore\n    Ledger --&gt; Reports\n    Reports --&gt; Analytics\n    InvoiceStore --&gt; Analytics\n    Ledger --&gt; SyncAgent\n    SyncAgent --&gt; DGI\n    Reports --&gt; PaymentPartners</code></pre>"},{"location":"architecture/data-flow/","title":"Data Flow Diagrams","text":"<p>Bono Pay paths prioritize a cloud-first fiscal authority. Every canonical payload (merchant_nif, outlet_id, pos_terminal_id, cashier_id, client, items, tax_groups, totals, payments, timestamp) flows through the Cloud Signing Service (HSM) before any fiscal number, signature, timestamp, or QR payload leaves the trusted zone. The diagrams below trace five operational flows described in the architecture specification and highlight how the fiscal ledger, tax engine, and sync agent collaborate with clients.</p> <p>Canonical payload &amp; trust boundary</p> <ul> <li>Clients (web dashboard users, API consumers, SDKs, future POS terminals) remain untrusted; they only present canonical JSON with deterministic field ordering.</li> <li>The Cloud Signing Service (HSM) is the sole authority that assigns fiscal numbers, generates authentication codes, timestamps, and QR payloads, and persists the hash-chained fiscal ledger.</li> <li>Sync Agent uploads sealed invoices to the DGI (MCF/e-MCF); clients may display the security elements but may never fabricate or mutate them.</li> </ul>"},{"location":"architecture/data-flow/#1-api-invoice-creation-happy-path","title":"1. API invoice creation (happy path)","text":"<p>Developers and automation systems call <code>POST /api/v1/invoices</code> to fiscalize a sale. The Bono Pay Invoicing API validates the payload, runs the 14-group tax engine, and forwards the result to the Cloud Signing Service. The signed response returns to the client immediately while the Sync Agent enqueues the ledger entry for the DGI.</p> <pre><code>sequenceDiagram\n    participant \"Merchant / Developer\" as Merchant\n    participant \"Bono Pay Invoicing API\" as InvoicingAPI\n    participant \"Tax Engine\" as TaxEngine\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n    participant \"Client App\" as ClientApp\n\n    Merchant-&gt;&gt;InvoicingAPI: POST /api/v1/invoices with canonical payload (merchant_nif, outlet_id, pos_terminal_id, cashier_id, client, items, tax_groups, totals, payments, timestamp)\n    InvoicingAPI-&gt;&gt;TaxEngine: validate schema + compute all 14 DGI tax groups\n    TaxEngine-&gt;&gt;CloudSigning: forward validated payload for fiscal number + signature\n    CloudSigning-&gt;&gt;Ledger: persist sealed invoice (fiscal_number, auth_code, timestamp, qr_payload) in hash-chained ledger\n    CloudSigning--&gt;&gt;InvoicingAPI: return sealed response with fiscal data\n    InvoicingAPI--&gt;&gt;ClientApp: deliver fiscalized invoice + security elements\n    CloudSigning-&gt;&gt;SyncAgent: queue ledger entry for upload\n    SyncAgent-&gt;&gt;DGI: transmit sealed invoice batch</code></pre>"},{"location":"architecture/data-flow/#2-web-dashboard-invoice-creation-browser-flow","title":"2. Web dashboard invoice creation (browser flow)","text":"<p>Bono Pay's PWA dashboard mirrors the API flow while adding UX touches for touchscreen terminals. The dashboard still builds the canonical payload, invokes the Invoicing API, and surfaces sealed invoices and delivery options without ever touching fiscal numbers.</p> <pre><code>sequenceDiagram\n    participant \"Merchant (Web Dashboard)\" as WebMerchant\n    participant \"Web Dashboard (PWA)\" as Dashboard\n    participant \"Service Worker Queue (IndexedDB)\" as SWQueue\n    participant \"Bono Pay Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    WebMerchant-&gt;&gt;Dashboard: finalize invoice draft (client selection, line items, payments)\n    Dashboard-&gt;&gt;SWQueue: enqueue canonical payload for online submission\n    SWQueue-&gt;&gt;InvoicingAPI: POST /api/v1/invoices when connectivity available\n    InvoicingAPI-&gt;&gt;CloudSigning: fiscalize payload\n    CloudSigning-&gt;&gt;Ledger: record sealed event\n    CloudSigning--&gt;&gt;InvoicingAPI: return fiscalized response\n    InvoicingAPI--&gt;&gt;Dashboard: update UI (receipt delivery, QR, fiscal number)\n    CloudSigning-&gt;&gt;SyncAgent: hand off entry for DGI sync\n    SyncAgent-&gt;&gt;DGI: upload sealed invoice</code></pre>"},{"location":"architecture/data-flow/#3-offline-client-flow-sdk-or-dashboard","title":"3. Offline client flow (SDK or dashboard)","text":"<p>Offline clients queue invoices locally (IndexedDB for dashboard, SQLite for SDKs) and retry automatic submission when they reconnect. Fiscalization happens only after the payload reaches the Cloud Signing Service, ensuring no sealed invoice is issued while the client remains offline.</p> <pre><code>sequenceDiagram\n    participant \"Merchant (SDK)\" as SDKMerchant\n    participant \"Local Queue (IndexedDB/SQLite)\" as LocalQueue\n    participant \"Bono Pay Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    SDKMerchant-&gt;&gt;LocalQueue: save canonical payload (queued, status=Queued)\n    LocalQueue--&gt;&gt;LocalQueue: await connectivity (automatic retries)\n    LocalQueue-&gt;&gt;InvoicingAPI: submit stored payload when online\n    InvoicingAPI-&gt;&gt;CloudSigning: fiscalize queued payload\n    CloudSigning-&gt;&gt;Ledger: append sealed invoice\n    CloudSigning--&gt;&gt;InvoicingAPI: deliver sealed response\n    InvoicingAPI--&gt;&gt;SDKMerchant: notify fiscalized status (green)\n    CloudSigning-&gt;&gt;SyncAgent: schedule upload\n    SyncAgent-&gt;&gt;DGI: transmit invoice batch</code></pre>"},{"location":"architecture/data-flow/#4-void-credit-note-fiscal-events","title":"4. Void &amp; credit note fiscal events","text":"<p>Voids and refunds are always new fiscal events that reference the original fiscal number. The same tax engine and signing flow produce a fresh fiscal number, ledger entry, and sealed response so auditors can trace both the original and reversal.</p> <pre><code>sequenceDiagram\n    participant \"Merchant / Auditor\" as MerchantAuditor\n    participant \"Bono Pay Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    MerchantAuditor-&gt;&gt;InvoicingAPI: POST /api/v1/invoices/{fiscal_number}/void with reference to original and new totals\n    InvoicingAPI-&gt;&gt;CloudSigning: rerun tax &amp; signing flow for void/credit note\n    CloudSigning-&gt;&gt;Ledger: append new sealed event (new fiscal_number, QR, auth_code, references original)\n    CloudSigning--&gt;&gt;InvoicingAPI: return sealed reversal response\n    InvoicingAPI--&gt;&gt;MerchantAuditor: provide void/credit note receipt\n    CloudSigning-&gt;&gt;SyncAgent: enqueue reversal for DGI\n    SyncAgent-&gt;&gt;DGI: upload reversal batch</code></pre>"},{"location":"architecture/data-flow/#5-report-generation-auditor-view","title":"5. Report generation (auditor view)","text":"<p>Report requests hit Bono Pay's reporting endpoints that query the Fiscal Ledger for the mandated Z, X, A, and audit export views. Each response includes fiscal_number ranges, auth codes, timestamps, and ledger hashes sourced from the cloud ledger so every report matches the same sealed invoices the Sync Agent uploads.</p> <pre><code>sequenceDiagram\n    participant \"Auditor / Merchant\" as Auditor\n    participant \"Bono Pay Reporting API\" as ReportingAPI\n    participant \"Report Generator\" as ReportGenerator\n    participant \"Fiscal Ledger\" as Ledger\n\n    Auditor-&gt;&gt;ReportingAPI: POST /api/v1/reports (type=Z/X/A/audit)\n    ReportingAPI-&gt;&gt;ReportGenerator: fetch ledger entries for requested range\n    ReportGenerator-&gt;&gt;Ledger: read hash-chained sealed invoices\n    Ledger--&gt;&gt;ReportGenerator: return fiscal numbers, auth codes, timestamps, tax totals\n    ReportGenerator--&gt;&gt;ReportingAPI: assemble report (JSON + PDF)\n    ReportingAPI--&gt;&gt;Auditor: deliver report with fiscal_authority_id and ledger hash</code></pre>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>Bono Pay is fiscal invoicing infrastructure for the DRC. This page explains the cloud-first architecture that treats the Cloud Signing Service as the trusted authority, keeps clients in the untrusted zone, and preserves offline behavior inspired by the Odoo lessons (PWA, service workers, IndexedDB queues). We describe who interacts with Bono Pay, why the trust boundary matters, and how the layered components work together to produce sealed invoices, reports, and DGI-ready data.</p>"},{"location":"architecture/overview/#system-context-c4","title":"System Context (C4)","text":"<p>Merchants, developers, and auditors rely on Bono Pay to fiscalize commerce, document every fiscal event, and surface auditable reports, while the platform shares sealed invoices with the DGI and notifies payment partners about settlement status. The context diagram keeps these actors, the Bono Pay Platform services, and the external systems visible so newcomers can trace how requests flow from the client to the fiscal authority.</p> <pre><code>flowchart LR\n    Merchant[\"Merchant / Finance Team\"]\n    Developer[\"Developer / Integration\"]\n    Auditor[\"Auditor / Regulator\"]\n    BonoPay[\"Bono Pay Platform\\n(Invoicing API + Dashboard + Cloud Signing + Sync)\"]\n    DGI[\"DGI (MCF / e-MCF)\"]\n    Payment[\"Payment Providers\"]\n    Merchant --&gt;|Creates invoices &amp; monitors dashboards| BonoPay\n    Developer --&gt;|Builds API/SDK integrations| BonoPay\n    Auditor --&gt;|Requests Z/X/A/audit exports| BonoPay\n    BonoPay --&gt;|Sealed invoice + security elements| DGI\n    BonoPay --&gt;|Payment status, webhooks, receipts| Payment</code></pre>"},{"location":"architecture/overview/#trust-boundary","title":"Trust Boundary","text":"<p>The Cloud Signing Service (HSM-backed) is the sole trusted component in Phase\u00a01. All client applications stay untrusted: Web Dashboard (PWA), API consumers, SDKs, and future POS terminals prepare canonical payloads (mandated identifiers, deterministic field ordering, 14 DGI tax groups), queue them locally when offline, and send them to Bono Pay Cloud. The Cloud Signing Service validates the payload, consults the Tax Engine, coordinates with the Monotonic Counter Manager, and produces the five security elements (fiscal number, fiscal authority ID, authentication code, trusted timestamp, QR payload) before returning a sealed response. Clients may only display or deliver those elements and must never fabricate them.</p> <pre><code>flowchart LR\n    subgraph \"Untrusted Zone\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        API[\"API Consumers\"]\n        SDK[\"SDK &amp; Libraries\"]\n        FuturePOS[\"Future POS / Terminals\"]\n    end\n    subgraph \"Trusted Zone\"\n        Signer[\"Cloud Signing Service (HSM)\"]\n        Tax[\"Tax Engine\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n        Sync[\"Sync Agent\"]\n    end\n    Dashboard --&gt;|Canonical payload + queued invoices| Signer\n    API --&gt;|Invoice requests| Signer\n    SDK --&gt;|Queued drafts &amp; retries| Signer\n    FuturePOS --&gt;|API-level integration| Signer\n    Counter --&gt; Signer\n    Tax --&gt; Signer\n    Signer --&gt; Ledger\n    Ledger --&gt; Reports\n    Ledger --&gt; Sync\n    Reports --&gt; Sync\n    Sync --&gt;|Sealed payload uploads| DGI[\"DGI (MCF / e-MCF)\"]</code></pre> <p>Note</p> <p>The trust boundary is enforced by the Cloud Signing Service (HSM) in Phase\u00a01. Phase\u00a03 reserves a role for the archived USB Fiscal Memory device as an optional trust anchor, but until DEF homologation is required the cloud produces and stores every security element. Clients can only report back statuses (<code>fiscalized</code>, <code>queued</code>, <code>synced</code>) via the API/Webhooks or the dashboard indicators.</p>"},{"location":"architecture/overview/#component-map","title":"Component Map","text":"<p>The Bono Pay platform is composed of four layers: clients that originate invoices, platform services that normalize and secure requests, the fiscal core where signing happens, and external integrations that consume sealed data. The component diagram below highlights how sales data flows from dashboards or SDKs into canonical serializers, travels through multi-user policies, reaches the Cloud Signing Service, and finally feeds the fiscal ledger, reports, and sync agents.</p> <pre><code>graph LR\n    subgraph \"Client Layer\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        APICl[\"API Consumers\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        Mobile[\"Mobile App (PWA)\"]\n        FuturePOS[\"Future POS / Terminals\"]\n    end\n    subgraph \"Platform Services\"\n        Canonical[\"Canonical Serializer\"]\n        Invoicing[\"Invoicing API\"]\n        TaxEngine[\"Tax Calculation Engine\"]\n        MultiAccess[\"Multi-User Access Control (API keys, roles, outlets)\"]\n        Delivery[\"Receipt Delivery (email/WhatsApp/PDF/print)\"]\n    end\n    subgraph \"Fiscal Core (Trusted)\"\n        Signer[\"Cloud Signing Service (HSM)\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n    end\n    subgraph \"External\"\n        SyncAgent[\"DGI Sync Agent\"]\n        Payment[\"Payment Gateway / Notification Service\"]\n    end\n\n    Dashboard --&gt; Canonical\n    APICl --&gt; Canonical\n    SDKs --&gt; Canonical\n    Mobile --&gt; Canonical\n    FuturePOS --&gt; Canonical\n    Canonical --&gt; Invoicing\n    MultiAccess --&gt; Invoicing\n    Invoicing --&gt; TaxEngine\n    TaxEngine --&gt; Signer\n    Canonical --&gt; Signer\n    Signer --&gt; Counter\n    Signer --&gt; Ledger\n    Ledger --&gt; Reports\n    Reports --&gt; Delivery\n    Delivery --&gt; Payment\n    Ledger --&gt; SyncAgent</code></pre>"},{"location":"architecture/overview/#operational-notes","title":"Operational Notes","text":"<ul> <li>Offline resilience: Clients use IndexedDB/SQLite queues, service workers, and other Odoo-inspired PWA patterns so tablets can keep capturing invoices even when disconnected. Queued payloads include canonical identifiers (<code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>) plus metadata about the user or API key. When connectivity returns, invoices are retried against the Invoicing API and fiscalized by the Cloud Signing Service.</li> <li>Sequential numbering: The Monotonic Counter Manager enforces serializable isolation per outlet, so every tenant sees strictly increasing fiscal numbers even under concurrent crews, multi-user dashboards, or SDK threads.</li> <li>Security elements &amp; reporting: The Cloud Signing Service (HSM) never hands out fiscal numbers, signatures, timestamps, or QR payloads to clients; it stores the sealed events in the hash-chained ledger, feeds the Report Generator with Z/X/A/audit exports, and surfaces ledger hashes for compliance reviews.</li> <li>Sync &amp; notifications: The Sync Agent uploads sealed invoices to the DGI (MCF/e-MCF) and exposes statuses via webhook notifications plus the dashboard's green/yellow/red telemetry. Payment Providers receive delivery updates but never see confidential signing secrets.</li> <li>Phase 3 reminder: When DEF homologation is required, the archived USB Fiscal Memory device takes over signing for that outlet, but the cloud ledger continues to mirror its outputs for auditability. Until then, the Bono Pay Cloud remains the trusted fiscal authority that developers and finance teams rely on.</li> </ul>"},{"location":"architecture/trust-boundary/","title":"Trust Boundary","text":"<p>Bono Pay positions the Cloud Signing Service (HSM-backed) as the sole trusted fiscal authority in Phase 1. Web dashboards, API consumers, SDKs, and future POS terminals live in the untrusted zone; they author canonical payloads (<code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>client</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, <code>timestamp</code>) and deliver them to Bono Pay Cloud for validation, tax calculation, signing, and ledger storage (see <code>spec/architecture-kutapay-system-1.md</code>). Nothing that undermines fiscal integrity is permitted to traverse backward across this boundary.</p>"},{"location":"architecture/trust-boundary/#what-crosses-the-boundary","title":"What crosses the boundary","text":"<ol> <li>Canonical invoice requests \u2014 Clients send deterministic JSON through <code>POST /api/v1/invoices</code> (or direct API/SDK calls) that include the 14 DGI tax groups, client classification, outlet/scoping identifiers, and payments in the field order mandated by the spec.</li> <li>Payment metadata &amp; tracing headers \u2014 Each request carries <code>X-BonoPay-Merchant-ID</code>, <code>X-BonoPay-Outlet-ID</code>, optionally <code>X-BonoPay-User-ID</code>/<code>X-BonoPay-Source</code>, and other telemetry that lets the Cloud scope the Monotonic Counter Manager per outlet.</li> <li>Retry/queue health updates \u2014 When dashboards or SDKs flush queued invoices after offline intervals, only the canonical payloads, timestamps, and queue metadata travel into the trusted zone so fiscalization can resume safely.</li> </ol>"},{"location":"architecture/trust-boundary/#what-the-trusted-zone-produces","title":"What the trusted zone produces","text":"<ul> <li>Sealed responses \u2014 The Cloud Signing Service returns the five mandatory elements (fiscal number, fiscal authority ID, cryptographic auth code, trusted timestamp, QR payload) plus <code>ledger_hash</code>, <code>dgi_status</code>, and the signed payload that clients may display or deliver.</li> <li>Ledger entries \u2014 The hash-chained Fiscal Ledger records each fiscal event immutably, linking counters, timestamps, and security elements in PostgreSQL with serializable isolation.</li> <li>DGI upload bundles \u2014 The Sync Agent packages sealed invoices for the DGI (MCF/e-MCF), honoring ack/\u200bretry semantics while never re-signing or mutating the payload.</li> <li>Audit-ready reports \u2014 The Report Generator emits Z/X/A/audit exports derived from the same ledger entries that produced the sealed invoice.</li> </ul>"},{"location":"architecture/trust-boundary/#what-never-crosses-the-boundary","title":"What never crosses the boundary","text":"<ul> <li>Private keys or signing material \u2014 HSM-held keys stay inside the Cloud Signing Service. Clients never see them.</li> <li>Raw monotonic counters or journal mutations \u2014 Counter increments and journal writes occur only inside the trusted zone. The Cloud enforces serializable isolation to prevent concurrency issues.</li> <li>Fabricated security elements \u2014 Client applications may only display sealed responses; they cannot invent fiscal numbers, timestamps, auth codes, or QR payloads.</li> <li>Untrusted reports \u2014 Reports described above come solely from the fiscal ledger; dashboards may read them but may not publish unverified totals.</li> <li>Internal health controls \u2014 Metrics like <code>counter_health</code> or <code>nonce_pool</code> remain within the trusted services; dashboards only surface sanitized statuses.</li> </ul> <pre><code>flowchart LR\n    subgraph \"Untrusted Zone (Clients)\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        API[\"API Consumers\"]\n        SDK[\"SDKs &amp; Integrations\"]\n        POS[\"Future POS Terminals\"]\n    end\n    subgraph \"Trusted Bono Pay Cloud\"\n        Signing[\"Cloud Signing Service (HSM)\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A)\"]\n        Sync[\"DGI Sync Agent\"]\n    end\n    DGI[\"DGI (MCF/e-MCF)\"]\n    Dashboard --&gt;|canonical invoice / POST /api/v1/invoices| Signing\n    API --&gt;|canonical invoice / POST /api/v1/invoices| Signing\n    SDK --&gt;|canonical invoice / POST /api/v1/invoices| Signing\n    POS --&gt;|canonical invoice / POST /api/v1/invoices| Signing\n    Signing --&gt; Counter\n    Counter --&gt; Ledger\n    Signing --&gt; Ledger\n    Ledger --&gt; Reports\n    Sync --&gt; DGI\n    Signing --&gt;|sealed invoice + security elements| Dashboard\n    Signing --&gt;|sealed invoice + security elements| API\n    Signing --&gt;|sealed invoice + security elements| SDK\n    Signing --&gt;|sealed invoice + security elements| POS\n    Ledger --&gt;|sealed invoice upload| Sync</code></pre>"},{"location":"architecture/trust-boundary/#failure-modes-at-the-boundary","title":"Failure modes at the boundary","text":"<ol> <li>Cloud Signing Service unavailable \u2014 Clients queue invoices locally (IndexedDB for the dashboard, SQLite for SDKs), display \u201cQueued\u201d indicators, and automatically retry submissions when the connection returns. The queue preserves canonical payload ordering so fiscalization resumes without duplication.</li> <li>Key rotation inside HSM \u2014 The Cloud handles key rollovers without exposing private material. Clients continue using the same API endpoints; the Cloud signs each request with the active key and surfaces rotation status through monitoring channels.</li> <li>Counter corruption or serialization violation \u2014 The Monotonic Counter Manager enforces serializable isolation in PostgreSQL, ensuring each outlet receives strictly increasing fiscal numbers. Any anomaly triggers fail-fast alerts and rejects new fiscalization until the ledger reconciles.</li> <li>DGI sync backpressure \u2014 The Sync Agent queues outbound bundles, retries with exponential backoff if the control module is slow, and surfaces errors to dashboards and webhooks so operators can intervene before compliance gaps emerge.</li> </ol>"},{"location":"architecture/trust-boundary/#trust-assumptions-table","title":"Trust assumptions table","text":"Assumption Enforcement The Cloud Signing Service (HSM) is the only authority that issues fiscal numbers, auth codes, timestamps, and QR payloads. The HSM + Monotonic Counter Manager run inside Bono Pay Cloud with serializable database isolation, and only sealed responses leave this boundary. Canonical payloads hit the trusted zone before fiscalization and include outlet-scoping metadata plus the 14 DGI tax groups. API/SDK clients serialize payloads per <code>spec/architecture-kutapay-system-1.md</code> and the Cloud rejects schema or ordering deviations before signing. Clients may not fabricate security elements after the trusted zone responds. The sealed response bundle contains every mandated element (<code>fiscal_number</code>, <code>fiscal_authority_id</code>, <code>auth_code</code>, <code>timestamp</code>, <code>qr_payload</code>); printers and auditors consume only these values. Multi-user, multi-terminal tenants share fiscal access safely. Each request includes <code>merchant_id</code>, <code>outlet_id</code>, and <code>api_key_id</code>/<code>user_id</code>, so the counter manager scopes numbering and quotas by outlet. Audit reports originate from the hash-chained ledger, not from client caches. The Report Generator queries the ledger directly (Z/X/A/audit) and exposes signed downloads via the Cloud API."},{"location":"architecture/trust-boundary/#phase-3-note","title":"Phase 3 note","text":"<p>Phase 3 introduces the optional USB Fiscal Memory device as a trust anchor for DEF-homologated merchants. When that hardware is deployed, it replaces the Cloud Signing Service for the local outlet while replicating every sealed invoice back to Bono Pay Cloud for ledger consistency and DGI sync (<code>design/docs-archive/hardware/</code>). The documentation above keeps the cloud-first story intact but flags the archived USB specs for future reference.</p>"},{"location":"cloud/architecture/","title":"Cloud Architecture","text":"<p>The Bono Pay Cloud is the trusted fiscal authority in Phase 1 (Software Invoicing). Unlike a relay that merely forwards sealed data, the cloud is responsible for the entire fiscalization pipeline: it receives canonical payloads from untrusted client applications, validates them, signs them via the HSM-backed Cloud Signing Service, assigns sequential fiscal numbers, timestamps them, stores them in the append-only Fiscal Ledger, and delivers sealed responses back to the caller. Only after an invoice is sealed does the Sync Agent forward it to the DGI.</p>"},{"location":"cloud/architecture/#responsibilities","title":"Responsibilities","text":"Component Role Cloud Signing Service (HSM) Assigns fiscal numbers via the Monotonic Counter Manager, signs canonical payloads with ECDSA keys that never leave the HSM, generates QR payloads, and produces trusted timestamps. Fiscal Ledger Append-only, hash-chained storage of every sealed invoice. Source of truth for Z/X/A reports and audit exports. Tax Engine Validates the 14 DGI tax groups, applies client classification rules, performs rounding, and rejects invalid payloads before signing. Report Generator Produces Z, X, A reports and full audit exports from the Fiscal Ledger on schedule or on demand. Sync Agent Uploads sealed invoices to the DGI MCF/e-MCF endpoint, handles retries with exponential backoff, and records acknowledgements. Merchant &amp; Outlet Registry Tracks merchants, outlets, API keys, users, and their association with HSM signing contexts. Manages provisioning, activation, and key rotation. Operations Dashboard Surfaces sync health, invoice pipeline status, report generation, and compliance KPIs for auditors and support staff. <p>Trust boundary reminder</p> <p>In Phase 1 the Cloud Signing Service is the sole authority for fiscal numbers, signatures, timestamps, and QR metadata. Client applications (API consumers, web dashboard, SDK integrators) submit canonical payloads and receive sealed responses \u2014 they never fabricate security elements.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can replace or augment the Cloud Signing Service for merchants needing DEF homologation. The cloud then acts as a sync relay. Hardware docs are archived in <code>docs-archive/hardware/</code>.</p>"},{"location":"cloud/architecture/#deployment-model","title":"Deployment model","text":""},{"location":"cloud/architecture/#deployment-options","title":"Deployment options","text":"<ol> <li>Serverless ingestion \u2014 Stateless functions (FaaS) validate incoming payloads, route them to the signing pipeline, and return sealed responses. This keeps bursty loads from overloading stateful systems and scales naturally when many outlets submit concurrently.</li> <li>Containerized services \u2014 Longer-running components (Cloud Signing Service, Report Generator, Operations Dashboard, Sync Agent) run inside orchestrated containers with horizontal scaling per tenant cluster. Containers host the HSM integration, ledger writes, reporting, and heavy CSV/Excel exports.</li> <li>Hybrid pattern \u2014 Front-door API and validation workers stay serverless for elasticity; the Cloud Signing Service, Fiscal Ledger, and Report Generator run on containers inside a private VPC within the DRC region.</li> </ol> <p>Each deployment option feeds into a multi-tenant namespace (see below) so containers and functions can be scaled independently per customer while sharing operational tooling, logs, and secrets.</p>"},{"location":"cloud/architecture/#multi-tenant-per-outlet-isolation","title":"Multi-tenant &amp; per-outlet isolation","text":"<p>The cloud is multi-tenant by design: every merchant (and by extension, every outlet) receives its own namespace, audit partition, and quota enforcement while being hosted inside the shared DRC deployment. Tenant metadata flows from the API request (merchant NIF, outlet ID, API key / user ID) into the registry and signing pipeline so the cloud can enforce serial numbering per outlet.</p> <p>The Monotonic Counter Manager maintains one counter per outlet with serializable database isolation. Even if multiple API consumers or dashboard users submit invoices simultaneously, the counter serializes them before the Cloud Signing Service signs, guaranteeing gap-free sequential fiscal numbers. Shared tooling (monitoring, billing, backups) reuses the same clusters, but each tenant's data sits in logically separated partitions with IAM policies.</p>"},{"location":"cloud/architecture/#data-residency-compliance","title":"Data residency &amp; compliance","text":"<p>All cloud workloads run in a DRC-hosted region to comply with local data residency expectations. Invoices, logs, and audit exports are stored encrypted at rest; keys are managed within the same region; TLS 1.3+ enforces encryption in transit. Backups are kept on redundant DRC zones, and any cross-border reporting is delivered through sealed exports (not raw invoice data) so no sensitive tax information leaves the country without explicit ministerial approval.</p> <p>The cloud also tracks regulatory metadata (compliance deadlines, report cadence, audit trail hashes) so operators can prove they met the DGI requirements described in the SFE specifications.</p>"},{"location":"cloud/architecture/#deployment-diagram","title":"Deployment diagram","text":"<pre><code>graph LR\n    subgraph Clients[\"Client Apps (untrusted)\"]\n        Dashboard[\"Web Dashboard\"]\n        API_Consumer[\"REST API consumers\"]\n        SDK[\"SDK integrators\"]\n    end\n    subgraph Cloud[\"Bono Pay Cloud (DRC deployment, trusted)\"]\n        Gateway[\"API Gateway\"]\n        TaxEng[\"Tax Engine\"]\n        HSM[\"Cloud Signing Service (HSM)\"]\n        Ledger[\"Fiscal Ledger\"]\n        Reports[\"Report Generator\"]\n        Sync[\"Sync Agent\"]\n        Registry[\"Merchant &amp; Outlet Registry\"]\n        Ops[\"Operations Dashboard\"]\n    end\n    DGI[\"DGI MCF / e-MCF\"]\n\n    Dashboard --&gt; Gateway\n    API_Consumer --&gt; Gateway\n    SDK --&gt; Gateway\n    Gateway --&gt; TaxEng\n    TaxEng --&gt; HSM\n    HSM --&gt; Ledger\n    Ledger --&gt; Reports\n    Ledger --&gt; Sync\n    Sync --&gt; DGI\n    Registry --&gt; HSM\n    Reports --&gt; Ops\n    Sync --&gt; Ops\n    Gateway --&gt; Ops\n\n    subgraph Region[\"DRC Data Residency\"]\n        Ledger\n        Registry\n        Ops\n        Reports\n    end</code></pre>"},{"location":"cloud/dgi-integration/","title":"DGI Integration","text":"<p>This page captures how the Bono Pay Cloud interfaces with the DGI control modules (MCF / e-MCF) and documents the known obligations versus the remaining unknowns uncovered during the integration spike (<code>spec/infrastructure-dgi-integration-1.md</code>).</p>"},{"location":"cloud/dgi-integration/#overview","title":"Overview","text":"<p>The DGI enforces a layered chain for fiscal compliance in the DRC. In Bono Pay's Phase 1 (Software Invoicing), the Cloud Signing Service (HSM) acts as the trusted fiscal authority \u2014 it assigns sequential fiscal numbers, signs invoices, generates timestamps and QR codes, and stores everything in the Fiscal Ledger. The Sync Agent then uploads sealed invoices to the DGI MCF/e-MCF control modules for central verification and tax surveillance.</p> <pre><code>flowchart LR\n  Client[\"Client Apps\\n(API / Dashboard / SDK)\"] --&gt;|canonical payload| Cloud[\"Bono Pay Cloud\\n(Cloud Signing Service)\"]\n  Cloud --&gt;|sealed invoice + security elements| Ledger[\"Fiscal Ledger\"]\n  Cloud --&gt;|sealed invoice + metadata| MCF[\"DGI MCF / e-MCF\\ncontrol modules\"]\n  MCF --&gt;|acknowledgement| Cloud\n  MCF --&gt;|delivery stream| DGI[\"DGI Backend\\n(central tax authority)\"]</code></pre> <p>This diagram emphasizes that the Cloud Signing Service generates the security elements (fiscal number, auth code, timestamp, QR) \u2014 it does not merely relay them. The Sync Agent handles the upstream delivery to the DGI.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can serve as the trusted signer for merchants needing DEF homologation. The Sync Agent still uploads sealed invoices from the DEF through the cloud to the DGI using the same pipeline.</p>"},{"location":"cloud/dgi-integration/#known-constraints-and-responsibilities","title":"Known constraints and responsibilities","text":"<ul> <li>In Phase 1, the Cloud Signing Service (HSM) produces the sequential fiscal number, authentication code, trusted timestamp, and QR payload that make an invoice legally valid. In Phase 3, the DEF can assume this role.</li> <li>Every submission to the DGI control modules must include the sealed canonical payload plus identifiers (fiscal_authority_id, outlet_id, merchant_nif, cashier_id / api_key_id) so that the DGI can link the invoice to its originating outlet.</li> <li>Offline client issuance is permitted (clients queue unsigned drafts locally), but the Cloud must seal them and then upload to the DGI as soon as possible. Regulators view uptime as mandatory and expect contingency plans.</li> <li>The DGI control modules enforce immutability, continuous compliance, and real-time VAT surveillance (per Arr\u00eat\u00e9 033), meaning the Cloud must log every sync attempt, failure, and acknowledgement.</li> <li>Bono Pay Cloud is also responsible for merchant/outlet registry tasks: storing activation codes, monitoring outlet health, and surfacing failure alerts to operators.</li> </ul>"},{"location":"cloud/dgi-integration/#sync-agent-pipeline","title":"Sync Agent pipeline","text":"<p>The Sync Agent runs as a background service within the Bono Pay Cloud:</p> <ol> <li>Poll the Fiscal Ledger for newly sealed invoices not yet acknowledged by the DGI.</li> <li>Format the DGI submission with the required security elements and identifiers.</li> <li>Upload to the MCF/e-MCF endpoint via authenticated HTTPS.</li> <li>Record the acknowledgement (or failure) in the Fiscal Ledger and update the invoice's <code>dgi_status</code>.</li> <li>Retry with exponential backoff on transient failures; escalate to FAILED after max retries.</li> <li>Surface dashboards and alerts for operators when uploads are pending or failing.</li> </ol>"},{"location":"cloud/dgi-integration/#unknowns-tracked-as-admonitions","title":"Unknowns (tracked as ??? admonitions)","text":"MCF/e-MCF API surface still unpublished <p>The research spike confirmed that the DGI has not released the endpoint URLs, transport protocol, or schema definitions for the control modules. Until those are published we cannot code the HTTP client or test payload validation.</p> Authentication method for the control modules is undefined <p>We do not know whether the control modules require a DGI-issued certificate, bearer token, signed JWT, or another credential, nor how key rotation or revocation is handled.</p> Offline behavior and retry rules are unspecified <p>The legislation insists every invoice must be reported, but the precise grace period, retry intervals, or thresholds that trigger manual intervention are unknown, so the sync engine must remain configurable until the DGI clarifies.</p>"},{"location":"cloud/dgi-integration/#spike-reference-next-steps","title":"Spike reference &amp; next steps","text":"<p>Refer to <code>spec/infrastructure-dgi-integration-1.md</code> for the full list of known facts and open questions gathered during this research pass. Update that file (and this page) as soon as the DGI publishes more integration guidance so the Sync Agent can evolve from placeholders to production-ready connectors.</p>"},{"location":"cloud/offline-sync/","title":"Offline-First Sync Design","text":"<p>Every invoice issued in the DRC must survive the most hostile networks. Bono Pay's architecture addresses this with a client-side offline queue: when the cloud is unreachable, client applications (web dashboard, API consumers, SDK integrators) queue unsigned canonical payloads locally (IndexedDB for web, SQLite for native/SDK) and submit them in order once connectivity returns. Fiscalization only happens when the Cloud Signing Service (HSM) processes the request \u2014 offline payloads are drafts, not fiscal events.</p>"},{"location":"cloud/offline-sync/#offline-model-overview","title":"Offline model overview","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; DRAFT : Client creates invoice (offline)\n    DRAFT --&gt; QUEUED : Saved to local queue\n    QUEUED --&gt; SUBMITTING : Connectivity restored\n    SUBMITTING --&gt; SEALED : Cloud Signing Service signs\n    SUBMITTING --&gt; RETRY : Network error\n    RETRY --&gt; SUBMITTING : Backoff timer expires\n    RETRY --&gt; FAILED : Max retries exceeded\n    FAILED --&gt; RETRY : Manual resume\n    SEALED --&gt; [*]</code></pre> <p>Offline issuance is not a compliance loophole</p> <p>Offline is allowed because merchants cannot halt commerce during connectivity outages. However, the locally queued payload is an unsigned draft \u2014 it carries no fiscal number, signature, or timestamp. The Cloud Signing Service must seal it before it becomes a fiscal event. The system emits alerts when drafts linger past the configured grace period (e.g., 24 hours) so field teams can investigate before auditors do.</p>"},{"location":"cloud/offline-sync/#client-side-queue-architecture","title":"Client-side queue architecture","text":"<p>Each client application maintains a local queue of unsigned canonical payloads. Each entry stores:</p> <ul> <li>canonical payload \u2014 the full invoice payload in deterministic field order (merchant_nif, outlet_id, items, tax_groups, totals, payments, timestamp).</li> <li>payload hash \u2014 detects duplicates across reconnect attempts and prevents double-submission.</li> <li>client metadata (outlet_id, user_id / api_key_id, source) \u2014 supplies traceability for multi-user scenarios.</li> <li>queue position \u2014 the local slot referenced by the sync state machine (QUEUED, SUBMITTING, RETRY, etc.).</li> <li>created_at \u2014 client-side timestamp for grace period monitoring (not used for fiscal purposes).</li> </ul>"},{"location":"cloud/offline-sync/#storage-backends","title":"Storage backends","text":"Client type Storage Notes Web Dashboard IndexedDB + Service Worker Service Worker intercepts <code>POST /invoices</code> when offline, stores the payload in IndexedDB, and replays when online. REST API consumer Caller's responsibility API clients should implement their own retry queue. The SDK provides a built-in queue. SDK (JavaScript/Python) SQLite / IndexedDB Built-in <code>OfflineQueue</code> class manages storage, ordering, and submission."},{"location":"cloud/offline-sync/#submission-flow","title":"Submission flow","text":"<p>When connectivity returns, the client's sync worker submits queued payloads in creation order to the Bono Pay Cloud API:</p> <ol> <li>Pick the oldest QUEUED entry and transition it to SUBMITTING.</li> <li>POST the canonical payload to <code>/api/v1/invoices</code> with the API key / bearer token.</li> <li>On success (201): The Cloud Signing Service returns the sealed response (fiscal_number, auth_code, timestamp, qr_payload). Store the sealed response locally, transition to SEALED, and move to the next entry.</li> <li>On transient failure (5xx, timeout): Transition to RETRY with exponential backoff (initial: 5s, max: 5min, jitter: \u00b120%). After <code>max_retries</code> (default: 10), transition to FAILED and raise an alert.</li> <li>On validation failure (4xx): Log the error, transition to FAILED, and surface the validation error to the user. Do not retry \u2014 the payload needs correction.</li> </ol> <p>Idempotency</p> <p>Each submission includes the <code>payload_hash</code> in an <code>Idempotency-Key</code> header. If the cloud has already sealed this exact payload (e.g., after a network timeout where the server processed the request but the client didn't receive the response), it returns the existing sealed response instead of creating a duplicate fiscal event.</p>"},{"location":"cloud/offline-sync/#grace-period-audit-logging","title":"Grace period &amp; audit logging","text":"<p>The DGI expects \"guaranteed eventual transmission,\" not best-effort delivery. As soon as a client regains connectivity, the queue flushes payloads in order and records the delay reason (network outage, user session expired, app backgrounded). Each submission attempt appends an audit record that includes:</p> <ul> <li>Out-of-band delay duration</li> <li>The client/user that triggered the retry</li> <li>Resulting status (SEALED, RETRY, FAILED)</li> </ul> <p>These logs are part of the \"transmission delays are logged and auditable\" requirement, so regulators can prove no invoice vanished during long offline spells.</p> <p>Grace periods should be configurable per deployment, but the default should align with DRC regulators' intolerance for extended \"suspicious offline\" windows. When the queue detects that a draft has lingered longer than the grace period, it surfaces a warning in the UI and raises a compliance alarm through the cloud dashboard.</p>"},{"location":"cloud/offline-sync/#client-ui-offline-indicators","title":"Client UI offline indicators","text":"<p>Client applications should mirror the queue state in the UI. Every draft/invoice shows a badge:</p> <ol> <li>Draft (gray) \u2014 queued in local storage; not yet submitted to the cloud. No fiscal number.</li> <li>Submitting (amber) \u2014 the sync worker is sending the payload to the Cloud Signing Service.</li> <li>Sealed (green) \u2014 the Cloud Signing Service returned the fiscal response. The invoice is now a fiscal event.</li> <li>Retrying (orange) \u2014 transient error; the sync worker will retry after backoff.</li> <li>Failed (red) \u2014 submission failed after max retries or validation error. Requires manual intervention.</li> </ol> <p>These indicators also drive network status chips (green/amber/red) and action buttons (\"Retry now\", \"Edit and resubmit\") to honor the principle that offline is acceptable but must be observable.</p>"},{"location":"cloud/offline-sync/#bandwidth-and-scheduling-optimizations","title":"Bandwidth and scheduling optimizations","text":"<p>Low-bandwidth deployments benefit from batching and compression:</p> <ul> <li>Batch submissions: Group queued payloads by outlet and submit them as a batch envelope to <code>/api/v1/invoices/batch</code>. The cloud processes each payload individually but returns all sealed responses in one HTTP response.</li> <li>Compression: Use gzip/Brotli for request/response bodies to reduce bandwidth.</li> <li>Throttling: Spread submissions over the grace period to avoid burst uploads during peak GSM charges. Apply jitter to backoff timers.</li> <li>Deduplication: The <code>payload_hash</code> + <code>Idempotency-Key</code> mechanism prevents duplicate fiscal events even when the client reconnects and replays the queue.</li> </ul> <p>Treat the queue like a compliance ledger</p> <p>Every state transition is proof that the invoice draft existed and was delivered responsibly. Because the Cloud Signing Service never releases a fiscal number until it processes the payload, the queue can safely replay unsigned drafts without risking duplicate issuance. Keep telemetry dashboards on this queue so auditors can reconstruct the whole story if needed.</p>"},{"location":"fiscal/invoice-lifecycle/","title":"Invoice lifecycle","text":""},{"location":"fiscal/invoice-lifecycle/#non-negotiable-six-step-flow","title":"Non-negotiable six-step flow","text":"<p>Every fiscal invoice must follow the same locked-down path so the trust boundary stays intact, the canonical payload remains deterministic, and the Cloud Signing Service (HSM) retains sole authority over fiscal numbers, signatures, timestamps, and QR payloads.</p> <ol> <li>Client apps prepare canonical payloads. Dashboards, SDKs, and API consumers queue invoices locally if offline (IndexedDB/SQLite) and, once connectivity returns, submit deterministic JSON that includes <code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code> (classification), <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, and <code>timestamp</code>.</li> <li>Invoicing API validates and taxes. The platform enforces schema, deterministic field ordering, the 14 DGI tax groups, and client classification before letting the Tax Engine compute the grouped totals and confirm the payload is well-formed.</li> <li>Cloud Signing Service (HSM) fiscalizes. The Monotonic Counter Manager guarantees sequential numbering per outlet, the HSM signs the payload (ECDSA), stamps a trusted UTC timestamp, and generates the QR code that bundles fiscal_number, auth_code, timestamp, and verification URL.</li> <li>Fiscal Ledger persists sealed events. The hash-chained, append-only ledger stores the sealed invoice, ledger hash, and security metadata so every report and audit entry can trace back to the same fiscal event.</li> <li>Clients deliver receipts. The platform surfaces the sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id) so merchants can deliver receipts via email, WhatsApp, PDF download, thermal print, or the API/web dashboard.</li> <li>Sync Agent uploads to DGI. The Sync Agent queues sealed invoices for MCF/e-MCF transmission, marks ledger entries <code>Synced_to_DGI</code>, and records acknowledgments as <code>Acknowledged</code>. If the DGI rejects a batch, the Sync Agent retries while preserving the hash chain and reportability.</li> </ol>"},{"location":"fiscal/invoice-lifecycle/#primary-fiscalization-sequence","title":"Primary fiscalization sequence","text":"<pre><code>sequenceDiagram\n    participant \"Client App (API / Dashboard / SDK)\"\n    participant \"Invoicing API\"\n    participant \"Tax Engine\"\n    participant \"Cloud Signing Service (HSM)\"\n    participant \"Fiscal Ledger\"\n    participant \"Sync Agent\"\n    participant \"DGI (MCF/e-MCF)\"\n\n    \"Client App (API / Dashboard / SDK)\"-&gt;&gt;\"Invoicing API\": 1. Submit canonical invoice payload\n    \"Invoicing API\"-&gt;&gt;\"Tax Engine\": 2. Validate schema &amp; compute 14 DGI tax groups\n    \"Tax Engine\"-&gt;&gt;\"Cloud Signing Service (HSM)\": 3. Assign fiscal number + sign + timestamp + QR\n    \"Cloud Signing Service (HSM)\"-&gt;&gt;\"Fiscal Ledger\": 4. Persist sealed invoice + ledger hash\n    \"Fiscal Ledger\"-&gt;&gt;\"Sync Agent\": 5. Enqueue sealed invoice for DGI\n    \"Sync Agent\"-&gt;&gt;\"DGI (MCF/e-MCF)\": 6. Upload sealed payload + security elements\n    \"Cloud Signing Service (HSM)\"--&gt;&gt;\"Client App (API / Dashboard / SDK)\": Return sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id)</code></pre>"},{"location":"fiscal/invoice-lifecycle/#invoice-state-machine","title":"Invoice state machine","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Draft\n    Draft --&gt; Submitted : API request accepted\n    Submitted --&gt; Validated : Tax engine + payload sanity\n    Validated --&gt; Fiscalized : Cloud Signing Service (HSM) approves\n    Fiscalized --&gt; Delivered : Receipts delivered / customer notified\n    Delivered --&gt; Synced_to_DGI : Sync Agent uploads to DGI (MCF/e-MCF)\n    Synced_to_DGI --&gt; Acknowledged : DGI acknowledges upload\n    Submitted --&gt; Validation_Failed : Schema/tax mismatch\n    Validation_Failed --&gt; Draft : Merchant fixes payload\n    Validated --&gt; Signing_Error : HSM rejects or counter issue\n    Signing_Error --&gt; Validated : Retry after cleanup\n    Synced_to_DGI --&gt; DGI_Rejected : DGI rejects batch\n    DGI_Rejected --&gt; Synced_to_DGI : Retry upload</code></pre> <p>The state diagram enforces the expectation that invoices never skip validation, signing, or synchronization; errors route back to safe states for retries. <code>Synced_to_DGI</code> captures the ledger entry once the Sync Agent pushes the sealed payload to the control modules, and <code>Acknowledged</code> only occurs after DGI confirms receipt.</p>"},{"location":"fiscal/invoice-lifecycle/#invoice-types","title":"Invoice types","text":"<p>Every invoice type the DGI mandates flows through the cloud-first lifecycle above. The Cloud Signing Service (HSM) masks service differences while the Fiscal Ledger keeps the immutable record.</p> Type Code Description Sale invoice <code>SALE</code> Standard retail/wholesale invoice that includes a full 14 tax-group breakdown and cloud-generated security elements. Advance invoice <code>ADVANCE</code> Prepayment invoice that locks in tax treatment, yet still uses the same canonical flow and receives a sealed response from the cloud. Credit note <code>CREDIT</code> Correction referencing the original fiscal number; signed as a new fiscal event so auditors can trace the adjustment. Export invoice <code>EXPORT</code> Duty/export-centric invoice that records customs/product details and shares the canonical payload + signing pipeline. Export credit note <code>EXPORT_CREDIT</code> Refund or correction for an export invoice; it binds to the export fiscal number and travels through the cloud signing sequence."},{"location":"fiscal/invoice-lifecycle/#special-flows","title":"Special flows","text":""},{"location":"fiscal/invoice-lifecycle/#void-flow","title":"Void flow","text":"<p>Voids are new fiscal events. A merchant references the original <code>fiscal_number</code>, builds a canonical payload with <code>invoice_type: \"CREDIT\"</code> or a dedicated void marker, and resubmits via <code>POST /api/v1/invoices</code>. The same six-step lifecycle applies: the Tax Engine recomputes totals, the Cloud Signing Service (HSM) issues a fresh fiscal number + signature, and the Fiscal Ledger appends a link back to the voided invoice. No records are deleted.</p>"},{"location":"fiscal/invoice-lifecycle/#refund-credit-note-flow","title":"Refund (credit note) flow","text":"<p>Refunds (credit notes) follow the canonical path because fiscalization happens inside the cloud. The Cloud Signing Service assigns a unique fiscal number, timestamps it, and emits a QR payload that the merchant can deliver alongside the refund receipt. The Fiscal Ledger tracks the lineage so auditors can reconcile the refund with the original invoice.</p>"},{"location":"fiscal/invoice-lifecycle/#draft-cancellation","title":"Draft cancellation","text":"<p>If a merchant cancels before submitting the canonical payload, the invoice stays local and never touches the trusted boundary. No fiscal number, ledger entry, or security elements are generated until the invoice re-enters the flow.</p> <p>Ancillary records remain read-only</p> <p>Every sealed invoice is append-only. Voids, refunds, and corrections create new fiscal events that reference the originals; nothing is rewound or deleted once the payload leaves the client application. This keeps the hash-chained ledger intact and satisfies the DGI mandate.</p>"},{"location":"fiscal/invoice-lifecycle/#report-generation-flow","title":"Report generation flow","text":"<pre><code>sequenceDiagram\n    participant \"Merchant / Auditor\"\n    participant \"Cloud API\"\n    participant \"Fiscal Ledger\"\n    participant \"Report Generator\"\n\n    \"Merchant / Auditor\"-&gt;&gt;\"Cloud API\": Request Z / X / A / audit export\n    \"Cloud API\"-&gt;&gt;\"Fiscal Ledger\": Query hash-chained sealed invoices\n    \"Fiscal Ledger\"-&gt;&gt;\"Report Generator\": Supply ordered entries\n    \"Report Generator\"--&gt;&gt;\"Cloud API\": Return signed report + ledger hash\n    \"Cloud API\"--&gt;&gt;\"Merchant / Auditor\": Deliver JSON/PDF download link</code></pre> <p>Reports read the same hash-chained ledger, include fiscal_authority_id + ledger hash, and can stream data to auditors even while the Sync Agent handles DGI uploads.</p>"},{"location":"fiscal/invoice-lifecycle/#phase-3-note","title":"Phase 3 note","text":"<p>When the archived USB Fiscal Memory device is deployed for DEF homologation, it replaces the Cloud Signing Service only for that outlet\u2019s signing step. The rest of the lifecycle (canonical payload, tax engine, ledger, Sync Agent, reports) remains unchanged. Refer to <code>design/docs-archive/hardware/</code> for the DEF protocol.</p>"},{"location":"fiscal/invoice-lifecycle/#references","title":"References","text":"<ul> <li><code>spec/architecture-kutapay-system-1.md</code> (trust boundary, canonical payload, tax engine, and lifecycle guardrails)</li> <li><code>.github/copilot-instructions.md</code> (Cloud Signing Service trust rules, offline behavior, and canonical payload requirements)</li> </ul>"},{"location":"fiscal/invoice-verification/","title":"Invoice Verification","text":"<p>Every sealed Bono Pay invoice carries a QR code that encodes the fiscal number, auth code, timestamp, and a verification URL. Invoice verification is the public-facing system that lets anyone \u2014 customers, auditors, DGI inspectors, or merchants themselves \u2014 confirm that an invoice was genuinely issued and sealed by the Cloud Signing Service (HSM). This page specifies the verification channels, API, cryptographic flow, and trust model.</p>"},{"location":"fiscal/invoice-verification/#why-verification-matters","title":"Why verification matters","text":"<p>Counterfeit invoices are a compliance and revenue risk in DRC markets. A trader hands a customer a receipt \u2014 how does the customer know it was really fiscalized? Verification closes that loop:</p> <ul> <li>Customers scan the QR on their receipt and instantly see whether the invoice is authentic.</li> <li>DGI inspectors verify invoices during field audits without needing VPN access to the merchant's systems.</li> <li>Auditors validate invoice chains in bulk through the API.</li> <li>Business partners confirm supplier invoices before recording them as deductible expenses.</li> </ul>"},{"location":"fiscal/invoice-verification/#verification-channels","title":"Verification channels","text":"<pre><code>flowchart LR\n    QR[\"QR Code on Receipt\"] --&gt; PORTAL[\"Public Verification Portal\\nverify.bonopay.cd\"]\n    QR --&gt; API[\"Verification API\\n/api/v1/verify\"]\n    QR --&gt; WHATSAPP[\"WhatsApp Bot\\n'V\u00e9rifier facture'\"]\n    MANUAL[\"Manual Entry\\n(fiscal number + auth code)\"] --&gt; PORTAL\n    MANUAL --&gt; WHATSAPP\n    PORTAL --&gt; RESULT[\"\u2705 Verified / \u274c Not Found / \u26a0\ufe0f Tampered\"]\n    API --&gt; RESULT\n    WHATSAPP --&gt; RESULT</code></pre> Channel Description Authentication required Phase Public Verification Portal Web page at <code>verify.bonopay.cd</code> \u2014 scan QR or type fiscal number + auth code No (public) Phase 1 Verification API REST endpoint for programmatic verification No (public, rate-limited) Phase 1 WhatsApp Bot Send QR photo or fiscal number to the bot No (public) Phase 2 Dashboard Inline verification in the merchant dashboard Yes (authenticated) Phase 1 SDK helpers <code>verifyInvoice()</code> method in JavaScript / Python SDKs No (delegates to API) Phase 1"},{"location":"fiscal/invoice-verification/#public-verification-portal","title":"Public Verification Portal","text":"<p>The portal at <code>verify.bonopay.cd</code> is a lightweight, mobile-first web page that requires no login. It's the URL encoded in every QR code.</p>"},{"location":"fiscal/invoice-verification/#user-flow","title":"User flow","text":"<pre><code>sequenceDiagram\n    participant C as Customer / Inspector\n    participant P as verify.bonopay.cd\n    participant V as Verification Service\n    participant L as Fiscal Ledger\n\n    C-&gt;&gt;P: Scan QR code or enter fiscal number + auth code\n    P-&gt;&gt;V: GET /api/v1/verify/{fiscal_number}?auth_code=...\n    V-&gt;&gt;L: Look up fiscal_number in ledger\n    L--&gt;&gt;V: Ledger entry (or not found)\n    V-&gt;&gt;V: Verify ECDSA signature against HSM public key\n    V-&gt;&gt;V: Compare auth_code, timestamp, fiscal_authority_id\n    V--&gt;&gt;P: Verification result\n    P--&gt;&gt;C: Display result with invoice summary</code></pre>"},{"location":"fiscal/invoice-verification/#portal-display","title":"Portal display","text":"<p>Verified invoice (\u2705):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u2705  FACTURE V\u00c9RIFI\u00c9E                       \u2551\n\u2551                                              \u2551\n\u2551  N\u00b0 Fiscal:    BONO-OUTLET001-000123         \u2551\n\u2551  Commer\u00e7ant:   Acme SARL                     \u2551\n\u2551  Date:         17 f\u00e9v 2026, 14:32 UTC        \u2551\n\u2551  Montant:      116 000 FC (TVA incl.)        \u2551\n\u2551  Autorit\u00e9:     HSM-CLUSTER-01                \u2551\n\u2551                                              \u2551\n\u2551  Signature cryptographique: \u2705 Valide        \u2551\n\u2551  Cha\u00eene du registre:        \u2705 Intacte       \u2551\n\u2551  Statut DGI:                \u2705 Synchronis\u00e9   \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre> <p>Not found (\u274c):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u274c  FACTURE NON TROUV\u00c9E                    \u2551\n\u2551                                              \u2551\n\u2551  Le num\u00e9ro fiscal fourni ne correspond       \u2551\n\u2551  \u00e0 aucune facture enregistr\u00e9e dans le        \u2551\n\u2551  syst\u00e8me Bono Pay.                           \u2551\n\u2551                                              \u2551\n\u2551  Si vous pensez que c'est une erreur,        \u2551\n\u2551  contactez le commer\u00e7ant ou le support.      \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre> <p>Tampered / invalid signature (\u26a0\ufe0f):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u26a0\ufe0f  ATTENTION \u2014 SIGNATURE INVALIDE        \u2551\n\u2551                                              \u2551\n\u2551  La facture existe dans le registre mais     \u2551\n\u2551  la signature cryptographique ne correspond  \u2551\n\u2551  pas. Ce document a peut-\u00eatre \u00e9t\u00e9 modifi\u00e9    \u2551\n\u2551  apr\u00e8s son \u00e9mission.                         \u2551\n\u2551                                              \u2551\n\u2551  Contactez le commer\u00e7ant et la DGI.          \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre>"},{"location":"fiscal/invoice-verification/#privacy-constraints","title":"Privacy constraints","text":"<p>The public portal shows a limited summary \u2014 merchant name, date, total amount, and verification status. It does not expose:</p> <ul> <li>Individual line items or item descriptions</li> <li>Client (buyer) name or NIF</li> <li>Payment method details</li> <li>Raw canonical payload or ledger hashes</li> </ul> <p>Merchants can optionally enable full receipt display for verified invoices via a dashboard toggle. Default: summary only.</p>"},{"location":"fiscal/invoice-verification/#verification-api","title":"Verification API","text":""},{"location":"fiscal/invoice-verification/#verify-by-fiscal-number","title":"Verify by fiscal number","text":"<pre><code>GET /api/v1/verify/{fiscal_number}?auth_code={auth_code}\n</code></pre> <p>No authentication required. This is a public endpoint. Rate-limited to prevent abuse.</p> <p>Response (200 \u2014 verified):</p> <pre><code>{\n  \"status\": \"verified\",\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"merchant_name\": \"Acme SARL\",\n  \"outlet_name\": \"Kinshasa Branch\",\n  \"timestamp\": \"2026-02-17T14:32:00Z\",\n  \"total\": 116000,\n  \"currency\": \"CDF\",\n  \"invoice_type\": \"sale\",\n  \"signature_valid\": true,\n  \"ledger_chain_valid\": true,\n  \"dgi_status\": \"synced\",\n  \"dgi_acknowledged_at\": \"2026-02-17T14:35:12Z\"\n}\n</code></pre> <p>Response (404 \u2014 not found):</p> <pre><code>{\n  \"status\": \"not_found\",\n  \"fiscal_number\": \"BONO-OUTLET001-999999\",\n  \"message\": \"No invoice found with this fiscal number.\"\n}\n</code></pre> <p>Response (200 \u2014 tampered):</p> <pre><code>{\n  \"status\": \"tampered\",\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"message\": \"Invoice exists but the provided auth_code does not match the signature on record.\",\n  \"signature_valid\": false\n}\n</code></pre>"},{"location":"fiscal/invoice-verification/#verify-by-qr-payload","title":"Verify by QR payload","text":"<pre><code>POST /api/v1/verify/qr\nContent-Type: application/json\n\n{\n  \"qr_data\": \"https://verify.bonopay.cd/i?fn=BONO-OUTLET001-000123&amp;ac=MEUCIQD8j2w8s...&amp;ts=2026-02-17T14:32:00Z&amp;fa=HSM-CLUSTER-01\"\n}\n</code></pre> <p>The API parses the QR data, extracts the fiscal number and auth code, and performs the same verification flow. This endpoint is useful for mobile apps that decode QR images.</p>"},{"location":"fiscal/invoice-verification/#bulk-verification","title":"Bulk verification","text":"<pre><code>POST /api/v1/verify/batch\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\n\n{\n  \"invoices\": [\n    { \"fiscal_number\": \"BONO-OUTLET001-000123\", \"auth_code\": \"MEUCIQD8j2w8s...\" },\n    { \"fiscal_number\": \"BONO-OUTLET001-000124\", \"auth_code\": \"MEUCIQCx9k...\" },\n    { \"fiscal_number\": \"BONO-OUTLET001-000125\", \"auth_code\": \"MEUCIQDp2...\" }\n  ]\n}\n</code></pre> <p>Response (200):</p> <pre><code>{\n  \"results\": [\n    { \"fiscal_number\": \"BONO-OUTLET001-000123\", \"status\": \"verified\", \"signature_valid\": true },\n    { \"fiscal_number\": \"BONO-OUTLET001-000124\", \"status\": \"verified\", \"signature_valid\": true },\n    { \"fiscal_number\": \"BONO-OUTLET001-000125\", \"status\": \"not_found\" }\n  ],\n  \"verified_count\": 2,\n  \"not_found_count\": 1,\n  \"tampered_count\": 0\n}\n</code></pre> <p>Bulk verification requires authentication (Bearer token) and is rate-limited separately (10 req/s, max 100 invoices per batch).</p>"},{"location":"fiscal/invoice-verification/#cryptographic-verification-flow","title":"Cryptographic verification flow","text":"<p>The verification service performs these checks in order:</p> <pre><code>flowchart TD\n    INPUT[\"Fiscal number + auth code\"] --&gt; LOOKUP[\"1. Look up fiscal_number\\nin Fiscal Ledger\"]\n    LOOKUP --&gt;|Not found| NF[\"\u274c NOT FOUND\"]\n    LOOKUP --&gt;|Found| SIGCHECK[\"2. Verify ECDSA signature\\nusing HSM public key\"]\n    SIGCHECK --&gt;|Invalid| TAMPERED[\"\u26a0\ufe0f TAMPERED\"]\n    SIGCHECK --&gt;|Valid| AUTHCHECK[\"3. Compare auth_code\\nwith stored value\"]\n    AUTHCHECK --&gt;|Mismatch| TAMPERED\n    AUTHCHECK --&gt;|Match| TSCHECK[\"4. Verify timestamp\\nagainst ledger ordering\"]\n    TSCHECK --&gt;|Anomaly| TAMPERED\n    TSCHECK --&gt;|Valid| CHAINCHECK[\"5. Verify hash chain\\n(previous + current entry)\"]\n    CHAINCHECK --&gt;|Broken| TAMPERED\n    CHAINCHECK --&gt;|Valid| VERIFIED[\"\u2705 VERIFIED\"]</code></pre>"},{"location":"fiscal/invoice-verification/#step-details","title":"Step details","text":"Step What is checked Failure meaning 1. Ledger lookup Fiscal number exists in the append-only Fiscal Ledger Invoice was never sealed by Bono Pay \u2014 possible counterfeit 2. Signature verification ECDSA signature over canonical payload is valid against the HSM's registered public key Invoice data was modified after signing \u2014 tampered 3. Auth code comparison Provided <code>auth_code</code> matches the stored cryptographic authentication code The auth code on the receipt doesn't match the original \u2014 possible forgery 4. Timestamp validation Timestamp is consistent with the ledger's monotonic ordering for that outlet Timestamp was backdated or replayed 5. Hash chain integrity The ledger entry's hash links correctly to the previous entry Ledger was tampered with \u2014 entries inserted, deleted, or reordered"},{"location":"fiscal/invoice-verification/#public-key-distribution","title":"Public key distribution","text":"<ul> <li>The HSM's public key is published at <code>verify.bonopay.cd/.well-known/fiscal-keys.json</code>.</li> <li>Keys are rotated according to the HSM key lifecycle (see ADR-0002). Old public keys remain available for verifying historical invoices.</li> <li>The DGI receives the public key during registration and can independently verify signatures without calling the Bono Pay API.</li> </ul> <pre><code>GET https://verify.bonopay.cd/.well-known/fiscal-keys.json\n\n{\n  \"keys\": [\n    {\n      \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n      \"algorithm\": \"ECDSA-P256\",\n      \"public_key\": \"MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...\",\n      \"valid_from\": \"2026-03-01T00:00:00Z\",\n      \"valid_until\": null,\n      \"status\": \"active\"\n    }\n  ]\n}\n</code></pre>"},{"location":"fiscal/invoice-verification/#qr-code-payload-format","title":"QR code payload format","text":"<p>The QR code on every receipt encodes a URL that the verification portal can parse directly:</p> <pre><code>https://verify.bonopay.cd/i?fn={fiscal_number}&amp;ac={auth_code}&amp;ts={timestamp}&amp;fa={fiscal_authority_id}\n</code></pre> Parameter Description Example <code>fn</code> Fiscal number <code>BONO-OUTLET001-000123</code> <code>ac</code> Cryptographic auth code (Base64URL-encoded ECDSA signature) <code>MEUCIQD8j2w8s...</code> <code>ts</code> Trusted timestamp (ISO 8601 UTC) <code>2026-02-17T14:32:00Z</code> <code>fa</code> Fiscal authority ID <code>HSM-CLUSTER-01</code> <p>The QR code is generated as a QR Code Model 2 with error correction level H (30% recovery) to ensure readability on thermal prints, wrinkled paper, and low-resolution phone cameras.</p>"},{"location":"fiscal/invoice-verification/#whatsapp-verification","title":"WhatsApp verification","text":"<p>The WhatsApp Invoice Bot (see AI &amp; Natural Language Capabilities) supports invoice verification as a public service \u2014 anyone with the bot's number can verify:</p> <p>By text:</p> <pre><code>User: V\u00e9rifier facture BONO-OUTLET001-000123\nBot:  \u2705 FACTURE V\u00c9RIFI\u00c9E\n      Commer\u00e7ant: Acme SARL\n      Date: 17 f\u00e9v 2026, 14:32\n      Montant: 116 000 FC\n      DGI: Synchronis\u00e9 \u2705\n</code></pre> <p>By QR photo:</p> <pre><code>User: [sends photo of receipt QR code]\nBot:  Scanning QR... \u2705 FACTURE V\u00c9RIFI\u00c9E\n      N\u00b0 Fiscal: BONO-OUTLET001-000123\n      Commer\u00e7ant: Acme SARL\n      Date: 17 f\u00e9v 2026, 14:32\n      Montant: 116 000 FC\n      DGI: Synchronis\u00e9 \u2705\n</code></pre> <p>Failed verification:</p> <pre><code>User: V\u00e9rifier facture FAKE-000001\nBot:  \u274c FACTURE NON TROUV\u00c9E\n      Ce num\u00e9ro fiscal n'existe pas dans le syst\u00e8me Bono Pay.\n      Si vous pensez que c'est une erreur, contactez le commer\u00e7ant.\n</code></pre>"},{"location":"fiscal/invoice-verification/#phase-phase-2-alongside-whatsapp-bot-launch","title":"Phase: Phase 2 (alongside WhatsApp bot launch)","text":""},{"location":"fiscal/invoice-verification/#sdk-verification-helpers","title":"SDK verification helpers","text":"<p>Both the JavaScript and Python SDKs include verification methods:</p>"},{"location":"fiscal/invoice-verification/#javascript-sdk","title":"JavaScript SDK","text":"<pre><code>import { BonoPay } from '@bonopay/sdk';\n\nconst client = new BonoPay(); // No API key needed for verification\n\n// Verify single invoice\nconst result = await client.verify('BONO-OUTLET001-000123', {\n  authCode: 'MEUCIQD8j2w8s...'\n});\nconsole.log(result.status);          // \"verified\"\nconsole.log(result.signatureValid);  // true\nconsole.log(result.dgiStatus);       // \"synced\"\n\n// Verify from QR data\nconst result = await client.verifyQR(\n  'https://verify.bonopay.cd/i?fn=BONO-OUTLET001-000123&amp;ac=MEUCIQD8j2w8s...'\n);\n\n// Offline signature verification (no API call)\nconst valid = client.verifySignatureOffline(payload, signature, publicKey);\n</code></pre>"},{"location":"fiscal/invoice-verification/#python-sdk","title":"Python SDK","text":"<pre><code>from bonopay import BonoPay\n\nclient = BonoPay()  # No API key needed for verification\n\n# Verify single invoice\nresult = client.verify(\"BONO-OUTLET001-000123\", auth_code=\"MEUCIQD8j2w8s...\")\nprint(result.status)           # \"verified\"\nprint(result.signature_valid)  # True\n\n# Bulk verify\nresults = client.verify_batch([\n    {\"fiscal_number\": \"BONO-OUTLET001-000123\", \"auth_code\": \"MEUCIQD8j2w8s...\"},\n    {\"fiscal_number\": \"BONO-OUTLET001-000124\", \"auth_code\": \"MEUCIQCx9k...\"},\n])\n\n# Offline signature verification\nvalid = client.verify_signature_offline(payload, signature, public_key)\n</code></pre>"},{"location":"fiscal/invoice-verification/#offline-verification","title":"Offline verification","text":"<p>The SDKs also support offline signature verification \u2014 given the canonical payload, the ECDSA signature, and the HSM's public key (cached from <code>/.well-known/fiscal-keys.json</code>), the SDK can verify the signature without calling the API. This is useful for:</p> <ul> <li>Auditors verifying large batches of invoices without rate limit concerns.</li> <li>DGI systems that verify signatures in their own infrastructure.</li> <li>Air-gapped environments where internet access is restricted.</li> </ul> <p>Offline verification checks the cryptographic signature only. It does not confirm ledger chain integrity, DGI sync status, or whether the invoice was voided/refunded after sealing.</p>"},{"location":"fiscal/invoice-verification/#dashboard-verification","title":"Dashboard verification","text":"<p>The merchant dashboard includes inline verification:</p> <ul> <li>Verification badge \u2014 every invoice in the dashboard shows a verification status icon (\u2705 verified, \u26a0\ufe0f chain anomaly, \ud83d\udd04 pending sync).</li> <li>Public link \u2014 each invoice detail page has a \"Share verification link\" button that copies the <code>verify.bonopay.cd</code> URL for that invoice.</li> <li>Bulk verify \u2014 merchants can select multiple invoices and run batch verification to confirm ledger integrity. This is useful after system migrations or to prepare for audits.</li> <li>Verification log \u2014 the dashboard shows how many times each invoice has been verified via the public portal, with timestamps and source channel (QR scan, manual entry, API, WhatsApp). No verifier identity is recorded.</li> </ul>"},{"location":"fiscal/invoice-verification/#anti-abuse-protections","title":"Anti-abuse protections","text":"<p>The public verification endpoints are unauthenticated by design \u2014 anyone should be able to verify an invoice. However, abuse prevention is critical:</p> Protection Detail Rate limiting Single-invoice verification: 30 req/min per IP. Bulk: 10 req/s per API key, max 100 per batch. CAPTCHA Portal shows CAPTCHA after 10 consecutive lookups from the same session. API endpoint is CAPTCHA-free. No enumeration 404 responses do not reveal whether the fiscal number format is valid \u2014 all non-matching inputs return the same \"not found\" response. Timing-safe comparison Auth code comparison uses constant-time comparison to prevent timing attacks. Logging Excessive verification attempts for the same fiscal number trigger an <code>invoice.verification_spike</code> alert (anomaly detection). Geo-restriction (optional) Merchants can restrict public verification to DRC IP ranges if they want to limit external probing."},{"location":"fiscal/invoice-verification/#phasing","title":"Phasing","text":"Capability Phase 1 Phase 2 Phase 4 Public Verification Portal \u2705 Web portal + QR scanning \u2014 \u2014 Verification API (single + QR) \u2705 Public, rate-limited \u2014 \u2014 SDK <code>verify()</code> + <code>verifyQR()</code> \u2705 In JS + Python SDKs \u2014 \u2014 Offline signature verification \u2705 SDK offline mode \u2014 \u2014 Public key distribution (JWKS) \u2705 <code>/.well-known/fiscal-keys.json</code> \u2014 \u2014 Dashboard verification badges \u2705 Inline badges + share link \u2014 \u2014 Bulk verification API \u2014 \u2705 Authenticated, batch endpoint \u2014 WhatsApp verification \u2014 \u2705 Text + QR photo \u2014 Verification analytics \u2014 \u2014 \u2705 Verification heatmaps, fraud detection"},{"location":"fiscal/reports/","title":"Reports (Z / X / A and Audit Export)","text":"<p>Bono Pay delivers the mandatory Z, X, and A reports plus an audit export directly from the Fiscal Ledger \u2014 the append-only, hash-chained journal maintained by the Cloud Signing Service. These reports are produced from the same canonical data that powers invoices, include the cloud-generated security elements (<code>fiscal_authority_id</code>, <code>fiscal_number</code>, <code>auth_code</code>, <code>trusted_timestamp</code>, <code>qr_payload</code>), and can be generated on demand or on a schedule for auditors and the DGI.</p>"},{"location":"fiscal/reports/#report-catalog","title":"Report catalog","text":"Report Purpose Frequency Primary audience Z report Daily closure with per-tax-group totals and invoice range End of day / merchant close Merchant, auditor, DGI X report Mid-period snapshot for shifts, sessions, and spot checks Hourly / shift / on-demand Merchant supervisors, auditors A report Line-item detail across invoices filtered by time period Ad-hoc (audits, inspections) Auditors, inspectors Audit export Full hash-chained journal dump (sales, voids, refunds) Scheduled or triggered by DGI DGI, compliance teams"},{"location":"fiscal/reports/#z-report-daily-closure","title":"Z report (Daily closure)","text":"<ul> <li>What it tells you: The exact invoice sequence consumed that day plus totals for every tax group, payment method, and grand totals. Use it to reconcile the fiscal counter and to prove that no invoice was skipped.</li> <li>How it's produced: The Report Generator samples the Fiscal Ledger after the last invoice of the day, collects the totals, and signs the report via the Cloud Signing Service. The report is stored in the cloud and available via the dashboard and API.</li> <li>Key fields: <code>outlet_id</code>, <code>fiscal_authority_id</code>, <code>date</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>invoice_count</code>, <code>tax_totals</code>, <code>grand_totals</code>, <code>ledger_hash</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#x-report-session-snapshot","title":"X report (Session snapshot)","text":"<ul> <li>What it tells you: Where the outlet stands mid-shift: invoiced range, totals by payment instrument, platform health, and any warning flags (e.g., sync delays, offline clients).</li> <li>How it's produced: Triggered on demand, at the start/end of a shift, or automatically (e.g., hourly). It helps supervisors detect drift before the day closes.</li> <li>Key fields: <code>period_id</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>totals</code>, <code>platform_status</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#a-report-article-level-detail","title":"A report (Article-level detail)","text":"<ul> <li>What it tells you: Every line item contributing to the invoices in a time range, including <code>tax_group</code>, <code>tax_rate</code>, <code>client_classification</code>, <code>line_total</code>, and a reference to the originating invoice.</li> <li>How it's produced: Filtered view over the Fiscal Ledger entries; the Report Generator assembles the subset using the merchant's product metadata and the canonical payloads stored alongside each sealed invoice.</li> <li>Key fields: <code>invoice_ref</code>, <code>article_id</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, <code>tax_rate</code>, <code>tax_amount</code>, <code>client_classification</code>, <code>generated_at</code>.</li> </ul>"},{"location":"fiscal/reports/#audit-export-full-journal-dump","title":"Audit export (Full journal dump)","text":"<ul> <li>What it tells you: The complete, append-only Fiscal Ledger (sales, voids, refunds, credit notes) with hashes, signatures, and all canonical payload metadata. Ideal for DGI reconciliation or for auditors that need a forensic copy.</li> <li>How it's produced: Read each ledger entry sequentially, attach <code>prev_hash</code>, <code>signature</code>, and <code>canonical_payload_hash</code>, then stream entries in chunked batches (<code>chunk_index</code>, <code>chunk_count</code>). Each chunk is acknowledged before the next is delivered to avoid partial exports.</li> <li>Key fields per entry: <code>record_type</code>, <code>sequence</code>, <code>timestamp</code>, <code>merchant_nif</code>, <code>client</code>, <code>totals</code>, <code>tax_breakdown</code>, <code>prev_hash</code>, <code>signature</code>, <code>canonical_payload_hash</code>.</li> </ul>"},{"location":"fiscal/reports/#sample-report-outputs","title":"Sample report outputs","text":"<pre><code>{\n  \"type\": \"Z\",\n  \"date\": \"2026-02-16\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 125,\n  \"invoice_count\": 25,\n  \"tax_totals\": [\n    { \"tax_group\": \"TG02\", \"base_amount\": \"15000.00\", \"tax_amount\": \"2400.00\" },\n    { \"tax_group\": \"TG01\", \"base_amount\": \"500.00\", \"tax_amount\": \"0.00\" }\n  ],\n  \"grand_totals\": { \"subtotal\": \"15500.00\", \"total_vat\": \"2400.00\", \"total\": \"17900.00\", \"currency\": \"CDF\" },\n  \"ledger_hash\": \"3F9B-7A12-...\",\n  \"generated_at\": \"2026-02-16T23:58:30Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"X\",\n  \"period_id\": \"Shift-A-2026-02-16-08\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 110,\n  \"invoice_count\": 10,\n  \"totals\": {\n    \"cash\": { \"subtotal\": \"4800.00\", \"tax\": \"768.00\", \"total\": \"5568.00\" },\n    \"mobile_money\": { \"subtotal\": \"2200.00\", \"tax\": \"352.00\", \"total\": \"2552.00\" }\n  },\n  \"platform_status\": {\n    \"cloud_signing_service\": \"healthy\",\n    \"pending_sync\": 0,\n    \"next_invoice_seq\": 111\n  },\n  \"generated_at\": \"2026-02-16T13:00:00Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"A\",\n  \"reporting_period\": \"2026-02-16\",\n  \"entries\": [\n    {\n      \"invoice_ref\": \"BONO-OUTLET42-110\",\n      \"description\": \"Wholesale service plan\",\n      \"quantity\": 1,\n      \"unit_price\": \"10000.00\",\n      \"line_total\": \"10000.00\",\n      \"tax_group\": \"TG03\",\n      \"tax_rate\": \"0.16\",\n      \"tax_amount\": \"1600.00\",\n      \"client_classification\": \"Company\",\n      \"generated_at\": \"2026-02-16T13:05:32Z\"\n    }\n  ]\n}\n</code></pre> <pre><code>{\n  \"type\": \"AUDIT_EXPORT\",\n  \"chunk_index\": 2,\n  \"chunk_count\": 5,\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"entries\": [\n    {\n      \"sequence\": 109,\n      \"record_type\": \"sale\",\n      \"timestamp\": \"2026-02-16T12:54:17Z\",\n      \"total\": \"116.00\",\n      \"tax_breakdown\": [{ \"tax_group\": \"TG02\", \"tax_amount\": \"16.00\" }],\n      \"prev_hash\": \"A4B2\",\n      \"signature\": \"ABCD1234EFGH\",\n      \"canonical_payload_hash\": \"8F3C\"\n    }\n  ],\n  \"generated_at\": \"2026-02-16T23:59:50Z\"\n}\n</code></pre>"},{"location":"fiscal/reports/#report-generation-flow","title":"Report generation flow","text":"<pre><code>sequenceDiagram\n    participant Client as Client App\n    participant Cloud as Bono Pay Cloud\n    participant HSM as Cloud Signing Service\n    participant Ledger as Fiscal Ledger\n    participant DGI as DGI\n\n    Client-&gt;&gt;Cloud: POST /invoices (canonical payload)\n    Cloud-&gt;&gt;HSM: Sign and assign fiscal number\n    HSM--&gt;&gt;Cloud: sealed response (fiscal_number, auth_code, timestamp, qr)\n    Cloud-&gt;&gt;Ledger: Append hash-chained entry\n    Cloud--&gt;&gt;Client: sealed invoice response\n    Note over Cloud,Ledger: Report Generator queries Fiscal Ledger\n    Cloud-&gt;&gt;DGI: Sync sealed invoices + reports (Z/X/A as needed)</code></pre> <p>Every sealed invoice creates a ledger entry that can be sampled by the Report Generator. Z reports are emitted at end-of-day closing, X reports are generated on shift/period boundaries, and A reports can be filtered per auditor request. Audit exports walk the ledger in order, so auditors always receive the hash chain and signature sequence to prove immutability.</p>"},{"location":"fiscal/reports/#using-the-reports","title":"Using the reports","text":"<ol> <li>During operations \u2014 Supervisors pull X reports via the dashboard or API to ensure totals match expected revenue and to monitor platform health (sync status, pending invoices, warning flags for connectivity issues).</li> <li>At close-of-day \u2014 Merchants run the Z report, download or print it, and archive the output alongside the receipts; the report's <code>ledger_hash</code> acts as a tamper-evident fingerprint of that day.</li> <li>Audits \u2014 Inspectors request A reports for specific clients, products, or dates. The exported lines include references to the canonical payload so they can verify the tax group and client classification.</li> <li>DGI exports \u2014 The audit export stream replicates the full Fiscal Ledger to the tax authority (chunked if necessary). Each chunk is acknowledged before the next is delivered to protect against network interruptions.</li> </ol> <p>No data is deleted: voids and refunds appear as separate entries in every report, and the audit export documents the corrective events with their own <code>sequence</code> numbers. When a client application is temporarily offline, unsigned payloads are queued locally and submitted once connectivity returns \u2014 reports reflect only invoices that have been sealed by the Cloud Signing Service.</p>"},{"location":"fiscal/security-elements/","title":"Security Elements on Invoices","text":"<p>The DGI SFE specification and the Bono Pay architecture mandate that every fiscal event carries five immutable security elements. In Phase 1 (Software Invoicing), the Cloud Signing Service (HSM) owns the counters, identifiers, timestamps, and signatures that prove an invoice was issued by an authorized system. Client applications (web dashboard, API consumers, SDK integrators) must treat these values as sealed outputs \u2014 they may display them but never fabricate or modify them.</p> <p>Cloud-generated security elements</p> <p>Client applications MAY NOT fabricate any of these values. They are generated inside the Cloud Signing Service (HSM), travel only in sealed responses, and are recorded in the append-only Fiscal Ledger. Missing or modified elements invalidate the invoice.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can replace or augment the Cloud Signing Service as the trusted signer for merchants who need full DEF homologation. The five elements remain identical; only the generation source changes. Hardware details are archived in <code>docs-archive/hardware/</code>.</p>"},{"location":"fiscal/security-elements/#sequential-fiscal-invoice-number","title":"Sequential fiscal invoice number","text":"<ul> <li>What it is: A monotonic, non-resettable counter that assigns every invoice a unique fiscal number and anchors the hash-chained Fiscal Ledger used for reports.</li> <li>Generated by: The Cloud Signing Service via the Monotonic Counter Manager, which uses serializable database isolation to guarantee gap-free sequential numbering per outlet.</li> <li>Receipt placement: Prominently printed near the merchant header so auditors see the outlet-level fiscal sequence.</li> <li>Verification: The dashboard, API consumers, and DGI compare the printed number with the Fiscal Ledger entry, the Z/X reports, and the expected counter for that outlet.</li> <li>Missing / invalid: The invoice is immediately rejected by the DGI and cannot be synchronized; the client must re-submit the canonical payload so the Cloud Signing Service can issue a new fiscal number.</li> </ul>"},{"location":"fiscal/security-elements/#fiscal-authority-id","title":"Fiscal authority ID","text":"<ul> <li>What it is: A unique identifier for the Cloud Signing Service instance (or HSM cluster) that produced the fiscal response. In Phase 3, this maps to the DEF NID for USB-signed invoices.</li> <li>Generated by: Assigned during HSM provisioning; the Cloud Signing Service includes it in every sealed response alongside the fiscal number and signature.</li> <li>Receipt placement: Printed beside the fiscal number in the security block so inspectors can trace the signing authority.</li> <li>Verification: Auditors and the DGI cross-check the fiscal authority ID against the registered HSM public key in the Bono Pay Cloud registry.</li> <li>Missing / invalid: Without a fiscal authority ID, the invoice cannot be tied to a certified signing service, and the DGI must mark it non-compliant.</li> </ul>"},{"location":"fiscal/security-elements/#cryptographic-authentication-code-signature","title":"Cryptographic authentication code (signature)","text":"<ul> <li>What it is: An ECDSA signature over the canonical payload, fiscal number, timestamp, and ledger metadata that proves the Cloud Signing Service approved the invoice.</li> <li>Generated by: The HSM inside the Cloud Signing Service using managed private keys that never leave the hardware security boundary.</li> <li>Receipt placement: Included in the security block or encoded inside the QR code so scanning software can verify it.</li> <li>Verification: The DGI, auditors, and Bono Pay dashboard validate the signature using the HSM's public key from the registry; signatures that fail verification trigger rejection.</li> <li>Missing / invalid: If the signature is absent or fails verification, the invoice is treated as unauthenticated and cannot be lodged with the DGI; the client must re-submit the payload for re-signing.</li> </ul>"},{"location":"fiscal/security-elements/#trusted-timestamp","title":"Trusted timestamp","text":"<ul> <li>What it is: A UTC timestamp anchored to NTP-synced cloud infrastructure that records when the Cloud Signing Service sealed the invoice.</li> <li>Generated by: The Cloud Signing Service at the moment of signing; it cannot be supplied or overridden by client applications.</li> <li>Receipt placement: Shown near the fiscal number / authority ID block and embedded in the QR payload to prove when the invoice was sealed.</li> <li>Verification: The Fiscal Ledger enforces monotonic ordering per outlet; the DGI and auditors compare timestamps against ledger order to detect drift or replay.</li> <li>Missing / invalid: Invoices without a trusted timestamp are non-compliant, cannot be reconciled with Z/X reports, and raise alerts for potential tampering.</li> </ul>"},{"location":"fiscal/security-elements/#qr-code-encoding-verification-data","title":"QR code encoding verification data","text":"<ul> <li>What it is: A machine-readable encoding of the fiscal number, fiscal authority ID, timestamp, signature, and a verification URL so inspectors and the DGI can validate the invoice.</li> <li>Generated by: The Cloud Signing Service after signing; the QR payload contains the sealed data that client applications render on receipts and the Sync Agent uploads to the DGI.</li> <li>Receipt placement: Typically printed at the bottom of the receipt, adjacent to the totals and security block.</li> <li>Verification: Inspectors and software scan the QR code to replay the data, validate the signature, and confirm the fiscal authority match. The QR encodes a URL to the public verification portal at <code>verify.bonopay.cd</code> \u2014 see Invoice Verification for the full verification flow, API, and cryptographic chain checks.</li> <li>Missing / invalid: Without the QR code the invoice fails the compliance checklist, and the DGI upload pipeline flags it as incomplete.</li> </ul>"},{"location":"fiscal/security-elements/#mock-receipt-layout","title":"Mock receipt layout","text":"<pre><code>flowchart TB\n  subgraph receipt[\"Mock receipt \u2014 Bono Pay fiscalized\"]\n    merchant[\"Merchant + outlet info\"]\n    fiscal[\"Fiscal number\\nFiscal authority ID\"]\n    timestamp[\"Trusted timestamp\"]\n    signature[\"Cryptographic authentication code\"]\n    qr[\"QR code \u2014 verification payload\"]\n  end\n  merchant --&gt; fiscal --&gt; timestamp --&gt; signature --&gt; qr</code></pre> <p>The diagram above shows how the five security elements are grouped near the receipt header and security block so every printout carries the data inspectors need. The QR code encapsulates the entire sealed payload, making verification a single scan away.</p>"},{"location":"fiscal/security-elements/#maintaining-compliance","title":"Maintaining compliance","text":"<p>Client applications always send the canonical payload to the Cloud Signing Service, which returns the five sealed security elements. Even when a client is temporarily offline, it queues the unsigned payload locally (IndexedDB / SQLite) and submits it once connectivity returns \u2014 fiscalization only happens when the Cloud Signing Service processes the request. Missing elements, altered values, or attempts to generate them outside the Cloud Signing Service immediately invalidate the invoice and keep it out of the audit trail. If a submission fails (network timeout, validation error), the client retries the request so the Cloud Signing Service can issue all five elements together.</p>"},{"location":"fiscal/tax-engine/","title":"Tax Engine","text":""},{"location":"fiscal/tax-engine/#regulatory-mandate","title":"Regulatory mandate","text":"<p>The DGI SFE specification and the Bono Pay discussion notes are unambiguous: the tax engine must handle all 14 DGI-defined tax groups, client classifications that drive tax selection, and precise rounding before an invoice is submitted to the Cloud Signing Service (HSM). The <code>spec/schema-tax-engine-1.md</code> document controls the canonical schema, while this page focuses on implementation guidance and examples.</p> <p>Regulatory constraint</p> <p>The tax engine cannot shortcut the 14-group requirement. If the documentable tax group manifest does not list a TG## code, the invoice must fail validation before it reaches the Cloud Signing Service.</p>"},{"location":"fiscal/tax-engine/#tax-group-matrix","title":"Tax Group Matrix","text":"Code Name Default Rate Typical usage TG01 Exempt 0% Embassies, diplomatic transfers, NGOs TG02 Standard VAT \u2014 Goods 16% Domestic merchandise TG03 Standard VAT \u2014 Services 16% Professional and intangible services TG04 Reduced VAT 9% Essential food, medicine, medical devices TG05 Public Financing VAT 16% State-sponsored programs or subsidies TG06 Customs VAT 16% Import deliveries billed in CDF TG07 Export Zero Rate 0% Export invoices, cross-border services TG08 Special Regime \u2014 Agriculture 5% Agriculture supply chain participants TG09 Special Regime \u2014 Mining 10% Mining operators with an active license TG10 Specific Tax \u2014 Fuel 25% Gasoline, diesel, aviation fuel TG11 Specific Tax \u2014 Tobacco 30% Cigarettes, cigars, tobacco sheets TG12 Specific Tax \u2014 Alcohol 20% Distilled spirits, beer, wine TG13 Specific Tax \u2014 Telecommunications 15% Mobile voice, data, SMS bundles TG14 Specific Tax \u2014 Digital Services 12% SaaS, streaming, digital ads consumed in DRC <p>The manifest version must travel with every invoice via <code>tax_group_manifest_version</code> so that audits can map totals to the rate set that was active at issuance.</p>"},{"location":"fiscal/tax-engine/#decision-tree-which-tax-group-applies","title":"Decision Tree \u2014 Which tax group applies?","text":"<pre><code>flowchart TD\n    Start[Start: classify the transaction] --&gt; Embassy{Is the client an embassy or diplomatic mission?}\n    Embassy -- Yes --&gt; TG1[TG01: Exempt]\n    Embassy -- No --&gt; Export{Is the item exported or consumed outside DRC?}\n    Export -- Yes --&gt; TG7[TG07: Export Zero Rate]\n    Export -- No --&gt; Special{Does the catalog mark the item as special regime or excise?}\n    Special --&gt; |Fuel| TG10[TG10: Specific Tax \u2014 Fuel]\n    Special --&gt; |Tobacco| TG11[TG11: Specific Tax \u2014 Tobacco]\n    Special --&gt; |Alcohol| TG12[TG12: Specific Tax \u2014 Alcohol]\n    Special --&gt; |Telecom| TG13[TG13: Specific Tax \u2014 Telecommunications]\n    Special --&gt; |Digital| TG14[TG14: Specific Tax \u2014 Digital Services]\n    Special --&gt; |Agriculture| TG8[TG08: Special Regime \u2014 Agriculture]\n    Special --&gt; |Mining| TG9[TG09: Special Regime \u2014 Mining]\n    Special --&gt; |Public| TG5[TG05: Public Financing VAT]\n    Special --&gt; |Customs| TG6[TG06: Customs VAT]\n    Special --&gt; |None| Kind{Is the good tangible or a service?}\n    Kind --&gt; |Goods| TG2[TG02: Standard VAT \u2014 Goods]\n    Kind --&gt; |Service| TG3[TG03: Standard VAT \u2014 Services]\n    Kind --&gt; |Reduced| TG4[TG04: Reduced VAT]</code></pre> <p>This flowchart should be embedded into the product catalog taxonomy. At each branch, the catalog metadata must flag the appropriate tax group so that the invoicing platform never guesses a code. The <code>special</code> branch also checks for catalogue flags such as <code>is_excise</code>, <code>use_customs_rate</code>, or <code>special_regime_code</code>.</p>"},{"location":"fiscal/tax-engine/#client-classification-and-its-effects","title":"Client Classification and Its Effects","text":"Classification Description Tax behavior individual Private person Default to TG02/TG03 or TG04 if the catalog marks the line as an essential good. company Registered corporation Use any tax group; TG02/TG03 are defaults. commercial_individual Sole trader Same as company but carries proprietor ID. professional Licensed professionals Services default to TG03; specify TG04 when the Ministry authorizes the reduced regime. embassy Diplomatic mission Always TG01 unless DGI issues a <code>tax_override_reason</code>. <p>Note</p> <p>Classification is recorded on every invoice. Use the classification to drive the first two branches of the tax group decision tree and to populate <code>client_classification</code> in the canonical payload.</p>"},{"location":"fiscal/tax-engine/#calculation-rounding-rules","title":"Calculation &amp; Rounding Rules","text":"<ol> <li>Calculate <code>tax_amount</code> as <code>tax_base \u00d7 tax_rate</code>.</li> <li>Round each line-level tax to the nearest centime (0.01 CDF) using half-up rounding; store any delta in <code>tax_rounding_adjustment</code>.</li> <li>Populate <code>tax_summary</code> with one row per tax group code, including zero-amount entries so auditors can verify conformity with the manifest.</li> <li>Apply TG07 (Export Zero Rate) only when the customer is outside DRC and the invoice_type is <code>export</code> or <code>export_service</code>.</li> <li>Do not mix TG01 with any other code in the same invoice unless the embassy provides a DGI override value that is logged in <code>tax_override_reason</code>.</li> </ol>"},{"location":"fiscal/tax-engine/#worked-examples","title":"Worked Examples","text":"Example Item Client classification Tax group Base (CDF) Rate Tax (CDF) Notes 1 Solar panels sold to a retailer company TG02 100000 16% 16000 Standard domestic goods example. 2 Galenic medicine sold to a clinic company TG04 150000 9% 13500 Reduced regime triggered by catalog flag <code>is_essential</code>. 3 Digital consultancy sold to a customer in Brussels company TG07 200000 0% 0 Export zero-rate; <code>tax_rounding_adjustment</code> remains 0."},{"location":"fiscal/tax-engine/#implementation-guidance","title":"Implementation guidance","text":"<ol> <li>Reference <code>spec/schema-tax-engine-1.md</code> for the authoritative TG## definitions and canonical schema fields before you add a new tax_group_code.</li> <li>Drive the taxonomy (export vs. local, special regime, excise) through catalog metadata and client classification.</li> <li>When the Cloud Signing Service returns the sealed fiscal response, persist <code>tax_summary</code> so you can regenerate Z/X/A reports that align with the manifest version.</li> <li>Update <code>tax_group_manifest_version</code> whenever DGI publishes a new rate or adds a group; the spec file mirrors the latest manifest and should be the source of truth for the document.</li> </ol>"},{"location":"hardware/protocol/","title":"USB Fiscal Device Protocol","text":"<p>This page summarizes the TXN / QRY / RPT / ADM / CFG commands that flow between the untrusted POS/fiscal service cluster and the trusted USB Fiscal Memory device. The full machine-readable definition lives in the protocol specification (<code>spec/protocol-usb-fiscal-device-1.md</code> in the project root), and ADR-0001 explains why the two-phase handshake is the only compliant option (read it here).</p> <p>The DEF is the only fiscal authority</p> <p>ADR-0001 mandates that no receipt may reach a customer unless the DEF has fully committed it (PREPARE \u2192 COMMIT \u2192 signed response). The POS must never print or queue a receipt before receiving the COMMIT response and verifying the <code>invoice_seq</code>, <code>auth_code</code>, and device timestamp.</p>"},{"location":"hardware/protocol/#command-families","title":"Command families","text":"Family Primary commands Role Transaction (TXN) <code>TXN|PREPARE</code>, <code>TXN|COMMIT</code> Nonce-based 2PC that validates and signs canonical invoices before exposing the security elements. Query (QRY) <code>QRY|STATUS</code>, <code>QRY|LOG &lt;seq&gt;</code> Health checks, recovery after power loss or crashes, and audit lookups. Reports (RPT) <code>RPT|Z</code>, <code>RPT|X</code>, <code>RPT|A</code> Z (daily closure), X (periodic snapshot), and A (article-level) reports generated in-device. Admin (ADM) <code>ADM|DUMPLOG</code>, <code>ADM|RESET</code> Exporting the hash\u2011chained journal and resetting counters under DGI authorization. Configuration (CFG) <code>CFG|TIME</code>, <code>CFG|INIT</code> Clock synchronization, device activation, and key provisioning."},{"location":"hardware/protocol/#canonical-payload-checklist","title":"Canonical payload checklist","text":"<p>Every <code>TXN|PREPARE</code> payload must follow the order in the protocol specification (<code>spec/protocol-usb-fiscal-device-1.md</code>). Include:</p> <ul> <li>Merchant metadata (<code>merchant_nif</code>, outlet/terminal/cashier IDs, invoice type).</li> <li>ISO 8601 timestamp that matches the device RTC.</li> <li>Client + classification block (Individual, Company, Commercial Individual, Professional, Embassy).</li> <li>Item list with code/description, quantity, unit price, and tax group.</li> <li>Tax group breakdown (code, rate, base, amount) for all 14 DGI tax groups.</li> <li>Totals object (<code>subtotal</code>, <code>total_vat</code>, <code>total</code>, <code>currency</code>).</li> <li>Payments array describing each instrument/method.</li> </ul> <p>Duplicating this order guarantees deterministic hashes and keeps signatures reproducible per Section 5.2 of the DISCUSSION document.</p>"},{"location":"hardware/protocol/#sequence-diagrams","title":"Sequence diagrams","text":""},{"location":"hardware/protocol/#happy-path-prepare-commit","title":"Happy path (PREPARE \u2192 COMMIT)","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE + canonical invoice\n    FiscalService-&gt;&gt;Device: PREPARE payload\n    Device--&gt;&gt;FiscalService: nonce + \"ready to commit\"\n    FiscalService-&gt;&gt;Device: TXN|COMMIT { \"nonce\": \"\u2026\" }\n    Device--&gt;&gt;FiscalService: fiscal response (invoice_seq, auth_code, QR)\n    FiscalService--&gt;&gt;POS: Receipt data + security elements</code></pre>"},{"location":"hardware/protocol/#error-path-schema-or-policy-violations","title":"Error path (schema or policy violations)","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE (malformed payload)\n    FiscalService-&gt;&gt;Device: PREPARE\n    Device--&gt;&gt;FiscalService: ERR SCHEMA_INVALID\n    FiscalService--&gt;&gt;POS: Alert cashier; show resolver UI\n    POS-&gt;&gt;FiscalService: TXN|PREPARE (canon payload retried)</code></pre>"},{"location":"hardware/protocol/#power-loss-recovery","title":"Power-loss recovery","text":"<pre><code>sequenceDiagram\n    participant POS\n    participant FiscalService\n    participant Device\n    POS-&gt;&gt;FiscalService: TXN|PREPARE\n    FiscalService-&gt;&gt;Device: PREPARE\n    Device--&gt;&gt;FiscalService: nonce\n    FiscalService-&gt;&gt;Device: TXN|COMMIT\n    Device---x Device: power loss during COMMIT\n    POS-&gt;&gt;FiscalService: QRY|STATUS\n    FiscalService-&gt;&gt;Device: STATUS\n    Device--&gt;&gt;FiscalService: next_invoice_seq still 105\n    FiscalService-&gt;&gt;Device: QRY|LOG 105\n    Device--&gt;&gt;FiscalService: log_entry (or \"not found\")</code></pre>"},{"location":"hardware/protocol/#failure-handling-and-rules","title":"Failure handling and rules","text":"<p>Nonces must never be reused</p> <p>Per ADR-0001, every COMMIT must carry the nonce issued by PREPARE. An invalid nonce yields <code>INVALID_NONCE</code> and a nonce that outlives its TTL yields <code>NONCE_EXPIRED</code>. The POS must restart the invoice flow (i.e., send a new <code>TXN|PREPARE</code> with the same canonical payload) rather than trying to reuse the old nonce.</p> <p>Device errors (<code>SCHEMA_INVALID</code>, <code>STORAGE_FULL</code>, <code>CLOCK_ROLLBACK_DETECTED</code>, <code>DEVICE_REVOKED</code>) always return <code>status: \"ERR\"</code> with a <code>code</code> field. The POS displays contextual guidance and only retries when the error signal indicates a temporary condition (<code>DEVICE_BUSY</code>, <code>STORAGE_FULL</code> after freeing space, <code>SCHEMA_INVALID</code> after user correction).</p> <p>No un-fiscalized receipt</p> <p>If the POS loses the fiscal response (COMMIT success but crash before printing), it must recover by querying <code>QRY|LOG &lt;seq&gt;</code> and reprint the missing ticket. Printing without a fiscal response violates the DRC mandate and is detectable by auditors (see ADR-0001, Section 5).</p>"},{"location":"hardware/protocol/#additional-resources","title":"Additional resources","text":"<ul> <li>Protocol specification \u2014 <code>spec/protocol-usb-fiscal-device-1.md</code> (project root)</li> <li>ADR-0001: Two-phase commit</li> </ul>"},{"location":"implementation/phase-1/","title":"Phase 1 \u2014 Software Invoicing","text":"<p>Phase 1 proves that the Bono Pay Cloud can deliver sealed, fiscally compliant invoices through an API-first platform, using the Cloud Signing Service (HSM) as the trusted fiscal authority, with a web dashboard, REST API, and SDKs.</p>"},{"location":"implementation/phase-1/#scope","title":"Scope","text":"<p>Cloud Signing Service + REST API + Web Dashboard + JavaScript/Python SDK + Z/X/A reports + manual DGI compliance tooling + public invoice verification portal.</p>"},{"location":"implementation/phase-1/#epics","title":"Epics","text":""},{"location":"implementation/phase-1/#1-cloud-signing-service-mvp","title":"1. Cloud Signing Service MVP","text":"<p>Description: Build the HSM-backed Cloud Signing Service that assigns sequential fiscal numbers, signs canonical payloads with ECDSA, generates QR codes, and stores everything in the append-only Fiscal Ledger.</p> <p>Acceptance criteria:</p> <ul> <li>Monotonic Counter Manager guarantees gap-free sequential numbering per outlet under serializable database isolation.</li> <li>HSM signs every canonical payload and returns <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>qr_payload</code>, and <code>fiscal_authority_id</code>.</li> <li>Fiscal Ledger stores hash-chained entries; each entry references the previous hash for tamper detection.</li> <li>Invoice mutations (void, refund, credit note) create new fiscal events \u2014 nothing is deleted.</li> </ul> <p>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>design/docs/architecture/trust-boundary.md</code>.</p>"},{"location":"implementation/phase-1/#2-rest-api-tax-engine","title":"2. REST API + Tax Engine","text":"<p>Description: Build the REST API that accepts canonical payloads, validates them through the tax engine (14 DGI groups + client classification), routes them to the Cloud Signing Service, and returns sealed responses.</p> <p>Acceptance criteria:</p> <ul> <li>API accepts canonical payloads with deterministic field ordering and validates all required fields.</li> <li>Tax Engine enforces TG01\u2013TG14, applies client classification rules (individual, company, commercial_individual, professional, embassy), and calculates rounding per <code>spec/schema-tax-engine-1.md</code>.</li> <li>API returns sealed responses with all five security elements.</li> <li>Error responses include actionable validation messages.</li> <li>Rate limiting (100 req/s per API key) and idempotency keys prevent abuse and duplicates.</li> </ul> <p>Dependencies: <code>spec/schema-tax-engine-1.md</code>, <code>design/docs/fiscal/tax-engine.md</code>.</p>"},{"location":"implementation/phase-1/#3-web-dashboard-mvp","title":"3. Web Dashboard MVP","text":"<p>Description: Deliver the web dashboard for invoice management, outlet administration, user/API key management, and report generation.</p> <p>Acceptance criteria:</p> <ul> <li>Dashboard supports invoice creation, viewing, filtering, and status tracking.</li> <li>Outlet registration and configuration via the dashboard.</li> <li>User and API key management with role-based access control (Cashier, Supervisor, Manager, Owner).</li> <li>Z/X/A report generation and download.</li> <li>Offline indicators for queued drafts.</li> </ul> <p>Dependencies: <code>design/docs/platform/dashboard.md</code>, <code>design/docs/platform/multi-user.md</code>.</p>"},{"location":"implementation/phase-1/#4-javascript-python-sdk","title":"4. JavaScript &amp; Python SDK","text":"<p>Description: Ship official client libraries with type-safe models, offline queue support, and receipt rendering helpers.</p> <p>Acceptance criteria:</p> <ul> <li>SDKs wrap the REST API with typed request/response models.</li> <li>Built-in offline queue (IndexedDB for browser, SQLite for native) with configurable grace period and retry logic.</li> <li>Tax engine helpers for building valid <code>tax_groups</code> and <code>tax_summary</code> arrays.</li> <li>Event callbacks for queue state transitions (synced, failed, grace exceeded).</li> </ul> <p>Dependencies: <code>design/docs/api/cloud.md</code>, <code>design/docs/api/invoicing-sdk.md</code>.</p>"},{"location":"implementation/phase-1/#5-manual-compliance-tooling-onboarding","title":"5. Manual compliance tooling &amp; onboarding","text":"<p>Description: Provide compliance tools to submit fiscal data to the DGI before automated MCF/e-MCF uploads are available.</p> <p>Acceptance criteria:</p> <ul> <li>Generate DGI-ready CSV/Excel exports containing sealed invoice metadata, fiscal numbers, tax summaries, and security elements.</li> <li>Produce Z/X/A reports and audit exports from the Fiscal Ledger.</li> <li>Public verification portal at <code>verify.bonopay.cd</code> live with QR scanning, manual fiscal number lookup, and ECDSA signature validation. See Invoice Verification.</li> <li>Verification API (<code>/api/v1/verify/{fiscal_number}</code>) available as a public, rate-limited endpoint for programmatic verification.</li> <li>SDK verification helpers (<code>verify()</code>, <code>verifyQR()</code>, <code>verifySignatureOffline()</code>) shipped in JavaScript and Python SDKs.</li> <li>Public key distribution via <code>/.well-known/fiscal-keys.json</code> so the DGI and auditors can verify signatures independently.</li> <li>Onboard initial clients with documentation, API keys, and training.</li> <li>Collect feedback and validate offline queue behavior under real-world conditions.</li> </ul> <p>Dependencies: <code>design/docs/fiscal/reports.md</code>, <code>design/docs/cloud/dgi-integration.md</code>.</p>"},{"location":"implementation/phase-1/#risks","title":"Risks","text":"<p>Phase 1 Risks</p> <ul> <li>The DGI MCF/e-MCF API remains undefined, so manual compliance tooling is required initially. Automated uploads come in Phase 2 or when the DGI publishes the spec.</li> <li>HSM provider selection and key provisioning may introduce lead time. Evaluate cloud HSM offerings (AWS CloudHSM, Azure Managed HSM) early.</li> <li>Field testing in DRC conditions may expose unexpected latency and connectivity patterns. The offline queue must handle extended outages gracefully.</li> </ul>"},{"location":"implementation/phase-2/","title":"Phase 2 \u2014 POS &amp; Retail","text":"<p>Phase 1 proved that the Cloud Signing Service, REST API, and web dashboard can deliver fiscally compliant invoices for B2B clients. Phase 2 extends the platform to physical retail and restaurant environments with POS SDK integration, multi-terminal support, mobile money payments, and the webhook event system.</p>"},{"location":"implementation/phase-2/#objectives","title":"Objectives","text":"<ul> <li>Onboard retail and restaurant outlets (multi-lane counters, mobile waitstaff, fast-service kiosks) using the same cloud fiscal authority from Phase 1.</li> <li>New capabilities: POS SDK, multi-terminal concurrency, mobile money integration, webhook API, enhanced dashboard views, and fleet observability.</li> </ul>"},{"location":"implementation/phase-2/#epics","title":"Epics","text":""},{"location":"implementation/phase-2/#1-pos-sdk-multi-terminal-support","title":"1. POS SDK &amp; multi-terminal support","text":"<p>Description: Build a POS SDK that wraps the Cloud API with receipt rendering, offline queue, and multi-terminal awareness. The Monotonic Counter Manager already serializes fiscal numbers per outlet, so POS terminals are simply additional API consumers.</p> <p>Acceptance criteria:</p> <ul> <li>POS SDK (JavaScript) handles invoice creation, offline queue, receipt template rendering, and device-specific status indicators.</li> <li>Multiple POS terminals per outlet submit invoices concurrently; the cloud serializes fiscal numbering without gaps.</li> <li>Each invoice carries <code>pos_terminal_id</code> and <code>cashier_id</code> for traceability.</li> <li>Receipt templates include all five security elements (fiscal number, fiscal authority ID, auth code, timestamp, QR code).</li> </ul> <p>Dependencies: <code>design/docs/platform/multi-user.md</code>, <code>design/docs/api/invoicing-sdk.md</code>.</p>"},{"location":"implementation/phase-2/#2-mobile-money-integration","title":"2. Mobile money integration","text":"<p>Description: Support mobile money (M-Pesa, Airtel Money, Orange Money) as payment methods within invoices. Payment confirmation callbacks trigger invoice submission or update payment status on existing invoices.</p> <p>Acceptance criteria:</p> <ul> <li>Payment callbacks from mobile money providers are processed and recorded in the invoice's <code>payments</code> array.</li> <li>Invoices can be sealed before or after payment confirmation (payment status does not block fiscalization).</li> <li>Dashboard shows payment status alongside invoice status.</li> </ul> <p>Dependencies: <code>design/docs/platform/integrations.md</code>.</p>"},{"location":"implementation/phase-2/#3-webhook-event-system","title":"3. Webhook event system","text":"<p>Description: Build the webhook delivery system that pushes signed event notifications to external endpoints when invoices are sealed, reports are generated, or sync errors occur.</p> <p>Acceptance criteria:</p> <ul> <li>Webhook events: <code>invoice.sealed</code>, <code>invoice.sync.success</code>, <code>invoice.sync.failed</code>, <code>report.generated</code>, <code>outlet.offline_alert</code>.</li> <li>Payloads are signed with HMAC-SHA256 using the webhook secret.</li> <li>Retry with exponential backoff on delivery failure (max 5 retries).</li> <li>Dashboard UI for webhook management (create, test, view delivery logs).</li> </ul> <p>Dependencies: <code>design/docs/platform/integrations.md</code>.</p>"},{"location":"implementation/phase-2/#4-enhanced-dashboard-supervisor-views","title":"4. Enhanced dashboard &amp; supervisor views","text":"<p>Description: Add shift management, supervisor drill-downs, and fleet health views to the web dashboard for retail operations.</p> <p>Acceptance criteria:</p> <ul> <li>Shift open/close workflow with X report generation per shift.</li> <li>Supervisor view showing all terminals in an outlet with real-time invoice counts and sync status.</li> <li>Fleet overview page (for multi-outlet merchants) with aggregate health metrics.</li> <li>Offline client alerts with draft counts and ages.</li> </ul> <p>Dependencies: <code>design/docs/platform/dashboard.md</code>.</p>"},{"location":"implementation/phase-2/#5-observability-onboarding-fleet-operations","title":"5. Observability, onboarding &amp; fleet operations","text":"<p>Description: Instrument the platform with monitoring, alerting, and onboarding playbooks for retail staff.</p> <p>Acceptance criteria:</p> <ul> <li>Dashboards showing API latency, signing throughput, sync queue depth, and error rates.</li> <li>Alerts for: failed DGI uploads, offline grace period exceeded, rate limit breaches, HSM health.</li> <li>Onboarding documentation for retail merchants: outlet setup, API key creation, POS SDK installation, tax group configuration.</li> <li>Automated regression tests for offline queue, multi-terminal concurrency, and mobile money flows.</li> </ul> <p>Dependencies: <code>design/docs/cloud/architecture.md</code>, <code>design/docs/cloud/offline-sync.md</code>.</p>"},{"location":"implementation/phase-2/#6-whatsapp-invoice-bot","title":"6. WhatsApp Invoice Bot","text":"<p>Description: Deploy a WhatsApp Business API integration that allows merchants to create invoices, query status, download receipts, and request reports by sending natural language messages in French or Lingala.</p> <p>Acceptance criteria:</p> <ul> <li>Merchant sends a free-text message describing a sale; the NL Invoice Parser extracts items, quantities, prices, client, and payment methods.</li> <li>Bot presents a draft preview with confidence score; merchant confirms or edits before fiscalization.</li> <li>Bot supports status queries (\"statut facture 004821\"), receipt downloads (PDF attachment), and Z report requests.</li> <li>Phone number linked to merchant account via OTP on first use.</li> <li>All bot interactions logged in the audit trail with <code>source: \"whatsapp_bot\"</code>.</li> <li>Session timeout: 15 minutes of inactivity.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>.</p>"},{"location":"implementation/phase-2/#7-natural-language-invoice-api","title":"7. Natural Language Invoice API","text":"<p>Description: Expose a REST endpoint (<code>/api/v1/invoices/natural</code>) that accepts free-text invoice descriptions in French, Lingala, Swahili, or English and returns a canonical payload for signing.</p> <p>Acceptance criteria:</p> <ul> <li>Endpoint accepts <code>{ \"text\": \"...\", \"language\": \"fr\" }</code> and returns a structured canonical payload.</li> <li>Confidence score \u2265 0.85 triggers auto-submission to the Cloud Signing Service; below 0.85 returns a draft for review.</li> <li>Entity extraction covers items, quantities, unit prices, client name, payment methods, and currency.</li> <li>Fuzzy matching against the merchant's product catalog resolves item names to SKUs and tax groups.</li> <li>Supports the same authentication and rate limiting as the core invoicing API.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>, <code>design/docs/fiscal/tax-engine.md</code>.</p>"},{"location":"implementation/phase-2/#8-tax-auto-classification-api","title":"8. Tax Auto-Classification API","text":"<p>Description: Expose a classification endpoint (<code>/api/v1/tax/classify</code>) that suggests the correct DGI tax group (TG01\u2013TG14) for items based on description, HS code, or product category.</p> <p>Acceptance criteria:</p> <ul> <li>Classifier trained on DRC customs tariff schedule, DGI circulars, and pilot transaction data.</li> <li>Confidence \u2265 0.90 \u2192 auto-apply; 0.70\u20130.90 \u2192 suggest with explanation; &lt; 0.70 \u2192 require manual classification.</li> <li>Available as a standalone API and integrated into the invoice creation flow (API, dashboard, and NL pipeline).</li> <li>Model accuracy \u2265 85% on a held-out test set of 1,000 classified items.</li> </ul> <p>Dependencies: <code>design/docs/fiscal/tax-engine.md</code>, <code>design/docs/platform/ai-capabilities.md</code>.</p>"},{"location":"implementation/phase-2/#9-rule-based-anomaly-detection","title":"9. Rule-Based Anomaly Detection","text":"<p>Description: Implement real-time rule-based anomaly detection on the Fiscal Ledger to catch numbering gaps, velocity spikes, excessive void rates, and suspicious timing patterns.</p> <p>Acceptance criteria:</p> <ul> <li>Hard rules trigger immediately for critical anomalies (numbering gaps, duplicate fiscal numbers, counter rollback).</li> <li>Statistical baselines (30-day rolling window) detect velocity, amount, and tax group distribution anomalies per outlet.</li> <li>Alerts surface in the dashboard alert center, via email, and through <code>anomaly.detected</code> webhook events.</li> <li>Each alert includes severity, description, affected outlet/cashier, and recommended action.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>, <code>design/docs/fiscal/reports.md</code>.</p>"},{"location":"implementation/phase-2/#risks","title":"Risks","text":"<p>Phase 2 Risks</p> <ul> <li>POS environments have unreliable connectivity; the offline queue must handle 48\u201372h outages without data loss or duplicate fiscal events.</li> <li>Mobile money provider APIs have variable reliability and documentation quality; build provider-agnostic abstractions.</li> <li>DGI readiness for automated uploads may still be pending \u2014 maintain manual compliance tooling as a fallback.</li> <li>Scaling to many outlets may expose performance bottlenecks in the signing pipeline or Fiscal Ledger writes.</li> </ul>"},{"location":"implementation/phase-3/","title":"Phase 3 \u2014 USB Hardware (DEF Homologation)","text":"<p>Phase 3 introduces the USB Fiscal Memory device (DEF) as an optional trust anchor for merchants who need full hardware homologation with the DGI. The Cloud Signing Service remains first-class \u2014 the DEF is an alternative signer that can replace or augment the cloud HSM for specific outlets. This phase delivers the firmware, dual-mode signing architecture, and DGI certification.</p>"},{"location":"implementation/phase-3/#objectives","title":"Objectives","text":"<ul> <li>Scope: USB Fiscal Memory firmware, dual-mode signing (Cloud HSM or DEF), device provisioning, and DGI hardware certification.</li> <li>Target: Merchants requiring DEF homologation; cloud-only merchants remain unaffected.</li> </ul>"},{"location":"implementation/phase-3/#dual-mode-signing-architecture","title":"Dual-mode signing architecture","text":"<pre><code>flowchart LR\n    Client[\"Client App\"] --&gt; API[\"Bono Pay Cloud API\"]\n    API --&gt; Router{\"Signing\\nmode?\"}\n    Router --&gt;|Cloud mode| HSM[\"Cloud Signing Service (HSM)\"]\n    Router --&gt;|DEF mode| Proxy[\"USB Device Proxy\"]\n    Proxy --&gt; DEF[\"USB Fiscal Memory\\n(DEF)\"]\n    HSM --&gt; Ledger[\"Fiscal Ledger\"]\n    DEF --&gt; Ledger\n    Ledger --&gt; Sync[\"Sync Agent\"]\n    Sync --&gt; DGI[\"DGI MCF / e-MCF\"]</code></pre> <p>Each outlet is configured with a signing mode (<code>cloud</code> or <code>def</code>). The API routes canonically identical payloads to the appropriate signer. Both signers produce the same five security elements and write to the same Fiscal Ledger, ensuring reports, audit exports, and DGI uploads are uniform regardless of signing mode.</p>"},{"location":"implementation/phase-3/#epics","title":"Epics","text":""},{"location":"implementation/phase-3/#1-usb-fiscal-memory-firmware","title":"1. USB Fiscal Memory firmware","text":"<p>Description: Develop the firmware for the USB Fiscal Memory device that implements the PREPARE/COMMIT protocol, monotonic counter, ECDSA signing via the secure element, hash-chained journal, and Z report generation.</p> <p>Acceptance criteria:</p> <ul> <li>PREPARE validates the canonical payload schema and returns a nonce without incrementing counters.</li> <li>COMMIT atomically increments the fiscal number, signs the payload, generates the timestamp and QR code, and appends to the hash-chained journal.</li> <li>Firmware generates Z reports from the local journal with sequence ranges, per-tax-group totals, and journal hashes.</li> <li>Power-loss recovery: interrupted COMMIT does not produce orphan fiscal numbers.</li> </ul> <p>Dependencies: Hardware docs in <code>docs-archive/hardware/</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>.</p>"},{"location":"implementation/phase-3/#2-usb-device-proxy-service","title":"2. USB Device Proxy service","text":"<p>Description: Build a local daemon/service that bridges the Cloud API to the USB device via USB CDC. The proxy receives canonical payloads from the cloud, executes PREPARE/COMMIT on the DEF, and returns the sealed response.</p> <p>Acceptance criteria:</p> <ul> <li>Proxy exposes a local REST/IPC interface that the Cloud API calls when the outlet is in DEF mode.</li> <li>Handles USB CDC framing, nonce lifecycle, and retry logic.</li> <li>Reports device health (counter, firmware version, free memory) back to the cloud for dashboard display.</li> <li>Auto-starts at boot; reconnects on USB disconnect.</li> </ul> <p>Dependencies: <code>spec/protocol-usb-fiscal-device-1.md</code>.</p>"},{"location":"implementation/phase-3/#3-device-provisioning-certificate-management","title":"3. Device provisioning &amp; certificate management","text":"<p>Description: Build the provisioning workflow that registers a DEF with the Cloud, binds it to an outlet, provisions its signing certificate, and manages key rotation.</p> <p>Acceptance criteria:</p> <ul> <li>Cloud registry tracks DEF serial, activation token, certificate, and firmware version per outlet.</li> <li>Activation flow binds a DEF to exactly one outlet (one-to-one mapping).</li> <li>Certificate rotation and revocation flows are documented and automated.</li> <li>Dashboard shows device status, certificate expiry, and firmware version.</li> </ul> <p>Dependencies: <code>design/docs/cloud/architecture.md</code>.</p>"},{"location":"implementation/phase-3/#4-dual-mode-integration-testing","title":"4. Dual-mode integration &amp; testing","text":"<p>Description: Ensure that Cloud HSM and DEF signers produce interchangeable sealed responses and that reports, audit exports, and DGI uploads work identically regardless of signing mode.</p> <p>Acceptance criteria:</p> <ul> <li>Same canonical payload produces structurally identical sealed responses from both signers (differing only in <code>fiscal_authority_id</code> and signature bytes).</li> <li>Fiscal Ledger, reports, and audit exports are agnostic to signing source.</li> <li>Switching an outlet from cloud to DEF mode (or vice versa) is seamless \u2014 counter continuity is maintained.</li> </ul>"},{"location":"implementation/phase-3/#5-dgi-hardware-homologation","title":"5. DGI hardware homologation","text":"<p>Description: Prepare and submit the DEF for DGI homologation, including documentation, test evidence, and physical device submission.</p> <p>Acceptance criteria:</p> <ul> <li>Homologation dossier includes: firmware specifications, security element generation proof, audit trail samples, Z/X/A report samples, and power-loss recovery evidence.</li> <li>DEF passes DGI technical committee review.</li> <li>Contingency plan: merchants can operate in cloud mode while homologation is pending.</li> </ul> <p>Dependencies: <code>design/docs/regulatory/legal-framework.md</code>, <code>design/docs/regulatory/arretes.md</code>.</p>"},{"location":"implementation/phase-3/#risks","title":"Risks","text":"<p>Phase 3 Risks</p> <ul> <li>USB hardware BOM ($10\u201315 target) may be difficult to achieve with secure MCU, SE, flash, and RTC. Supply chain issues could delay production.</li> <li>DGI homologation timelines are unpredictable. Cloud mode serves as the fallback.</li> <li>Maintaining two signing paths increases testing surface area. Invest in automated dual-mode regression tests.</li> <li>Field deployment of hardware in DRC conditions (power instability, heat, humidity) requires ruggedized design and extensive field testing.</li> </ul>"},{"location":"implementation/phase-4/","title":"Phase 4 \u2014 Enterprise &amp; Integrations","text":"<p>Phase 4 extends Bono Pay into enterprise environments with ERP connectors, fleet management, advanced analytics, and multi-country expansion research. This phase builds on the mature API, SDKs, and dual-mode signing infrastructure delivered in Phases 1\u20133.</p>"},{"location":"implementation/phase-4/#objectives","title":"Objectives","text":"<ul> <li>Scope: ERP connectors, fleet management dashboard, webhook/event streaming enhancements, advanced analytics, and multi-country regulatory research.</li> <li>Target: Large enterprises, ERP integrators, and government agencies.</li> </ul>"},{"location":"implementation/phase-4/#epics","title":"Epics","text":""},{"location":"implementation/phase-4/#1-erp-connectors","title":"1. ERP connectors","text":"<p>Description: Build certified connectors for major ERP systems that enable automatic fiscalization of invoices generated by the ERP.</p> <p>Connectors:</p> ERP Integration method Priority SAP Business One SAP DI API / Service Layer add-on High Odoo 17+ Custom module (Python) publishing to Bono Pay REST API High Sage X3 Sage X3 Web Services endpoint Medium Custom / in-house REST API + SDK (JavaScript / Python) Ongoing <p>Acceptance criteria:</p> <ul> <li>Each connector maps the ERP's invoice data model to Bono Pay's canonical payload.</li> <li>Sealed responses (fiscal number, auth code, QR code) are written back to the ERP's invoice record.</li> <li>Connectors handle offline queuing: if Bono Pay Cloud is unreachable, invoices are queued locally and retried.</li> <li>Error mapping: ERP-side validation errors are translated into meaningful messages.</li> <li>Installation guide, configuration reference, and troubleshooting docs for each connector.</li> </ul> <p>Dependencies: <code>api/cloud.md</code>, <code>api/invoicing-sdk.md</code>.</p>"},{"location":"implementation/phase-4/#2-fleet-management-dashboard","title":"2. Fleet management dashboard","text":"<p>Description: A dedicated dashboard view for enterprises managing many outlets, terminals, and (optionally) DEF devices across multiple locations.</p> <p>Features:</p> <ul> <li>Map view: Geo-located outlets with real-time status (online, offline, syncing).</li> <li>Device health panel: DEF firmware version, certificate expiry, counter status, free memory (Phase 3 outlets only).</li> <li>Fiscal number audit: Cross-outlet check for numbering gaps, duplicates, or sequence anomalies.</li> <li>Bulk management: Batch-create outlets, assign users, push configuration changes.</li> <li>Alert center: Notifications for offline outlets, failed syncs, approaching certificate expiry, and DGI submission failures.</li> </ul> <p>Acceptance criteria:</p> <ul> <li>Dashboard supports 500+ outlets per merchant without degradation.</li> <li>Real-time status updates via WebSocket or SSE (\u2264 5 s latency).</li> <li>Role-based access: fleet manager role can view all outlets but cannot issue invoices.</li> </ul> <p>Dependencies: <code>platform/multi-user.md</code>, <code>cloud/architecture.md</code>.</p>"},{"location":"implementation/phase-4/#3-advanced-analytics","title":"3. Advanced analytics","text":"<p>Description: Analytics engine that transforms Fiscal Ledger data into actionable insights for merchants and compliance teams, powered by ML-based anomaly detection, predictive forecasting, and natural language search.</p> <p>Reports:</p> Report Description Revenue trends Daily/weekly/monthly revenue by outlet, product category, and tax group Tax liability forecast Projected tax obligations based on current invoicing velocity and seasonal patterns (Prophet / ARIMA) Client segmentation Invoice volume and revenue by client classification (individual, company, embassy, etc.) Compliance scorecard DGI submission success rate, average sync latency, numbering integrity, AI-driven risk score per outlet Cashier performance Invoices per hour, average transaction value, void/refund rate per cashier Seasonal demand Peak/trough period identification for inventory and staffing Cash flow prediction Forecast mobile money vs. cash collection timing <p>Acceptance criteria:</p> <ul> <li>Analytics queries run against a read replica or data warehouse \u2014 no impact on transactional performance.</li> <li>Pre-built dashboards for each report with export to CSV, PDF, and Excel.</li> <li>API endpoint for programmatic access to analytics data.</li> <li>Data retention: analytics data available for at least 10 years (regulatory requirement).</li> </ul> <p>Dependencies: <code>fiscal/reports.md</code>.</p>"},{"location":"implementation/phase-4/#4-webhook-event-streaming-enhancements","title":"4. Webhook &amp; event streaming enhancements","text":"<p>Description: Upgrade the webhook system to support event streaming for high-throughput integrations and real-time data pipelines.</p> <p>Features:</p> <ul> <li>Event streaming: Optional Kafka/NATS topic per merchant for real-time event consumption.</li> <li>Replay: Re-deliver events from a specific timestamp or sequence number.</li> <li>Filtering: Subscribe to specific event types, outlets, or conditions.</li> <li>Dead letter queue: Automatically quarantine events that fail delivery after max retries.</li> <li>Signature verification: HMAC-SHA256 signatures on webhook payloads for authenticity.</li> </ul> <p>Acceptance criteria:</p> <ul> <li>Streaming endpoint supports \u2265 1,000 events/second per merchant.</li> <li>Replay covers at least 30 days of event history.</li> <li>Dead letter queue is accessible via API and dashboard.</li> </ul> <p>Dependencies: <code>platform/integrations.md</code>.</p>"},{"location":"implementation/phase-4/#5-multi-country-regulatory-research","title":"5. Multi-country regulatory research","text":"<p>Description: Research and document the regulatory requirements for expanding Bono Pay beyond the DRC. Identify common patterns and country-specific adaptations.</p> <p>Target countries (research only):</p> Country Fiscal regime Priority Republic of Congo (Brazzaville) SFE-like regime (research needed) High Rwanda EBM (Electronic Billing Machine) Medium Kenya TIMS (Tax Invoice Management System) Medium Cameroon MECeF (Machine \u00c9lectronique Certifi\u00e9e de Facturation) Low <p>Deliverables:</p> <ul> <li>Regulatory summary per country (equivalent of <code>regulatory/</code> folder).</li> <li>Gap analysis: what Bono Pay already supports vs. what needs adaptation.</li> <li>Architecture impact assessment: multi-country tax engine, multi-currency, localization.</li> <li>Go/no-go recommendation for each country.</li> </ul>"},{"location":"implementation/phase-4/#6-ai-powered-capabilities-full-suite","title":"6. AI-Powered Capabilities (Full Suite)","text":"<p>Description: Deploy the full AI suite that builds on Phase 2's foundation (WhatsApp bot, NL invoicing, tax classifier, rule-based anomaly detection) with advanced ML models, OCR, compliance monitoring, and natural language search.</p> <p>Components:</p> Component Description ML Anomaly Detection Replace Phase 2 rule-based triggers with Isolation Forest / Autoencoder models trained on per-outlet baselines. Detect velocity, amount, timing, tax group, and void/refund anomalies with higher precision. Predictive Analytics Engine Time-series forecasting (Prophet / ARIMA) for tax liability, revenue projection, seasonal demand, and cash flow prediction. Dashboard forecast cards with confidence intervals. OCR &amp; Document Digitization Camera/PDF upload \u2192 preprocessing \u2192 Tesseract/Cloud Vision OCR \u2192 field extraction (NER + layout analysis) \u2192 human review \u2192 stored as digitized record. Historical paper invoices are informational records only \u2014 never fabricate fiscal numbers for scanned documents. NLP Compliance Monitoring Monitor DGI website, official gazette, and ministry circulars for regulatory changes. NLP document classifier detects changes to tax rates, exemptions, and reporting obligations. Alerts reviewed by compliance team before pushing to merchants. Smart Search (Text-to-SQL) Natural language queries over fiscal data via dashboard search bar and <code>/api/v1/search/query</code>. Fine-tuned CodeLlama/StarCoder translates French/English questions into sandboxed SQL queries against the Fiscal Ledger read replica. Role-based access control enforced. Voice Invoice Creation Speech-to-text (Whisper multilingual) \u2192 text \u2192 NL Invoice Parser pipeline. Supports French, Lingala, Swahili. <p>Acceptance criteria:</p> <ul> <li>ML anomaly detection achieves \u2265 80% precision with &lt; 5% false positive rate.</li> <li>Predictive forecasts within \u00b115% accuracy for 30-day projections.</li> <li>OCR field extraction accuracy \u2265 90%. Low-quality scans flagged for manual entry.</li> <li>Compliance monitor detects regulatory changes within 48 hours of publication.</li> <li>Smart Search handles \u2265 90% of common finance team queries with correct results.</li> <li>Voice input achieves \u2265 85% entity extraction accuracy for supported languages.</li> <li>All AI models run within the Bono Pay cloud boundary. No cross-tenant training.</li> </ul> <p>Dependencies: <code>platform/ai-capabilities.md</code>, <code>fiscal/reports.md</code>, <code>cloud/architecture.md</code>.</p> <p>See AI &amp; Natural Language Capabilities for full specifications, data flows, and privacy governance.</p>"},{"location":"implementation/phase-4/#risks","title":"Risks","text":"<p>Phase 4 Risks</p> <ul> <li>ERP connector maintenance burden: each connector requires ongoing updates as ERPs release new versions.</li> <li>Multi-country expansion may require separate legal entities and local partnerships.</li> <li>Analytics on large datasets requires careful data warehouse design to avoid performance issues.</li> <li>Event streaming infrastructure (Kafka/NATS) adds operational complexity.</li> <li>AI model accuracy depends on sufficient training data from Phases 1\u20133; limited pilot volume may require synthetic data augmentation.</li> <li>OCR accuracy degrades significantly on poor-quality scans (torn, faded, handwritten) common in DRC markets.</li> <li>Multilingual NLP (especially Lingala and Tshiluba) has limited pre-trained model coverage; fine-tuning requires labeled datasets.</li> </ul>"},{"location":"implementation/phase-4/#success-criteria","title":"Success criteria","text":"<ul> <li>ERP connectors certified and deployed with enterprise customers.</li> <li>Fleet dashboard supports enterprise merchants with multi-outlet operations.</li> <li>Analytics reports are used by merchants for tax planning.</li> <li>Multi-country research delivers go/no-go recommendations.</li> <li>WhatsApp bot and NL Invoice API handle production invoice volumes.</li> <li>Tax Auto-Classifier accuracy \u2265 85% on production items.</li> <li>Anomaly detection surfaces real issues with &lt; 5% false positive rate.</li> <li>Smart Search resolves \u2265 90% of natural language finance queries correctly.</li> </ul>"},{"location":"implementation/roadmap/","title":"Implementation Roadmap","text":""},{"location":"implementation/roadmap/#overview","title":"Overview","text":"<p>This document lays out the phased rollout for Bono Pay's fiscal invoicing platform, beginning with a software-first B2B pilot, scaling through POS and retail integrations, adding optional USB hardware for merchants that need DEF homologation, and culminating in enterprise-grade connectors and analytics. Each phase builds on the architecture, cloud signing, and fiscal engine work captured throughout these docs.</p>"},{"location":"implementation/roadmap/#timeline","title":"Timeline","text":"<pre><code>timeline\n    title Bono Pay Implementation Roadmap\n    Phase 1 \u2014 Software Invoicing\n        : Cloud Signing Service + Fiscal Ledger MVP\n        : REST API + Tax Engine (14 DGI groups)\n        : Web Dashboard MVP\n        : JavaScript and Python SDK\n    Phase 2 \u2014 POS and Retail\n        : POS SDK + multi-terminal support\n        : Mobile money integration\n        : Webhook event system\n        : WhatsApp Invoice Bot + NL API\n    Phase 3 \u2014 USB Hardware\n        : USB Fiscal Memory firmware\n        : Cloud + DEF dual-mode signing\n        : DGI hardware certification\n    Phase 4 \u2014 Enterprise\n        : ERP connectors \u2014 SAP and Odoo\n        : Fleet management dashboard\n        : Advanced analytics + AI suite\n        : Multi-country expansion research</code></pre>"},{"location":"implementation/roadmap/#phase-1-software-invoicing","title":"Phase 1 \u2014 Software Invoicing","text":"<p>The foundation phase. Delivers the API-first invoicing platform with cloud fiscal signing, the tax engine, web dashboard, and SDKs.</p> <p>Key deliverables:</p> <ul> <li>Cloud Signing Service (HSM) + Monotonic Counter Manager + Fiscal Ledger</li> <li>REST API with full invoice lifecycle (create, void, refund, credit note)</li> <li>Tax Engine enforcing all 14 DGI tax groups + client classification</li> <li>Web Dashboard for invoice management, reports, and outlet administration</li> <li>JavaScript and Python SDKs with offline queue support</li> <li>Z/X/A reports and audit export from the Fiscal Ledger</li> <li>Manual DGI compliance tooling (CSV/audit dump) until MCF/e-MCF API lands</li> </ul> <p>See Phase 1 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"implementation/roadmap/#phase-2-pos-retail","title":"Phase 2 \u2014 POS &amp; Retail","text":"<p>Extends the platform to physical retail by adding POS SDK integration, multi-terminal support, mobile money payments, the webhook event system, and the first AI-powered capabilities.</p> <p>Key deliverables:</p> <ul> <li>POS SDK that wraps the Cloud API with receipt rendering and offline queue</li> <li>Multi-terminal concurrency via the existing Monotonic Counter Manager</li> <li>Mobile money integration (M-Pesa, Airtel Money, Orange Money)</li> <li>Webhook API for real-time event streaming to external systems</li> <li>Enhanced dashboard with shift management and supervisor views</li> <li>Observability and alerting for fleet operations</li> <li>WhatsApp Invoice Bot \u2014 create, query, and receive sealed invoices via WhatsApp Business API (French, Lingala)</li> <li>Natural Language Invoice API \u2014 submit invoices as free-text via <code>/api/v1/invoices/natural</code></li> <li>Tax Auto-Classification API \u2014 ML-assisted tax group suggestions for items and HS codes</li> <li>Rule-based anomaly detection \u2014 real-time alerts for numbering gaps, velocity spikes, and void rate anomalies</li> </ul> <p>See Phase 2 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"implementation/roadmap/#phase-3-usb-hardware","title":"Phase 3 \u2014 USB Hardware","text":"<p>Introduces the USB Fiscal Memory device (DEF) as an optional trust anchor for merchants who need full DEF homologation. The cloud remains first-class; the DEF is an alternative signer.</p> <p>Key deliverables:</p> <ul> <li>USB Fiscal Memory firmware (PREPARE/COMMIT protocol, immutable journal)</li> <li>Dual-mode architecture: Cloud HSM or DEF can sign invoices per outlet</li> <li>Device provisioning, activation, and certificate management</li> <li>Cloud sync for DEF-signed invoices (same Sync Agent pipeline)</li> <li>DGI hardware homologation and certification</li> </ul> <p>See Phase 3 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"implementation/roadmap/#phase-4-enterprise-scale","title":"Phase 4 \u2014 Enterprise &amp; Scale","text":"<p>Enterprise-grade integrations, fleet management, advanced analytics, and the full AI suite for large-scale deployments.</p> <p>Key deliverables:</p> <ul> <li>ERP connectors (SAP S/4HANA, Odoo) with tax group mapping</li> <li>Fleet management dashboard for multi-branch monitoring</li> <li>Advanced analytics (tax-group heatmaps, anomaly detection, trend analysis)</li> <li>Automated compliance reporting and audit export scheduling</li> <li>Multi-country expansion research (regulatory analysis for neighboring markets)</li> <li>ML-based anomaly detection \u2014 Isolation Forest / Autoencoder models replacing Phase 2 rule-based triggers</li> <li>Predictive analytics \u2014 tax liability forecasts, revenue projections, seasonal demand, and compliance risk scoring</li> <li>OCR &amp; document digitization \u2014 scan paper invoices into structured records via camera or PDF upload</li> <li>NLP compliance monitoring \u2014 detect regulatory changes in DGI publications and alert merchants</li> <li>Smart Search \u2014 natural language queries over fiscal data (text-to-SQL) in the dashboard and API</li> <li>Voice invoice creation \u2014 speech-to-text pipeline feeding the NL Invoice Parser</li> </ul> <p>See Phase 4 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"implementation/roadmap/#monitoring-validation","title":"Monitoring &amp; Validation","text":"<p>Maintain a rolling review cadence after each phase completes:</p> <ul> <li>Monthly sync audits \u2014 Verify Fiscal Ledger integrity, DGI upload success rates, and counter continuity.</li> <li>Quarterly security reviews \u2014 Audit HSM key rotation, API key usage, and access control compliance.</li> <li>Phase gate reviews \u2014 Before advancing to the next phase, validate all acceptance criteria, run <code>mkdocs build --strict</code>, and confirm regulatory alignment.</li> <li>DGI checkpoint \u2014 As the MCF/e-MCF API details emerge, update the Sync Agent and DGI integration docs accordingly.</li> </ul>"},{"location":"platform/ai-capabilities/","title":"AI &amp; Natural Language Capabilities","text":"<p>Bono Pay embeds AI and natural language processing directly into its fiscal invoicing infrastructure so merchants, cashiers, and compliance teams interact with the platform in the language they already speak \u2014 French, Lingala, Swahili, or Tshiluba \u2014 rather than through forms and dropdowns. This page specifies every AI surface, its data flow, trust boundary rules, and phased rollout.</p>"},{"location":"platform/ai-capabilities/#design-principles","title":"Design principles","text":"<ul> <li>AI assists, the Cloud Signing Service decides. AI models suggest tax groups, parse natural language, and flag anomalies, but the Cloud Signing Service (HSM) remains the sole authority for fiscal numbers, signatures, timestamps, and QR codes. No AI output bypasses the trust boundary.</li> <li>Human-in-the-loop by default. AI suggestions (tax classification, anomaly flags, compliance alerts) are presented for review before becoming fiscal events. Confidence thresholds gate auto-approval.</li> <li>Multilingual-first. All NLP models support French (primary), Lingala, Swahili, and Tshiluba. English is supported for international clients and developers.</li> <li>Privacy-preserving. Invoice data fed to AI models stays within Bono Pay's cloud boundary. No customer data is sent to third-party model providers unless the merchant explicitly opts in and a data processing agreement is signed.</li> </ul>"},{"location":"platform/ai-capabilities/#capability-map","title":"Capability map","text":"<pre><code>flowchart TD\n    NL[\"Natural Language Input\\n(WhatsApp, Chat, Voice)\"]\n    OCR[\"OCR &amp; Document Scan\"]\n    NL --&gt; PARSE[\"NL Invoice Parser\"]\n    OCR --&gt; PARSE\n    PARSE --&gt; CANON[\"Canonical Payload Builder\"]\n    CANON --&gt; VALIDATE[\"Tax Engine\\n(14 DGI Groups)\"]\n    VALIDATE --&gt; SIGN[\"Cloud Signing Service\\n(HSM)\"]\n\n    LEDGER[\"Fiscal Ledger\"] --&gt; ANOMALY[\"Anomaly Detection\"]\n    LEDGER --&gt; PREDICT[\"Predictive Analytics\"]\n    LEDGER --&gt; SEARCH[\"Smart Search &amp; Insights\"]\n    ANOMALY --&gt; ALERTS[\"Alert Center\"]\n    PREDICT --&gt; DASH[\"Dashboard &amp; Reports\"]\n    SEARCH --&gt; DASH\n\n    CLASSIFY[\"Tax Auto-Classifier\"] --&gt; VALIDATE\n    COMPLY[\"Compliance Monitor\"] --&gt; ALERTS</code></pre>"},{"location":"platform/ai-capabilities/#1-natural-language-invoice-creation","title":"1. Natural Language Invoice Creation","text":""},{"location":"platform/ai-capabilities/#problem","title":"Problem","text":"<p>Merchants in DRC markets \u2014 small traders, school bursars, wholesale distributors \u2014 don't want to fill in 15 form fields. They want to say or type what happened (\"Vendez 3 sacs de ciment \u00e0 45 000 FC chacun \u00e0 \u00c9tablissement Kabila, pay\u00e9 moiti\u00e9 mobile money moiti\u00e9 cash\") and get a sealed invoice back.</p>"},{"location":"platform/ai-capabilities/#specification","title":"Specification","text":"Attribute Detail Input channels WhatsApp Business API, Web dashboard chat widget, REST API (<code>/api/v1/invoices/natural</code>), Voice (speech-to-text pipeline) Languages French, Lingala, Swahili, Tshiluba, English Output Canonical JSON payload ready for the Tax Engine and Cloud Signing Service Confidence threshold \u2265 0.85 \u2192 auto-submit for signing; &lt; 0.85 \u2192 present draft for review Fallback If confidence &lt; 0.60, prompt the user for clarification (\"Quel est le NIF du client?\")"},{"location":"platform/ai-capabilities/#data-flow","title":"Data flow","text":"<pre><code>sequenceDiagram\n    participant M as Merchant (WhatsApp / Chat)\n    participant NLP as NL Invoice Parser\n    participant CAT as Product Catalog\n    participant TAX as Tax Engine\n    participant CSS as Cloud Signing Service (HSM)\n\n    M-&gt;&gt;NLP: \"Vends 3 sacs ciment 45000 FC \u00e0 Ets Kabila, moiti\u00e9 MoMo moiti\u00e9 cash\"\n    NLP-&gt;&gt;CAT: Resolve \"sacs ciment\" \u2192 SKU, unit price, tax group\n    CAT--&gt;&gt;NLP: SKU-0042, TG01 (TVA 16%)\n    NLP-&gt;&gt;NLP: Extract: qty=3, unit_price=45000, client=\"Ets Kabila\", payments=[mobile_money: 67500, cash: 67500]\n    NLP--&gt;&gt;M: Draft preview (confidence 0.91) \u2014 \"Confirm or edit?\"\n    M-&gt;&gt;NLP: \u2705 Confirm\n    NLP-&gt;&gt;TAX: Canonical payload\n    TAX-&gt;&gt;CSS: Validated payload\n    CSS--&gt;&gt;M: Sealed invoice (fiscal_number, QR, auth_code)</code></pre>"},{"location":"platform/ai-capabilities/#entity-extraction-targets","title":"Entity extraction targets","text":"Entity Examples Required Items \"3 sacs ciment\", \"10 cahiers\" Yes Unit price \"45 000 FC\", \"$12.50\" Yes Client \"Ets Kabila\", \"M. Tshisekedi\" No (defaults to anonymous individual) Payment methods \"cash\", \"MoMo\", \"moiti\u00e9-moiti\u00e9\" No (defaults to cash) Currency \"FC\", \"USD\", \"dollars\" No (defaults to CDF) Tax group override \"exon\u00e9r\u00e9\", \"export\" No (auto-classified from catalog)"},{"location":"platform/ai-capabilities/#implementation-notes","title":"Implementation notes","text":"<ul> <li>Use a fine-tuned multilingual LLM (e.g., mT5 or Mistral-based) for entity extraction, with a retrieval-augmented generation (RAG) layer backed by the merchant's product catalog.</li> <li>Catalog matching uses fuzzy search (Levenshtein + embedding similarity) so \"ciment\" matches \"Ciment Portland CPA 42.5 50kg\".</li> <li>The parser outputs a confidence score per field plus an aggregate score. Fields below 0.70 confidence are highlighted in the draft preview.</li> <li>Voice input runs through Whisper (multilingual) \u2192 text \u2192 same NLP pipeline.</li> </ul>"},{"location":"platform/ai-capabilities/#phase-phase-2-initial-whatsapp-bot-phase-4-voice-advanced-nlu","title":"Phase: Phase 2 (initial WhatsApp bot) / Phase 4 (voice, advanced NLU)","text":""},{"location":"platform/ai-capabilities/#2-whatsapp-invoice-bot","title":"2. WhatsApp Invoice Bot","text":""},{"location":"platform/ai-capabilities/#problem_1","title":"Problem","text":"<p>WhatsApp is the dominant communication channel in DRC. Merchants already discuss transactions over WhatsApp \u2014 Bono Pay should meet them there.</p>"},{"location":"platform/ai-capabilities/#specification_1","title":"Specification","text":"Attribute Detail Platform WhatsApp Business API (Cloud API) Capabilities Create invoices, query invoice status, download receipts (PDF), request Z/X reports, check DGI sync status, verify invoices (text or QR photo) Authentication Phone number linked to merchant account + OTP verification on first use Languages French, Lingala (others via NL pipeline)"},{"location":"platform/ai-capabilities/#conversation-flows","title":"Conversation flows","text":"<p>Invoice creation:</p> <pre><code>Merchant: Facture pour Ets Mwamba, 5 cartons savon 12000 FC\nBot: \ud83d\udcdd Brouillon cr\u00e9\u00e9:\n     Client: Ets Mwamba\n     - 5\u00d7 Savon Multi-Usage (TG01 TVA 16%) \u2014 60 000 FC\n     - TVA: 9 600 FC\n     - Total: 69 600 FC\n     Paiement: Cash\n     \u2705 Confirmer | \u270f\ufe0f Modifier | \u274c Annuler\nMerchant: \u2705\nBot: \u2705 Facture scell\u00e9e \u2014 N\u00b0 Fiscal: 001-2026-004821\n     \ud83d\udcce [T\u00e9l\u00e9charger PDF] | \ud83d\udcf1 [Voir QR]\n</code></pre> <p>Status query:</p> <pre><code>Merchant: Statut facture 004821\nBot: \u2705 Facture 001-2026-004821\n     Scell\u00e9e: 2026-06-15 14:32 UTC\n     DGI: Synchronis\u00e9 \u2705\n     Client: Ets Mwamba \u2014 69 600 FC\n</code></pre> <p>Report request:</p> <pre><code>Merchant: Rapport Z aujourd'hui\nBot: \ud83d\udcca Rapport Z \u2014 15 juin 2026\n     Factures: 47 | Total HT: 3 240 000 FC | TVA: 518 400 FC\n     \ud83d\udcce [T\u00e9l\u00e9charger PDF] | \ud83d\udcca [Voir d\u00e9tails]\n</code></pre>"},{"location":"platform/ai-capabilities/#security-constraints","title":"Security constraints","text":"<ul> <li>The bot never displays or transmits signing keys, HSM credentials, or raw auth codes in conversation.</li> <li>Receipts sent as PDF attachments include the QR code and fiscal number but the bot does not render the raw cryptographic signature.</li> <li>Session timeout: 15 minutes of inactivity.</li> <li>All bot interactions are logged in the audit trail with <code>source: \"whatsapp_bot\"</code>.</li> </ul>"},{"location":"platform/ai-capabilities/#phase-phase-2","title":"Phase: Phase 2","text":""},{"location":"platform/ai-capabilities/#3-tax-auto-classification","title":"3. Tax Auto-Classification","text":""},{"location":"platform/ai-capabilities/#problem_2","title":"Problem","text":"<p>DRC's 14 DGI tax groups are nuanced. Merchants frequently mis-classify items, leading to tax errors, compliance risk, and rejected returns. AI can suggest the correct tax group from the item description or HS code.</p>"},{"location":"platform/ai-capabilities/#specification_2","title":"Specification","text":"Attribute Detail Input Item description (free text), HS code (optional), product category Output Suggested tax group (TG01\u2013TG14), confidence score, explanation Model Classification model trained on DRC customs tariff schedule, DGI circulars, and historical Bono Pay transaction data Threshold \u2265 0.90 \u2192 auto-apply; 0.70\u20130.90 \u2192 suggest with explanation; &lt; 0.70 \u2192 manual classification required"},{"location":"platform/ai-capabilities/#tax-group-mapping-examples","title":"Tax group mapping examples","text":"Item description Suggested TG Confidence Explanation \"Ciment Portland 50kg\" TG01 (TVA 16%) 0.97 Construction materials \u2014 standard rate \"Cahiers scolaires A4\" TG04 (TVA 0% \u2014 exon\u00e9r\u00e9) 0.94 School supplies \u2014 exempt per DGI circular 2024/03 \"Bi\u00e8re Primus 72cl\" TG07 (Accise + TVA) 0.96 Alcoholic beverages \u2014 excise + VAT \"Consulting juridique\" TG01 (TVA 16%) 0.88 Professional services \u2014 standard rate \"Mat\u00e9riel m\u00e9dical import\u00e9\" TG05 (TVA 0% \u2014 exon\u00e9r\u00e9) 0.72 Medical equipment \u2014 review needed, exemption depends on end-use certificate"},{"location":"platform/ai-capabilities/#training-data-sources","title":"Training data sources","text":"<ol> <li>DRC customs tariff schedule (tarif douanier) \u2014 thousands of HS code \u2192 duty/tax mappings.</li> <li>DGI circulars and arr\u00eat\u00e9s \u2014 exemptions, special rates, and reclassifications.</li> <li>Bono Pay transaction history \u2014 real-world item descriptions with confirmed tax groups (post-Phase 1 pilot).</li> <li>Merchant product catalogs \u2014 uploaded during onboarding.</li> </ol>"},{"location":"platform/ai-capabilities/#integration-point","title":"Integration point","text":"<p>The Tax Auto-Classifier sits between the canonical payload builder and the Tax Engine. It runs during invoice creation (API, dashboard, or NL pipeline) and is also available as a standalone endpoint:</p> <pre><code>POST /api/v1/tax/classify\n{\n  \"items\": [\n    { \"description\": \"Ciment Portland 50kg\", \"hs_code\": \"2523.29\" },\n    { \"description\": \"Service de nettoyage\" }\n  ]\n}\n\nResponse:\n{\n  \"classifications\": [\n    { \"description\": \"Ciment Portland 50kg\", \"tax_group\": \"TG01\", \"confidence\": 0.97, \"explanation\": \"Construction materials \u2014 standard VAT rate\" },\n    { \"description\": \"Service de nettoyage\", \"tax_group\": \"TG01\", \"confidence\": 0.91, \"explanation\": \"Cleaning services \u2014 standard VAT rate\" }\n  ]\n}\n</code></pre>"},{"location":"platform/ai-capabilities/#phase-phase-2-model-training-begins-with-phase-1-pilot-data","title":"Phase: Phase 2 (model training begins with Phase 1 pilot data)","text":""},{"location":"platform/ai-capabilities/#4-anomaly-detection","title":"4. Anomaly Detection","text":""},{"location":"platform/ai-capabilities/#problem_3","title":"Problem","text":"<p>Fiscal fraud, numbering irregularities, and operational errors are difficult to catch manually at scale. AI monitors the Fiscal Ledger for patterns that indicate problems.</p>"},{"location":"platform/ai-capabilities/#specification_3","title":"Specification","text":"Attribute Detail Data source Fiscal Ledger (append-only, hash-chained), invoice metadata, sync logs Detection types See table below Alert channels Dashboard alert center, email, webhook (<code>anomaly.detected</code> event), WhatsApp bot Response Alert \u2192 human review \u2192 flag/dismiss/investigate"},{"location":"platform/ai-capabilities/#detection-categories","title":"Detection categories","text":"Category Pattern Severity Example Numbering anomaly Gap in fiscal number sequence, duplicate fiscal numbers, counter rollback Critical Fiscal number jumps from 004821 to 004823 \u2014 missing 004822 Velocity anomaly Unusual spike or drop in invoice volume for an outlet High Outlet invoiced 500 items in 1 hour vs. daily average of 50 Amount anomaly Invoice total significantly exceeds historical norms High Single invoice for 50M FC when outlet's max is typically 500K FC Timing anomaly Invoices generated outside business hours or in suspicious patterns Medium 200 invoices sealed between 02:00\u201303:00 AM Tax group anomaly Sudden shift in tax group distribution suggesting mis-classification Medium Outlet switches 80% of items from TG01 to TG04 (exempt) in one week Void/refund anomaly Excessive void or refund rate relative to sales High 40% void rate in a single shift Sync delay anomaly Invoices stuck in offline queue beyond grace period Medium 500 drafts queued for 72+ hours without sync"},{"location":"platform/ai-capabilities/#model-approach","title":"Model approach","text":"<ul> <li>Statistical baselines: Establish per-outlet, per-cashier, and per-time-period baselines using rolling 30-day windows.</li> <li>Isolation Forest / Autoencoder: Unsupervised anomaly detection on multivariate features (invoice count, total, tax group distribution, void rate, sync latency).</li> <li>Rule-based triggers: Hard rules for critical anomalies (numbering gaps, duplicate fiscal numbers) that bypass ML and alert immediately.</li> </ul>"},{"location":"platform/ai-capabilities/#phase-phase-2-rule-based-phase-4-ml-based","title":"Phase: Phase 2 (rule-based) / Phase 4 (ML-based)","text":""},{"location":"platform/ai-capabilities/#5-predictive-analytics","title":"5. Predictive Analytics","text":""},{"location":"platform/ai-capabilities/#problem_4","title":"Problem","text":"<p>Finance teams need forward-looking insights \u2014 projected tax liability, revenue trends, seasonal patterns \u2014 not just backward-looking reports.</p>"},{"location":"platform/ai-capabilities/#specification_4","title":"Specification","text":"Report Description Model Tax liability forecast Projected monthly/quarterly tax obligations based on current invoicing velocity and seasonal patterns Time-series forecasting (Prophet / ARIMA) Revenue projection Revenue forecast by outlet, product category, and client segment Time-series + regression Seasonal demand Identify peak/trough periods for inventory and staffing Seasonal decomposition Cash flow prediction Predict when mobile money vs. cash payments will be collected Classification + time-series Compliance risk score Per-outlet risk score based on anomaly history, sync reliability, and tax classification accuracy Logistic regression / gradient boosting"},{"location":"platform/ai-capabilities/#dashboard-integration","title":"Dashboard integration","text":"<p>Predictive insights surface in the web dashboard as:</p> <ul> <li>Forecast cards \u2014 \"Estimated TVA liability for March: 2.4M FC (\u00b18%)\" on the dashboard home.</li> <li>Trend charts \u2014 Revenue and tax projections overlaid on historical data with confidence intervals.</li> <li>Risk indicators \u2014 Color-coded compliance risk scores per outlet in the fleet view.</li> <li>Alerts \u2014 \"Tax liability projected to exceed 10M FC this quarter \u2014 review TG distribution\" in the alert center.</li> </ul>"},{"location":"platform/ai-capabilities/#api-access","title":"API access","text":"<pre><code>GET /api/v1/analytics/forecast?outlet_id=OUT-001&amp;metric=tax_liability&amp;period=quarterly\n</code></pre>"},{"location":"platform/ai-capabilities/#phase-phase-4-requires-sufficient-historical-data-from-phases-13","title":"Phase: Phase 4 (requires sufficient historical data from Phases 1\u20133)","text":""},{"location":"platform/ai-capabilities/#6-ocr-document-digitization","title":"6. OCR &amp; Document Digitization","text":""},{"location":"platform/ai-capabilities/#problem_5","title":"Problem","text":"<p>Many DRC businesses have years of paper invoices that are not in any digital system. Bono Pay can ingest these as historical records (not fiscally sealed \u2014 they're already issued) or convert incoming paper invoices from suppliers into structured data.</p>"},{"location":"platform/ai-capabilities/#specification_5","title":"Specification","text":"Attribute Detail Input Camera photo, scanned PDF, uploaded image Output Structured invoice data (items, amounts, tax groups, client info) Languages French, English Accuracy target \u2265 95% character accuracy, \u2265 90% field extraction accuracy Use cases (1) Digitize historical paper invoices for record-keeping. (2) Extract data from supplier invoices for purchase ledger entry."},{"location":"platform/ai-capabilities/#processing-pipeline","title":"Processing pipeline","text":"<pre><code>flowchart LR\n    SCAN[\"Photo / PDF Upload\"] --&gt; PREPROCESS[\"Image Preprocessing\\n(deskew, denoise, contrast)\"]\n    PREPROCESS --&gt; OCR[\"OCR Engine\\n(Tesseract / Cloud Vision)\"]\n    OCR --&gt; EXTRACT[\"Field Extractor\\n(NER + layout analysis)\"]\n    EXTRACT --&gt; REVIEW[\"Human Review UI\"]\n    REVIEW --&gt; STORE[\"Store as\\ndigitized record\\nor draft invoice\"]</code></pre>"},{"location":"platform/ai-capabilities/#constraints","title":"Constraints","text":"<ul> <li>OCR-digitized invoices are stored as <code>source: \"ocr_scan\"</code> and are not fiscally sealed unless the merchant explicitly requests a new fiscal event.</li> <li>The system never fabricates fiscal numbers for scanned historical invoices \u2014 they are informational records only.</li> <li>Low-quality scans (blurry, torn, partial) are flagged for manual entry.</li> </ul>"},{"location":"platform/ai-capabilities/#phase-phase-4","title":"Phase: Phase 4","text":""},{"location":"platform/ai-capabilities/#7-compliance-monitoring","title":"7. Compliance Monitoring","text":""},{"location":"platform/ai-capabilities/#problem_6","title":"Problem","text":"<p>DRC tax regulations change \u2014 new arr\u00eat\u00e9s, updated tax rates, revised exemption lists. Merchants need to know when changes affect their invoicing.</p>"},{"location":"platform/ai-capabilities/#specification_6","title":"Specification","text":"Attribute Detail Sources DGI website, official gazette (Journal Officiel), ministry circulars, partner legal advisors Detection NLP-based document analysis that identifies changes to tax rates, exemptions, invoicing requirements, and reporting obligations Output Alert with summary, affected tax groups, recommended action, and link to source document Review Bono Pay compliance team reviews and confirms before pushing to merchants"},{"location":"platform/ai-capabilities/#alert-examples","title":"Alert examples","text":"Change detected Affected TG Recommended action New arr\u00eat\u00e9 exempts agricultural inputs from TVA TG01 \u2192 TG04 for qualifying items Review product catalog and reclassify agricultural inputs DGI increases TVA rate from 16% to 18% TG01 Update tax engine rate; effective date: 2027-01-01 New reporting requirement: monthly electronic submission mandatory All Update Sync Agent schedule from weekly to daily batch"},{"location":"platform/ai-capabilities/#phase-phase-4-monitoring-ongoing-manual-review-by-compliance-team-from-phase-1","title":"Phase: Phase 4 (monitoring) / Ongoing (manual review by compliance team from Phase 1)","text":""},{"location":"platform/ai-capabilities/#8-smart-search-insights","title":"8. Smart Search &amp; Insights","text":""},{"location":"platform/ai-capabilities/#problem_7","title":"Problem","text":"<p>Finance teams and auditors ask questions like \"How much TVA did we collect on cement sales in Q3?\" or \"Show me all invoices for Ets Mwamba over 500,000 FC.\" Today they export data and use spreadsheets. Natural language search lets them ask directly.</p>"},{"location":"platform/ai-capabilities/#specification_7","title":"Specification","text":"Attribute Detail Input Natural language query in the dashboard search bar or via API Languages French, English Data source Fiscal Ledger, invoice metadata, reports, analytics Output Structured answer (table, chart, or summary) with source citations"},{"location":"platform/ai-capabilities/#query-examples","title":"Query examples","text":"Natural language query Structured interpretation Result type \"Total TVA pour ciment en Q3 2026\" <code>SUM(tax_amount) WHERE item LIKE 'ciment%' AND tax_group='TG01' AND date BETWEEN '2026-07-01' AND '2026-09-30'</code> Number + breakdown table \"Factures Ets Mwamba &gt; 500 000 FC\" <code>SELECT * FROM invoices WHERE client='Ets Mwamba' AND total &gt; 500000</code> Invoice list \"Quel caissier a le plus de factures annul\u00e9es ce mois?\" <code>SELECT cashier_id, COUNT(*) FROM invoices WHERE type='void' AND month=current GROUP BY cashier_id ORDER BY count DESC LIMIT 1</code> Ranked list \"Compare revenue outlet Gombe vs Limete this quarter\" Multi-outlet revenue comparison Bar chart"},{"location":"platform/ai-capabilities/#architecture","title":"Architecture","text":"<ul> <li>Text-to-SQL / Text-to-Query layer translates natural language into structured queries against the Fiscal Ledger read replica.</li> <li>Guardrails prevent queries that could expose raw signing keys, HSM credentials, or other merchants' data.</li> <li>Queries are scoped to the authenticated merchant's data and respect role-based access control.</li> <li>Complex queries that would scan more than 1M rows are queued and run async with progress indication.</li> </ul>"},{"location":"platform/ai-capabilities/#phase-phase-4_1","title":"Phase: Phase 4","text":""},{"location":"platform/ai-capabilities/#api-surface-summary","title":"API surface summary","text":"Endpoint Method Description Phase <code>/api/v1/invoices/natural</code> POST Create invoice from natural language text Phase 2 <code>/api/v1/tax/classify</code> POST Classify items into tax groups Phase 2 <code>/api/v1/analytics/forecast</code> GET Retrieve predictive forecasts Phase 4 <code>/api/v1/analytics/anomalies</code> GET List detected anomalies Phase 2 <code>/api/v1/ocr/scan</code> POST Upload document for OCR extraction Phase 4 <code>/api/v1/search/query</code> POST Natural language search over fiscal data Phase 4 <p>All AI endpoints inherit the same authentication (Bearer token), rate limiting, and tenant isolation as the core invoicing API.</p>"},{"location":"platform/ai-capabilities/#model-hosting-infrastructure","title":"Model hosting &amp; infrastructure","text":"Component Technology Notes NL Invoice Parser Fine-tuned multilingual LLM (mT5 / Mistral) + RAG Hosted within Bono Pay cloud boundary Tax Auto-Classifier Gradient-boosted classifier + embedding similarity Trained on DRC tariff schedule + transaction history Anomaly Detection Isolation Forest + rule engine Statistical baselines per outlet Predictive Analytics Prophet / ARIMA time-series models Runs on Fiscal Ledger read replica OCR Tesseract + Cloud Vision API (opt-in) Image preprocessing pipeline Smart Search Text-to-SQL (fine-tuned CodeLlama / StarCoder) Sandboxed query execution Compliance Monitor NLP document classifier + change detector Semi-automated with human review <p>All models run on dedicated compute within the Bono Pay cloud boundary. Inference latency targets: &lt; 2 s for NL parsing, &lt; 500 ms for tax classification, &lt; 1 s for search queries.</p>"},{"location":"platform/ai-capabilities/#privacy-data-governance","title":"Privacy &amp; data governance","text":"<ul> <li>Data residency: All training data and model weights stay within the Bono Pay cloud boundary (same region as the Fiscal Ledger).</li> <li>No cross-tenant training: Models are fine-tuned per merchant or on anonymized aggregate data. One merchant's invoice data never trains another merchant's model.</li> <li>Audit trail: Every AI suggestion, confidence score, and human override is logged with <code>ai_suggestion_id</code>, <code>model_version</code>, and <code>accepted: true/false</code>.</li> <li>Opt-in for cloud AI: Merchants who prefer not to use AI features can disable them at the outlet level. Tax classification falls back to manual selection.</li> <li>Data retention for training: Transaction data used for model training follows the same 10-year regulatory retention requirement as the Fiscal Ledger.</li> </ul>"},{"location":"platform/ai-capabilities/#phasing-summary","title":"Phasing summary","text":"Capability Phase 1 Phase 2 Phase 4 Natural Language Invoice Creation \u2014 WhatsApp bot + chat widget Voice input, advanced NLU WhatsApp Invoice Bot \u2014 Core flows (create, status, reports) Extended (analytics, alerts) Tax Auto-Classification \u2014 Model training + API Auto-apply with high confidence Anomaly Detection \u2014 Rule-based alerts ML-based + compliance scoring Predictive Analytics \u2014 \u2014 Full forecasting suite OCR &amp; Document Digitization \u2014 \u2014 Camera + PDF pipeline Compliance Monitoring Manual review Manual review NLP-assisted monitoring Smart Search &amp; Insights \u2014 \u2014 Text-to-SQL search"},{"location":"platform/api/","title":"Invoicing API","text":"<p>Bono Pay is fiscal invoicing infrastructure for the DRC. The Invoicing API is the primary developer surface that receives canonical payloads, applies the 14 DGI tax groups, and routes the request through the Cloud Signing Service (HSM-backed). Every fiscal event is numbered by the Monotonic Counter Manager, signed inside the HSM, timestamped, and stored in the hash-chained fiscal ledger before Bono Pay returns the sealed response to the caller. This surface honors the SFE specifications (docs/sfe-specifications-v1-summary) by supporting the five mandatory invoice types, the 14 tax groups, immutable security elements, and offline queueing semantics required by the DGI.</p>"},{"location":"platform/api/#authentication","title":"Authentication","text":"<p>Requests require an outbound API key scoped to a merchant and an outlet. Send <code>Authorization: Bearer &lt;token&gt;</code> plus <code>X-BonoPay-Merchant-ID</code> and <code>X-BonoPay-Outlet-ID</code> headers so the Cloud can enforce multi-tenant quotas. Optional headers such as <code>X-BonoPay-User-ID</code> or <code>X-BonoPay-Source</code> help auditors trace which dashboard user, SDK, or future POS terminal produced a fiscal request. The platform enforces rate limits per outlet and per API key (e.g., 60 requests/min); honor <code>Retry-After</code> in <code>429</code> responses and back off accordingly.</p>"},{"location":"platform/api/#core-endpoints","title":"Core endpoints","text":""},{"location":"platform/api/#post-apiv1invoices","title":"POST /api/v1/invoices","text":"<p>Create and fiscalize an invoice in one call. Bono Pay validates the canonical payload, applies the tax engine (all 14 DGI tax groups plus client classification), and forwards the payload to the Cloud Signing Service (HSM). The cloud assigns the next sequential fiscal number for the outlet, signs the payload, timestamps it, generates the QR payload, stores the sealed invoice in the fiscal ledger, and returns the response that clients may display or deliver via email/WhatsApp/PDF/print.</p> <p>Bono Pay enforces deterministic field ordering so every signature is reproducible. Clients queue invoices locally (IndexedDB on the dashboard or SQLite in SDKs) when offline and flush them via this endpoint once connectivity returns.</p>"},{"location":"platform/api/#canonical-payload","title":"Canonical payload","text":"<ol> <li><code>merchant_nif</code> (string) \u2014 tax identifier for the merchant issuing the invoice.</li> <li><code>outlet_id</code> (string) \u2014 the outlet within the merchant namespace.</li> <li><code>pos_terminal_id</code> (string) \u2014 the terminal, SDK, or service creating the invoice.</li> <li><code>cashier_id</code> (string) \u2014 operator or session token.</li> <li><code>invoice_type</code> (sale, advance, credit_note, export, export_credit).</li> <li><code>timestamp</code> (ISO 8601 UTC) \u2014 when the invoice was authored.</li> <li><code>client</code> \u2014 object with <code>name</code>, <code>nif</code>, and <code>classification</code> (<code>Individual</code>, <code>Company</code>, <code>CommercialIndividual</code>, <code>Professional</code>, <code>Embassy</code>).</li> <li><code>items[]</code> \u2014 array of line items; each entry lists <code>code</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, and <code>taxable_unit</code>.</li> <li><code>tax_groups[]</code> \u2014 array covering each of the 14 DGI tax groups present (<code>code</code>, <code>name</code>, <code>rate</code>, <code>base_amount</code>, <code>tax_amount</code>).</li> <li><code>totals</code> \u2014 object with <code>subtotal</code>, <code>total_vat</code>, <code>total</code>, and <code>currency</code>.</li> <li><code>payments[]</code> \u2014 array of payment instruments with <code>method</code>, <code>amount</code>, <code>instrument_id</code>, and <code>currency</code>.</li> </ol> <pre><code>{\n  \"merchant_nif\": \"308123456\",\n  \"outlet_id\": \"outlet-kin001\",\n  \"pos_terminal_id\": \"sdk-js-01\",\n  \"cashier_id\": \"cashier-13\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-17T04:00:00Z\",\n  \"client\": {\n    \"name\": \"Acme Ltd\",\n    \"nif\": \"123456789\",\n    \"classification\": \"Company\"\n  },\n  \"items\": [\n    {\n      \"code\": \"CONS-001\",\n      \"description\": \"Consulting hours\",\n      \"quantity\": 2,\n      \"unit_price\": \"500.00\",\n      \"tax_group\": \"TG03\",\n      \"taxable_unit\": \"hour\"\n    }\n  ],\n  \"tax_groups\": [\n    {\n      \"code\": \"TG03\",\n      \"name\": \"Standard VAT \u2014 Services\",\n      \"rate\": \"0.16\",\n      \"base_amount\": \"1000.00\",\n      \"tax_amount\": \"160.00\"\n    }\n  ],\n  \"totals\": {\n    \"subtotal\": \"1000.00\",\n    \"total_vat\": \"160.00\",\n    \"total\": \"1160.00\",\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    {\n      \"method\": \"mobile_money\",\n      \"amount\": \"1160.00\",\n      \"instrument_id\": \"AIRTEL-001\",\n      \"currency\": \"CDF\"\n    }\n  ]\n}\n</code></pre>"},{"location":"platform/api/#get-apiv1invoicesfiscal_number","title":"GET /api/v1/invoices/{fiscal_number}","text":"<p>Retrieve a sealed invoice with every security element and ledger metadata. The response includes the canonical payload, fiscal number, fiscal authority ID, authentication code, timestamp, QR payload, <code>ledger_hash</code>, <code>dgi_status</code> (<code>queued</code>, <code>synced</code>, <code>failed</code>), and the originating <code>outlet_id</code>.</p>"},{"location":"platform/api/#get-apiv1invoices","title":"GET /api/v1/invoices","text":"<p>List invoices with filters (<code>merchant_nif</code>, <code>outlet_id</code>, <code>date_range</code>, <code>client.nif</code>, <code>status</code>, <code>fiscal_number</code>) plus pagination (<code>page</code>, <code>per_page</code>). Sort by <code>timestamp</code> or <code>fiscal_number</code>. Include query parameters to surface <code>dgi_status</code> so dashboards can display completion badges (real-time vs. queued).</p>"},{"location":"platform/api/#post-apiv1invoicesfiscal_numbervoid","title":"POST /api/v1/invoices/{fiscal_number}/void","text":"<p>Issue a credit note fiscal event. Provide the reason and item adjustments; Bono Pay treats the event as a new fiscal event, repeats the tax engine work, signs it via the Cloud Signing Service, and appends it to the ledger while referencing the original invoice.</p>"},{"location":"platform/api/#post-apiv1invoicesfiscal_numberrefund","title":"POST /api/v1/invoices/{fiscal_number}/refund","text":"<p>Create a refund fiscal event that preserves audit trails. Include the refund <code>amount</code>, <code>currency</code>, <code>payment_reference</code>, and optional <code>reason</code>. The Cloud Signing Service returns a new fiscal number/auth code pair for the refund.</p>"},{"location":"platform/api/#post-apiv1reports","title":"POST /api/v1/reports","text":"<p>Trigger Z/X/A and audit exports derived from the cloud fiscal ledger. Provide the report <code>type</code>, applicable <code>outlet_id</code>, and the <code>period</code> (date or shift). The response carries <code>report_id</code>, <code>download_url</code>, and the <code>ledger_hash</code> digest that links the report back to the sealed invoices.</p>"},{"location":"platform/api/#get-apiv1tax-groups","title":"GET /api/v1/tax-groups","text":"<p>Return the manifest of all 14 DGI tax groups with <code>code</code>, <code>name</code>, <code>rate</code>, and <code>effective_from</code> timestamps. Clients cache this payload so offline queues can compute totals before submission.</p>"},{"location":"platform/api/#response-structure","title":"Response structure","text":"<p>Bono Pay returns a sealed invoice envelope that mirrors the canonical payload plus the security elements minted inside the Cloud Signing Service (HSM).</p> <pre><code>{\n  \"status\": \"ok\",\n  \"code\": \"INVOICE_FISCALIZED\",\n  \"payload\": {\n    \"fiscal_number\": \"BONO-2026-000458\",\n    \"auth_code\": \"H8F2-A9D3-9001\",\n    \"timestamp\": \"2026-02-17T04:00:02Z\",\n    \"qr_payload\": \"https://bonopay.cd/verify?fiscal_number=BONO-2026-000458\",\n    \"fiscal_authority_id\": \"cloud-signer-west-1\",\n    \"dgi_status\": \"queued\",\n    \"ledger_hash\": \"e3b0c44298fc1c149afbf4c8996fb924\",\n    \"security_elements\": {\n      \"fiscal_number\": \"BONO-2026-000458\",\n      \"auth_code\": \"H8F2-A9D3-9001\",\n      \"timestamp\": \"2026-02-17T04:00:02Z\",\n      \"qr_payload\": \"https://bonopay.cd/verify?fiscal_number=BONO-2026-000458\",\n      \"fiscal_authority_id\": \"cloud-signer-west-1\"\n    }\n  }\n}\n</code></pre> <p>The <code>dgi_status</code> field tracks whether the Sync Agent has uploaded the sealed invoice to the DGI: <code>queued</code>, <code>synced</code>, or <code>failed</code>. Client apps can highlight the sync status (green Real-time, yellow Queued, red Retry) without ever fabricating <code>fiscal_number</code> or <code>auth_code</code>.</p>"},{"location":"platform/api/#error-handling","title":"Error handling","text":"<ul> <li><code>400 Invalid canonical payload</code> \u2014 missing fields, incorrect ordering, or mismatched tax totals.</li> <li><code>401 Unauthorized</code> \u2014 missing or invalid bearer token.</li> <li><code>403 Forbidden</code> \u2014 the API key lacks scope for the merchant/outlet requested.</li> <li><code>422 Fiscalization failed</code> \u2014 the Cloud Signing Service rejected the payload (totals, tax group mismatch, unsupported invoice type).</li> <li><code>429 Too many requests</code> \u2014 rate limit exceeded; honor the <code>Retry-After</code> header before resubmitting.</li> <li><code>500 Internal server error</code> \u2014 transient HSM, ledger, or Sync Agent failure; retry with exponential backoff.</li> </ul>"},{"location":"platform/api/#webhook-notifications","title":"Webhook notifications","text":"<p>Bono Pay can deliver webhook notifications when invoices change state. Each webhook is signed with <code>X-BonoPay-Signature</code> (HMAC-SHA256) and includes <code>fiscal_number</code>, <code>dgi_status</code>, <code>ledger_hash</code>, and the canonical payload hash. Statuses include <code>fiscalized</code>, <code>synced</code>, <code>dgi_acknowledged</code>, and <code>fiscal_error</code>. Queue indicators (e.g., <code>Queued \u2192 Fiscalized</code>) let dashboards update colored badges in near real time.</p> <pre><code>{\n  \"event\": \"invoice.fiscalized\",\n  \"fiscal_number\": \"BONO-2026-000458\",\n  \"dgi_status\": \"queued\",\n  \"ledger_hash\": \"e3b0c44298fc1c149afbf4c8996fb924\",\n  \"source\": \"dashboard\",\n  \"security_elements\": {\n    \"auth_code\": \"H8F2-A9D3-9001\",\n    \"timestamp\": \"2026-02-17T04:00:02Z\"\n  }\n}\n</code></pre>"},{"location":"platform/api/#code-examples","title":"Code examples","text":""},{"location":"platform/api/#curl","title":"CURL","text":"<pre><code>curl -X POST https://api.bonopay.cd/api/v1/invoices \\\n  -H \"Authorization: Bearer $BONOPAY_API_TOKEN\" \\\n  -H \"X-BonoPay-Merchant-ID: bonopay-ks-1\" \\\n  -H \"X-BonoPay-Outlet-ID: outlet-kin001\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '@invoice.json'\n</code></pre>"},{"location":"platform/api/#python","title":"Python","text":"<pre><code>import requests\n\nresponse = requests.post(\n    \"https://api.bonopay.cd/api/v1/invoices\",\n    headers={\n        \"Authorization\": f\"Bearer {os.environ['BONOPAY_API_TOKEN']}\",\n        \"X-BonoPay-Merchant-ID\": \"bonopay-ks-1\",\n        \"X-BonoPay-Outlet-ID\": \"outlet-kin001\"\n    },\n    json=invoice_payload  # see canonical structure above\n)\n\nresponse.raise_for_status()\nprint(response.json()[\"payload\"][\"fiscal_number\"])\n</code></pre>"},{"location":"platform/api/#javascript","title":"JavaScript","text":"<pre><code>const createInvoice = async (payload) =&gt; {\n  const response = await fetch(\"https://api.bonopay.cd/api/v1/invoices\", {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${BONOPAY_API_TOKEN}`,\n      \"X-BonoPay-Merchant-ID\": \"bonopay-ks-1\",\n      \"X-BonoPay-Outlet-ID\": \"outlet-kin001\",\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify(payload)\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.code);\n  }\n\n  return response.json().payload;\n};\n\nconst memoryPayload = {\n  /* canonical payload */\n};\n</code></pre>"},{"location":"platform/dashboard/","title":"Web Dashboard","text":"<p>The Bono Pay Web Dashboard is a Progressive Web App layer that sits in the untrusted client zone. It loads in any modern browser, caches product/customer catalogs, and builds canonical payloads that are sent to the Cloud Signing Service (HSM-backed) for sequential fiscal numbering, signature generation, and QR payload creation. Every fiscalized invoice is then mirrored back to the UI for receipts, reports, and DGI sync status, while the UI keeps a secondary queue of uploads that still need confirmation from the cloud.</p>"},{"location":"platform/dashboard/#architecture","title":"Architecture","text":"<ul> <li>PWA + Service Worker. The dashboard is a single-page Progressive Web App. This design means the UI assets (HTML, CSS, JS, fonts, icons) are cached by a Service Worker, so even the cheapest Android tablet boots instantly after the first visit.</li> <li>IndexedDB cache &amp; queue. Product catalogs, customer lists, tax group manifests, and queued uploads live in IndexedDB so the UI can search instantly even while offline. The queue stores canonical invoices (deterministic field order) and tracks whether they have been uploaded to the cloud or are waiting for acknowledgement.</li> <li>Background sync for canonical payloads. The UI drafts invoices locally, shows a fiscal ribbon while it sends <code>POST /api/v1/invoices</code> to Bono Pay Cloud, and waits for the HSM-backed Cloud Signing Service to reply with fiscal number, auth code, timestamp, and QR. Only after <code>status: ok</code> arrives does the UI deem the sale complete and enable receipt delivery or sync retries.</li> </ul> <p>Lessons from Odoo</p> <p>We reuse Odoo\u2019s single-screen checkout, IndexedDB caching, and offline resilience but overlay fiscal-status indicators, dual-currency displays, and mobile money-native chips. The dashboard feels familiar to merchants while respecting the trust boundary: the UI never fabricates fiscal numbers or tamper-resistant hashes.</p>"},{"location":"platform/dashboard/#key-screens","title":"Key Screens","text":""},{"location":"platform/dashboard/#invoice-creation","title":"Invoice creation","text":"<p>Single-screen checkout, inspired by Odoo, keeps the product grid, order summary, and numpad visible together. Large tap targets, instant search-as-you-type, barcode scanning, and favorites speed entry. Each line item shows its DGI tax group badge and updates dual-currency totals (CDF + USD) in real time. A mandatory client classification selector (individual, company, commercial individual, professional, embassy) enables the Submit button.</p>"},{"location":"platform/dashboard/#invoice-list-search","title":"Invoice list &amp; search","text":"<p>Filters for date range, client NIF, fiscal number, and status (fiscalized / queued / error) help cashiers retrieve past sales. Each row highlights the fiscal number, auth code snippet, QR preview, and a Delivery column that lists emailed, WhatsApp, PDF, or thermal print copies. Queued invoices display a yellow badge until the cloud confirms receipt.</p>"},{"location":"platform/dashboard/#client-classification-management","title":"Client &amp; classification management","text":"<p>This screen houses DRC client metadata (classification, tax ID, contact information) and lets finance teams update tax group defaults, multi-currency pricing, or mobile money preferences. Every client record is referenced when building canonical payloads that the Cloud Signing Service validates.</p>"},{"location":"platform/dashboard/#reports-reconciliation","title":"Reports &amp; reconciliation","text":"<p>Session dashboards show Z/X/A totals, tax-group breakdowns, offline queue depth, and DGI sync status. When a cashier closes a session, the UI calls <code>POST /api/v1/reports</code> (Z report) and displays the device signature, ledger hash, and audit export links. A \u201cReport ready\u201d badge stays on until DGI acknowledges the batch.</p>"},{"location":"platform/dashboard/#settings-access-controls","title":"Settings &amp; access controls","text":"<p>Outlets, API keys, and roles (admin, invoicer, viewer, auditor) are managed here. Each API key is scoped to an outlet, and the UI surfaces the <code>outlet_id</code>, <code>user_id</code>/<code>api_key_id</code>, and <code>source</code> (dashboard, API, SDK, POS) so the Monotonic Counter Manager in Bono Pay Cloud can serialize numbering without conflicts.</p>"},{"location":"platform/dashboard/#ux-principles","title":"UX Principles","text":"<ol> <li>Offline-first &amp; responsive. Service Worker + IndexedDB cache the catalog, assets, and queue so the UI renders instantly on a $50 tablet even when connectivity drops.</li> <li>Single-screen workflow. Product grid \u2192 order summary \u2192 numpad: no page refreshes required. Instant product search, barcode scans, and favorites keep interactions snappy.</li> <li>Minimal typing. Tap, drag, and numpad entry replace keyboards. Customer selection, classification, and notes remain the only required text inputs.</li> <li>Fiscal status ribbon. A persistent banner reports Device connected/disconnected/error with green/yellow/red states. It shows the latest fiscal number, the last auth code, and any blocking compliance warnings. Receipt printing is disabled until the Ribbon confirms fiscalization.</li> <li>Dual-currency totals. Subtotals, VAT, and grand totals display both CDF and USD so merchants can compare against their reference rate while the canonical payload records every currency field for the Cloud Signing Service.</li> <li>Mobile money-first payments. Payment chips for Airtel Money, M-Pesa, Orange Money, cash, and bank transfer show currency, available balance, and split-payment stacking. Payment icons stay legible even at smaller sizes.</li> <li>Localized &amp; accessible. Language toggles (French / Lingala), high-contrast badges, and text-scaling controls keep the dashboard WCAG-friendly, especially around fiscal status and offline warnings.</li> </ol>"},{"location":"platform/dashboard/#offline-first-operations","title":"Offline-first operations","text":"<p>Fiscalization always happens before anything else. When connectivity disappears, the invoice remains fiscalized (Cloud Signing Service signed) but the upload to DGI is pending. The offline queue widget sits in the footer and shows \u201cX invoices pending cloud sync.\u201d It is separate from the fiscal status ribbon and only tracks uploads, not fiscalization. If invoices linger for too long, the widget turns amber and surfaces a \u201cRetry upload\u201d action. Once connectivity returns, the Service Worker wakes up, flushes pending payloads, and updates each row\u2019s sync badge.</p> <p>Offline queue vs. fiscal status</p> <p>Fiscal status uses green/yellow/red badges for Connected/Queued/Error states (gas green = real-time signing, yellow = invoice waiting for cloud sync, red = device or network error). The offline queue widget tracks uploads to the cloud and DGI and offers manual retry when necessary.</p>"},{"location":"platform/dashboard/#delivery-fiscal-confirmation","title":"Delivery &amp; fiscal confirmation","text":"<p>After the Cloud Signing Service replies, the UI shows a success toast with the fiscal number, auth code, timestamp, and QR preview. Receipt delivery options include email, WhatsApp share, PDF download, and browser print (thermal print via printer APIs). The dashboard also stores the ledger hash and DGI sync status for audit requests and exposes <code>POST /api/v1/reports</code> links (Z, X, A, audit export) so auditors can download sealed data without touching the USB device.</p>"},{"location":"platform/dashboard/#mermaid-wireframe-flow","title":"Mermaid wireframe flow","text":"<pre><code>flowchart LR\n    A[\"Dashboard\"] --&gt; B[\"Create Invoice\"]\n    B --&gt; C[\"Add Items + Tax\"]\n    C --&gt; D[\"Submit to Bono Pay Cloud\"]\n    D --&gt; E[\"Cloud Signing Service HSM\"]\n    E --&gt; F[\"Receipt Delivery\\nemail / WhatsApp / PDF / print\"]</code></pre>"},{"location":"platform/integrations/","title":"Integrations","text":"<p>Bono Pay is designed as an API-first invoicing platform \u2014 every feature available in the web dashboard is also available through the REST API and SDKs. This page describes the integration tiers, partner connectors, and webhook system that allow external systems to consume sealed fiscal invoices, reports, and compliance events.</p>"},{"location":"platform/integrations/#integration-tiers","title":"Integration tiers","text":"<pre><code>flowchart LR\n    subgraph Tier1[\"Tier 1 \u2014 REST API\"]\n        API[\"Bono Pay REST API\\n(invoices, reports, audit)\"]\n    end\n    subgraph Tier2[\"Tier 2 \u2014 SDKs\"]\n        JS[\"JavaScript SDK\"]\n        PY[\"Python SDK\"]\n    end\n    subgraph Tier3[\"Tier 3 \u2014 Webhooks\"]\n        WH[\"Webhook delivery\\n(signed payloads)\"]\n    end\n    subgraph Tier4[\"Tier 4 \u2014 ERP Connectors\"]\n        SAP[\"SAP S/4HANA\"]\n        Odoo[\"Odoo\"]\n        Custom[\"Custom ERP\"]\n    end\n    API --&gt; JS\n    API --&gt; PY\n    API --&gt; WH\n    WH --&gt; SAP\n    WH --&gt; Odoo\n    WH --&gt; Custom</code></pre> Tier Description Phase Tier 1 \u2014 REST API Direct HTTPS calls to the Bono Pay Cloud API. Full access to invoice creation, status queries, report generation, and audit exports. Phase 1 Tier 2 \u2014 SDKs Official client libraries (JavaScript, Python) that wrap the REST API with offline queuing, retry logic, and type-safe models. Phase 1 Tier 3 \u2014 Webhooks Event-driven notifications pushed to customer endpoints when invoices are sealed, reports are generated, or sync errors occur. Payloads are signed for verification. Phase 2 Tier 4 \u2014 ERP Connectors Pre-built connectors for SAP S/4HANA and Odoo that map Bono Pay's 14 tax groups to ERP tax codes, sync sealed invoices, and push acknowledgement receipts. Phase 4"},{"location":"platform/integrations/#rest-api-integration","title":"REST API integration","text":"<p>The REST API is the foundation for all integrations. Key capabilities:</p> Endpoint Method Description <code>/api/v1/invoices</code> POST Submit a canonical payload for fiscalization <code>/api/v1/invoices/{fiscal_number}</code> GET Retrieve a sealed invoice <code>/api/v1/invoices/batch</code> POST Submit multiple payloads in one request <code>/api/v1/reports</code> POST Generate Z/X/A reports <code>/api/v1/audit/export</code> GET Download hash-chained journal exports <code>/api/v1/outlets/{outlet_id}/status</code> GET Check outlet sync health and counter <code>/api/v1/verify/{fiscal_number}</code> GET Public \u2014 verify invoice authenticity (no auth required) <p>All endpoints require TLS 1.3+, <code>Authorization: Bearer &lt;api_key&gt;</code>, and return JSON responses. See the Cloud API Reference for full request/response schemas.</p>"},{"location":"platform/integrations/#webhook-events","title":"Webhook events","text":"<p>Webhooks notify external systems of fiscal events in near real-time. Each webhook delivery includes:</p> <ul> <li>Signed payload \u2014 HMAC-SHA256 signature in the <code>X-Bono-Signature</code> header, computed with the webhook secret.</li> <li>Event type \u2014 identifies what happened (see table below).</li> <li>Idempotency key \u2014 prevents duplicate processing on the receiver side.</li> </ul> Event Trigger Payload highlights <code>invoice.sealed</code> Cloud Signing Service seals an invoice <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>outlet_id</code> <code>invoice.sync.success</code> DGI acknowledges the invoice <code>fiscal_number</code>, <code>dgi_status</code>, <code>acknowledged_at</code> <code>invoice.sync.failed</code> DGI upload fails after max retries <code>fiscal_number</code>, <code>error</code>, <code>retry_count</code> <code>report.generated</code> Z/X/A report is ready <code>report_id</code>, <code>type</code>, <code>download_url</code> <code>outlet.offline_alert</code> Client drafts exceed grace period <code>outlet_id</code>, <code>draft_count</code>, <code>oldest_draft_age</code>"},{"location":"platform/integrations/#webhook-configuration","title":"Webhook configuration","text":"<pre><code>POST /api/v1/webhooks\n{\n  \"url\": \"https://erp.example.com/bono-events\",\n  \"events\": [\"invoice.sealed\", \"report.generated\"],\n  \"secret\": \"whsec_...\",\n  \"active\": true\n}\n</code></pre>"},{"location":"platform/integrations/#erp-connectors-phase-4","title":"ERP connectors (Phase 4)","text":"<p>Pre-built connectors for enterprise systems:</p>"},{"location":"platform/integrations/#sap-s4hana","title":"SAP S/4HANA","text":"<ul> <li>Ingest sealed invoices via IDoc or OData.</li> <li>Map TG01\u2013TG14 to SAP tax codes automatically.</li> <li>Push journal entries to FI/CO modules.</li> <li>Reconcile fiscal reports with SAP cash management.</li> </ul>"},{"location":"platform/integrations/#odoo","title":"Odoo","text":"<ul> <li>Sync sealed invoices to Odoo's <code>account.move</code> model.</li> <li>Map tax groups to Odoo fiscal positions.</li> <li>Auto-generate Odoo payment entries from Bono Pay payment data.</li> <li>Dashboard widget showing DGI sync status.</li> </ul>"},{"location":"platform/integrations/#custom-erp","title":"Custom ERP","text":"<ul> <li>Use the webhook API (Tier 3) to receive events.</li> <li>Use the REST API (Tier 1) to pull invoices and reports on demand.</li> <li>Reference the canonical payload schema in <code>spec/schema-tax-engine-1.md</code> for field mapping.</li> </ul>"},{"location":"platform/integrations/#mobile-money-integration-phase-2","title":"Mobile money integration (Phase 2)","text":"<p>Bono Pay supports mobile money as a payment method within invoices:</p> Provider Integration method Notes M-Pesa API callback Payment confirmation triggers invoice submission Airtel Money API callback Same flow as M-Pesa Orange Money API callback Same flow as M-Pesa <p>Mobile money payments are recorded in the invoice's <code>payments</code> array with <code>method: \"mobile_money\"</code> and the provider reference. The payment status does not affect fiscalization \u2014 invoices can be sealed before or after payment confirmation.</p>"},{"location":"platform/integrations/#pos-integration-phase-2","title":"POS integration (Phase 2)","text":"<p>In Phase 2, point-of-sale systems connect to Bono Pay as API consumers:</p> <ul> <li>POS terminals submit canonical payloads via the REST API or SDK.</li> <li>The POS SDK handles offline queuing, retry logic, and receipt rendering.</li> <li>Multi-terminal outlets share a single fiscal counter via the Monotonic Counter Manager.</li> <li>See Multi-User Access Control for details on terminal/user identity.</li> </ul>"},{"location":"platform/integrations/#ai-powered-integration-surfaces","title":"AI-powered integration surfaces","text":"<p>Bono Pay embeds AI across its integration tiers so external systems and end-users benefit from natural language processing, automated classification, and intelligent alerting:</p> AI capability Integration point Phase Natural Language Invoice API (<code>/api/v1/invoices/natural</code>) Any REST client or SDK can submit invoices as free-text French/Lingala/Swahili instead of structured JSON Phase 2 Tax Auto-Classification (<code>/api/v1/tax/classify</code>) ERPs and POS systems call the classifier to suggest tax groups before building the canonical payload Phase 2 Anomaly Detection webhooks (<code>anomaly.detected</code> event) External systems receive real-time alerts when the Fiscal Ledger shows irregularities Phase 2 Smart Search API (<code>/api/v1/search/query</code>) Dashboards and BI tools query fiscal data using natural language Phase 4 WhatsApp Bot Merchants create, query, and receive invoices via WhatsApp Business API Phase 2 <p>See AI &amp; Natural Language Capabilities for full specifications.</p>"},{"location":"platform/integrations/#security-considerations","title":"Security considerations","text":"<ul> <li>All integrations authenticate via API keys scoped to specific outlets and permissions.</li> <li>Webhook payloads are signed with HMAC-SHA256; receivers must verify the signature before processing.</li> <li>ERP connectors use OAuth 2.0 or certificate-based authentication for the ERP side.</li> <li>API keys can be rotated and revoked without downtime.</li> <li>Rate limiting protects the API from abuse (default: 100 req/s per API key).</li> <li>AI endpoints inherit the same authentication, rate limiting, and tenant isolation as the core invoicing API. AI models run within the Bono Pay cloud boundary \u2014 no customer data is sent to third-party providers unless explicitly opted in.</li> </ul>"},{"location":"platform/multi-user/","title":"Multi-User Access Control","text":"<p>Bono Pay supports multiple users, API keys, and roles within a single merchant account. Each outlet can have many concurrent users (cashiers, managers, API integrators) submitting invoices through the API, web dashboard, or SDK \u2014 while the Monotonic Counter Manager in the Cloud Signing Service guarantees serialized fiscal numbering per outlet.</p>"},{"location":"platform/multi-user/#identity-model","title":"Identity model","text":"<pre><code>flowchart TD\n    Merchant[\"Merchant (NIF)\"] --&gt; Outlet1[\"Outlet A\"]\n    Merchant --&gt; Outlet2[\"Outlet B\"]\n    Outlet1 --&gt; User1[\"User: Cashier 1\\n(dashboard login)\"]\n    Outlet1 --&gt; User2[\"User: Cashier 2\\n(dashboard login)\"]\n    Outlet1 --&gt; Key1[\"API Key: ERP Integration\\n(server-to-server)\"]\n    Outlet2 --&gt; User3[\"User: Manager\\n(dashboard login)\"]\n    Outlet2 --&gt; Key2[\"API Key: Mobile App\\n(SDK)\"]</code></pre> Entity Description Identifier Merchant The legal entity registered with the DGI. Owns one or more outlets. <code>merchant_nif</code> Outlet A physical or logical business location. Each outlet has its own fiscal counter. <code>outlet_id</code> User A human who logs into the web dashboard. Assigned a role per outlet. <code>user_id</code> API Key A programmatic credential for server-to-server or SDK access. Scoped to an outlet. <code>api_key_id</code>"},{"location":"platform/multi-user/#roles-and-permissions","title":"Roles and permissions","text":"Role Create invoices View invoices Generate reports Manage users/keys Manage outlet settings Cashier \u2705 Own only \u274c \u274c \u274c Supervisor \u2705 All in outlet \u2705 \u274c \u274c Manager \u2705 All in outlet \u2705 \u2705 \u2705 Owner \u2705 All outlets \u2705 \u2705 \u2705 API Key \u2705 Scoped Scoped \u274c \u274c <p>Principle of least privilege</p> <p>Users and API keys default to the most restrictive permissions. Elevated roles must be explicitly granted by an Owner or Manager.</p>"},{"location":"platform/multi-user/#fiscal-numbering-under-concurrency","title":"Fiscal numbering under concurrency","text":"<p>When multiple users or API keys submit invoices to the same outlet simultaneously, the Monotonic Counter Manager serializes them:</p> <ol> <li>Each invoice request enters a per-outlet queue inside the Cloud Signing Service.</li> <li>The counter increments atomically under serializable database isolation \u2014 no gaps, no duplicates.</li> <li>The sealed response includes the assigned <code>fiscal_number</code> and the <code>user_id</code> or <code>api_key_id</code> that submitted the payload, providing full traceability.</li> </ol> <pre><code>sequenceDiagram\n    participant C1 as Cashier 1\n    participant C2 as Cashier 2\n    participant API as API Gateway\n    participant HSM as Cloud Signing Service\n    participant Counter as Monotonic Counter\n\n    C1-&gt;&gt;API: POST /invoices (payload A)\n    C2-&gt;&gt;API: POST /invoices (payload B)\n    API-&gt;&gt;HSM: Enqueue payload A\n    API-&gt;&gt;HSM: Enqueue payload B\n    HSM-&gt;&gt;Counter: Acquire next fiscal number (serialized)\n    Counter--&gt;&gt;HSM: fiscal_number = 101\n    HSM--&gt;&gt;API: Sealed response A (fiscal_number: 101)\n    HSM-&gt;&gt;Counter: Acquire next fiscal number\n    Counter--&gt;&gt;HSM: fiscal_number = 102\n    HSM--&gt;&gt;API: Sealed response B (fiscal_number: 102)\n    API--&gt;&gt;C1: Invoice sealed (101)\n    API--&gt;&gt;C2: Invoice sealed (102)</code></pre>"},{"location":"platform/multi-user/#invoice-tagging","title":"Invoice tagging","text":"<p>Every sealed invoice carries metadata identifying who submitted it:</p> <pre><code>{\n  \"fiscal_number\": \"BONO-OUTLET42-101\",\n  \"merchant_nif\": \"123456789\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"submitted_by\": {\n    \"type\": \"user\",\n    \"id\": \"USR-007\",\n    \"role\": \"cashier\"\n  },\n  \"source\": \"dashboard\"\n}\n</code></pre> <p>For API key submissions, <code>submitted_by</code> contains <code>\"type\": \"api_key\"</code> and the key ID. The <code>source</code> field indicates the channel: <code>dashboard</code>, <code>api</code>, or <code>sdk</code>.</p>"},{"location":"platform/multi-user/#api-key-management","title":"API key management","text":"<ul> <li>Creation: Owners and Managers create API keys scoped to a specific outlet via the dashboard or API.</li> <li>Rotation: Keys can be rotated without downtime \u2014 the old key remains valid for a configurable grace period (default: 24 hours).</li> <li>Revocation: Immediate revocation is available. Revoked keys return <code>401 Unauthorized</code>.</li> <li>Scoping: Each API key specifies which operations it can perform (e.g., create invoices only, or create + view reports).</li> </ul>"},{"location":"platform/multi-user/#audit-trail","title":"Audit trail","text":"<p>All user and API key actions are logged with:</p> <ul> <li><code>user_id</code> or <code>api_key_id</code></li> <li>Action performed (create_invoice, view_report, manage_user, etc.)</li> <li>Timestamp</li> <li>Outlet context</li> <li>IP address / user agent</li> </ul> <p>Audit logs are available via the dashboard (Manager/Owner) and through the <code>/api/v1/audit/actions</code> endpoint.</p>"},{"location":"platform/multi-user/#session-management","title":"Session management","text":"<ul> <li>Dashboard sessions use secure cookies with <code>HttpOnly</code>, <code>Secure</code>, and <code>SameSite=Strict</code> attributes.</li> <li>Session tokens are rotated on login to prevent session fixation.</li> <li>Idle sessions expire after 30 minutes (configurable per merchant).</li> <li>API keys do not use sessions \u2014 they authenticate via <code>Authorization: Bearer &lt;api_key&gt;</code> on every request.</li> </ul>"},{"location":"platform/overview/","title":"Platform Overview","text":""},{"location":"platform/overview/#what-is-bono-pay","title":"What is Bono Pay?","text":"<p>Bono Pay is fiscal invoicing infrastructure for the DRC\u2014think Stripe Invoices for compliance teams that need canonical payloads, trusted fiscal numbers, and HSM-backed signing without shipping any hardware.</p>"},{"location":"platform/overview/#how-bono-pay-works","title":"How Bono Pay works","text":"<ol> <li>Client apps (web dashboard, REST API consumers, and SDKs) prepare canonical JSON invoices with deterministic field ordering (<code>merchant_id</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, <code>timestamp</code>) and queue drafts in IndexedDB/SQLite when offline.</li> <li>The Invoicing API validates schema, enforces the 14 DGI tax groups and client classifications (Individual, Company, CommercialIndividual, Professional, Embassy), applies rounding rules, and forwards the sanitized payload to the Cloud Signing Service.</li> <li>The Cloud Signing Service (HSM) requests the next sequential fiscal number from the Monotonic Counter Manager, signs the payload, timestamps the event, generates the QR payload, and anchors the sealed invoice inside the append-only Fiscal Ledger while the Report Generator refreshes Z/X/A/audit summaries.</li> <li>The sealed invoice (fiscal number, auth code, timestamp, QR, fiscal authority ID, ledger hash) flows back to the caller so receipts can be delivered via email, WhatsApp, PDF, or thermal print; ledger entries are also accessible to auditors and API consumers.</li> <li>The Sync Agent ships the sealed payload to the DGI\u2019s MCF/e-MCF control modules, tracks the <code>dgi_status</code> (<code>queued</code>, <code>synced</code>, <code>failed</code>), and surfaces acknowledgments through dashboards, webhooks, and SDK callbacks.</li> </ol>"},{"location":"platform/overview/#platform-flow","title":"Platform Flow","text":"<pre><code>flowchart LR\n  A[\"API / Dashboard\"] --&gt; C[\"Bono Pay Cloud\\nInvoicing API + Cloud Signing Service HSM\"]\n  B[\"SDKs &amp; Integrations\"] --&gt; C\n  C --&gt; D[\"Sealed Invoice\\nFiscal Ledger &amp; Report Generator\"]\n  D --&gt; E[\"Email / WhatsApp / PDF / Print\"]\n  D --&gt; F[\"Sync Agent \u2014 MCF/e-MCF\"]</code></pre>"},{"location":"platform/overview/#design-principles","title":"Design principles","text":"<ul> <li>Cloud-first trust boundary: The Cloud Signing Service (HSM) is the only authority for fiscal numbers, auth codes, timestamps, and QR payloads; client apps never fabricate or mutate security elements.</li> <li>Offline resilience: Inspired by the Odoo lessons, the PWA caches catalogs and customers in IndexedDB, keeps service workers alive, shows fiscal device status badges, and flushes IndexedDB/SQLite queues only after the canonical payload is sealed.</li> <li>Deterministic canonical payloads: Field ordering, tax group metadata, and payment records are never reshuffled so the Fiscal Ledger and QR payloads remain verifiable.</li> <li>Multi-user, multi-tenant scale: Each invoice tags <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, and API key scopes so the Monotonic Counter Manager serializes numbering per outlet while roles and quotas protect tenants.</li> <li>Mobile money + multi-currency support: Airtel Money, M-Pesa, Orange Money, and USD/CDF split payments are front and center so traders and schools can use cash and mobile instruments simultaneously.</li> <li>AI-assisted, human-confirmed: Natural language invoice creation, tax auto-classification, anomaly detection, and predictive analytics are embedded across the platform \u2014 but the Cloud Signing Service remains the sole fiscal authority. AI suggests; the HSM decides. See AI &amp; Natural Language Capabilities.</li> </ul>"},{"location":"platform/overview/#target-users","title":"Target users","text":"<ul> <li>Finance teams and comptrollers who need sealed invoices, Z/X/A/audit reports, and instant receipts (email, WhatsApp, PDF, print) without managing hardware.</li> <li>Merchants and cashiers who create invoices by typing a natural language message \u2014 in French, Lingala, or Swahili \u2014 via WhatsApp or the dashboard chat widget, and receive a sealed fiscal invoice in seconds. See Natural Language Invoice Creation.</li> <li>Developers building integrations, SDKs, ERP connectors, or webhook consumers who expect Stripe-like payloads, rate limits, and deterministic behavior.</li> <li>POS vendors and retailers preparing for Phase 2 multi-terminal deployment with local fiscal services that mediate access to the cloud signer.</li> <li>Auditors, regulators, and the DGI who demand append-only ledgers, canonical security elements, and verified QR codes for every invoice.</li> </ul>"},{"location":"platform/overview/#security-compliance","title":"Security &amp; compliance","text":"<p>Bono Pay satisfies the SFE specifications: all five invoice types plus the 14 DGI tax groups run through the tax engine, client classification is mandatory, and every sealed invoice includes the fiscal number, fiscal authority ID, cryptographic auth code, trusted timestamp, and QR payload produced by the Cloud Signing Service (HSM). The Fiscal Ledger remains append-only, the Report Generator emits Z/X/A/audit exports, and voids/refunds become new fiscal events instead of deletions.</p> <p>Anyone \u2014 customers, auditors, DGI inspectors \u2014 can verify that an invoice is genuine by scanning the QR code on the receipt or entering the fiscal number at the public verification portal (<code>verify.bonopay.cd</code>). The verification service checks the ECDSA signature against the HSM's public key, confirms hash-chain integrity in the Fiscal Ledger, and reports DGI sync status \u2014 all without requiring login. See Invoice Verification.</p>"},{"location":"platform/overview/#delivery-reporting","title":"Delivery &amp; reporting","text":"<p>Receipt delivery is multi-channel (email, WhatsApp, PDF, thermal print) and always includes the fiscal number plus QR payload while the ledger and Report Generator power Z, X, A, and audit export data for inspectors and finance teams. The WhatsApp Invoice Bot also serves as a delivery and query channel \u2014 merchants can check invoice status, download receipts, and request Z reports directly in their WhatsApp conversation. Offline-first clients queue invoices locally, surface queue depth indicators, and retry until Bono Pay Cloud seals the payload. The Sync Agent handles DGI integration (MCF/e-MCF) so authorized invoices and ledger hashes reach the ministry even when connectivity is intermittent.</p> <p>Anomaly detection continuously monitors the Fiscal Ledger for numbering gaps, velocity spikes, and suspicious patterns, surfacing alerts through the dashboard, email, and webhooks. Predictive analytics project tax liability and revenue trends so finance teams plan ahead rather than react.</p>"},{"location":"platform/overview/#phasing-summary","title":"Phasing summary","text":"<ol> <li>Phase 1 \u2014 Software Invoicing (current): Cloud Signing Service (HSM) is the trusted authority, the Invoicing API/web dashboard/SDK ecosystem produce canonical payloads, and sealed invoices stream to delivery channels while the Sync Agent uploads to the DGI.</li> <li>Phase 2 \u2014 POS &amp; Retail: Multi-terminal POS apps reuse the same cloud fiscal signer, add local fiscal services for shared USB devices, and keep the offline/PWA lessons (service worker, IndexedDB, fiscal status badges) for tablets and phones.</li> <li>Phase 3 \u2014 USB Hardware (optional): The archived USB Fiscal Memory device can become an optional trust anchor for DEF-homologated outlets; its documentation lives in <code>design/docs-archive/hardware/</code> while the cloud still mirrors every sealed event for reporting and audits.</li> </ol>"},{"location":"platform/sdk/","title":"SDK &amp; Libraries","text":"<p>Bono Pay provides SDKs and client libraries that wrap the Invoicing API so developers can focus on invoices, receipts, and integrations instead of plumbing canonical payloads. This page replaces the legacy POS plugin reference and summarizes the same deterministic payload structure, offline queueing guarantees, and webhook handling that the archived POS plugin document captured.</p>"},{"location":"platform/sdk/#supported-sdks","title":"Supported SDKs","text":"<ul> <li>JavaScript / TypeScript (npm) \u2014 Browser, Electron, React Native, and POS integrations can share the same package.</li> <li>Python (pip) \u2014 Flask/FastAPI backends, ERP connectors, and accounting scripts.</li> <li>PHP (composer) \u2014 Legacy ERP systems or PHP-based ecommerce platforms.</li> <li>Future adopters \u2014 Java, .NET, and native mobile SDKs land in Phase 1+ as usage grows.</li> </ul> <p>Each SDK targets the canonical payload described in <code>spec/design-pos-plugin-api-1.md</code>, enforces authentication headers like <code>Authorization: Bearer</code>, and respects the <code>X-BonoPay-Merchant-ID</code> / <code>X-BonoPay-Outlet-ID</code> scoping that the Invoicing API (<code>design/docs/platform/api.md</code>) requires.</p>"},{"location":"platform/sdk/#core-sdk-features","title":"Core SDK features","text":"<ul> <li>Authentication helpers \u2014 Acquire, refresh, and attach scoped API keys.</li> <li>Canonical payload serialization \u2014 Always order <code>merchant_id</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>items</code>, <code>tax_groups</code>, <code>totals</code>, and <code>payments</code> so signatures remain reproducible (see <code>spec/design-cloud-api-1.md</code> and <code>spec/design-pos-plugin-api-1.md</code>).</li> <li>Offline queue with auto-retry \u2014 IndexedDB (browser) or SQLite (native) keeps drafts, flushes FIFO when connectivity returns, and surfaces fiscal status callbacks (<code>onQueued</code>, <code>onFiscalized</code>, <code>onError</code>).</li> <li>Tax group helpers \u2014 Ship the 14 DGI tax group codes plus client classification validation (Individual, Company, Commercial Individual, Professional, Embassy) before hitting the API.</li> <li>Receipt rendering \u2014 HTML/print-ready templates plus PDF helpers so dashboards and POS screens can embed fiscal numbers, auth codes, and QR payloads.</li> <li>Webhook signature verification \u2014 Validate <code>X-BonoPay-Signature</code> (HMAC-SHA256) before honoring <code>fiscalized</code>, <code>synced</code>, or <code>dgi_rejected</code> events.</li> <li>Webhook receivers + delivery utilities \u2014 Automatically verify payloads, emit typed events, and surface <code>ledger_hash</code> + <code>security_elements</code> for auditing.</li> </ul>"},{"location":"platform/sdk/#getting-started","title":"Getting started","text":""},{"location":"platform/sdk/#javascript-typescript","title":"JavaScript / TypeScript","text":"<pre><code>npm install @bonopay/sdk\n</code></pre> <pre><code>import { BonoPay } from '@bonopay/sdk';\n\nconst client = new BonoPay({ apiKey: process.env.BONOPAY_API_KEY });\nconst invoice = await client.invoices.create({\n  client: { name: 'Acme Ltd', nif: '987654321', classification: 'Company' },\n  items: [{ description: 'Consulting', quantity: 1, unit_price: 500, tax_group: 'TG03' }],\n  currency: 'CDF',\n  merchant_id: 'bonopay-ks-1',\n  outlet_id: 'outlet-kin001',\n  pos_terminal_id: 'pos-sdk-js',\n  cashier_id: 'cashier-42',\n  invoice_type: 'sale',\n  timestamp: new Date().toISOString(),\n  tax_groups: [\n    {\n      code: 'TG03',\n      name: 'Standard VAT \u2014 Services',\n      rate: '0.16',\n      base_amount: '500.00',\n      tax_amount: '80.00'\n    }\n  ],\n  totals: { subtotal: '500.00', total_vat: '80.00', total: '580.00', currency: 'CDF' },\n  payments: [{ method: 'mobile_money', amount: '580.00', instrument_id: 'MOMO-123', currency: 'CDF' }]\n});\n\nconsole.log('Fiscal number', invoice.fiscal_number, 'QR', invoice.qr_payload);\n</code></pre>"},{"location":"platform/sdk/#python","title":"Python","text":"<pre><code>pip install bonopay-sdk\n</code></pre> <pre><code>from bonopay import BonoPay\n\nclient = BonoPay(api_key=os.environ[\"BONOPAY_API_TOKEN\"])\npayload = {\n    \"merchant_id\": \"bonopay-ks-1\",\n    \"outlet_id\": \"outlet-kin001\",\n    \"pos_terminal_id\": \"python-sdk-01\",\n    \"cashier_id\": \"cashier-13\",\n    \"invoice_type\": \"sale\",\n    \"timestamp\": \"2026-02-17T04:00:00Z\",\n    \"client\": {\"name\": \"Acme Ltd\", \"nif\": \"123456789\", \"classification\": \"Company\"},\n    \"items\": [{\"code\": \"CONS-001\", \"description\": \"Consulting hours\", \"quantity\": 2, \"unit_price\": \"500.00\", \"tax_group\": \"TG03\", \"taxable_unit\": \"hour\"}],\n    \"tax_groups\": [{\"code\": \"TG03\", \"name\": \"Standard VAT \u2014 Services\", \"rate\": \"0.16\", \"base_amount\": \"1000.00\", \"tax_amount\": \"160.00\"}],\n    \"totals\": {\"subtotal\": \"1000.00\", \"total_vat\": \"160.00\", \"total\": \"1160.00\", \"currency\": \"CDF\"},\n    \"payments\": [{\"method\": \"mobile_money\", \"amount\": \"1160.00\", \"instrument_id\": \"MOMO-123\", \"currency\": \"CDF\"}]\n}\n\ninvoice = client.invoices.create(payload)\nprint(\"Fiscalized:\", invoice[\"payload\"][\"fiscal_number\"], \"with QR\", invoice[\"payload\"][\"qr_payload\"])\n</code></pre>"},{"location":"platform/sdk/#canonical-payload-tax-helpers","title":"Canonical payload &amp; tax helpers","text":"<p>Every SDK enforces the field ordering defined in <code>spec/design-pos-plugin-api-1.md</code> (merchant_id \u2192 payments) and mirrors the same validation rules described in the Invoicing API reference. Tax group helpers surface the 14 DGI codes plus client classifications before the request leaves the client, so the Cloud Signing Service can trust the payload order and tax totals when the payload arrives.</p>"},{"location":"platform/sdk/#offline-queue-reliability","title":"Offline queue &amp; reliability","text":"<p>Offline is non-negotiable. SDKs queue invoices in IndexedDB (browser) or SQLite (native) with statuses such as <code>draft</code>, <code>queued</code>, <code>fiscalized</code>, and <code>error</code>. When connectivity returns, the SDK flushes invoices FIFO to <code>POST /api/v1/invoices</code>, recomputes totals if the catalog changed, and retries with exponential backoff (100 ms \u2192 5 s \u2192 20 s, max 3 attempts). Each retry line logs the <code>nonce</code>/<code>hash</code> so merchants can audit why a submission was delayed. Fiscal status callbacks keep dashboards in sync: green for <code>fiscalized</code>, yellow for queued, red for errors.</p>"},{"location":"platform/sdk/#webhooks-verification","title":"Webhooks &amp; verification","text":"<p>The SDK verifies <code>X-BonoPay-Signature</code> (HMAC-SHA256) before honoring webhook events that describe <code>dgi_status</code> changes (<code>queued</code>, <code>synced</code>, <code>dgi_acknowledged</code>, <code>fiscal_error</code>). Webhook payloads include <code>fiscal_number</code>, <code>ledger_hash</code>, and the canonical payload hash so applications can reconcile receipts without touching untrusted layers. The SDK also exposes helper functions to render receipts (HTML + PDF) summarizing the security elements and tax breakdown.</p>"},{"location":"platform/sdk/#pos-integration-guide-phase-2-preview","title":"POS integration guide (Phase 2 preview)","text":"<p>Phase 2 POS vendors embed the same SDK to talk to Bono Pay Cloud instead of running a local fiscal service. In practice, each POS terminal becomes another API consumer that connects through the SDK, scopes requests with <code>outlet_id</code> and <code>user_id</code>, and relies on the SDK\u2019s deterministic serialization, offline queue, and webhook callbacks. POS integrations can reuse the same receipt templates, tax group helpers, and webhook logic that existing dashboards use, which means the transition from Phase 1 dashboards to Phase 2 multi-terminal POS systems is seamless.</p>"},{"location":"platform/sdk/#see-also","title":"See also","text":"<ul> <li><code>design/docs/platform/api.md</code> \u2014 the REST endpoints that every SDK targets.</li> <li><code>spec/design-pos-plugin-api-1.md</code> \u2014 formal payload specification and canonical ordering.</li> <li><code>design/docs/api/pos-plugin.md</code> \u2014 legacy plugin reference (archived for Phase 3 compliance) that preserved the original payload examples.</li> </ul>"},{"location":"regulatory/arretes/","title":"DRC fiscal arr\u00eat\u00e9s that govern Bono Pay","text":"<p>Bono Pay lives inside the tightly regulated world of the Facture Normalis\u00e9e mandate. Four ministerial orders work together: - Arr\u00eat\u00e9 032/2023 defines the governance and committee that approves architecture, vendors, and timelines. - Arr\u00eat\u00e9 033/2023 lays down the operational requirements for every invoice and device, enforcing the trust boundary that the governance committee supervises. - Arr\u00eat\u00e9 034/2023 regulates who may commercialize devices and software, so the governance committee can evaluate those suppliers. - Arr\u00eat\u00e9 016/2025 patches the commercialization regime defined in 034 while keeping the operational and governance foundations intact.</p> <p>Each tab below distills one arr\u00eat\u00e9 with the latest implications for Bono Pay. Cross-links point to related orders so reviewers see how governance, operational rules, commercialization, and amendments intersect.</p> <p>Phased compliance</p> <p>Bono Pay addresses these regulations in phases: Phase 1 (Software Invoicing) uses the Cloud Signing Service (HSM) as the trusted fiscal authority. Phase 3 introduces the USB Fiscal Memory device (DEF) for merchants requiring hardware homologation. The regulatory obligations remain constant across phases \u2014 only the trusted signer changes.</p> Arr\u00eat\u00e9 032 \u2014 Governance"},{"location":"regulatory/arretes/#arrete-032","title":"Arr\u00eat\u00e9 n\u00b0032/2023 \u2014 Governance of the reform","text":"<p>Arr\u00eat\u00e9 032 does not touch invoices directly; it creates the Comit\u00e9 de Suivi with a Steering Committee, Technical Committee, and Technical Secretariat that oversee every design, budget, and deployment decision. It authorizes external technical providers, controls procurement, and appoints the bodies that approve the operational framework in Arr\u00eat\u00e9 033 and the commercialization rules in Arr\u00eat\u00e9 034.</p> <p>Key responsibilities - Validate the project charter, architecture, and vendor selections. - House the Technical Committee that drafts specifications, including the Bono Pay architecture. - Command the Technical Secretariat to document all decisions and preserve institutional memory. - Manage political relationships with the DGI, DGDA, and other ministries so that operational changes (e.g., new invoices, reports, or compliance hooks) can roll out in harmony with the enforcement path defined in Arr\u00eat\u00e9 033.</p> <p>Bono Pay implications - Every new architecture document (specs, ADRs, APIs) must be up for review by this committee, so keep changelogs and summaries ready. - Vendor certification requests and pricing disclosures ultimately flow to the same governance body that owns the rules in Arr\u00eat\u00e9 034. - The Technical Committee can change specs without new legislation; the documentation process must stay flexible to respond to rapid directives.</p> Arr\u00eat\u00e9 033 \u2014 Operational rules"},{"location":"regulatory/arretes/#arrete-033","title":"Arr\u00eat\u00e9 n\u00b0033/2023 \u2014 Operationalizing the standardized invoice","text":"<p>This is the core operational law. It forces every VAT-registered merchant to issue a standardized invoice through an approved system, insists on physical DEFs or e-UF/e-MCF fallback pathways, and moves compliance from periodic reporting to continuous, always-on discipline.</p> <p>Highlights - Every transaction must return a sealed invoice with DEF-generated security elements; no invoice equals non-compliance, even offline. - Two parallel enforcement paths: physical USB/DEF devices (UF + MCF) or controlled cloud/electronic systems, both required to keep fallback hardware handy. - Vendors must certify devices, provide maintenance, and keep audited change logs\u2014feeding back into the governance structure in Arr\u00eat\u00e9 032. - Device lifecycles are strictly controlled: activation, deactivation, and failure reporting happen under DGI supervision. - Financial incentives (50% hardware tax credit) accelerate adoption while tightening penalties for misuse.</p> <p>Cross-references - The governance in Arr\u00eat\u00e9 032 approves the technical architecture that this operational order enforces. - The supplier certification pipeline in Arr\u00eat\u00e9 034 makes sure only homologated technology appears in this mandate. - Arr\u00eat\u00e9 016/2025 (see below) softens supplier scarcity but leaves the obligation to fiscalize every sale unchanged.</p> <p>Bono Pay implications - In Phase 1, the Cloud Signing Service (HSM) fulfills the DEF role via software. In Phase 3, the USB device provides hardware-level compliance. - Offline-first behavior is a legal requirement \u2014 not a convenience \u2014 so client applications must queue unsigned drafts and submit them once the cloud is reachable. - Outlet registration, activation, and failure reporting need automation so DGI inspectors see the same data the law demands.</p> Arr\u00eat\u00e9 034 \u2014 Commercialization and market design"},{"location":"regulatory/arretes/#arrete-034","title":"Arr\u00eat\u00e9 n\u00b0034/2023 \u2014 Licensing fiscal sellers","text":"<p>Arr\u00eat\u00e9 034 regulates who can sell DEF hardware and SFE software. It institutes a four-role model (DEF, SFE, suppliers, distributors), a multi-stage approval pipeline (agr\u00e9ment \u2192 homologation \u2192 authorization), strict distributor obligations, and price visibility to keep the market traceable. The first version even limited suppliers to three, creating regional monopolies (later relaxed by Arr\u00eat\u00e9 016/2025).</p> <p>Key rules - Suppliers must prove technical, financial, and logistical readiness, maintain 24-month manufacturer partnerships, and undergo homologation every time they change their product. - Distributors install, train, and support \u2014 users cannot self-install, ensuring traceability. - The tax authority monitors stock, spare parts, pricing, and reporting; any deviation can trigger withdrawal. - SFE providers must guarantee immutability, security, and archival retention, aligning with the reporting expectations from Arr\u00eat\u00e9 033.</p> <p>Bono Pay implications - Homologation planning is critical: almost any firmware or configuration change needs declaration or re-certification. - Distributor relationships matter; Bono Pay needs trusted partners to cover installation, training, and maintenance. - Pricing changes are visible to DGI, so every offer must include a pre-approved price list. - The governance body in Arr\u00eat\u00e9 032 uses these commercialization metrics to approve vendors, so keep documentation ready.</p> Arr\u00eat\u00e9 016/2025 \u2014 Amendment to Arr\u00eat\u00e9 034"},{"location":"regulatory/arretes/#arrete-016-2025","title":"Arr\u00eat\u00e9 n\u00b0016/2025 \u2014 Scaling amendment","text":"<p>This amendment keeps the commercialization controls of Arr\u00eat\u00e9 034 but fixes key bottlenecks: it removes the three-supplier ceiling, limits approvals to two-year renewable terms, clarifies minor update handling, and tightens distributor accountability while leaving mandatory fiscalization intact.</p> <p>What changed - Unlimited suppliers (while retaining technical, financial, and coverage thresholds) so the market can scale without artificial scarcity. - Supplier approvals now expire after two years, introducing planned renewal activities for Bono Pay. - Minor software changes can be declared instead of undergoing full re-homologation, reducing friction for SFE iterations noted in Arr\u00eat\u00e9 033. - Distributor obligations now explicitly cover user onboarding, training, and fair territorial coverage with price discipline still enforced. - Enterprises may seek conditional exemptions, acknowledging complex ERP/SFE deployments while keeping governance oversight from Arr\u00eat\u00e9 032.</p> <p>Bono Pay implications - The path to certification is more realistic, but the two-year cadence demands an approval lifecycle plan. - Minor updates no longer require major re-certification, so the documentation strategy should categorize changes as \"minor\" vs. \"material\" and declare them appropriately. - Pricing discipline and distributor accountability remain high-priority constraints, so contractual language must reference this order alongside Arr\u00eat\u00e9 034. - The amendment is an explicit acknowledgement that the same operational rules in Arr\u00eat\u00e9 033 still apply even as the commercialization regime adapts.</p>"},{"location":"regulatory/legal-framework/","title":"DRC Fiscal Compliance Legal Framework","text":"<p>The Democratic Republic of Congo layers multiple ministerial orders and technical specifications to move every transaction through a trusted fiscal control stack. Bono Pay must navigate that stack: the governance machine that approves strategy, the operational rules that ban deleted invoices, the commercialization controls that limit who may sell hardware, the amendments easing scaling, and the SFE technical specification that defines what every compliant billing system must emit.</p>"},{"location":"regulatory/legal-framework/#regulatory-hierarchy","title":"Regulatory hierarchy","text":"<pre><code>flowchart TB\n    A[\"Arr\u00eat\u00e9 032/2023&lt;br/&gt;Governance Committee\"]\n    B[\"Arr\u00eat\u00e9 033/2023&lt;br/&gt;Standardized Invoice &amp; DEF Rules\"]\n    C[\"Arr\u00eat\u00e9 034/2023&lt;br/&gt;Commercialization &amp; Licensing\"]\n    D[\"Arr\u00eat\u00e9 016/2025&lt;br/&gt;Scaling Discipline &amp; Updates\"]\n    E[\"SFE Specifications v1.0&lt;br/&gt;Technical Billing Requirements\"]\n    A --&gt; B\n    A --&gt; C\n    B --&gt; E\n    C --&gt; E\n    D --&gt; C\n    D --&gt; E\n    C -.-&gt; D</code></pre>"},{"location":"regulatory/legal-framework/#document-summaries","title":"Document summaries","text":"Document Scope Bono Pay impact Arr\u00eat\u00e9 032/2023 Creates the Comit\u00e9 de Suivi with Steering Committee, Technical Committee, and Secretariat that own governance, procurement, and documentation for the standardized invoicing reform. Stay aligned with the committees, treat governance decisions as authoritative, keep documentation up to date, and position Bono Pay as a staffed technical partner rather than a pure vendor. Arr\u00eat\u00e9 033/2023 Defines the mandatory issuance of standardized invoices, the dual (physical DEF + e-DEF) enforcement paths, device/fallback requirements, and the operational discipline every VAT-registered merchant must maintain. Design Bono Pay so every sale is a fiscal event, support offline-first issuance with trusted security elements, include fallback hardware (USB device per outlet), and make error reporting realtime; expect inspectors everywhere. Arr\u00eat\u00e9 034/2023 Regulates who may commercialize DEF and SFE products through pre-qualification, homologation, and distribution pipelines, with certified suppliers, distributors, and price transparency obligations. Plan for a regulated sales channel: seek homologation, partner with distributors for installation/support, disclose pricing, and maintain spare parts / stock for at least three years. Arr\u00eat\u00e9 016/2025 Adjusts commercialization rules by removing supply caps, adding two-year approval windows, clarifying which updates require re-homologation, and reinforcing distributor accountability. Treat regulatory approvals as renewable (every two years), declare minor IMS updates instead of full re-cert, honor consistent pricing, and ensure distributors can cover training/support/territory responsibilities. SFE Specifications v1.0 DGI technical requirements for certified enterprise billing systems: layered SFE \u2192 DEF \u2192 MCF \u2192 DGI architecture plus 14 tax groups, five invoice types, mandatory security elements, reports, offline behavior, and immutable storage. Embed all five invoice types, implement every tax group/client classification, enforce security element generation in the hardware layer, produce Z/X/A/audit outputs, and respect immutability/offline expectations before any cloud sync."},{"location":"regulatory/legal-framework/#adoption-timeline","title":"Adoption timeline","text":"Date Regulation Milestone 2023-10-23 Arr\u00eat\u00e9 032/033/034 Governance body formed, standardized invoice rules enforced, and commercialization controls put in place; merchants had a three-month compliance window (extendable two months) and must keep approved hardware active. 2025-02-27 Arr\u00eat\u00e9 016/2025 Supplier cap removed, approval validity capped at two years, minor software updates declarable, pricing discipline strengthened, and distributor obligations clarified to improve throughput. 2023 (DGI) SFE Specifications v1.0 Living technical reference for every billing system to integrate with DEF/MCF, enforce 14 tax groups, 5 invoice types, security elements, and mandated reports; treat as evergreen until superseded."},{"location":"regulatory/legal-framework/#key-compliance-deadlines-expectations","title":"Key compliance deadlines &amp; expectations","text":"<ul> <li>Rapid compliance window (Arr\u00eat\u00e9 033): VAT-registered merchants had three months (plus two-month extension) to transition to approved invoicing systems. Bono Pay\u2019s rollout must be fast because regulators expect no gaps.</li> <li>Approval cadence (Arr\u00eat\u00e9 034 &amp; 016/2025): Pre-qualification and homologation reviews each take up to 30 working days; major modifications trigger re-homologation, while minor updates require declarations. Plan firmware/system changes with these gating periods in mind.</li> <li>Renewal rhythm (Arr\u00eat\u00e9 016/2025): Every homologated DEF/SFE approval lasts two years, so renewal processes must be resourced and scheduled before expiry.</li> <li>Distribution commitments (Arr\u00eat\u00e9 034 &amp; 016/2025): Maintain 60-day replenishment pledges, three-year spare-part guarantees, consistent pricing disclosures, and accountable distributors covering onboarding and after-sales.</li> <li>Technical observability (SFE spec): Archives must retain invoices for at least one year, report outputs (Z/X/A/audit) must be generated locally, and every invoice must carry sequential fiscal number, device ID, signature, timestamp, and QR code before syncing; offline issuance remains normal operation.</li> <li>Fallback &amp; resilience (Arr\u00eat\u00e9 033): Hardware failure is not an excuse\u2014fallback systems must stay powered; replacement devices and offline queues must be ready immediately whenever connectivity or device issues occur.</li> </ul>"},{"location":"regulatory/legal-framework/#phased-compliance-strategy","title":"Phased compliance strategy","text":"Phase Scope Compliance approach Phase 1 \u2014 Software Invoicing API-first invoicing platform with Cloud Signing Service (HSM) Cloud HSM generates all security elements. Meets SFE requirements via software. Manual DGI submissions until MCF/e-MCF API is published. Phase 2 \u2014 POS &amp; Retail POS SDK, multi-terminal, mobile money POS terminals connect as API consumers. Cloud remains fiscal authority. Phase 3 \u2014 USB Hardware USB Fiscal Memory device (DEF) for DEF homologation Optional USB device signs invoices locally. Cloud syncs sealed data to DGI. Full hardware homologation path. Phase 4 \u2014 Enterprise ERP connectors, fleet management, analytics Enterprise integrations built on the established fiscal platform."},{"location":"regulatory/legal-framework/#implications-for-bono-pay","title":"Implications for Bono Pay","text":"<ol> <li>Governance alignment: Treat the Steering and Technical Committees as the ultimate arbiters \u2014 submit architecture and compliance reports, engage politically, and log every decision for the Secretariat.</li> <li>Operational discipline: The invoicing platform and Cloud Signing Service must enforce the layered mandate (SFE \u2192 trusted signer \u2192 MCF \u2192 DGI) with the append-only Fiscal Ledger, security elements, and per-outlet serialized numbering.</li> <li>Commercial readiness: Homologation, distributor partnerships, pricing disclosures, spare parts, and two-year renewal plans are as critical as software delivery.</li> <li>Technical completeness: Support all 14 tax groups, five invoice types, offline-first behavior, and mandated reports before reaching DGI; treat the SFE spec as a living contract even as regulatory details (e.g., QR payloads) evolve.</li> </ol>"},{"location":"regulatory/sfe-specs/","title":"SFE Specifications (v1)","text":"<p>This page distills the DGI Syst\u00e8me de Facturation d'Entreprise (SFE) requirements so the Bono Pay design team can trace every regulatory demand to our architecture, fiscal flows, and hardware guarantees.</p> <p>The official summary calls out the layered deployment (SFE \u2192 DEF \u2192 MCF/e-MCF \u2192 DGI), mandates five invoice types, demands all 14 tax groups, requires Z/X/A/audit reporting, and insists security elements come from the trusted fiscal layer\u2014not the POS. These constraints steer the content on the fiscal engine, hardware, and reports pages.</p> <p>Trust boundary reminder</p> <p>In Phase 1, the Cloud Signing Service (HSM) is the trusted component that generates fiscal numbers, authentication codes, trusted timestamps, and QR codes. In Phase 3, the USB Fiscal Memory device (DEF) can assume this role for merchants needing hardware homologation. In both phases, client applications (API consumers, dashboard, SDK) must treat security elements as sealed outputs. See Architecture Trust Boundary for details.</p>"},{"location":"regulatory/sfe-specs/#mandatory-invoice-types","title":"Mandatory Invoice Types","text":"Invoice Type French Label Purpose Sale invoice Facture de vente Everyday retail/wholesale sales; the default workflow in <code>design/docs/fiscal/invoice-lifecycle.md</code>. Advance invoice Facture d'avance Payments received before goods/services are fulfilled; still requires PREPARE \u2192 COMMIT. Credit note Note de cr\u00e9dit Correction for returned goods or billing adjustments; treated as a new fiscal event. Export invoice Facture d'exportation Sales destined outside the DRC; destines the invoice to TG07 (Export Zero Rate). Export credit note Note de cr\u00e9dit d'exportation Refund tied to an export transaction, sequenced independently like all refunds. <p>Each type is implemented by the same canonical flow documented in the Invoice Lifecycle page: client submits the canonical payload to the Cloud Signing Service, receives the sealed response with security elements, and delivers the receipt.</p>"},{"location":"regulatory/sfe-specs/#14-dgi-tax-groups","title":"14 DGI Tax Groups","text":"Code Name Rate Notes TG01 Exempt 0% Diplomats, embassies, NGOs, government transfers. TG02 Standard VAT \u2014 Goods 16% Default for tangible goods. TG03 Standard VAT \u2014 Services 16% Professional and intangible services. TG04 Reduced VAT 9% Essential foodstuffs and medicines flagged in catalog metadata. TG05 Public Financing VAT 16% Publicly funded programs; requires funding source metadata. TG06 Customs VAT 16% Imported goods (CIF basis) in addition to duties. TG07 Export Zero Rate 0% Goods/services consumed outside the DRC; requires export certificate. TG08 Special Regime \u2014 Agriculture 5% Agribusiness items registered under the agricultural regime. TG09 Special Regime \u2014 Mining 10% Mining sector goods/services with operator license metadata. TG10 Specific Tax \u2014 Fuel 25% Excise on gasoline, diesel, aviation fuel. TG11 Specific Tax \u2014 Tobacco 30% Applies to cigarettes, cigars, and tobacco preparations. TG12 Specific Tax \u2014 Alcohol 20% Spirits, beer, wine sold for domestic consumption. TG13 Specific Tax \u2014 Telecommunications 15% Mobile/data/SMS packages; include telecom operator ID. TG14 Specific Tax \u2014 Digital Services 12% Streaming, SaaS, online advertising delivered to DRC clients. <p>These codes feed the canonical <code>tax_groups</code> manifest described in <code>spec/schema-tax-engine-1.md</code> (project root) and are enforced by the Tax Engine. Each invoice must carry a <code>tax_summary</code> entry per group, and the Fiscal Ledger uses these to drive the Z/X/A reports.</p>"},{"location":"regulatory/sfe-specs/#required-reports","title":"Required Reports","text":"Report Purpose Trigger Z Report Daily closure with totals per tax group, fiscal number range, and ledger hash. End-of-day or manual closure; cloud-initiated. X Report Periodic/session snapshot with counts, totals by payment method, and platform health. Configurable (hourly/shift) for operators or auditors. A Report Article-level detail, enumerating every line item with tax group, client classification, and invoice reference. On-demand for audits or DGI requests. Audit Export Full append-only journal (sales, voids, refunds, resets) sent in chunks for deep reconciliation. Scheduled (monthly/annual) or upon DGI request. <p>Report design lives in <code>design/docs/fiscal/reports.md</code>. The Z/X/A outputs are produced by the Report Generator from the Fiscal Ledger's hash-chained entries and counters.</p>"},{"location":"regulatory/sfe-specs/#security-elements","title":"Security Elements","text":"Element Phase 1: Generated by Phase 3: Generated by Where referenced Sequential fiscal number Cloud Signing Service (Monotonic Counter Manager) USB Fiscal Memory device Printed on every receipt; enforced by the per-outlet counter. Fiscal authority ID Cloud Signing Service (HSM cluster ID) USB Fiscal Memory device (DEF NID) Identifies the trusted signer in every response and sync payload. Authentication code Cloud HSM (ECDSA signature) DEF Secure Element (ECDSA) Cryptographic proof stored in the Fiscal Ledger. Trusted timestamp Cloud infrastructure (NTP-synced) DEF RTC Anchor for chronological integrity; the Sync Agent uses it for ordering. QR code Cloud Signing Service (encoded fiscal number + auth code + timestamp) DEF (same encoding) Exposed to inspectors and customers; verified by DGI and internal tools. <p>In Phase 1, every element comes from the Cloud Signing Service. In Phase 3, the DEF generates them locally. Client applications may only display these values \u2014 see Security Elements for per-element verification rules.</p>"},{"location":"regulatory/sfe-specs/#offline-behavior-dgi-integration","title":"Offline Behavior &amp; DGI Integration","text":"<p>The specification emphasizes that offline operation is normal. In Phase 1, client applications queue unsigned draft payloads locally (IndexedDB / SQLite) when the cloud is unreachable. Once connectivity returns, the drafts are submitted to the Cloud Signing Service for sealing. The Sync Agent then uploads sealed invoices to the MCF/e-MCF control modules. A dedicated sync state machine ensures retries, grace periods, and conflict resolution:</p> <ul> <li><code>design/docs/cloud/offline-sync.md</code> documents how drafts transition from <code>QUEUED</code> to <code>SEALED</code> (via the Cloud Signing Service) and how sealed invoices are uploaded to the DGI.</li> <li><code>design/docs/cloud/dgi-integration.md</code> captures the known vs unknown pieces of the MCF/e-MCF API and highlights the remaining blockers for homologation.</li> </ul> <p>This layered behavior mirrors the core architecture: canonical payloads flow from client applications to the Cloud Signing Service (or DEF in Phase 3), then sealed invoices flow through the Sync Agent to the DGI control modules.</p>"},{"location":"regulatory/sfe-specs/#data-integrity-immutability-and-mutations","title":"Data Integrity, Immutability, and Mutations","text":"<p>The SFE must never delete invoices. Corrections are credit notes, voids are new fiscal events, and all entries remain in the append-only Fiscal Ledger. These expectations appear in the Invoice Lifecycle narrative and the Architecture Context Map (<code>memory-bank/context-map.md</code> in the project root). Any mutation references the original invoice and is submitted as a new canonical payload to the Cloud Signing Service (or DEF in Phase 3), ensuring auditability.</p> <p>This page is part of the regulatory view of the MkDocs site. For additional context, consult the DRC Legal Framework overview and the Arr\u00eat\u00e9 Summaries tabs.</p>"}]}