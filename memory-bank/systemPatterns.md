# System Patterns

## Trust boundary
POS applications (mobile, tablet, SaaS) and KutaPay Cloud are untrusted: they assemble canonical payloads, queue transmissions, and forward fiscal responses. The USB Fiscal Memory device is the trusted fiscal authority; it alone validates schema, increments the monotonic counter, signs data, stores an immutable entry, and returns the fiscal number, auth code, timestamp, and QR code.

## Offline-first
Fiscalization happens locally on the USB device regardless of connectivity. The device continues to accept canonical payloads, even when the cloud or DGI are unreachable, while the POS/cloud store queued, sealed invoices for deferred uploads.

## Multi-terminal per-outlet
One USB device is paired with each outlet (not each cashier). Retail or restaurant environments run multiple POS terminals that communicate with a shared local fiscal service over Wi-Fi/LAN. Every payload tags outlet ID, POS terminal ID, and cashier/waiter ID so the device can enforce sequential ordering per outlet.

## Two-phase commit
The device implements the PREPARE → COMMIT cycle: the POS prepares a request, the device validates the schema/counters, and only after consensus does it commit with the cryptographic signature and log append. Partial states must be handled gracefully; failures revert to a safe state without incrementing the fiscal counter.

## Immutable, hash-chained journal
Each log entry links to the previous record to prevent tampering and support audits. The device generates Z, X, and A reports and exports audit logs based on the append-only journal. Nothing is deleted—voids/refunds are recorded as new fiscal events referencing the original invoice.

## Security elements
Every sealed invoice carries the device-controlled fiscal number, device ID (DEF NID), authentication signature, trusted timestamp, and QR code. These values are generated by the USB device, not the POS. The canonical payload always includes tax group detail, client classification, and deterministic field ordering to make signatures reproducible.
